/*! For license information please see index.js.LICENSE.txt */
(()=>{var e={48:(e,a,t)=>{const n=t(7252).Router(),i=t(7789),{storeActivityCalendarValidator:s}=t(9334),{updateActivityCalendarValidator:r}=t(2972),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.monev_activity_calendar"]),i.index),n.get("/show/:id",u(["view.monev_activity_calendar"]),i.show),n.post("/create",u(["create.monev_activity_calendar"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.monev_activity_calendar"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.monev_activity_calendar"]),i.destroy),e.exports=n},52:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(2273),s=t(4930),r=t(2482);e.exports=async function(e){const a=e.cms_event_category_id?await s("cms_events_categories").where("id",e.cms_event_category_id).first():null,t=await n(e.thumbnail_ids,"documents",r);return{id:e.id,eventCategory:a?await i(a):null,thumbnail:t,title:e.title,description:e.description,eventContent:e.event_content,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},99:e=>{e.exports={toYoutubeEmbed:function(e){try{const a=new URL(String(e)),t=a.hostname.replace(/^www\./,"").toLowerCase();if(!new Set(["youtube.com","m.youtube.com","youtu.be","youtube-nocookie.com","music.youtube.com"]).has(t)&&!t.endsWith(".youtube.com"))return e;if(a.pathname.startsWith("/embed/"))return e;let n=null;const i=a.pathname.split("/").filter(Boolean);if("youtu.be"===t?n=i[0]||null:a.pathname.startsWith("/watch")?n=a.searchParams.get("v"):a.pathname.startsWith("/shorts/")?n=i[1]||i[0]||null:a.searchParams.get("v")&&(n=a.searchParams.get("v")),!n)return e;const s=function(e){if(!e)return null;if(/^\d+$/.test(String(e)))return parseInt(e,10);const a=String(e).match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);if(!a)return null;const t=3600*parseInt(a[1]||0,10)+60*parseInt(a[2]||0,10)+parseInt(a[3]||0,10);return Number.isFinite(t)?t:null}(a.searchParams.get("t")||a.searchParams.get("start")),r=a.searchParams.get("list"),o=`https://www.youtube.com/embed/${encodeURIComponent(n)}`,l=new URLSearchParams;return s&&s>0&&l.set("start",String(s)),r&&l.set("list",r),l.toString()?`${o}?${l.toString()}`:o}catch{return e}}}},168:(e,a,t)=>{const n=t(4930),i=t(7484),{toArray:s}=t(7872),{applySearch:r,applyPagination:o,applyRelationIn:l,formatPaginationResult:d}=t(3210),u=t(1332),c=t(6870),m=t(2668),p=t(3345),{applyTrashedScope:g}=t(7438);a.index=async(e,a)=>{const{search:t,topicId:p,status:w}=e.query,h=p??e.query["topicId[]"];try{let i=n("kmis_learning_attempts as quizParticipant").leftJoin("users as user","quizParticipant.attempt_by","user.id").leftJoin("kmis_topics as topic","quizParticipant.kmis_topic_id","topic.id").select("quizParticipant.*").orderBy("quizParticipant.created_at","desc");if(g(i,e,"quizParticipant.deleted_at"),l(i,"quiz.kmis_topic_id",h,{as:"number"}),w){const e=s(w).map(Number).filter(e=>[1,2,3].includes(e));e.length>0&&(i=i.whereIn("quizParticipant.quiz_attempt_status",e))}r(i,t,["user.name","topic.title"]);const p=o(e.query),_=await d(i,p,n);if(0===_.data.length){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const k=await Promise.all(_.data.map(e=>m(e))),b=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data partisipan ujian berhasil diambil.",{data:k,pagination:_.pagination});return a.status(200).json(b.toResponse())}catch(e){i.error(`| Quiz Partisipant KMIS | - Error function index : ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await n("kmis_learning_attempts").where("id",t).whereNull("deleted_at").first();if(!e){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data partisipan ujian dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=e.kmis_topic_id;if(!i){const i=await n("kmis_quiz_responses as r").select("r.*").where("r.kmis_learning_attempt_id",t).whereNull("r.deleted_at").orderBy("r.answered_at","asc");if(0===i.length){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data jawaban kuis untuk attempt '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const[s,r]=await Promise.all([m(e),Promise.all(i.map(e=>p(e)))]),o=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail jawaban kuis yang dikerjakan peserta berhasil didapatkan.",{learningParticipant:s,exam:r});return a.status(200).json(o.toResponse())}const s=await n("kmis_quiz as q").select("q.*").whereNull("q.deleted_at").where(function(){this.where("q.kmis_topic_id",i)}).orderBy("q.created_at","asc"),r=await n("kmis_quiz_responses as r").select("r.*").where("r.kmis_learning_attempt_id",t).whereNull("r.deleted_at"),o=new Map(r.map(e=>[Number(e.kmis_quiz_id),e])),l=[];for(const e of s){const a=o.get(Number(e.id));a?l.push(a):l.push({id:null,kmis_learning_attempt_id:t,kmis_quiz_id:e.id,selected_option:null,is_marker:null,is_correct:null,answered_at:null,created_at:null,updated_at:null,deleted_at:null})}if(0===l.length){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Tidak ada soal kuis aktif untuk topik attempt '${t}'.`);return a.status(200).json(e.toResponse())}const[d,g]=await Promise.all([m(e),Promise.all(l.map(e=>p(e)))]),w=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail jawaban kuis yang dikerjakan peserta berhasil didapatkan.",{learningParticipant:d,exam:g});return a.status(200).json(w.toResponse())}catch(e){i.error(`| Quiz Partisipant KMIS | - Error function show: ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},248:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l}=t(7872),{asJsonb:d}=t(6192),{applyRelationIn:u,applySearch:c,applyPagination:m,formatPaginationResult:p}=t(3210),g=t(1701),w=t(1332),h=t(6870),_=t(7724),k=t(6479),{applyTrashedScope:b}=t(7438),{applyLatestThenTrashed:f}=t(7540);a.index=async(e,a)=>{const{search:t,categoryId:n,topicType:r}=e.query,o=n??e.query["categoryId[]"],l=r??e.query["topicType[]"];try{let n=i("kmis_topics as topic").leftJoin("kmis_categories as category","topic.kmis_categories_id","category.id").select("topic.*");b(n,e,"topic.deleted_at"),u(n,"topic.kmis_categories_id",o,{as:"number"}),u(n,"topic.topic_type",l,{as:"string"}),c(n,t,["topic.title","category.title"]),f(n,"topic.deleted_at","topic.created_at","topic.id");const s=m(e.query),r=await p(n,s,i);if(0===r.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(r.data.map(e=>_(e))),g=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data topik berhasil diambil.",{data:d,pagination:r.pagination});return a.status(200).json(g.toResponse())}catch(e){s.error(`| Topic KMIS | - Error function index : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{userPic:o,categoryId:l,topicType:u,title:c,description:m,totalQuiz:p,quizDuration:w}=e.body,_=r(o).map(e=>Number(e)).filter(e=>Number.isInteger(e));try{if(w<300){const e=new h(422,"INVALID_QUIZ_DURATION","Durasi Quiz Terlalu Pendek","Durasi quiz minimal adalah 5 menit (300 detik).");return a.status(422).json(e.toResponse())}const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("kmis_topics").whereRaw("lower(title) = lower(?)",[c]).whereNull("deleted_at").first()){const e=new h(422,"DUPLICATE_TITLE","Duplikat Data",`Judul topik '${c}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}if(!o){const e=new h(422,"INVALID_USER_PIC_FORMAT","Format User Pic Tidak Valid","Daftar userPic tidak boleh kosong.");return a.status(422).json(e.toResponse())}if(_.length>0){const e=(await t("users").whereIn("id",_).andWhere("account_status",2).andWhere("role_id",2).select("id")).map(e=>Number(e.id));if(_.filter(a=>!e.includes(a)).length>0){const e=new h(422,"INVALID_USER_PIC","Pengajar Tidak Ditemukan","Sebagian pengajar yang dipilih tidak ditemukan. Pastikan pengguna yang dipilih adalah pengajar dan belum dinonaktifkan.");return a.status(422).json(e.toResponse())}}if(!e.files||0===e.files.length){const e=new h(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File cover wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>1){const e=new h(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(t.mimetype)){const e=new h(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh JPG, JPEG, PNG, dan WebP.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new h(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}const s=await g.uploadDocuments(e.files,e),r=s?.[0],b=Number(r);await t("kmis_topics").insert({user_pic:d(_),kmis_categories_id:l,topic_cover_ids:d([b]),topic_type:u,title:c,description:m,total_quiz:p,quiz_duration:w}).returning("*"),await k.logCreate({userId:k.fromReq(e),module:"kmis",subject:"List Topik"},t),await t.commit();const f=new h(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data topik '${c}' berhasil ditambahkan.`);return a.status(201).json(f.toResponse())}catch(e){await t.rollback(),s.error(`| Topic KMIS | - Error function store: ${e.message}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("kmis_topics").select("*").where("id",t).first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await _(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data topik '${e.title}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Topic KMIS | - Error function show: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{userPic:u,categoryId:c,topicType:m,title:p,description:w,totalQuiz:_,quizDuration:b,materialOrderIds:f,deleteDocumentIds:y}=e.body,R=e.params.id,E=r(u).map(e=>Number(e)).filter(e=>Number.isInteger(e));try{if(b<300){const e=new h(422,"INVALID_QUIZ_DURATION","Durasi Quiz Terlalu Pendek","Durasi quiz minimal adalah 5 menit (300 detik).");return a.status(422).json(e.toResponse())}const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(void 0!==u){if(E&&0===E.length){const e=new h(422,"INVALID_USER_PIC_FORMAT","Format User Pic Tidak Valid","Daftar userPic tidak boleh kosong.");return a.status(422).json(e.toResponse())}if(E.length>0){const e=(await t("users").whereIn("id",E).andWhere("account_status",2).andWhere("role_id",2).select("id")).map(e=>Number(e.id)),n=E.filter(a=>!e.includes(a));if(n.length>0){const e=new h(422,"INVALID_USER_PIC","Pengajar Tidak Ditemukan","Sebagian pengajar yang dipilih tidak ditemukan. Pastikan pengguna yang dipilih adalah pengajar dan belum dinonaktifkan.");return a.status(422).json(e.toResponse())}}}const T=r(f).map(String);if(T&&T.length>0){const e=await t("kmis_materials").whereIn("id",T).select("id").then(e=>{const a=e.map(e=>e.id);return T.filter(e=>!a.includes(e))});if(e.length>0){const t=new h(422,"INVALID_MATERIAL_IDS","ID Material Tidak Valid",`ID material berikut tidak ditemukan di database: ${e.join(", ")}.`);return a.status(422).json(t.toResponse())}}const S=await t("kmis_topics").where("id",R).first();if(!S){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${R}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const A=o(S.material_order_ids).map(String);if(D=T,A.sort().join(",")!==D.sort().join(",")){const e=new h(422,"MATERIAL_ORDER_IDS_MISMATCH","ID Material Tidak Sesuai","ID material dalam 'materialOrderIds' tidak sesuai dengan data yang ada sebelumnya.");return a.status(422).json(e.toResponse())}if(await t("kmis_topics").whereRaw("lower(title) = lower(?)",[p]).whereNull("deleted_at").whereNot("id",R).first()){const e=new h(422,"DUPLICATE_TITLE","Duplikat Data",`Judul '${p}' sudah digunakan pada topik lain.`);return a.status(422).json(e.toResponse())}const I=r(y).map(String),N=["image/jpeg","image/jpg","image/png","image/webp"],j=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="topic_cover_ids",maxFilesAllowed:i=1,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, dan WebP."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:S,deleteDocumentIds:I,files:Array.isArray(e.files)?e.files:[],dbColumn:"topic_cover_ids",maxFilesAllowed:1,allowedTypes:N,sizeLimitBytes:52428800});if(!j.ok){const e=new h(j.http,j.code,j.title,j.desc);return a.status(j.http).json(e.toResponse())}const v=o(S.topic_cover_ids);let O=l(v,{as:"number"})[0]??null;null!=O&&I.includes(String(O))&&(await g.deleteDocuments([O]),O=null);let L=null;Array.isArray(e.files)&&e.files.length>0&&(L=await g.uploadDocuments(e.files,e));const M=L?.[0]??O??null,C=null!=M?[Number(M)]:[],F={kmis_categories_id:c,topic_cover_ids:d(C),topic_type:m,title:p,description:w,total_quiz:_,quiz_duration:b,updated_at:t.fn.now()};void 0!==f&&(F.material_order_ids=i.raw("?",[f])),void 0!==u&&(F.user_pic=d(E)),await t("kmis_topics").where("id",R).update(F),await k.logUpdate({userId:k.fromReq(e),module:"kmis",subject:"List Topik"},t),await t.commit();const P=new h(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data topik '${p}' berhasil diperbarui.`);return a.status(200).json(P.toResponse())}catch(e){await t.rollback(),s.error(`| Topic KMIS | - Error function update : ${e.message}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}var D},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new h(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new h(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("kmis_topics").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data topik yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("kmis_topics").whereIn("id",r).update({deleted_at:t.fn.now()}),await k.logDelete({userId:k.fromReq(e),module:"kmis",subject:"List Topik"},t),await t.commit();const o=new h(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data topik.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| Topic KMIS | - Error function destroy : ${e.message}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new h(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new h(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("kmis_topics").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data topik terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.title?.toLowerCase?.()??""),d=await t("kmis_topics").select(i.raw("lower(title) AS ltitle")).whereNull("deleted_at").whereIn(i.raw("lower(title)"),o),u=new Set(d.map(e=>e.ltitle)),c=new Set,m=new Set;for(const e of r){const a=(e.title||"").toLowerCase();c.has(a)?m.add(a):c.add(a)}const p=[],g=[],w=new Set;for(const e of r){const a=(e.title||"").toLowerCase(),t=u.has(a),n=m.has(a);t||n||w.has(a)?g.push({id:e.id,title:e.title}):(w.add(a),p.push(e))}let _=0;if(p.length>0){const e=p.map(e=>e.id);await t("kmis_topics").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),_=e.length}if(await k.logRestore({userId:k.fromReq(e),module:"kmis",subject:"List Topik"},t),await t.commit(),0===_){const e=new h(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const b=[`Berhasil mengembalikan ${_} data yang terhapus.`];g.length&&b.push(`Terlewat ${g.length} karena bentrok/duplikat data.`);const f=new h(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",b.join(" "));return a.status(200).json(f.toResponse())}catch(e){s.error(`| Topic KMIS | - Error function restore: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},253:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.updateEventValidator=[n("categoryId").notEmpty().withMessage("Kategori kegiatan wajib dipilih.").bail().isInt().withMessage("Kategori kegiatan harus berupa angka.").bail().custom(async e=>{if(!await i("cms_events_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori kegiatan yang Anda pilih tidak ditemukan.");return!0}),n("title").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("eventContent").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},337:e=>{function a(e=""){if("string"!=typeof e)return"";let a=e.normalize("NFD").replace(/\p{Diacritic}/gu,"");return a=a.replace(/\b(ir|dr|drs|dra|prof|h|hj|kh|ust|ustaz|ustadz|ustadzah|s\.?t|s\.?kom|s\.?e|s\.?si|s\.?pd|s\.?pd\.?i|s\.?farm|s\.?kes|m\.?m|m\.?t|m\.?kom|m\.?si|m\.?sc|m\.?pd|m\.?pd\.?i|m\.?kes|m\.?farm|mba|mph|ph\.?d|sp\.?og|sp\.?b|sp\.?pd|sp\.?p|sp\.?t|sp\.?a)\b/gi," "),a=a.replace(/[.,]/g," "),a=a.replace(/\s+/g," ").trim().toLowerCase(),a=a.replace(/[^\p{L}\p{N}]+/gu,""),a}e.exports={normalizeNameForCredential:a,makeInitialPasswordFromName:function(e=""){return`${a(e)}RIMBA2025`},generateRandomPassword:function(e=8){let a="";for(let t=0;t<e;t++)a+="0123456789".charAt(Math.floor(10*Math.random()));return a},stripTitlesOnly:function(e=""){if("string"!=typeof e||!e.trim())return"";let a=e;return a=a.replace(/[,]/g," "),a=a.replace(/\b(?:ir|insinyur|dr|drs|dra|drg|prof|h|hj|kh|ust|ustaz|ustadz|ustadzah|s\.?\s?t|s\.?\s?kom|s\.?\s?e|s\.?\s?si|s\.?\s?pd(?:\.?\s?i)?|s\.?\s?farm|s\.?\s?kes|m\.?\s?m|m\.?\s?t|m\.?\s?kom|m\.?\s?si|m\.?\s?sc|m\.?\s?pd(?:\.?\s?i)?|m\.?\s?kes|m\.?\s?farm|mba|mph|ph\.?\s?d|sp\.?\s?og|sp\.?\s?b|sp\.?\s?pd|sp\.?\s?p|sp\.?\s?t|sp\.?\s?a)\b\.?/gi," "),a=a.replace(/\s{2,}/g," ").replace(/[.;:]+$/g,"").trim(),a=a.replace(/\(\s*\)/g,"").trim(),a}}},339:(e,a,t)=>{const n=t(7252).Router(),i=t(1888),{storeEventValidator:s}=t(6879),{updateEventValidator:r}=t(253),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.cms_management"]),i.index),n.get("/show/:id",u(["view.cms_management"]),i.show),n.post("/create",u(["create.cms_management"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.array("files",20),r,o,i.update),n.delete("/delete",u(["delete.cms_management"]),i.destroy),n.patch("/restore",u(["restore.cms_management"]),i.restore),e.exports=n},360:(e,a,t)=>{const{body:n}=t(7975);a.updateMonthlyRealizationValidator=[n("description").optional({nullable:!0,checkFalsy:!0}).trim().bail().isString().withMessage("Deskripsi harus berupa teks."),n("progress").notEmpty().withMessage("Progres tidak boleh kosong.").bail().toInt().isInt({min:0,max:100}).withMessage("Progres harus bilangan bulat 0 s.d 100."),n("problem").notEmpty().withMessage("Permasalahan tidak boleh kosong.").bail().trim().notEmpty().withMessage("Permasalahan tidak boleh kosong.").bail().isString().withMessage("Permasalahan harus berupa teks.")]},364:(e,a,t)=>{const n=t(7252).Router(),i=t(6967),s=t(5233);n.get("/get-all-news-category",i,s.getAllNewsCategory),n.get("/get-news-category/:id",i,s.getNewsCategorybyId),n.get("/get-all-news",i,s.getAllNews),n.get("/get-news/:id",i,s.getNewsbyId),n.get("/get-news-by-category/:id",i,s.getNewsbyNewsCategoryId),n.get("/get-news-by-slug/:slug",i,s.getNewsbySlug),n.get("/get-all-event-category",i,s.getAllEventCategory),n.get("/get-event-category/:id",i,s.getEventCategorybyId),n.get("/get-all-event",i,s.getAllEvent),n.get("/get-event/:id",i,s.getEventbyId),n.get("/get-event-by-category/:id",i,s.getEventbyEventCategoryId),n.get("/get-all-animal-category",i,s.getAllAnimalCategory),n.get("/get-animal-category/:id",i,s.getAnimalCategorybyId),n.get("/get-all-animal",i,s.getAllAnimalComposition),n.get("/get-animal/:id",i,s.getAnimalCompositionbyId),n.get("/get-animal-by-category/:id",i,s.getAnimalCompositionbyAnimalCategoryId),n.get("/get-all-legal-document",i,s.getAllLegalDocument),n.get("/get-legal-document/:id",i,s.getLegalDocumentbyId),n.get("/get-all-faq",i,s.getAllFaq),n.get("/get-faq/:id",i,s.getFaqbyId),n.get("/get-all-content",i,s.getAllContent),e.exports=n},521:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeTopicValidator=[n("categoryId").notEmpty().withMessage("Kategori topik wajib dipilih.").bail().isInt().withMessage("Kategori topik harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori topik yang Anda pilih tidak ditemukan.");return!0}),n("topicType").notEmpty().withMessage("Tipe topik tidak boleh kosong.").isIn(["Pengetahuan","Pelatihan"]).withMessage("Tipe topik harus salah satu dari Pengetahuan dan Pelatihan."),n("title").notEmpty().withMessage("Judul topik tidak boleh kosong.").bail().isString().withMessage("Judul topik harus berupa teks.").bail().isLength({max:255}).withMessage("Judul topik maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi topik tidak boleh kosong.").bail().isString().withMessage("Deskripsi topik harus berupa teks."),n("totalQuiz").if(n("topicType").equals("Pelatihan")).notEmpty().withMessage("Jumlah soal pertanyaan wajib diisi untuk tipe topik Pelatihan.").bail().isInt().withMessage("Jumlah soal pertanyaan harus berupa angka."),n("quizDuration").if(n("topicType").equals("Pelatihan")).notEmpty().withMessage("Waktu penyelesaian pertanyaan wajib diisi untuk tipe topik Pelatihan.").bail().isInt().withMessage("Waktu penyelesaian pertanyaan harus berupa angka dan satuan detik.")]},601:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeAnimalCompositionValidator=[n("categoryId").notEmpty().withMessage("Kategori komposisi satwa wajib dipilih.").bail().isInt().withMessage("Kategori komposisi satwa harus berupa angka.").bail().custom(async e=>{if(!await i("cms_animal_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori komposisi satwa yang Anda pilih tidak ditemukan.");return!0}),n("name").custom(e=>{if(void 0===e)throw new Error("Nama komposisi satwa tidak boleh kosong.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi komposisi satwa tidak boleh kosong.");return!0}),n("total").notEmpty().withMessage("Total komposisi satwa tidak boleh kosong.").bail().isInt({min:0}).withMessage("Total komposisi satwa harus berupa bilangan bulat lebih besar atau sama dengan 0.").toInt()]},675:(e,a,t)=>{const n=t(4930),i=t(7484),s=t(1332),r=t(6870);a.dashboardInfo=async(e,a)=>{try{const e=await async function(){const e=await n("users").where("role_id",2).whereNull("deleted_at").count({total:"id"}).first();return{value:Number(e?.total??0)}}(),t=await async function(){const e=await n("users").where("role_id",4).whereNull("deleted_at").count({total:"id"}).first();return{value:Number(e?.total??0)}}(),i=await async function(){const e=await n("kmis_topics").whereNull("deleted_at").count({total:"id"}).first();return{value:Number(e?.total??0)}}(),r=await async function(){const e=await n("kmis_materials").whereNull("deleted_at").count({total:"id"}).first();return{value:Number(e?.total??0)}}(),o=await async function(){const e=await n("kmis_quiz").whereNull("deleted_at").count({total:"id"}).first();return{value:Number(e?.total??0)}}(),l=await async function(){const e=await n("kmis_learning_attempts").whereNull("deleted_at").countDistinct({total:"attempt_by"}).first();return{value:Number(e?.total??0)}}(),d=await async function(){const e=await n("kmis_learning_attempts").whereNull("deleted_at").avg({avg_feedback:"feedback"}).first(),a=null==e?.avg_feedback?0:Number(e.avg_feedback);return{value:Number(a.toFixed(2))}}(),u=await async function(){const{rows:e}=await n.raw("\n    WITH months AS (\n      SELECT generate_series(1,12) AS mon\n    ),\n    stats AS (\n      SELECT\n        EXTRACT(MONTH FROM created_at)::int AS mon,\n        COUNT(DISTINCT attempt_by)::int AS cnt\n      FROM kmis_learning_attempts\n      WHERE deleted_at IS NULL\n        AND quiz_attempt_status = 2\n        AND attempt_by IS NOT NULL\n        AND created_at >= date_trunc('year', CURRENT_DATE)\n        AND created_at <  date_trunc('year', CURRENT_DATE) + interval '1 year'\n      GROUP BY 1\n    )\n    SELECT m.mon, COALESCE(s.cnt, 0)::int AS total\n    FROM months m\n    LEFT JOIN stats s ON s.mon = m.mon\n    ORDER BY m.mon;\n  "),a=Array(12).fill(0);for(const t of e){const e=(t.mon??1)-1;a[e]=Number(t.total)||0}return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].map((e,t)=>({name:e,value:a[t]}))}(),c=new s(200,"DATA_FOUND","Data Ditemukan","Data dashboard KMIS berhasil didapatkan.",{totalEducator:e,totalStudent:t,totalTopic:i,totalMaterial:r,totalQuiz:o,totalUserAttemptParticipant:l,averageFeedback:d,userStatsAttemptFinished:u});a.status(200).json(c.toResponse())}catch(e){i.error(`| Dashboard KMIS | - Error function dashboardInfo: ${e.message}`);const t=new r(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},690:(e,a,t)=>{const{body:n}=t(7975);a.updateTargetValidator=[n("description").optional({nullable:!0,checkFalsy:!0}).trim().notEmpty().withMessage("Deskripsi tidak boleh kosong bila dikirim.").bail().isString().withMessage("Deskripsi harus berupa teks."),n("budgetTarget").optional({nullable:!0,checkFalsy:!0}).toInt().isInt({min:0}).withMessage("Target anggaran harus bilangan bulat >= 0."),n("physicalTarget").optional({nullable:!0,checkFalsy:!0}).toFloat().isFloat({min:0}).withMessage("Target fisik harus angka >= 0.")]},769:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{orderByYearMonth:r}=t(9062),{asJsonb:o}=t(6192),{toArray:l,normJsonbArray:d,normIdArray:u,parseJsonSafe:c,isPlainObject:m}=t(7872),p=t(1701),g=t(1332),w=t(6870),h=t(5317),_=t(6479);function k(e){if(null==e)return null;const a=String(e).trim();if(/^-?\d+$/.test(a)){const e=Number(a);return e>=0&&e<=11?e:e>=1&&e<=12?e-1:null}return{jan:0,january:0,januari:0,feb:1,february:1,februari:1,mar:2,march:2,maret:2,apr:3,april:3,may:4,mei:4,jun:5,june:5,juni:5,jul:6,july:6,juli:6,aug:7,august:7,agustus:7,sep:8,sept:8,september:8,oct:9,october:9,oktober:9,nov:10,november:10,dec:11,december:11,desember:11}[a.toLowerCase()]??null}function b(e,a){const t=function(e){const a=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],t=Number(e);return Number.isFinite(t)?t>=0&&t<=11?a[t]:t>=1&&t<=12?a[t-1]:String(e):String(e??"")}(e);return null!=a?`${t} ${a}`:t}a.getMonthlyRealizationbyActivityPackageId=async(e,a)=>{const{id:t}=e.params;try{if(!await i("monev_activity_packages").select("id").where("id",t).whereNull("deleted_at").first()){const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Paket aktivitas dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const{sql:e,bindings:n}=r("year","month","asc","asc"),s=await i("monev_monthly_realizations").where("monev_activity_packages_id",t).whereNull("deleted_at").orderByRaw(e,n),o=await i("monev_monthly_realization_pending_updates").where("monev_activity_packages_id",t).whereNull("deleted_at").orderByRaw(e,n),l=await Promise.all(s.map(e=>h(e))),d=await Promise.all(o.map(e=>h(e))),u=new g(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Daftar realisasi bulanan untuk paket aktivitas #${t} berhasil didapatkan.`,{monevMonthlyRealizationtOriginal:l,monevMonthlyRealizationPendingUpdate:d});return a.status(200).json(u.toResponse())}catch(e){s.error(`| Monthly Realization MONEV | - Error function getMonthlyRealizationbyActivityPackageId: ${e.message}`);const t=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),r={budgetRealization:e.body.budgetRealization,progress:e.body.progress,description:e.body.description,problem:e.body.problem,deleteDocumentIds:e.body.deleteDocumentIds},g=e.userId,h=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new w(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const f=await i("monev_monthly_realizations").select(["id","monev_activity_packages_id","evidence_file_ids","month","year"]).where("id",h).first();if(!f){await t.rollback();const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Realisasi bulanan dengan id '${h}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const y=b(f.month,f.year),R=k(f.month),E=Number(f.year);if(!Number.isFinite(E)||null==R){await t.rollback();const e=new w(422,"INVALID_PERIOD","Periode Tidak Valid","Nilai bulan/tahun pada realisasi tidak valid.");return a.status(422).json(e.toResponse())}const D=await t("monev_targets").select(["id","budget_target","physical_target"]).where("monev_activity_packages_id",f.monev_activity_packages_id).andWhere("month",R).andWhere("year",E).whereNull("deleted_at").first(),T=e=>{if(null==e)return!0;if("string"==typeof e)return""===e.trim()||0===Number(e);if("number"==typeof e)return 0===Number(e);const a=Number(e);return!!Number.isFinite(a)&&0===a};if(!D||T(D.budget_target)&&T(D.physical_target)){await t.rollback();const e=new w(422,"TARGET_REQUIRED","Target Bulanan Belum Diisi",`Mohon lengkapi minimal salah satu target pada target (budget target atau physical target) untuk periode '${y}' sebelum mengisi realisasi.`);return a.status(422).json(e.toResponse())}const S=await i("users").select("id","role_id").where({id:g}).first();if(!S){await t.rollback();const e=new w(200,"INVALID_USER_ID","Akun Tidak Ditemukan",`Akun dengan id '${h}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const A=Number(S.role_id);if(void 0!==r.budgetRealization){const e=function(e,a={}){const{allowEmpty:t=!1,maxNameLen:n=255,fieldLabel:i="budgetRealization"}=a;let s=e;if("string"==typeof s&&(s=c(s)??s),!Array.isArray(s))return{error:new w(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",`${i} format harus array of object dengan properti { name: string, value: number }.`)};const r=s.map(e=>{if(!m(e))return null;let{name:a,value:t}=e;if("string"!=typeof a)return null;if(a=a.trim(),0===a.length)return null;if("number"==typeof n&&a.length>n)return null;const i=Number(t);return Number.isFinite(i)?i<0?null:{name:a,value:i}:null}).filter(Boolean);return t||0!==r.length?{value:r}:{error:new w(422,"INVALID_CONTENT_ITEMS","Elemen Konten Tidak Valid",`Setiap elemen ${i} harus objek { name:string, value:number } dan minimal satu elemen valid.`)}}(r.budgetRealization,{allowEmpty:!1,maxNameLen:255,fieldLabel:"budgetRealization"});if(e.error)return await t.rollback(),a.status(422).json(e.error.toResponse());r.budgetRealization=e.value}const I=await t("monev_monthly_realization_pending_updates").select(["id","evidence_file_ids"]).where({monev_monthly_realization_id:h}).whereNull("deleted_at").orderBy("created_at","desc").first(),N=d(f.evidence_file_ids).length>0?f.evidence_file_ids:I?.evidence_file_ids??[],{deleteDocumentIds:j}=r,v=l(j).map(String),O=["image/jpeg","image/jpg","image/png","image/webp","application/pdf","application/zip","application/x-zip-compressed"],L=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="evidence_file_ids",maxFilesAllowed:i=1,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp","application/pdf","application/zip","application/x-zip-compressed"],sizeLimitBytes:r=52428800}){const o=u(d(e?.[n]),{as:"string"}),c=l(a).map(String),m=o.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===o.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, WebP, PDF, dan ZIP."};if(e.size>r)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(r/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:{evidence_file_ids:N},deleteDocumentIds:v,files:Array.isArray(e.files)?e.files:[],dbColumn:"evidence_file_ids",maxFilesAllowed:1,allowedTypes:O,sizeLimitBytes:52428800});if(!L.ok){const e=new w(L.http,L.code,L.title,L.desc);return a.status(L.http).json(e.toResponse())}const M=d(N);let C=u(M,{as:"number"})[0]??null;null!=C&&v.includes(String(C))&&(await p.deleteDocuments([C]),C=null);let F=null;Array.isArray(e.files)&&e.files.length>0&&(F=await p.uploadDocuments(e.files,e));const P=F?.[0]??C??null,$=null!=P?[Number(P)]:[],U=o($),V=await async function(e,{id:a,payload:t,userId:n,userRoleId:i,evidence_files:s}){const r=a=>e.raw("?::jsonb",[JSON.stringify(a??null)]),o=e=>!(null==e||""===String(e).trim()||/^null$/i.test(String(e))||/^undefined$/i.test(String(e))),l=e.fn.now(),{budgetRealization:d,progress:u,description:c,problem:m}=t,p=await e("monev_monthly_realizations").select(["id","validate_by","edited_by","monev_activity_packages_id","month","year","evidence_file_ids","budget_realization","progress","description","problem","validation_status","rejection_message"]).where("id",a).forUpdate().first();if(!p){const e=new Error("Monthly Realization not found");throw e.code="MONTHLY_REALIZATION_NOT_FOUND",e}const g=b(p.month,p.year);if(1===Number(i)){const t={edited_by:n,validate_by:n,validation_status:2,evidence_file_ids:s,validate_at:l,updated_at:l};if(o(d)&&(t.budget_realization=r(d)),o(u)){const e=Math.max(0,Math.min(100,Number(u)));t.progress=Number.isFinite(e)?e:p.progress}return o(m)&&(t.problem=m),o(c)&&(t.description=c),await e("monev_monthly_realizations").where("id",a).update(t),await _.logUpdate({userId:n,module:"monev",subject:`Realisasi Bulanan Kegiatan di Bulan '${g}' (update langsung oleh superadmin)`},e),await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").update({deleted_at:l,updated_at:l}),{mode:"direct",patch:t}}const w=o(d)?d:p.budget_realization,h=o(u)?(()=>{const e=Math.max(0,Math.min(100,Number(u)));return Number.isFinite(e)?e:p.progress})():p.progress,k={monev_monthly_realization_id:a,edited_by:n,monev_activity_packages_id:p.monev_activity_packages_id,month:p.month,year:p.year,evidence_file_ids:s,budget_realization:r(w),progress:h,problem:o(m)?m:p.problem,description:o(c)?c:p.description},f=await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").orderBy("created_at","desc").first();if(f)return await e("monev_monthly_realization_pending_updates").where("id",f.id).update({...k,updated_at:l}),await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").whereNot("id",f.id).update({deleted_at:l,updated_at:l}),1!==p.validation_status&&await e("monev_monthly_realizations").where("id",a).update({validation_status:1,updated_at:l}),await _.logUpdate({userId:n,module:"monev",subject:`Realisasi Bulanan Kegiatan di Bulan '${g}' (pending update replaced)`},e),{mode:"pending",pending:{id:f.id,...k}};const y={...k,created_at:l,updated_at:l},R=await e("monev_monthly_realization_pending_updates").insert(y).returning(["id"]),E=Array.isArray(R)?"object"==typeof R[0]?R[0].id:R[0]:null;return 1!==p.validation_status&&await e("monev_monthly_realizations").where("id",a).update({validation_status:1,updated_at:l}),await _.logCreate({userId:n,module:"monev",subject:`Realisasi Bulanan Kegiatan di Bulan '${g}' (pending update)`},e),{mode:"pending",pending:{id:E,...y}}}(t,{id:h,payload:r,userId:g,userRoleId:A,evidence_files:U});if(await t.commit(),"direct"===V.mode){const e=new w(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui","Perubahan realisasi bulanan berhasil diperbarui langsung.");return a.status(200).json(e.toResponse())}const B=new w(200,"SUCCESS_QUEUE_UPDATE","Perubahan Menunggu Validasi","Perubahan realisasi bulanan berhasil disimpan sebagai usulan dan menunggu validasi.");return a.status(200).json(B.toResponse())}catch(e){await t.rollback(),s.error(`| Monthly Realization MONEV | - Error function update : ${e.message}`);const n=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.verification=async(e,a)=>{const t=await i.transaction(),r={validationStatus:e.body.validationStatus,rejectionReason:e.body.rejectionReason},o=e.userId,l=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new w(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const d=await i("users").select("id","role_id").where({id:o}).first();if(!d){await t.rollback();const e=new w(200,"INVALID_USER_ID","Akun Tidak Ditemukan",`Akun dengan id '${id}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(1!==Number(d.role_id)){await t.rollback();const e=new w(403,"FORBIDDEN_ROLE","Akses Ditolak","Anda tidak memiliki hak untuk melakukan Verifikasi Realisasi bulanan.");return a.status(403).json(e.toResponse())}const u=await t("monev_monthly_realization_pending_updates").select(["id","monev_monthly_realization_id"]).where("id",l).whereNull("deleted_at").forUpdate().first();if(!u){await t.rollback();const e=new w(422,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Realisasi bulanan data pending dengan ID '${id}' tidak ditemukan.`);return a.status(422).json(e.toResponse())}const m=u.monev_monthly_realization_id,p=await t("monev_monthly_realizations").select(["id","monev_activity_packages_id","month","year","evidence_file_ids","budget_realization","progress","description","problem","validation_status","rejection_message"]).where("id",m).forUpdate().first();if(!p){await t.rollback();const e=new w(422,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Realisasi bulanan dengan ID '${id}' tidak ditemukan.`);return a.status(422).json(e.toResponse())}const g=(()=>{const e=Number(p.month);return Number.isFinite(e)?e:k(p.month)})(),h=Number(p.year);if(!Number.isFinite(h)||null==g){await t.rollback();const e=new w(422,"INVALID_PERIOD","Periode Tidak Valid","Nilai bulan/tahun tidak valid untuk diverifikasi.");return a.status(422).json(e.toResponse())}const f=b(g,h),y=new Date,R=y.getFullYear(),E=y.getMonth();if(h>R||h===R&&g>E){await t.rollback();const e=new w(422,"FUTURE_PERIOD_NOT_ALLOWED","Tidak Boleh Verifikasi Periode Mendatang",`Periode '${f}' masih di masa depan dan belum bisa diverifikasi.`);return a.status(422).json(e.toResponse())}if(2===p.validation_status||3===p.validation_status){const e=new w(200,"ALREADY_VALIDATED","Sudah Divalidasi",`Realisasi bulanan untuk bulan '${f}' sudah berstatus ${{1:"Pending",2:"Approve",3:"Rejected"}[p.validation_status]}.`);return a.status(200).json(e.toResponse())}const D=await t("monev_targets").select(["id","budget_target","physical_target","validation_status"]).where("monev_activity_packages_id",p.monev_activity_packages_id).andWhere("month",g).andWhere("year",h).whereNull("deleted_at").first(),T=e=>{if(null==e)return!0;if("string"==typeof e)return""===e.trim()||0===Number(e);if("number"==typeof e)return 0===Number(e);const a=Number(e);return!!Number.isFinite(a)&&0===a};if(!D||T(D.budget_target)&&T(D.physical_target)){await t.rollback();const e=new w(422,"TARGET_REQUIRED","Target Bulanan Belum Diisi",`Target periode '${f}' belum memiliki data (budget/physical). Tidak dapat melakukan verifikasi realisasi.`);return a.status(422).json(e.toResponse())}if(2!==Number(D.validation_status??0)){await t.rollback();const e=new w(422,"TARGET_NOT_VALIDATED","Target Bulanan Belum Tervalidasi",`Target periode '${f}' belum disetujui/tervalidasi. Tidak dapat melakukan verifikasi realisasi sebelum target disetujui.`);return a.status(422).json(e.toResponse())}const S=await async function(e,{monthlyId:a,payload:t,userId:n}){const i=e.fn.now(),s=a=>{if("string"==typeof a){const e=c(a);null!==e&&(a=e)}return e.raw("?::jsonb",[JSON.stringify(a??null)])},r=await e("monev_monthly_realizations").select(["id","month","year"]).where("id",a).first();if(!r){const e=new Error("Realisasi bulanan not found");throw e.code="MONTHLY_REALIZATION_NOT_FOUND",e}const o=b(r.month,r.year),l=await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").orderBy("created_at","desc").first();if(2===t.validationStatus){if(!l){const e=new Error("Tidak ada usulan pending untuk diverifikasi.");throw e.code="NO_PENDING",e}const t={budget_realization:s(l.budget_realization),progress:l.progress,problem:l.problem,description:l.description,evidence_file_ids:s(l.evidence_file_ids),validate_by:n,validate_at:i,validation_status:2,rejection_message:null,updated_at:i};return await e("monev_monthly_realizations").where("id",a).update(t),await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").update({deleted_at:i,updated_at:i}),await _.logUpdate({userId:n,module:"monev",subject:`Verifikasi Realisasi Bulanan Kegiatan di Bulan '${o}' (APPROVED)`},e),{mode:"approved",month:r.month,year:r.year,patch:t}}const d={validate_by:n,validate_at:i,validation_status:3,rejection_message:t.rejectionReason??null,updated_at:i};return await e("monev_monthly_realizations").where("id",a).update(d),await e("monev_monthly_realization_pending_updates").where({monev_monthly_realization_id:a}).whereNull("deleted_at").update({deleted_at:i,updated_at:i}),await _.logUpdate({userId:n,module:"monev",subject:`Verifikasi Realisasi Bulanan Kegiatan di Bulan '${o}' (REJECTED)`},e),{mode:"rejected",month:r.month,year:r.year,patch:d}}(t,{monthlyId:m,payload:r,userId:o});await t.commit();const A=b(S.month,S.year);if("approved"===S.mode){const e=new w(200,"SUCCESS_APPROVE","Berhasil Approve",`Realisasi bulanan untuk bulan '${A}' berhasil disetujui dan diperbarui.`);return a.status(200).json(e.toResponse())}const I=new w(200,"SUCCESS_REJECT","Berhasil Reject",`Realisasi bulanan untuk bulan '${A}' ditolak dengan alasan: ${r.rejectionReason}.`);return a.status(200).json(I.toResponse())}catch(e){await t.rollback(),s.error(`| Monthly Realization MONEV | - Error function verification : ${e.message}`);const n=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},818:e=>{"use strict";e.exports=require("dotenv")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},897:(e,a,t)=>{const n=t(7252).Router(),i=t(1066),{storeNewsCategoryValidator:s}=t(3821),{updateNewsCategoryValidator:r}=t(7221),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.master_data"]),i.index),n.get("/show/:id",u(["view.master_data"]),i.show),n.post("/create",u(["create.master_data"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.master_data"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.master_data"]),i.destroy),n.patch("/restore",u(["restore.master_data"]),i.restore),e.exports=n},925:(e,a,t)=>{const{body:n}=t(7975);a.storeStudentValidator=[n("name").notEmpty().withMessage("Nama peserta tidak boleh kosong.").bail().isString().withMessage("Nama peserta harus berupa teks.").bail().isLength({max:255}).withMessage("Nama peserta maksimal 255 karakter."),n("email").notEmpty().withMessage("Email peserta tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.").bail().isString().withMessage("Email peserta harus berupa teks.")]},957:(e,a,t)=>{const{body:n}=t(7975);a.updateFaqValidator=[n("question").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("answer").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},1004:e=>{e.exports=async function(e){return{id:e.id,title:e.title,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},1022:(e,a,t)=>{const{parseJsonSafe:n,normJsonbArray:i,isPlainObject:s}=t(7872),{resolveArrayRelations:r}=t(7972),o=t(2482);e.exports=async function(e,a={}){const{withImage:t=!1}=a,l=String(e.type||"").toLowerCase(),d=e.content;let u,c=d;if("text"===l){if(s(d))c=d;else if("string"==typeof d){const e=n(d);s(e)&&(c=e)}}else if("textarray"===l||"imagearray"===l)if(Array.isArray(d))c=d;else{const e=i(d);if(Array.isArray(e)&&e.length>=0)c=e;else if("string"==typeof d){const e=n(d);Array.isArray(e)&&(c=e)}}else if("string"==typeof d){const e=n(d);null!==e&&(c=e)}t&&(u=await r(e.content_file_ids,"documents",o));const m={id:e.id,type:e.type,content:c};return t?{...m,image:u}:m}},1066:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{isPlainObject:r,normIdArray:o,handleLocalizedText:l}=t(7872),{applyJsonbSearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),m=t(1332),p=t(6870),g=t(7026),w=t(6479),{applyTrashedScope:h}=t(7438),{applyLatestThenTrashed:_}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("cms_news_categories as category").select("category.*");h(n,e,"category.deleted_at"),d(n,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0}),_(n,"category.deleted_at","category.created_at","category.id");const s=u(e.query),r=await c(n,s,i);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>g(e))),l=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori berita berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| News Category Master | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{name:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=l(r,{allowPartial:!1,maxLen:void 0,fieldLabel:"name"});if(s.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const d=l(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(d.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",d.error.message);return a.status(422).json(e.toResponse())}if(await t("cms_news_categories").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(name->>'en') = lower(?)",[s.value.en])}).first()){await t.rollback();const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori berita ini sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_news_categories").insert({name:{id:s.value.id,en:s.value.en},description:{id:d.value.id,en:d.value.en}}),await w.logCreate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Berita"},t),await t.commit();const u=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kategori berita '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| News Category Master | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_news_categories").select("*").where("id",t).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori berita dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await g(e),s=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori berita '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| News Category Master | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{name:o,description:d}=e.body,u=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_news_categories").where("id",u).first();if(!s){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori berita dengan ID '${u}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const c=r(s.name)?s.name:parseJsonSafe(s.name)??{id:"",en:""},m=r(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""};let g=c;if(void 0!==o){const e=l(o,{allowPartial:!0,maxLen:void 0,fieldLabel:"nama"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...c,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=c.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=c.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Nama harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}g={id:String(t.id).trim(),en:String(t.en).trim()}}let h=m;if(void 0!==d){const e=l(d,{allowPartial:!0,maxLen:void 0,fieldLabel:"deskripsi"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...m,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=m.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=m.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}h={id:String(t.id).trim(),en:String(t.en).trim()}}if(((g.id??"").toLowerCase()!==(c.id??"").toLowerCase()||(g.en??"").toLowerCase()!==(c.en??"").toLowerCase())&&await t("cms_news_categories").whereNull("deleted_at").whereNot("id",u).andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[g.id]).orWhereRaw("lower(name->>'en') = lower(?)",[g.en])}).first()){const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori berita (ID/EN) sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_news_categories").where("id",u).update({name:g,description:h,updated_at:t.fn.now()}),await w.logUpdate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Berita"},t),await t.commit();const _=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kategori berita '${g.id}' berhasil diperbarui.`);return a.status(200).json(_.toResponse())}catch(e){await t.rollback(),s.error(`| News Category Master | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_news_categories").select("id","name").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori berita yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_news_categories").whereIn("id",r).update({deleted_at:t.fn.now()}),await w.logDelete({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Berita"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data kategori berita.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| News Category Master | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const l=await t("cms_news_categories").select("id","name").whereIn("id",n).whereNotNull("deleted_at");if(0===l.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const d=e=>{const a=r(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=l.map(e=>{const a=d(e.name);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let g=[];(c.length||m.length)&&(g=await t("cms_news_categories").select("id","name").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(name->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(name->>'en')"),m):this.whereIn(i.raw("lower(name->>'en')"),m))}));const h=new Set;for(const e of g){const a=d(e.name);a.idLower&&h.add(`id:${a.idLower}`),a.enLower&&h.add(`en:${a.enLower}`)}const _=new Set,k=new Set,b=new Set;for(const e of u)e.idLower&&(_.has(e.idLower)?b.add(`id:${e.idLower}`):_.add(e.idLower)),e.enLower&&(k.has(e.enLower)?b.add(`en:${e.enLower}`):k.add(e.enLower));const f=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&h.has(a)||t&&h.has(t),i=a&&b.has(a)||t&&b.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,name:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),f.push(e))}let D=0;if(f.length>0){const e=f.map(e=>e.rowId);await t("cms_news_categories").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await w.logRestore({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Berita"},t),await t.commit(),0===D){const e=new p(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| News Category Master | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},1227:(e,a,t)=>{const{body:n}=t(7975);a.updateActivityCategoryValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},1244:(e,a,t)=>{const{body:n}=t(7975);a.resetPasswordValidator=[n("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),n("otp").notEmpty().withMessage("OTP tidak boleh kosong, silahkan masukkan kode OTP yang berasal dari email yang Anda terima.").bail().isNumeric().withMessage("Kode OTP yang valid harus berupa angka.").bail().isLength({min:6,max:6}).withMessage("Kode OTP harus terdiri dari 6 digit."),n("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter."),n("passwordConfirmation").notEmpty().withMessage("Konfirmasi password tidak boleh kosong.").bail().custom((e,{req:a})=>e===a.body.password).withMessage("Konfirmasi password tidak cocok. Pastikan password yang anda masukkan sudah sesuai.")]},1278:e=>{"use strict";e.exports=require("pdfkit")},1328:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["Text","Image","Video","Audio","File","Link","TextArray","ImageArray"]);a.storeContentValidator=[n("type").trim().notEmpty().withMessage("Tipe konten tidak boleh kosong.").bail().isString().withMessage("Tipe konten harus berupa teks.").bail().isIn(s).withMessage(`Tipe konten harus salah satu dari: ${s.join(", ")}.`),n("content").optional({nullable:!0,checkFalsy:!0}),n("order").optional({nullable:!0,checkFalsy:!0}).toInt().isInt({min:0}).withMessage("Order harus berupa bilangan bulat bernilai  0.").bail().custom(async e=>{if(null==e)return!0;if(await i("cms_contents").where({order:e}).whereNull("deleted_at").first())throw new Error(`Order '${e}' sudah digunakan.`);return!0})]},1332:e=>{e.exports=class{constructor(e,a=null,t,n,i=null){this.status=e,this.case=a,this.title=t,this.description=n,this.data=i}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description},data:this.data}}}},1442:(e,a,t)=>{const{body:n}=t(7975);a.storeCategoryValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},1483:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),r=t(1278),o=t(9896),l=t(6928),d=t(1572),{asJsonb:u}=t(6192),c=t(6348),{applySearch:m,applyPagination:p,applyRelationIn:g,formatPaginationResult:w}=t(3210),{normIdArray:h}=t(7872),{trackTopicViewsForReq:_}=t(6417),k=t(1784),{stripTitlesOnly:b}=t(337),{applyTrashedScope:f}=t(7438),y=t(1701),R=t(1332),E=t(6870),D=t(6479),T=t(2668),S=t(3034),A=t(7724),I=t(5206),N=t(5278),j=t(3345),v=Object.freeze({STARTED:1,FINISHED:2,ABANDONED:3});async function O(e){const a=await i("kmis_learning_attempts as a").where("a.id",e).select(["a.kmis_topic_id","a.completed_material_ids"]).first();if(!a)throw new Error("Topik atau pembelajaran tidak ditemukan");const t=await i("kmis_topics").where("id",a.kmis_topic_id).whereNull("deleted_at").select("material_order_ids").first(),n=h(t?.material_order_ids,{as:"number"}).length;return h(a?.completed_material_ids,{as:"number"}).length===n}function L(e){if(!e)return null;if(o.existsSync(e)&&".svg"!==l.extname(e).toLowerCase())return e;const a=e.replace(/\.svg$/i,".png");return o.existsSync(a)?a:null}a.getPublicMaterialbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await i("kmis_materials").select("*").where("id",t).whereNull("deleted_at").first();if(!e){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data materi dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await i("kmis_topics").select("id","topic_type").where("id",e.kmis_topic_id).whereNull("deleted_at").first();if(!n){const t=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${e.kmis_topic_id}' tidak ditemukan.`);return a.status(200).json(t.toResponse())}if("Pelatihan"===n.topic_type){const e=new E(404,"MATERIAL_NOT_FOUND","Materi Tidak Ditemukan","Materi dengan ID tersebut tidak ditemukan.");return a.status(200).json(e.toResponse())}const s=await N(e),r=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data materi '${e.title}' berhasil didapatkan.`,s);return a.status(200).json(r.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getPublicMaterialbyId : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getListLearningAttempt=async(e,a)=>{const{search:t,categoryId:n,finishedStatus:r}=e.query,o=n??e.query["categoryId[]"],l=r??e.query["finishedStatus[]"],d=e.userId;try{let n=i("kmis_learning_attempts as quizParticipant").leftJoin("users as user","quizParticipant.attempt_by","user.id").leftJoin("kmis_topics as topic","quizParticipant.kmis_topic_id","topic.id").select("quizParticipant.*").where("quizParticipant.attempt_by",d);f(n,e,"quizParticipant.deleted_at"),g(n,"topic.kmis_categories_id",o,{as:"number"});const s=h(l,{as:"number"}),r=e=>1===s.length&&s[0]===e;r(2)?n.andWhere(function(){this.whereRaw('\n          "quizParticipant"."certificate_ids" IS NOT NULL\n          AND jsonb_typeof("quizParticipant"."certificate_ids") = \'array\'\n          AND jsonb_array_length("quizParticipant"."certificate_ids") > 0\n        ')}):r(3)&&n.andWhere(function(){this.whereRaw("COALESCE(\"quizParticipant\".\"certificate_ids\", '[]'::jsonb) = '[]'::jsonb")}),m(n,t,["user.name","topic.title"]),n.orderByRaw('\n      CASE "quizParticipant"."quiz_attempt_status"\n        WHEN 2 THEN 0\n        WHEN 1 THEN 1\n        WHEN 3 THEN 2\n        ELSE 3\n      END ASC,\n      "quizParticipant"."created_at" DESC\n    ');const u=p(e.query),c=await w(n,u,i);if(0===c.data.length){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const _=await Promise.all(c.data.map(e=>T(e))),k=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data partisipan ujian berhasil diambil.",{data:_,pagination:c.pagination});return a.status(200).json(k.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getListLearningAttempt : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getDetailLearningAttemptbyTopicId=async(e,a)=>{const{id:t}=e.params;try{const n=await i("kmis_topics").select("*").where("id",t).whereNull("deleted_at").first();if(!n){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}await _([n.id],e);const s=await i("kmis_topics").select("*").where("id",t).whereNull("deleted_at").first(),[r,o,l,d]=await Promise.all([i("kmis_materials").select(["id","title","material_types"]).where("kmis_topic_id",t).whereNull("deleted_at").orderBy("created_at","asc"),i("kmis_materials").where("kmis_topic_id",t).whereNull("deleted_at").count("* as total").first(),i("kmis_learning_attempts").select(["attempt_by","feedback","feedback_comment"]).where("kmis_topic_id",t).whereIn("quiz_attempt_status",[v.FINISHED,v.ABANDONED]).whereNull("deleted_at").distinct("attempt_by").limit(5),i("kmis_learning_attempts").where("kmis_topic_id",t).whereIn("quiz_attempt_status",[v.FINISHED,v.ABANDONED]).whereNotNull("feedback").whereNull("deleted_at").avg({avg:"feedback"}).first()]),u=Number(o?.total||0),c=await Promise.all(l.map(async e=>{const a=await i("users").select("*").where("id",e.attempt_by).first();return{ratedBy:a?await S(a):null,rate:e.feedback??null,comment:e.feedback_comment??null}})),m=d&&null!=d.avg?Number(d.avg):null,p={topic:await A(s),totalMaterial:u,feedback:c,avgFeedbackRate:m,material:r.map(e=>({id:e.id,title:e.title,materialType:e.material_types}))},g=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data topik '${s.title}' berhasil didapatkan.`,p);return a.status(200).json(g.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getDetailLearningAttemptbyTopicId : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getOrderMaterialLearningAttemptbyTopicId=async(e,a)=>{const{id:t}=e.params,n=e.userId;try{const e=await i("kmis_learning_attempts").select(["id","attempt_by","certificate_ids","kmis_topic_id","completed_material_ids","quiz_attempt_status","quiz_assessment_status","total_material","learning_started","completed_quiz","quiz_started","quiz_finished","quiz_duration","score_total","feedback","feedback_comment","created_at","updated_at","deleted_at"]).where("kmis_topic_id",t).where("attempt_by",n).first();if(!e){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan topik ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const s=h(topic.material_order_ids,{as:"string"}).map(e=>Number(e)).filter(Number.isFinite),r=new Set(h(e.completed_material_ids,{as:"string"})),o=await i("kmis_materials").select("*").whereIn("id",s).whereNull("deleted_at").orderByRaw("array_position(?, id)",[s]),l=await Promise.all(o.map(async e=>({...await N(e),isCompleted:r.has(String(e.id))}))),d=await T(e),u=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail materi berdasarkan urutan berhasil didapatkan.",{material:l,learningAttempt:d});return a.status(200).json(u.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getOrderMaterialLearningAttemptbyTopicId : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getLearningAttemptMaterialbyId=async(e,a)=>{const{id:t}=e.params,n=e.userId;try{const e=await i("kmis_materials").select("id","created_by","uploaded_by","kmis_topic_id","materials_file_ids","materials_cover_ids","title","material_types","material_data","description","created_at","updated_at","deleted_at").where("id",t).whereNull("deleted_at").first();if(!e){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data materi dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const s=await i("kmis_learning_attempts").select("id","learning_started").where("attempt_by",n).where("kmis_topic_id",e.kmis_topic_id).whereNull("deleted_at").orderBy("id","desc").first();if(!s){const e=new E(200,"DATA_NOT_FOUND","Pembelajaran Tidak Ditemukan","Data learning attempt tidak ditemukan. Silakan mulai pembelajaran topik ini terlebih dahulu.");return a.status(200).json(e.toResponse())}await i("kmis_learning_attempts").where("id",s.id).whereNull("learning_started").update({learning_started:k.toUTC((new Date).toISOString()),updated_at:i.fn.now()});const r=await N(e),o=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data materi '${e.title}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getLearningAttemptMaterialbyId : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.storeLearningAttempt=async(e,a)=>{const t=await i.transaction(),{topicId:r}=e.body,o=e.userId;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new E(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const l=await i("kmis_topics").where("id",r).whereNull("deleted_at").first();if(!l){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${r}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const d=h(l.material_order_ids,{as:"number"}).length;if(await t("kmis_learning_attempts").where({attempt_by:o,kmis_topic_id:r}).whereNull("deleted_at").first()){await t.rollback();const e=new E(409,"ALREADY_EXISTS","Attempt Sudah Ada","Kamu sudah mempelajari topik pembelajaran saat ini, Silahkan lanjutkan ke topik lainnya.");return a.status(409).json(e.toResponse())}await t("kmis_learning_attempts").insert({attempt_by:o,kmis_topic_id:r,quiz_attempt_status:1,quiz_assessment_status:!1,total_material:d}).returning("*"),await D.logCreate({userId:D.fromReq(e),module:"kmis",subject:"Pembelajaran Materi & Quiz"},t),await t.commit();const u=new E(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data pembelajaran materi & quiz berhasil ditambahkan untuk topik pembelajaran '${l?.title??"Topik Pembelajaran"}'.`);return a.status(201).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Learning Attempt KMIS | - Error function storeLearningAttempt: ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.updateProgressLearningAttempt=async(e,a)=>{const t=await i.transaction(),n=e.params.id;try{const i=await t("kmis_learning_attempts").where("id",n).whereNull("deleted_at").forUpdate().first();if(!i){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data pembelajaran dengan ID '${n}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const s=await t("kmis_topics").where("id",i.kmis_topic_id).whereNull("deleted_at").first(),r=h(s?.material_order_ids,{as:"number"});if(0===r.length){await t.rollback();const e=new E(422,"TOPIC_INVALID","Topik Tidak Valid","Tidak ada materi yang tersedia dalam topik ini.");return a.status(422).json(e.toResponse())}console.log("Ini adalah urutan ID material dari Topics: ",s.material_order_ids);const o=h(i?.completed_material_ids,{as:"number"});if(o.length===r.length){await t.rollback();const e=new E(200,"LEARNING_ALREADY_COMPLETED","Pembelajaran Sudah Selesai","Anda sudah menyelesaikan semua materi dalam topik ini. Silahkan lanjutkan mengerjakan kuis dan dapatkan sertifikatnya!.");return a.status(200).json(e.toResponse())}if(o.length>0&&o[0]!==r[0]){await t.rollback();const e=new E(422,"INVALID_MATERIAL_ORDER","Urutan Materi Tidak Sesuai","Anda harus menyelesaikan materi pertama terlebih dahulu.");return a.status(422).json(e.toResponse())}console.log("Ini adalah urutan ID material yang sudah di selesaikan: ",o);const l=r[o.length];if(!Number.isFinite(l)){await t.rollback();const e=new E(422,"INVALID_MATERIAL_ID","ID Materi Tidak Valid","ID materi yang dicari tidak valid.");return a.status(422).json(e.toResponse())}if(!await t("kmis_materials").where("id",l).whereNull("deleted_at").first()){await t.rollback();const e=new E(422,"MATERIAL_NOT_FOUND","Materi Tidak Ditemukan","Materi untuk validasi tidak ditemukan.");return a.status(422).json(e.toResponse())}const d=[...o,l];if(d.length>r.length){await t.rollback();const e=new E(422,"INVALID_PROGRESS","Progress Tidak Valid","Jumlah materi yang diselesaikan melebihi jumlah materi yang ada.");return a.status(422).json(e.toResponse())}const c=u(d);await t("kmis_learning_attempts").where("id",n).update({completed_material_ids:c,updated_at:t.fn.now()}).returning(["completed_material_ids","updated_at"]),await D.logUpdate({userId:D.fromReq(e),module:"kmis",subject:"Pembelajaran Materi & Quiz"},t),await t.commit();const m=new E(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Progress materi berhasil diperbarui menjadi ${d.length}/${r.length}.`);return a.status(200).json(m.toResponse())}catch(e){await t.rollback(),s.error(`| Learning Attempt KMIS | - Error function updateProgressLearningAttempt: ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.getAllQuizbyTopicId=async(e,a)=>{const{id:t}=e.params,n=e.userId;try{const e=await i("kmis_topics").where("id",t).select("id","title","topic_type").whereNull("deleted_at").first();if(!e){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if("Pengetahuan"===e.topic_type){const e=new E(200,"QUIZ_NOT_ACCESSIBLE","Kuis Tidak Dapat Diakses","Topik ini bersifat publik dan bertipe 'Pengetahuan', sehingga kuis tidak dapat diakses.");return a.status(200).json(e.toResponse())}if(!await i("kmis_learning_attempts").where("kmis_topic_id",e.id).where("attempt_by",n).whereNull("deleted_at").orderBy("id","desc").first()){const e=new E(200,"DATA_NOT_FOUND","Pembelajaran Tidak Ditemukan","Data learning attempt tidak ditemukan. Silakan mulai pembelajaran topik ini terlebih dahulu.");return a.status(200).json(e.toResponse())}const s=await i("kmis_quiz").where("kmis_topic_id",e.id).whereNull("deleted_at").select(["id","kmis_topic_id","question","answer_a","answer_b","answer_c","answer_d","created_at","updated_at"]).orderBy("id","asc");if(!s||0===s.length){const t=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kuis untuk topik '${e.title}' tidak ditemukan.`);return a.status(200).json(t.toResponse())}const r=await Promise.all(s.map(e=>I(e))),o=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Daftar kuis untuk topik '${e.title}' berhasil didapatkan.`,{quiz:r});return a.status(200).json(o.toResponse())}catch(e){s.error(`| Learning Attempt KMIS | - Error function getAllQuizbyTopicId : ${e.message}`);const t=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getQuizAttemptbylearningAttemptId=async(e,a)=>{const t=await i.transaction(),{id:n}=e.params,r=e.userId;try{let e;try{e=await O(n)}catch(e){await t.rollback();const n=new E(422,"LEARNING_ATTEMPT_NOT_FOUND","Topik atau Pembelajaran Tidak Ditemukan","Data learning attempt tidak ditemukan.");return a.status(422).json(n.toResponse())}if(!e){await t.rollback();const e=new E(422,"LEARNING_PROGRESS_INCOMPLETE","Progress Belajar Belum Tercapai","Anda belum menyelesaikan seluruh materi pada topik ini. Silahkan selesaikan materi terlebih dahulu.");return a.status(422).json(e.toResponse())}const s=await t("kmis_learning_attempts").where("id",n).whereNull("deleted_at").first();if(!s){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan ID '${n}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const o=await i("kmis_topics").where("id",s.kmis_topic_id).select("id","topic_type").whereNull("deleted_at").first();if(!o){const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${s.kmis_topic_id}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if("Pengetahuan"===o.topic_type){const e=new E(200,"QUIZ_NOT_ACCESSIBLE","Kuis Tidak Dapat Diakses","Topik ini bersifat publik dan bertipe 'Pengetahuan', sehingga kuis tidak dapat diakses.");return a.status(200).json(e.toResponse())}if(BigInt(String(s.attempt_by))!==BigInt(String(r))){await t.rollback();const e=new E(403,"FORBIDDEN_QUIZ_ACCESS","Akses Ditolak","Anda tidak berhak melihat jawaban untuk kuis yang bukan milik anda.");return a.status(403).json(e.toResponse())}const l=k.toUTC((new Date).toISOString());await i("kmis_learning_attempts").where("id",s.id).whereNull("quiz_started").update({quiz_started:l,updated_at:i.fn.now()});const d=await async function(e){const a=await i("kmis_learning_attempts").where("id",e).select(["id","attempt_by","kmis_topic_id","quiz_started","quiz_finished"]).whereNull("deleted_at").first();if(!a)return{learningParticipant:null,exam:[]};const t=await T(a),n={id:t.id,attemptUser:t.attemptUser||null,topic:t.topic||null,quizStarted:t.quizStarted||null,quizFinished:t.quizFinished||null},s=await i("kmis_topics").where("id",a.kmis_topic_id).whereNull("deleted_at").select(["id","total_quiz"]).first(),r=Number(s?.total_quiz??0),o=await i("kmis_quiz").where("kmis_topic_id",a.kmis_topic_id).whereNull("deleted_at").select(["id","question","answer_a","answer_b","answer_c","answer_d"]).orderBy("id","asc"),l=await i("kmis_quiz_responses as r").select(["r.id","r.kmis_quiz_id","r.selected_option","r.is_marker","r.answered_at"]).where("r.kmis_learning_attempt_id",e).whereNull("r.deleted_at"),d=new Map;for(const e of l){const a=d.get(e.kmis_quiz_id);(!a||new Date(e.answered_at)>new Date(a.answered_at))&&d.set(e.kmis_quiz_id,e)}const u=o.map(e=>{const a=d.get(e.id)||null,t={id:e.id,question:e.question,answerA:e.answer_a,answerB:e.answer_b,answerC:e.answer_c,answerD:e.answer_d};return{id:a?a.id:null,quiz:t,selectedOption:a?a.selected_option:null,isMarker:a?!!a.is_marker:null,answeredAt:a?a.answered_at:null}});if(Number.isFinite(r)&&r>u.length){const e=r-u.length;for(let a=0;a<e;a++)u.push(null)}return{learningParticipant:n,exam:u}}(n),u=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail jawaban kuis berhasil didapatkan.",d);return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Quiz Attempt KMIS | - Error function getQuizAttemptbylearningAttemptId: ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.storeQuizAttempt=async(e,t)=>{const r=await i.transaction(),{learningAttemptId:o,quizId:l}=e.body,d=String(e.body.selectedOption||"").trim().toUpperCase(),u=!!e.body.isMarker,c=e.userId;try{let s,m;try{s=await O(o)}catch(e){await r.rollback();const a=new E(422,"LEARNING_ATTEMPT_NOT_FOUND","Topik atau Pembelajaran Tidak Ditemukan","Data learning attempt tidak ditemukan.");return t.status(422).json(a.toResponse())}if(!s){await r.rollback();const e=new E(422,"LEARNING_PROGRESS_INCOMPLETE","Progress Belajar Belum Tercapai","Anda belum menyelesaikan seluruh materi pada topik ini. Silahkan selesaikan materi terlebih dahulu.");return t.status(422).json(e.toResponse())}try{m=await async function(e){const a=await i("kmis_learning_attempts as a").join("kmis_topics as t","a.kmis_topic_id","t.id").where("a.id",e).select("t.quiz_duration","a.quiz_started").first();if(!a)throw new Error("Topik atau pembelajaran tidak ditemukan.");const t=Number(a.quiz_duration??0);if(!Number.isFinite(t)||t<=0)return!0;if(!a.quiz_started)return!0;const n=k.toUTC(a.quiz_started),s=k.toUTC(new Date);return!n||!s||Math.max(0,Math.floor((s-n)/1e3))<=t}(o)}catch(e){await r.rollback();const a=new E(422,"LEARNING_ATTEMPT_NOT_FOUND","Topik atau Pembelajaran Tidak Ditemukan","Data learning attempt tidak ditemukan.");return t.status(422).json(a.toResponse())}if(!m)return a.submitAllAttempt(e,t);const p=n(e);if(!p.isEmpty()){const e=p.array().map(e=>e.msg).join(" "),a=new E(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return t.status(422).json(a.toResponse())}try{const a=await r("kmis_learning_attempts").where("id",o).whereNull("deleted_at").forUpdate().first();if(!a){await r.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan ID '${o}' tidak ditemukan.`);return t.status(200).json(e.toResponse())}if(BigInt(String(a.attempt_by))!==BigInt(String(c))){await r.rollback();const e=new E(403,"FORBIDDEN_QUIZ_ACCESS","Akses Ditolak","Anda tidak berhak mengisi jawaban untuk kuis yang bukan milik anda.");return t.status(403).json(e.toResponse())}if([v.FINISHED,v.ABANDONED].includes(Number(a.quiz_attempt_status))){await r.rollback();const e=new E(409,"ATTEMPT_CLOSED","Attempt Tidak Aktif","Kuis sudah selesai/ditutup, tidak dapat menambahkan jawaban.");return t.status(409).json(e.toResponse())}const n=await r("kmis_quiz").where("id",l).whereNull("deleted_at").first();if(!n){await r.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Kuis dengan ID '${l}' tidak ditemukan.`);return t.status(200).json(e.toResponse())}if(Number(n.kmis_topic_id)!==Number(a.kmis_topic_id)){await r.rollback();const e=new E(422,"FAILED_VALIDATION","Kuis Tidak Sesuai Topik","Kuis tidak termasuk dalam topik pembelajaran ini.");return t.status(422).json(e.toResponse())}const[{total:i}]=await r("kmis_quiz").where("kmis_topic_id",a.kmis_topic_id).whereNull("deleted_at").count("* as total"),s=Number(i||0),[{total:m}]=await r("kmis_quiz_responses").where("kmis_learning_attempt_id",o).whereNull("deleted_at").count("* as total"),p=Number(m||0),g=await r("kmis_quiz_responses").where({kmis_learning_attempt_id:o,kmis_quiz_id:l}).whereNull("deleted_at").first(),w=!!g;w&&await r("kmis_quiz_responses").where("id",g.id).update({deleted_at:r.fn.now()});const h=k.toUTC((new Date).toISOString()),_=d===String(n.correct_option||"").toUpperCase();await r("kmis_quiz_responses").insert({kmis_learning_attempt_id:o,kmis_quiz_id:l,selected_option:d,is_marker:u,is_correct:_,answered_at:h}).returning("*");const b=p+(w?0:1);await D.logCreate({userId:D.fromReq(e),module:"kmis",subject:"Pembelajaran Materi & Quiz",description:w?`Revisi jawaban: topicId=${a.kmis_topic_id}, quizId=${l}, selected=${d}, correct=${_}, progress=${b}/${s}`:`Menyimpan jawaban: quizId=${l}, selected=${d}, correct=${_}, progress=${b}/${s}`},r),await r.commit();const f=new E(201,w?"SUCCESS_REVISED_ANSWER":"SUCCESS_ANSWERED_QUESTION","Berhasil Menyimpan Data",w?`Revisi jawaban pada soal ${l} tersimpan (${b}/${s}).`:`Jawaban berhasil tersimpan (${b}/${s}).`);return t.status(201).json(f.toResponse())}catch(e){throw await r.rollback(),e}}catch(e){await r.rollback(),s.error(`| Quiz Attempt KMIS | - Error function storeQuizAttempt: ${e.message}`);const a=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}},a.submitAllAttempt=async(e,a)=>{const t=await i.transaction(),{learningAttemptId:o}=e.body,m=e.userId;try{const p=n(e);if(!p.isEmpty()){const e=p.array().map(e=>e.msg).join(" "),t=new E(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}let g,w,h;try{if(g=await t("kmis_learning_attempts").where("id",o).whereNull("deleted_at").forUpdate().first(),!g){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan ID '${o}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(BigInt(String(g.attempt_by))!==BigInt(String(m))){await t.rollback();const e=new E(403,"FORBIDDEN_QUIZ_ACCESS","Akses Ditolak","Anda tidak berhak submit jawaban untuk kuis yang bukan milik anda.");return a.status(403).json(e.toResponse())}if([v.FINISHED,v.ABANDONED].includes(Number(g.quiz_attempt_status))){await t.rollback();const e=new E(409,"ATTEMPT_CLOSED","Attempt Tidak Aktif","Kuis sudah selesai/ditutup, tidak dapat mengirim jawaban.");return a.status(409).json(e.toResponse())}w=await async function(e,{learningAttemptId:a,topicId:t,req:n}){const i=await e("kmis_quiz_responses").where("kmis_learning_attempt_id",a).whereNull("deleted_at").select([e.raw("COUNT(*)::int AS answered_count"),e.raw("SUM(CASE WHEN is_correct THEN 1 ELSE 0 END)::int AS correct_count")]).first(),[{total:s}]=await e("kmis_quiz").where("kmis_topic_id",t).whereNull("deleted_at").count("* as total"),r=Number(i?.answered_count||0),o=Number(i?.correct_count||0),l=Number(s||0),d=Math.max(r-o,0),u=Math.max(l-r,0),c=k.toUTC((new Date).toISOString()),m=e.raw("GREATEST(EXTRACT(EPOCH FROM (?::timestamp without time zone - COALESCE(quiz_started, ?::timestamp without time zone)))::int, 0)",[c,c]),p=function(e,a,t=2){const n=Number(e||0),i=Number(a||0);if(i<=0)return 0;const s=n/i*100,r=10**t;return Math.round(s*r)/r}(o,l,2);let g=v.FINISHED;return r!==l&&(g=v.ABANDONED),await e("kmis_learning_attempts").where("id",a).update({quiz_assessment_status:!0,quiz_finished:c,quiz_duration:m,questions_answered:r,completed_quiz:r,correct_count:o,wrong_count:d,empty_count:u,score_total:p,quiz_attempt_status:g,updated_at:e.fn.now()}),await D.logCreate({userId:D.fromReq(n),module:"kmis",subject:"Pembelajaran Materi & Quiz",description:`Menyelesaikan kuis dengan attempt_id=${a} (answered=${r}/${l}, correct=${o}, score=${p})`},e),{answeredCount:r,totalQuiz:l,correctCount:o,score:p}}(t,{learningAttemptId:o,topicId:g.kmis_topic_id,req:e});try{h=await async function(e,{learningAttemptId:a}){const t=await e("kmis_learning_attempts as a").leftJoin("users as u","u.id","a.attempt_by").leftJoin("kmis_topics as t","t.id","a.kmis_topic_id").where("a.id",a).whereNull("a.deleted_at").select(["a.id","a.score_total","a.quiz_started",e.raw("COALESCE(u.name, '') as user_name"),e.raw("COALESCE(t.title, '') as topic_name")]).first();if(!t)throw new Error(`Attempt #${a} tidak ditemukan saat generate sertifikat.`);const n=t.topic_name||"-",i=b(t.user_name||"-"),s=Number(t.score_total||0),o=new Intl.NumberFormat("id-ID",{maximumFractionDigits:2}).format(s),d=k.formatTanggalIndonesia(t.quiz_started,1),u=k.formatTanggalIndonesia((new Date).toISOString(),1),c=process.env.CERT_ASSETS_DIR||l.resolve(process.cwd(),"assets"),m=[l.join(c,"logo-atrbpn.svg"),l.join(c,"logo-GEF.svg"),l.join(c,"logo-UNEP.svg")].map(L),p=await new Promise((e,a)=>{try{const l=new r({size:"A4",layout:"landscape",margin:0,info:{Title:`Certificate Attempt #${t.id}`,Author:"Rimba",Subject:"Kuis Completion Certificate"}}),c=[];l.on("data",e=>c.push(e)),l.on("end",()=>e(Buffer.concat(c))),l.on("error",a);const p=l.page.width,g=l.page.height;l.rect(0,0,p,g).fill("#FFFFFF"),l.save(),l.opacity(.1).lineWidth(2).strokeColor("#1f1b2d"),l.rect(18,18,p-36,g-36).stroke(),l.restore();const w=l.linearGradient(0,0,0,g);w.stop(0,"#7fb786").stop(.6,"#568d5d").stop(1,"#3e6b44");const h=l.linearGradient(0,0,0,g);h.stop(0,"#3e6b44").stop(.5,"#568d5d").stop(1,"#7fb786");const _=Math.min(340,.34*p),k=-40,b=-40,f=g+40;l.save(),l.moveTo(k+0*_,b).lineTo(k+.75*_,b).lineTo(k+.5*_,.6*g).lineTo(k+.85*_,f).lineTo(k+0*_,f).closePath().fill(w),l.restore();const y=Math.min(360,.36*p),R=p-y+60,E=-60,D=g+60;l.save(),l.moveTo(R+.45*y,E).lineTo(R+1*y,E).lineTo(R+1*y,D).lineTo(R+.25*y,D).lineTo(R+.55*y,.5*g).closePath().fill(h),l.restore();const T=48,S=36;l.font("Helvetica-Bold").fontSize(16).fillColor("#1f1b2d").text("Program Koridor RIMBA",T,S,{align:"left"}),l.font("Helvetica").fontSize(7).fillColor("#313038").text(`Sertifikat  ${u}`,T,S+22,{align:"left",characterSpacing:1.5});const A=24,I=8,N=8,j=32,v=2*I+3*j+2*N,O=A+2*I,L=p-T-v,M=S;l.save().roundedRect(L,M,v,O,8).fill("#ffffff").lineWidth(2).strokeColor("#568d5d").roundedRect(L,M,v,O,8).stroke().restore();let C=L+I;for(let J=0;J<m.length;J++){const Y=m[J];if(Y)try{l.image(Y,C,M+I,{fit:[j,A],align:"center",valign:"center"})}catch{l.save().rect(C,M+I,j,A).fill("#e7efe8").restore()}else l.save().rect(C,M+I,j,A).fill("#e7efe8").restore();C+=j+N}const F=120;l.font("Helvetica-Bold").fontSize(56).fillColor("#568d5d").text("CERTIFICATE",0,F,{align:"center",characterSpacing:4.5}),l.font("Helvetica-Bold").fontSize(16).fillColor("#b7b3c9").text("OF ACHIEVEMENT",0,F+54,{align:"center",characterSpacing:2.5});const P=.7*p;let $=40;for(l.font("Helvetica-Bold").fontSize($);l.widthOfString(i)>P&&$>22;)$-=1,l.fontSize($);l.fillColor("#1f1b2d").text(i,0,F+112,{align:"center"});const U=.7*p,V=(p-U)/2,B=l.y+8;l.save().opacity(.15).moveTo(V,B).lineTo(V+U,B).lineWidth(3).stroke("#1f1b2d").restore();const q=B+18;l.font("Helvetica").fontSize(13).fillColor("#5e5b6b").text(`Telah menyelesaikan program pembelajaran untuk topik ${n} dengan skor akhir ${o}.`,.14*p,q,{width:.72*p,align:"center"});const x=q+64,z=.8*p,K=(p-z)/2,G=z/3;function s(e,a,t){const n=K+e*G,i=x;l.font("Helvetica-Bold").fontSize(10).fillColor("#313038").text(a.toUpperCase(),n,i,{width:G,align:"center",characterSpacing:1.5});const s=i+22;l.save().opacity(.2).moveTo(n+16,s).lineTo(n+G-16,s).lineWidth(2).stroke("#1f1b2d").restore(),l.font("Helvetica-Bold").fontSize(12).fillColor("#1f1b2d").text(t,n,s+8,{width:G,align:"center"})}s(0,"Issued on",u),s(1,"Started",d),s(2,"Attempt ID",`#${t.id}`),l.font("Helvetica").fontSize(10).fillColor("#313038").text("Sertifikat ini diterbitkan secara otomatis oleh sistem setelah peserta menyelesaikan seluruh materi dan kuis pada topik terkait.",48,g-40,{width:p-96,align:"center"}),l.end()}catch(W){a(W)}});return{fieldname:"files[]",originalname:`certificate-${t.id}.pdf`,mimetype:"application/pdf",buffer:p,size:p.length}}(t,{learningAttemptId:o});const a=await async function(e,{req:a,learningAttemptId:t,file:n}){const i=await y.uploadDocuments([n],a),s=i?.[0],r=Number(s||0);if(!r)throw new Error("Gagal mengunggah sertifikat ke storage server.");return await e("kmis_learning_attempts").where("id",t).update({certificate_ids:u([r]),updated_at:e.fn.now()}),r}(t,{req:e,learningAttemptId:o,file:h});s.info(`| Quiz Attempt KMIS | - Automated certificate created: ${a}, at ${(new Date).toISOString()}`)}catch(e){await t.rollback(),s.error(`| Quiz Attempt KMIS | - Automated certificate failure: ${e.message}`);const n=new E(500,"SERVER_ERROR","Gagal Membuat Sertifikat","Terjadi kesalahan saat membuat/mengunggah sertifikat, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(n.toResponse())}await t.commit(),await async function({attemptId:e,certFile:a,summary:t}){try{if(!a?.buffer||!a?.originalname)return s.warn(`| Quiz Attempt KMIS | - No certificate to send for attempt_id=${e}`),!1;const n=await i("kmis_learning_attempts as a").leftJoin("users as u","u.id","a.attempt_by").leftJoin("kmis_topics as t","t.id","a.kmis_topic_id").where("a.id",e).whereNull("a.deleted_at").first(["a.id","a.kmis_topic_id","a.attempt_by",i.raw("COALESCE(u.name, '') as user_name"),i.raw("COALESCE(u.email, '') as user_email"),i.raw("COALESCE(t.title, '') as topic_name")]),r=n?.user_email?.trim();if(!r)return s.warn(`| Quiz Attempt KMIS | - No email found for attempt_id=${e}, skipping email.`),!1;const o=b(n?.user_name||"-"),l=n?.topic_name||"-",u=t?.score??null,m=d.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),p=c("kmis_certificate_email.html",{name:o,topic_name:l,score:u,from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});return await m.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:r,subject:`Sertifikat Kelulusan KMIS - ${l}`,html:p,attachments:[{filename:a.originalname,content:a.buffer,contentType:a.mimetype||"application/pdf"}]}),s.info(`| Quiz Attempt KMIS | - Certificate email sent to ${r} (attempt_id=${e})`),!0}catch(a){return s.error(`| Quiz Attempt KMIS | - Failed to send certificate email (attempt_id=${e}): ${a.message}`),!1}}({attemptId:o,certFile:h,summary:w});const{answeredCount:n,totalQuiz:p,correctCount:_,score:f}=w,R=new E(200,"SUCCESS_FINISH_QUIZ","Berhasil Menyimpan Data",`Semua jawaban yang dipilih berhasil disubmit. Terjawab: ${n}/${p}, benar: ${_}, skor: ${f}.`);return a.status(200).json(R.toResponse())}catch(e){throw await t.rollback(),e}}catch(e){await t.rollback(),s.error(`| Quiz Attempt KMIS | - Error function storeQuizAttempt: ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.getLearningAttemptCompletedById=async(e,a)=>{const t=await i.transaction(),{id:n}=e.params,r=e.userId;try{const e=await i("kmis_learning_attempts").select("*").where({id:n,attempt_by:r}).whereNull("deleted_at").first();if(!e){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan ID '${n}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(Number(e.quiz_attempt_status)===v.STARTED){await t.rollback();const e=new E(409,"LEARNING_NOT_FINISHED","Pembelajaran Belum Selesai","Pembelajaran sedang berjalan, tidak dapat melihat detail pembelajaran.");return a.status(409).json(e.toResponse())}if(![v.FINISHED,v.ABANDONED].includes(Number(e.quiz_attempt_status))){await t.rollback();const e=new E(409,"LEARNING_NOT_COMPLETED","Pembelajaran Belum Selesai","Status pembelajaran belum selesai.");return a.status(409).json(e.toResponse())}const s=e.kmis_topic_id;if(!s){const s=await i("kmis_quiz_responses as r").select("r.*").where("r.kmis_learning_attempt_id",e.id).whereNull("r.deleted_at").orderBy("r.answered_at","asc");if(0===s.length){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data jawaban kuis untuk attempt '${n}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const[r,o]=await Promise.all([T(e),Promise.all(s.map(e=>j(e)))]);await t.commit();const l=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail pembelajaran dan jawaban kuis berhasil diambil.",{learningParticipant:r,exam:o});return a.status(200).json(l.toResponse())}const[o,l]=await Promise.all([i("kmis_quiz as q").select("q.*").whereNull("q.deleted_at").where(function(){this.where("q.kmis_topic_id",s)}).orderBy("q.created_at","asc"),i("kmis_quiz_responses as r").select("r.*").where("r.kmis_learning_attempt_id",e.id).whereNull("r.deleted_at")]),d=new Map(l.map(e=>[Number(e.kmis_quiz_id),e])),u=o.map(a=>d.get(Number(a.id))||{id:null,kmis_learning_attempt_id:e.id,kmis_quiz_id:a.id,selected_option:null,is_marker:null,is_correct:null,answered_at:null,created_at:null,updated_at:null,deleted_at:null}),[c,m]=await Promise.all([T(e),Promise.all(u.map(e=>j(e)))]);await t.commit();const p=new R(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail pembelajaran dan jawaban kuis berhasil diambil.",{learningParticipant:c,exam:m});return a.status(200).json(p.toResponse())}catch(e){await t.rollback(),s.error(`| Quiz Attempt KMIS | - Error function getLearningAttemptCompletedById: ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.feedback=async(e,a)=>{const t=await i.transaction(),{feedback:r,comment:o}=e.body,{id:l}=e.params,d=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new E(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("kmis_learning_attempts").where("id",l).whereNull("deleted_at").first();if(!s){await t.rollback();const e=new E(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Pembelajaran dengan ID '${l}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(BigInt(String(s.attempt_by))!==BigInt(String(d))){await t.rollback();const e=new E(403,"FORBIDDEN_QUIZ_ACCESS","Akses Ditolak","Anda tidak berhak submit feedback untuk kuis yang bukan milik anda.");return a.status(403).json(e.toResponse())}if([v.STARTED].includes(Number(s.quiz_attempt_status))){await t.rollback();const e=new E(409,"FEEDBACK_NOT_ALLOWED","Feedback Tidak Diperbolehkan","Kuis sedang berjalan, tidak dapat mengirim feedback.");return a.status(409).json(e.toResponse())}await t("kmis_learning_attempts").where("id",l).update({feedback:r,feedback_comment:o,quiz_attempt_status:v.FINISHED,updated_at:t.fn.now()}),await t.commit();const u=new E(200,"SUCCESS_UPDATE_DATA","Feedback Berhasil Diperbarui",`Feedback untuk pembelajaran ID '${l}' diperbarui menjadi ${r}.`);return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Learning Attempt KMIS | - Error function feedback : ${e.message}`);const n=new E(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},1501:(e,a,t)=>{const{body:n}=t(7975);a.loginValidator=[n("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),n("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter.")]},1520:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["Swakelola 1","Swakelola 2","Swakelola 3","Kontraktual"]);a.updateActivityPackageValidator=[n("picDivisionId").notEmpty().withMessage("Divisi PIC wajib dipilih.").bail().isInt().withMessage("Divisi PIC harus berupa angka.").bail().custom(async e=>{if(!await i("monev_pic_divisions").where("id",e).whereNull("deleted_at").first())throw new Error("Divisi PIC yang Anda pilih tidak ditemukan.");return!0}),n("contractType").trim().notEmpty().withMessage("Tipe kontrak tidak boleh kosong.").bail().isString().withMessage("Tipe kontrak harus berupa teks.").bail().isIn(s).withMessage(`Tipe kontrak harus salah satu dari: ${s.join(", ")}.`),n("mak").notEmpty().withMessage("MAK tidak boleh kosong.").bail().isString().withMessage("MAK harus berupa teks.").bail().isLength({max:50}).withMessage("MAK maksimal 50 karakter."),n("name").notEmpty().withMessage("Nama Paket tidak boleh kosong.").bail().isString().withMessage("Nama Paket harus berupa teks.").bail().isLength({max:180}).withMessage("Nama Paket maksimal 180 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks."),n("unitOutput").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks."),n("codeOutput").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks."),n("volume").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:50}).withMessage("Judul kategori maksimal 50 karakter."),n("pagu").notEmpty().withMessage("Jumlah Pagu tidak boleh kosong.").bail().isInt().withMessage("Jumlah Pagu harus berupa angka."),n("partner").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:150}).withMessage("Judul kategori maksimal 150 karakter.")]},1572:e=>{"use strict";e.exports=require("nodemailer")},1606:e=>{e.exports=async function(e){return{id:e.id,userPic:e.user_pic,title:e.title,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},1643:e=>{function a(e){return String(e).split("/").map(e=>{if(""===e)return e;try{e=decodeURIComponent(e)}catch{}return encodeURIComponent(e)}).join("/")}function t(e){if(null==e)return e;const t=String(e);if(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(t))try{const e=new URL(t);return e.pathname=a(e.pathname),e.toString()}catch{return t.replace(/ /g,"%20")}const[n,i=""]=t.split("#",2),[s,r=""]=n.split("?",2);return a(s)+(r?`?${r}`:"")+(i?`#${i}`:"")}e.exports={encodeUrl:t,encodePathSegments:a,encodeFileUrlPayload:function(e,a="server_file_url"){return Array.isArray(e)?e.map(e=>e&&"object"==typeof e?{...e,[a]:t(e[a])}:e):e&&"object"==typeof e?{...e,[a]:t(e[a])}:e}}},1701:(e,a,t)=>{const n=t(4930),i=t(7780),{encodeUrl:s}=t(1643),r=t(7484);e.exports=class{static async uploadDocuments(e,a){const t=[],o=a.userId;try{const a=await i.uploadToServer(e);if(Array.isArray(a)&&a.length>0)for(const e of a)if(e&&e.server_file_id){const[{id:a}]=await n("documents").insert({uploaded_by:o,verified_by:1,file_id:e.server_file_id,file_name:e.server_file_name,file_path:e.server_file_path,file_url:s(e.server_file_url),file_mime_type:e.server_file_mime_type,file_size:e.server_file_size}).returning(["id"]);t.push(Number(a)),r.info("| documentHelper | - Document uploaded successfully",{file_name:e.server_file_name,file_size:e.server_file_size,document_id:a})}else r.error("| documentHelper | - Failed to save document. No file_id in response.",e);else r.error("| documentHelper | - Invalid upload response format.",a)}catch(e){throw r.error("| Document Helper | - Error during document upload",{error:e.message}),new Error("Failed to upload documents.")}return t}static async deleteDocuments(e){try{const a=(await n("documents").select("file_id").whereIn("id",e)).map(e=>e.file_id);if(await n("documents").whereIn("id",e).update({deleted_at:n.fn.now()}),a.length>0){const t=await i.deleteFromServer(a);r.info("| documentHelper | - Documents deleted from storage.",{file_ids:a,document_ids:e,result:t})}}catch(e){throw r.error("| Document Helper | - Failed to delete document from storage.",{error:e.message}),new Error("Failed to delete documents.")}}}},1717:(e,a,t)=>{const{body:n}=t(7975);a.storeMonevDashboardValidator=[n("hibah").notEmpty().withMessage("Hibah tidak boleh kosong.").bail().isInt().withMessage("Hibah harus berupa angka."),n("description").notEmpty().withMessage("Deskripsi hibah tidak boleh kosong.").bail().isString().withMessage("Deskripsi hibah harus berupa teks.")]},1763:e=>{"use strict";e.exports=require("express-rate-limit")},1766:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),r=t(4729),o=t(1572),{asJsonb:l}=t(6192),{applySearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),{normIdArray:m,parseJsonSafe:p,isPlainObject:g}=t(7872),{stripTitlesOnly:w,generateRandomPassword:h}=t(337),_=t(6348),{checkEmailDeliverability:k}=t(8467),b=t(1332),f=t(6870),y=t(1606),R=t(6479),{applyTrashedScope:E}=t(7438),{applyLatestThenTrashed:D}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("monev_pic_divisions as division").select("division.*");E(n,e,"division.deleted_at"),d(n,t,["division.title"]),D(n,"division.deleted_at","division.created_at","division.id");const s=u(e.query),r=await c(n,s,i);if(0===r.data.length){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>y(e))),l=new b(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data divisi berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| PIC Division MONEV | - Error function index : ${e.message}`);const t=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new f(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("monev_pic_divisions").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").first()){await t.rollback();const e=new f(422,"DUPLICATE_TITLE","Duplikat Data",`Judul divisi '${r}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}await t("monev_pic_divisions").insert({title:r,description:o}).returning("*"),await R.logCreate({userId:R.fromReq(e),module:"master_data",subject:"List Kategori Divisi PIC"},t),await t.commit();const s=new f(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data divisi '${r}' berhasil ditambahkan.`);return a.status(201).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| PIC Division MONEV | - Error function store: ${e.message}`);const n=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("monev_pic_divisions").select("*").where("id",t).first();if(!e){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data divisi dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await y(e),s=new b(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data divisi '${e.title}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| PIC Division MONEV | - Error function show: ${e.message}`);const t=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{title:r,description:o,userIds:d}=e.body,u=e.params.id,c=m(d,{as:"number"}).filter(Number.isFinite),p=[...new Set(c)];try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new f(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(!await t("monev_pic_divisions").where("id",u).first()){await t.rollback();const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data divisi dengan ID '${u}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("monev_pic_divisions").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").whereNot("id",u).first()){await t.rollback();const e=new f(422,"DUPLICATE_TITLE","Duplikat Data",`Judul '${r}' sudah digunakan pada divisi lain.`);return a.status(422).json(e.toResponse())}if(p.includes(1)){await t.rollback();const e=new f(422,"FORBIDDEN_USER_ID","User Tidak Diizinkan","User dengan ID 1 (super admin) tidak boleh ditetapkan sebagai PIC.");return a.status(422).json(e.toResponse())}if(p.length>0){const e=await t("users").whereIn("id",p).pluck("id"),n=new Set(e.map(Number)),i=p.filter(e=>!n.has(e));if(i.length>0){await t.rollback();const e=new f(422,"INVALID_USER_IDS","Pengguna Tidak Ditemukan",`Beberapa userIds tidak valid: ${i.join(", ")}.`);return a.status(422).json(e.toResponse())}}await t("monev_pic_divisions").where("id",u).update({user_pic:l(p),title:r,description:o,updated_at:t.fn.now()}),await R.logUpdate({userId:R.fromReq(e),module:"master_data",subject:"List Kategori Divisi PIC"},t),await t.commit();const s=new f(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data divisi '${r}' berhasil diperbarui.`);return a.status(200).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| PIC Division MONEV | - Error function update : ${e.message}`);const n=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=m(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new f(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new f(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("monev_pic_divisions").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data divisi yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("monev_pic_divisions").whereIn("id",r).update({deleted_at:t.fn.now()}),await R.logDelete({userId:R.fromReq(e),module:"master_data",subject:"List Kategori Divisi PIC"},t),await t.commit();const o=new f(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data divisi.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| PIC Division MONEV | - Error function destroy : ${e.message}`);const n=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=m(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new f(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new f(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("monev_pic_divisions").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data divisi terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.title?.toLowerCase?.()??""),l=await t("monev_pic_divisions").select(i.raw("lower(title) AS ltitle")).whereNull("deleted_at").whereIn(i.raw("lower(title)"),o),d=new Set(l.map(e=>e.ltitle)),u=new Set,c=new Set;for(const e of r){const a=(e.title||"").toLowerCase();u.has(a)?c.add(a):u.add(a)}const p=[],g=[],w=new Set;for(const e of r){const a=(e.title||"").toLowerCase(),t=d.has(a),n=c.has(a);t||n||w.has(a)?g.push({id:e.id,title:e.title}):(w.add(a),p.push(e))}let h=0;if(p.length>0){const e=p.map(e=>e.id);await t("monev_pic_divisions").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),h=e.length}if(await R.logRestore({userId:R.fromReq(e),module:"master_data",subject:"List Kategori Divisi PIC"},t),await t.commit(),0===h){const e=new f(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const _=[`Berhasil mengembalikan ${h} data yang terhapus.`];g.length&&_.push(`Terlewat ${g.length} karena bentrok/duplikat data.`);const k=new f(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",_.join(" "));return a.status(200).json(k.toResponse())}catch(e){s.error(`| PIC Division MONEV | - Error function restore: ${e.message}`);const t=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.assignPic=async(e,a)=>{const t=await i.transaction(),{userPic:n}=e.body,d=e.params.id;let u=[];try{const i=await t("monev_pic_divisions").where("id",d).first();if(!i){await t.rollback();const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data divisi dengan ID '${d}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const c=function(e,a={}){const{allowEmpty:t=!1,maxNameLen:n=255,maxEmailLen:i=255,fieldLabel:s="userPic"}=a;let r=e;if("string"==typeof r&&(r=p(r)??r),!Array.isArray(r))return{error:new f(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",`${s} format harus array of object dengan properti { name: string, email: string }.`)};const o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/i,l=r.map(e=>{if(!g(e))return null;let{name:a,email:t}=e;return"string"!=typeof a?null:(a=a.trim(),0===a.length||"number"==typeof n&&a.length>n||"string"!=typeof t?null:(t=t.trim(),0===t.length||"number"==typeof i&&t.length>i?null:o.test(t)?{name:a,email:t}:null))}).filter(Boolean);if(!t&&0===l.length)return{error:new f(422,"INVALID_CONTENT_ITEMS","Elemen Konten Tidak Valid",`Setiap elemen ${s} harus objek { name, email } dan minimal satu elemen valid.`)};const d=new Set,u=[];for(const e of l){const a=e.email.toLowerCase();d.has(a)||(d.add(a),u.push(e))}return{value:u}}(n,{allowEmpty:!1,fieldLabel:"userPic",maxNameLen:255,maxEmailLen:255});if(c.error)return await t.rollback(),a.status(422).json(c.error.toResponse());const m=c.value,b=await async function(e,a,t){const n=new Set,i=new Set;for(const e of t){const a=e.email.trim().toLowerCase();n.has(a)?i.add(a):n.add(a)}const s=t.map(e=>e.email.trim().toLowerCase());let r=[];if(s.length>0&&(r=await e("users").select("id","email","role_id").whereIn(e.raw("lower(email)"),s).whereNull("deleted_at")),r.some(e=>1===Number(e.id)))return{error:new f(422,"FORBIDDEN_USER_ID","User Tidak Diizinkan","User dengan ID 1 (super admin) tidak boleh ditetapkan sebagai PIC.")};const o=r.filter(e=>1!==Number(e.role_id)&&3!==e.id);if(o.length>0){const e=o.map(e=>String(e.email).toLowerCase());return{error:new f(422,"DUPLICATE_EMAIL","Duplikat Email",`Email berikut sudah digunakan oleh akun non-Super Admin dan non-Monev: ${e.join(", ")}.`)}}if(s.length>0){const t=`\n      SELECT d.id, d.title, lower(e->>'email') AS email\n      FROM monev_pic_divisions d\n      CROSS JOIN LATERAL jsonb_array_elements(COALESCE(d.user_pic, '[]'::jsonb)) AS e\n      WHERE d.deleted_at IS NULL\n        AND d.id <> ?\n        AND lower(e->>'email') IN (${s.map(()=>"?").join(",")})\n    `,{rows:n}=await e.raw(t,[a,...s]);if(n.length>0){const e=n.reduce((e,a)=>((e[a.email]||=[]).push(a.title??`Divisi #${a.id}`),e),{}),a=Object.entries(e).map(([e,a])=>`${e} (sudah di: ${[...new Set(a)].join(", ")})`).join("; ");return{error:new f(422,"DUPLICATE_PIC_ASSIGNMENT","Rangkap Divisi Tidak Diizinkan",`Beberapa email sudah terdaftar pada divisi lain: ${a}.`)}}}return{emailsLower:s,existingRole1Emails:new Set(r.filter(e=>1===Number(e.role_id)).map(e=>String(e.email).toLowerCase()))}}(t,d,m);if(b.error)return await t.rollback(),a.status(422).json(b.error.toResponse());const y=new Set(function(e){let a=[];a=Array.isArray(e)?e:"string"==typeof e?p(e)||[]:g(e)?e:[];const t=[];for(const e of a)if(g(e)&&"string"==typeof e.email){const a=e.email.trim().toLowerCase();a&&t.push(a)}return t}(i.user_pic)),E=new Set(m.map(e=>e.email.trim().toLowerCase())),D=[...y].filter(e=>!E.has(e));if(D.length>0){const e=(await t("users").select("id","email","role_id").whereIn(t.raw("lower(email)"),D).whereNull("deleted_at")).filter(e=>1!==Number(e.id)&&1!==Number(e.role_id)).map(e=>e.id);e.length>0&&await t("users").whereIn("id",e).update({role_id:1,updated_at:t.fn.now()})}const T=await async function(e,a){const t=[],n=[],i=a.map(e=>e.email.trim().toLowerCase()),o=i.length>0?await e("users").select("id","name","email","role_id").whereIn(e.raw("lower(email)"),i).whereNull("deleted_at"):[],l=new Map(o.map(e=>[String(e.email).toLowerCase(),e]));for(const i of a){const a=i.name.trim(),o=i.email.trim(),d=o.toLowerCase(),u=l.get(d);if(u){await e("users").where({id:u.id}).update({role_id:3,updated_at:e.fn.now()});continue}const c=await k(o,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(s.info(`[email-check] ${o} -> ${c.ok} (${c.reason}) ${JSON.stringify(c.detail||[])}`),!c.ok)return{error:new f(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${o}' tampaknya tidak dapat menerima email. Gunakan email lain.`)};const m=w(a),p=h(8),g=await r.hash(p,12),[_]=await e("users").insert({name:m,email:o,role_id:3,account_status:2,password:g}).returning(["id","name","email","created_at"]);t.push(_),n.push({name:m,email:o,password:p})}return{createdUsers:t,credentials:n}}(t,m);if(T.error)return await t.rollback(),a.status(422).json(T.error.toResponse());u=T.credentials,await t("monev_pic_divisions").where("id",d).update({user_pic:l(m),updated_at:t.fn.now()}),await R.logUpdate({userId:R.fromReq(e),module:"master_data",subject:"Assign Pengguna Divisi PIC"},t),await t.commit();try{await async function(e){if(!e||0===e.length)return;const a=o.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}});for(const t of e){const e=_("credential_monev.html",{name:t.name,email:t.email,password:t.password,login_url:process.env.APP_LOGIN_URL||"#",from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});try{await a.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:t.email,subject:"Credential Akun PIC MONEV RIMBA",html:e}),s.info(`[PIC Credential] sent to ${t.email}`)}catch(e){s.warn(`[PIC Credential] FAILED to ${t.email}: ${e.message}`)}}}(u)}catch(e){s.warn(`[PIC Credential] Bulk send error: ${e.message}`)}const S=new f(200,"SUCCESS_ASSIGN_PIC","Berhasil Memperbarui","Data PIC berhasil diperbarui.");return a.status(200).json(S.toResponse())}catch(e){await t.rollback(),s.error(`| PIC Division MONEV | - Error function update : ${e.message}`);const n=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},1784:(e,a,t)=>{const n=t(6293),i=t(3824),s=t(5789),r=t(6167);t(2064),n.extend(i),n.extend(s),n.extend(r),n.locale("id");const o="Asia/Jakarta",l=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2})$/i;function d(e,a=o){if(null==e||""===e)return null;if("number"==typeof e){const a=e<1e12?1e3*e:e;return n.utc(a)}if(e instanceof Date)return n(e).utc();const t=String(e).trim();if(!t)return null;if(l.test(t))return n.utc(t);const i=t.replace("T"," "),s=n.tz(i,a);return s.isValid()?s.utc():null}e.exports={isIso8601Z:function(e){return l.test(String(e))},toDatabaseUTC:function(e,a=o){const t=d(e,a);return t?t.tz("UTC").format("YYYY-MM-DD HH:mm:ss"):null},formatTanggalIndonesia:function(e,a=1,t={}){const n=t.inputTz||o,i=t.displayTz||"Asia/Jakarta",s=d(e,n);if(!s)return"-";const r=s.tz(i);switch(a){case 1:return r.format("dddd, D MMMM YYYY");case 2:return`${r.format("dddd, D MMMM YYYY")} pukul ${r.format("HH:mm")} WIB`;case 3:default:return r.format("D MMMM YYYY");case 4:return r.format("DD-MM-YYYY");case 5:return s.tz("UTC").format("YYYY-MM-DD HH:mm:ss");case 6:return r.format("DD/MM/YYYY")}},toUTC:function(e,a=o){const t=d(e,a);return t?t.toDate():null},_internals:{parseToUTC:d}}},1832:e=>{"use strict";e.exports=require("knex")},1888:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l,isPlainObject:d,handleLocalizedText:u}=t(7872),{asJsonb:c}=t(6192),{applyRelationIn:m,applyJsonbSearch:p,applyPagination:g,formatPaginationResult:w}=t(3210),h=t(1701),_=t(1332),k=t(6870),b=t(52),f=t(6479),{applyTrashedScope:y}=t(7438),{applyLatestThenTrashed:R}=t(7540);a.index=async(e,a)=>{const{search:t,eventCategoryId:n}=e.query,r=n??e.query["eventCategoryId[]"];try{let n=i("cms_events as event").select("event.*");y(n,e,"event.deleted_at"),m(n,"event.cms_event_category_id",r,{as:"number"}),p(n,t,["event.title->>'id'","event.title->>'en'"],{mode:"or",split:!0}),R(n,"event.deleted_at","event.created_at","event.id");const s=g(e.query),o=await w(n,s,i);if(0===o.data.length){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>b(e))),d=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kegiatan berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){s.error(`| Event CMS | - Error function index : ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{categoryId:r,title:o,description:l,eventContent:d}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=u(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"title"});if(s.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const m=u(l,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(m.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",m.error.message);return a.status(422).json(e.toResponse())}const p=u(d,{allowPartial:!1,maxLen:void 0,fieldLabel:"eventContent"});if(p.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",p.error.message);return a.status(422).json(e.toResponse())}if(!e.files||0===e.files.length){const e=new k(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File thumbnail wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>1){const e=new k(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(t.mimetype)){const e=new k(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh JPG, JPEG, PNG, dan WebP.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new k(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}if(await t("cms_events").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(title->>'en') = lower(?)",[s.value.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Judul kegiatan (ID/EN) sudah digunakan. Silakan gunakan judul lain.");return a.status(422).json(e.toResponse())}const g=await h.uploadDocuments(e.files,e),w=g?.[0],_=Number(w);await t("cms_events").insert({cms_event_category_id:r,thumbnail_ids:c([_]),title:{id:s.value.id,en:s.value.en},description:{id:m.value.id,en:m.value.en},event_content:{id:p.value.id,en:p.value.en}}).returning("*"),await f.logCreate({userId:f.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit();const b=new k(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kegiatan '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(b.toResponse())}catch(e){await t.rollback(),s.error(`| Event CMS | - Error function store: ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_events").select("*").where("id",t).first();if(!e){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=d(e.title)?e.title:parseJsonSafe(e.title)||{},s=n.id||n.en||"Tanpa Nama",r=await b(e),o=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kegiatan '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){s.error(`| Event CMS | - Error function show: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{categoryId:m,title:p,description:g,eventContent:w,deleteDocumentIds:_}=e.body,b=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_events").where("id",b).first();if(!s){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${b}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const y=d(s.title)?s.title:parseJsonSafe(s.title)??{id:"",en:""},R=d(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""},E=d(s.event_content)?s.event_content:parseJsonSafe(s.event_content)??{id:"",en:""};let D=y;if(void 0!==p){const e=u(p,{allowPartial:!0,maxLen:void 0,fieldLabel:"title"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...y,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=y.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=y.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Judul harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}D={id:String(t.id).trim(),en:String(t.en).trim()}}let T=R;if(void 0!==g){const e=u(g,{allowPartial:!0,maxLen:void 0,fieldLabel:"description"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...R,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=R.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=R.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}T={id:String(t.id).trim(),en:String(t.en).trim()}}let S=E;if(void 0!==w){const e=u(w,{allowPartial:!0,maxLen:void 0,fieldLabel:"eventContent"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...E,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=E.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=E.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Konten acara harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}S={id:String(t.id).trim(),en:String(t.en).trim()}}if(((D.id??"").toLowerCase()!==(y.id??"").toLowerCase()||(D.en??"").toLowerCase()!==(y.en??"").toLowerCase())&&await t("cms_events").whereNull("deleted_at").whereNot("id",b).andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[D.id]).orWhereRaw("lower(title->>'en') = lower(?)",[D.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Judul kegiatan (ID/EN) sudah digunakan pada kegiatan lain.");return a.status(422).json(e.toResponse())}const A=r(_).map(String),I=["image/jpeg","image/jpg","image/png","image/webp"],N=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="thumbnail_ids",maxFilesAllowed:i=1,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, dan WebP."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:s,deleteDocumentIds:A,files:Array.isArray(e.files)?e.files:[],dbColumn:"thumbnail_ids",maxFilesAllowed:1,allowedTypes:I,sizeLimitBytes:52428800});if(!N.ok){const e=new k(N.http,N.code,N.title,N.desc);return a.status(N.http).json(e.toResponse())}const j=o(s.thumbnail_ids);let v=l(j,{as:"number"})[0]??null;null!=v&&A.includes(String(v))&&(await h.deleteDocuments([v]),v=null);let O=null;Array.isArray(e.files)&&e.files.length>0&&(O=await h.uploadDocuments(e.files,e));const L=O?.[0]??v??null,M=null!=L?[Number(L)]:[];await t("cms_events").where("id",b).update({cms_event_category_id:m,thumbnail_ids:c(M),title:D,description:T,event_content:S,updated_at:t.fn.now()}),await f.logUpdate({userId:f.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit();const C=new k(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kegiatan '${D.id}' berhasil diperbarui.`);return a.status(200).json(C.toResponse())}catch(e){await t.rollback(),s.error(`| Event CMS | - Error function update : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_events").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kegiatan yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_events").whereIn("id",r).update({deleted_at:t.fn.now()}),await f.logDelete({userId:f.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit();const o=new k(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data kegiatan.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| Event CMS | - Error function destroy : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("cms_events").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kegiatan terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=e=>{const a=d(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=r.map(e=>{const a=o(e.title);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let p=[];(c.length||m.length)&&(p=await t("cms_events").select("id","title").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(title->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(title->>'en')"),m):this.whereIn(i.raw("lower(title->>'en')"),m))}));const g=new Set;for(const e of p){const a=o(e.title);a.idLower&&g.add(`id:${a.idLower}`),a.enLower&&g.add(`en:${a.enLower}`)}const w=new Set,h=new Set,_=new Set;for(const e of u)e.idLower&&(w.has(e.idLower)?_.add(`id:${e.idLower}`):w.add(e.idLower)),e.enLower&&(h.has(e.enLower)?_.add(`en:${e.enLower}`):h.add(e.enLower));const b=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&g.has(a)||t&&g.has(t),i=a&&_.has(a)||t&&_.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,title:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),b.push(e))}let D=0;if(b.length>0){const e=b.map(e=>e.rowId);await t("cms_events").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await f.logRestore({userId:f.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit(),0===D){const e=new k(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new k(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| Event CMS | - Error function restore: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},1960:(e,a,t)=>{const{body:n}=t(7975);a.storeAnimalCategoryValidator=[n("name").custom(e=>{if(void 0===e)throw new Error("Nama kategori satwa wajib diisi.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi kategori satwa wajib diisi.");return!0})]},1970:(e,a,t)=>{const{body:n}=t(7975);a.updateCategoryValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},1976:(e,a,t)=>{const n=t(7252).Router(),i=t(8992),{storeActivityPackageValidator:s}=t(2878),{updateActivityPackageValidator:r}=t(1520),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.monev_activity"]),i.index),n.get("/show/:id",u(["view.monev_activity"]),i.show),n.post("/create",u(["create.monev_activity"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.monev_activity"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.monev_activity"]),i.destroy),n.get("/export",u(["view.monev_activity"]),i.export),e.exports=n},2024:(e,a,t)=>{const n=t(4930),i=t(3034);e.exports=async function(e){const a=await n("users").where("id",e.id).first(),t=await n("kmis_learning_attempts").where("attempt_by",a.id).whereNull("deleted_at").select(n.raw("COUNT(*)::int AS total_attempts"),n.raw("SUM(CASE WHEN quiz_attempt_status = 2 THEN 1 ELSE 0 END)::int AS total_finished"),n.raw("COALESCE(AVG(CASE WHEN quiz_attempt_status = 2 THEN score_total END), 0)::double precision AS avg_score_finished"),n.raw("COUNT(DISTINCT kmis_topic_id)::int AS total_topics_taken")).first();return{id:a.id,user:a?await i(a):null,totalTopic:Number(t?.total_topics_taken??0),totalAttempts:Number(t?.total_attempts??0),totalFinished:Number(t?.total_finished??0),avgScoreFinished:Number(t?.avg_score_finished??0),createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},2064:e=>{"use strict";e.exports=require("dayjs/locale/id")},2069:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{isPlainObject:r,normIdArray:o,handleLocalizedText:l}=t(7872),{applyJsonbSearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),m=t(1332),p=t(6870),g=t(8641),w=t(6479),{applyTrashedScope:h}=t(7438),{applyLatestThenTrashed:_}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("cms_animal_categories as category").select("category.*");h(n,e,"category.deleted_at"),d(n,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0}),_(n,"category.deleted_at","category.created_at","category.id");const s=u(e.query),r=await c(n,s,i);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>g(e))),l=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori satwa berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| Animal Category Master | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{name:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=l(r,{allowPartial:!1,maxLen:void 0,fieldLabel:"name"});if(s.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const d=l(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(d.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",d.error.message);return a.status(422).json(e.toResponse())}if(await t("cms_animal_categories").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(name->>'en') = lower(?)",[s.value.en])}).first()){await t.rollback();const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori satwa ini sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_animal_categories").insert({name:{id:s.value.id,en:s.value.en},description:{id:d.value.id,en:d.value.en}}),await w.logCreate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Satwa"},t),await t.commit();const u=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kategori satwa '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Category Master | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_animal_categories").select("*").where("id",t).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori satwa dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await g(e),s=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori satwa '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Animal Category Master | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{name:o,description:d}=e.body,u=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_animal_categories").where("id",u).first();if(!s){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori satwa dengan ID '${u}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const c=r(s.name)?s.name:parseJsonSafe(s.name)??{id:"",en:""},m=r(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""};let g=c;if(void 0!==o){const e=l(o,{allowPartial:!0,maxLen:void 0,fieldLabel:"nama"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...c,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=c.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=c.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Nama harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}g={id:String(t.id).trim(),en:String(t.en).trim()}}let h=m;if(void 0!==d){const e=l(d,{allowPartial:!0,maxLen:void 0,fieldLabel:"deskripsi"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...m,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=m.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=m.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}h={id:String(t.id).trim(),en:String(t.en).trim()}}if(((g.id??"").toLowerCase()!==(c.id??"").toLowerCase()||(g.en??"").toLowerCase()!==(c.en??"").toLowerCase())&&await t("cms_animal_categories").whereNull("deleted_at").whereNot("id",u).andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[g.id]).orWhereRaw("lower(name->>'en') = lower(?)",[g.en])}).first()){const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori satwa (ID/EN) sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_animal_categories").where("id",u).update({name:g,description:h,updated_at:t.fn.now()}),await w.logUpdate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Satwa"},t),await t.commit();const _=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kategori satwa '${g.id}' berhasil diperbarui.`);return a.status(200).json(_.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Category Master | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_animal_categories").select("id","name").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_animal_categories").whereIn("id",r).update({deleted_at:t.fn.now()}),await w.logDelete({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Satwa"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data kategori satwa.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Category Master | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const l=await t("cms_animal_categories").select("id","name").whereIn("id",n).whereNotNull("deleted_at");if(0===l.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const d=e=>{const a=r(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=l.map(e=>{const a=d(e.name);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let g=[];(c.length||m.length)&&(g=await t("cms_animal_categories").select("id","name").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(name->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(name->>'en')"),m):this.whereIn(i.raw("lower(name->>'en')"),m))}));const h=new Set;for(const e of g){const a=d(e.name);a.idLower&&h.add(`id:${a.idLower}`),a.enLower&&h.add(`en:${a.enLower}`)}const _=new Set,k=new Set,b=new Set;for(const e of u)e.idLower&&(_.has(e.idLower)?b.add(`id:${e.idLower}`):_.add(e.idLower)),e.enLower&&(k.has(e.enLower)?b.add(`en:${e.enLower}`):k.add(e.enLower));const f=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&h.has(a)||t&&h.has(t),i=a&&b.has(a)||t&&b.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,name:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),f.push(e))}let D=0;if(f.length>0){const e=f.map(e=>e.rowId);await t("cms_animal_categories").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await w.logRestore({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Satwa"},t),await t.commit(),0===D){const e=new p(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| Animal Category Master | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},2096:e=>{"use strict";e.exports=require("morgan")},2110:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(6870);e.exports=(e,a,t)=>{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new i(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}t()}},2250:e=>{"use strict";e.exports=require("dns")},2273:e=>{e.exports=async function(e){return{id:e.id,name:e.name,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},2299:(e,a,t)=>{const{body:n}=t(7975);a.storeFaqValidator=[n("question").custom(e=>{if(void 0===e)throw new Error("Pernyataan wajib diisi.");return!0}),n("answer").custom(e=>{if(void 0===e)throw new Error("Deskripsi jawaban wajib diisi.");return!0})]},2305:e=>{"use strict";e.exports=require("form-data")},2327:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(4729),r=t(1572),o=t(7484),{toArray:l,normJsonbArray:d,normIdArray:u}=t(7872),{applySearch:c,applyPagination:m,formatPaginationResult:p}=t(3210),{stripTitlesOnly:g,makeInitialPasswordFromName:w}=t(337),{asJsonb:h}=t(6192),_=t(1701),k=t(6348),b=t(1332),f=t(6870),y=t(3034),R=t(4388),E=t(6479);a.getUserProfile=async(e,a)=>{const t=e.userId;try{const e=await i("users").select("*").where("id",t).whereNull("deleted_at").first();if(!e){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data akun pengguna dengan ID '${id}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=g(e.name),s=await y(e),r=new b(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data akun pengguna '${n}' berhasil didapatkan.`,s);return a.status(200).json(r.toResponse())}catch(e){o.error(`| Profile | - Error function getUserProfile: ${e.message}`);const t=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getUserActivitybyUserId=async(e,a)=>{const{id:t}=e.params,{search:n}=e.query;try{const s=await i("users as user").where("user.id",t).whereNot("user.role_id",1).whereNull("user.deleted_at").first();if(!s){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data akun pengguna dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}let r=i("activity_logs as activity").leftJoin("users as user","user.id","activity.user_id").select("activity.*").where("activity.user_id",s.id).whereNull("activity.deleted_at").orderBy("activity.created_at","desc");c(r,n,["activity.module","activity.key","user.name"]);const o=m(e.query),l=await p(r,o,i);if(0===l.data.length){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>R(e,s))),u=new b(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data aktivitas pengguna berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(u.toResponse())}catch(e){o.error(`| Profile | - Error function getUserActivitybyUserId: ${e.message}`);const t=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.updateUserData=async(e,a)=>{const t=await i.transaction(),{name:l,email:c,birthDate:m,gender:p,phoneNumber:b,profession:y,address:R}=e.body,D=e.userId,T=e=>{if(null==e)return!1;const a=String(e).trim();return!!a&&!/^null$/i.test(a)&&!/^undefined$/i.test(a)};try{const S=n(e);if(!S.isEmpty()){const e=S.array().map(e=>e.msg).join(" "),t=new f(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const A=await t("users").where("id",D).whereNull("deleted_at").first();if(!A){const e=new f(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data pengguna dengan ID '${D}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const I=e.file??e.files?.files?.[0]??null,N=d(A.photo_profile_ids),j=u(N,{as:"number"})[0]??null,v=null!=j,O=!!I;let L=null;if(O){const a=await _.uploadDocuments([I],e);if(L=a?.[0]??null,null==L)throw new Error("UPLOAD_FAILED: tidak mendapatkan ID dokumen baru.")}const M=String(A.email||"").trim().toLowerCase(),C=T(c)?String(c).trim().toLowerCase():M,F=T(c)&&C!==M,P=T(l)?l:A.name,$=g(P);let U=null,V=null;F&&(U=w(P),V=await s.hash(U,12));const B={updated_at:t.fn.now(),...F&&{password:V,account_status:1},...O&&{photo_profile_ids:h([Number(L)])},...T(l)&&{name:l},...T(c)&&{email:c},...T(m)&&{birth_date:i.raw("left(?,10)::date",[m])},...T(p)&&{gender:Number(p)},...T(b)&&{phone_number:b},...T(y)&&{profession:y},...T(R)&&{address:R}};await t("users").where("id",D).update(B);const q=await t("roles").select("name").where("id",A.role_id).first(),x=q?.name??"User";if(await E.logUpdate({userId:E.fromReq(e),module:"profile",subject:"Data Diri"},t),await t.commit(),v&&O&&L&&L!==j&&_.deleteDocuments([j]).catch(e=>{o.warn(`Gagal hapus foto lama user ${D}: ${e.message}`)}),F)try{const e=c,a=r.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),t=k("credential_new_email.html",{name:$,email:e,password:U,role_name:x,login_url:process.env.APP_LOGIN_URL||"#",from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await a.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:e,subject:"Credential Akun Baru RIMBA",html:t}),o.info(`| Student KMIS | - Credential email successfully sent to ${e} at ${(new Date).toISOString()}`)}catch(e){o.error(`| Profile | - Failed to send credential email: ${e.message}`)}const z=new f(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data akun pengguna '${$}' berhasil diperbarui.`);return a.status(200).json(z.toResponse())}catch(e){await t.rollback(),o.error(`| Profile | - Error function update : ${e.message}`);const n=new f(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},2363:(e,a,t)=>{const n=t(7252).Router(),i=t(2408),{storeLegalDocumentValidator:s}=t(6567),{updateLegalDocumentValidator:r}=t(8573),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.cms_management"]),i.index),n.get("/show/:id",u(["view.cms_management"]),i.show),n.post("/create",u(["create.cms_management"]),c.array("files",5),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.array("files",5),r,o,i.update),n.delete("/delete",u(["delete.cms_management"]),i.destroy),n.patch("/restore",u(["restore.cms_management"]),i.restore),e.exports=n},2408:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l,isPlainObject:d,handleLocalizedText:u}=t(7872),{asJsonb:c}=t(6192),{applyStartEndDateFilter:m,validateDateRangeRequiredBoth:p,applyJsonbSearch:g,applyPagination:w,formatPaginationResult:h}=t(3210),_=t(1701),k=t(1332),b=t(6870),f=t(5212),y=t(6479),{applyTrashedScope:R}=t(7438),{applyLatestThenTrashed:E}=t(7540);a.index=async(e,a)=>{const{search:t,start_date:n,end_date:r}=e.query;try{const s=p(n,r);if(!s.ok){const e=new b(422,s.code,s.title,s.desc);return a.status(422).json(e.toResponse())}let o=i("cms_legal_documents as document").select("document.*");R(o,e,"document.deleted_at"),m(o,"document.created_at",n,r,{inclusiveEnd:!0}),g(o,t,["document.title->>'id'","document.title->>'en'"],{mode:"or",split:!0}),E(o,"document.deleted_at","document.created_at","document.id");const l=w(e.query),d=await h(o,l,i);if(0===d.data.length){const e=new b(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const u=await Promise.all(d.data.map(e=>f(e))),c=new k(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data dokumen hukum berhasil diambil.",{data:u,pagination:d.pagination});return a.status(200).json(c.toResponse())}catch(e){s.error(`| Legal Document CMS | - Error function index : ${e.message}`);const t=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new b(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=u(r,{allowPartial:!1,maxLen:void 0,fieldLabel:"title"});if(s.error){const e=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const l=u(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(l.error){const e=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",l.error.message);return a.status(422).json(e.toResponse())}if(!e.files||0===e.files.length){const e=new b(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File thumbnail wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>5){const e=new b(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 5 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["application/pdf"].includes(t.mimetype)){const e=new b(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh PDF.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new b(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}if(await t("cms_legal_documents").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(title->>'en') = lower(?)",[s.value.en])}).first()){const e=new b(422,"DUPLICATE_TITLE","Duplikat Data","Judul dokumen hukum (ID/EN) sudah digunakan. Silakan gunakan judul lain.");return a.status(422).json(e.toResponse())}const d=await _.uploadDocuments(e.files,e),m=d?.[0],p=Number(m);await t("cms_legal_documents").insert({document_ids:c([p]),title:{id:s.value.id,en:s.value.en},description:{id:l.value.id,en:l.value.en}}).returning("*"),await y.logCreate({userId:y.fromReq(e),module:"cms",subject:"List Dokumen Hukum"},t),await t.commit();const g=new b(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data dokumen hukum '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(g.toResponse())}catch(e){await t.rollback(),s.error(`| Legal Document CMS | - Error function store: ${e.message}`);const n=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_legal_documents").select("*").where("id",t).first();if(!e){const e=new b(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data dokumen hukum dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=d(e.title)?e.title:parseJsonSafe(e.title)||{},s=n.id||n.en||"Tanpa Nama",r=await f(e),o=new k(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data dokumen hukum '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){s.error(`| Legal Document CMS | - Error function show: ${e.message}`);const t=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{title:m,description:p,deleteDocumentIds:g}=e.body,w=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new b(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_legal_documents").where("id",w).first();if(!s){const e=new b(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data dokumen hukum dengan ID '${w}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const h=d(s.title)?s.title:parseJsonSafe(s.title)??{id:"",en:""},k=d(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""};let f=h;if(void 0!==m){const e=u(m,{allowPartial:!0,maxLen:void 0,fieldLabel:"title"});if(e.error){const t=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...h,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=h.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=h.en),!t.id||!t.en){const e=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Judul harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}f={id:String(t.id).trim(),en:String(t.en).trim()}}let R=k;if(void 0!==p){const e=u(p,{allowPartial:!0,maxLen:void 0,fieldLabel:"description"});if(e.error){const t=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...k,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=k.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=k.en),!t.id||!t.en){const e=new b(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}R={id:String(t.id).trim(),en:String(t.en).trim()}}if(((f.id??"").toLowerCase()!==(h.id??"").toLowerCase()||(f.en??"").toLowerCase()!==(h.en??"").toLowerCase())&&await t("cms_legal_documents").whereNull("deleted_at").whereNot("id",w).andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[f.id]).orWhereRaw("lower(title->>'en') = lower(?)",[f.en])}).first()){const e=new b(422,"DUPLICATE_TITLE","Duplikat Data","Judul dokumen hukum (ID/EN) sudah digunakan pada dokumen hukum lain.");return a.status(422).json(e.toResponse())}const E=r(g).map(String),D=["application/pdf"],T=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="document_ids",maxFilesAllowed:i=1,allowedTypes:s=["application/pdf"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe PDF."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:s,deleteDocumentIds:E,files:Array.isArray(e.files)?e.files:[],dbColumn:"document_ids",maxFilesAllowed:1,allowedTypes:D,sizeLimitBytes:52428800});if(!T.ok){const e=new b(T.http,T.code,T.title,T.desc);return a.status(T.http).json(e.toResponse())}const S=o(s.document_ids);let A=l(S,{as:"number"})[0]??null;null!=A&&E.includes(String(A))&&(await _.deleteDocuments([A]),A=null);let I=null;Array.isArray(e.files)&&e.files.length>0&&(I=await _.uploadDocuments(e.files,e));const N=I?.[0]??A??null,j=null!=N?[Number(N)]:[];await t("cms_legal_documents").where("id",w).update({document_ids:c(j),title:f,description:R,updated_at:t.fn.now()}),await y.logUpdate({userId:y.fromReq(e),module:"cms",subject:"List Dokumen Hukum"},t),await t.commit();const v=new b(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data dokumen hukum '${f.id}' berhasil diperbarui.`);return a.status(200).json(v.toResponse())}catch(e){await t.rollback(),s.error(`| Legal Document CMS | - Error function update : ${e.message}`);const n=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new b(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new b(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_legal_documents").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new b(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data dokumen hukum yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_legal_documents").whereIn("id",r).update({deleted_at:t.fn.now()}),await y.logDelete({userId:y.fromReq(e),module:"cms",subject:"List Dokumen Hukum"},t),await t.commit();const o=new b(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data dokumen hukum.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| Legal Document CMS | - Error function destroy : ${e.message}`);const n=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new b(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new b(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("cms_legal_documents").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new b(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data dokumen hukum terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=e=>{const a=d(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=r.map(e=>{const a=o(e.title);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let p=[];(c.length||m.length)&&(p=await t("cms_legal_documents").select("id","title").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(title->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(title->>'en')"),m):this.whereIn(i.raw("lower(title->>'en')"),m))}));const g=new Set;for(const e of p){const a=o(e.title);a.idLower&&g.add(`id:${a.idLower}`),a.enLower&&g.add(`en:${a.enLower}`)}const w=new Set,h=new Set,_=new Set;for(const e of u)e.idLower&&(w.has(e.idLower)?_.add(`id:${e.idLower}`):w.add(e.idLower)),e.enLower&&(h.has(e.enLower)?_.add(`en:${e.enLower}`):h.add(e.enLower));const k=[],f=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&g.has(a)||t&&g.has(t),i=a&&_.has(a)||t&&_.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?f.push({id:e.id,title:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),k.push(e))}let D=0;if(k.length>0){const e=k.map(e=>e.rowId);await t("cms_legal_documents").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await y.logRestore({userId:y.fromReq(e),module:"cms",subject:"List Dokumen Hukum"},t),await t.commit(),0===D){const e=new b(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];f.length&&T.push(`Terlewat ${f.length} karena bentrok/duplikat data.`);const S=new b(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| Legal Document CMS | - Error function restore: ${e.message}`);const t=new b(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},2470:(e,a,t)=>{const{body:n}=t(7975);a.updateShareReportValidator=[n("name").notEmpty().withMessage("Nama laporan tidak boleh kosong.").bail().isString().withMessage("Nama laporan harus berupa teks.").bail().isLength({max:255}).withMessage("Nama laporan maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi laporan tidak boleh kosong.").bail().isString().withMessage("Deskripsi laporan harus berupa teks.")]},2482:e=>{e.exports=function(e){return{id:e.id,uploadedBy:e.uploaded_by,verifiedBy:e.verified_by,fileId:e.file_id,fileName:e.file_name,filePath:e.file_path,fileUrl:e.file_url,fileMimeType:e.file_mime_type,fileSize:e.file_size,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},2525:e=>{"use strict";e.exports=require("helmet")},2534:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeSubmitAllAttemptValidator=[n("learningAttemptId").notEmpty().withMessage("Pembelajaran materi wajib dipilih.").bail().isInt().withMessage("Pembelajaran materi harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_learning_attempts").where("id",e).whereNull("deleted_at").first())throw new Error("Pembelajaran materi yang dipilih tidak ditemukan.");return!0})]},2553:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["A","B","C","D"]);a.updateQuizValidator=[n("topicId").notEmpty().withMessage("Topic kuis wajib dipilih.").bail().isInt().withMessage("Topic kuis harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_topics").where("id",e).whereNull("deleted_at").first())throw new Error("Topic kuis yang Anda pilih tidak ditemukan.");return!0}),n("question").trim().notEmpty().withMessage("Soal pertanyaan tidak boleh kosong.").bail().isString().withMessage("Soal pertanyaan harus berupa teks."),n("answerA").trim().notEmpty().withMessage("Jawaban pilihan A tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan A harus berupa teks."),n("answerB").trim().notEmpty().withMessage("Jawaban pilihan B tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan B harus berupa teks."),n("answerC").trim().notEmpty().withMessage("Jawaban pilihan C tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan C harus berupa teks."),n("answerD").trim().notEmpty().withMessage("Jawaban pilihan D tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan D harus berupa teks."),n("correctOption").trim().notEmpty().withMessage("Tipe konten tidak boleh kosong.").bail().isString().withMessage("Tipe konten harus berupa teks.").bail().isIn(s).withMessage(`Jawaban harus salah satu dari: ${s.join(", ")}.`),n("explanation").customSanitizer(e=>{if(null==e)return null;const a=String(e).trim();return""===a?null:a}).optional({nullable:!0}).isString().withMessage("Penjelasan jawaban dari pertanyaan harus berupa teks.")]},2668:(e,a,t)=>{const n=t(4930),{resolveArrayRelations:i}=t(7972),{normIdArray:s}=t(7872),r=t(2482),o=t(5278),l=t(3034),d=t(7724);e.exports=async function(e){const[a,t]=await Promise.all([e.attempt_by?n("users").where("id",e.attempt_by).first():null,e.kmis_topic_id?n("kmis_topics").where("id",e.kmis_topic_id).first():null]),u=await i(e.certificate_ids,"documents",r),c=s(e.completed_material_ids,{as:"number"}),m=await n("kmis_materials").whereIn("id",c).select("id","kmis_topic_id","materials_file_ids","materials_cover_ids","title","material_types","material_data","description").orderByRaw("array_position(?, id)",[c]),p=await Promise.all(m.map(e=>o(e)));return{id:e.id,attemptUser:a?await l(a):null,topic:t?await d(t):null,completedMaterial:p,attemptStatus:e.quiz_attempt_status,assessmentStatus:e.quiz_assessment_status,totalMaterial:e.total_material,learningStarted:e.learning_started,completedQuiz:e.completed_quiz,quizStarted:e.quiz_started,quizFinished:e.quiz_finished,quizDuration:e.quiz_duration,questionsAnswered:e.questions_answered,correctCount:e.correct_count,wrongCount:e.wrong_count,emptyCount:e.empty_count,scoreTotal:e.score_total,feedback:e.feedback,feedbackComment:e.feedback_comment,certificate:u,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},2732:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.updateNewsValidator=[n("categoryId").notEmpty().withMessage("Kategori berita wajib dipilih.").bail().isInt().withMessage("Kategori berita harus berupa angka.").bail().custom(async e=>{if(!await i("cms_news_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori berita yang Anda pilih tidak ditemukan.");return!0}),n("title").notEmpty().withMessage("Judul berita tidak boleh kosong."),n("slug").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("newsContent").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},2756:(e,a,t)=>{const{body:n}=t(7975);a.storeShareReportValidator=[n("name").notEmpty().withMessage("Nama laporan tidak boleh kosong.").bail().isString().withMessage("Nama laporan harus berupa teks.").bail().isLength({max:255}).withMessage("Nama laporan maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi laporan tidak boleh kosong.").bail().isString().withMessage("Deskripsi laporan harus berupa teks.")]},2878:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["Swakelola 1","Swakelola 2","Swakelola 3","Kontraktual"]),r=Object.freeze([0,1,2,3,4,5,6,7,8,9,10,11]);a.storeActivityPackageValidator=[n("picDivisionId").notEmpty().withMessage("Divisi PIC wajib dipilih.").bail().isInt().withMessage("Divisi PIC harus berupa angka.").bail().custom(async e=>{if(!await i("monev_pic_divisions").where("id",e).whereNull("deleted_at").first())throw new Error("Divisi PIC yang Anda pilih tidak ditemukan.");return!0}),n("contractType").trim().notEmpty().withMessage("Tipe kontrak tidak boleh kosong.").bail().isString().withMessage("Tipe kontrak harus berupa teks.").bail().isIn(s).withMessage(`Tipe kontrak harus salah satu dari: ${s.join(", ")}.`),n("mak").notEmpty().withMessage("MAK tidak boleh kosong.").bail().isString().withMessage("MAK harus berupa teks.").bail().isLength({max:50}).withMessage("MAK maksimal 50 karakter."),n("name").notEmpty().withMessage("Nama Paket tidak boleh kosong.").bail().isString().withMessage("Nama Paket harus berupa teks.").bail().isLength({max:255}).withMessage("Nama Paket maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks."),n("unitOutput").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks."),n("codeOutput").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks."),n("volume").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:50}).withMessage("Judul kategori maksimal 50 karakter."),n("pagu").notEmpty().withMessage("Jumlah Pagu tidak boleh kosong.").bail().isInt().withMessage("Jumlah Pagu harus berupa angka."),n("partner").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:150}).withMessage("Judul kategori maksimal 150 karakter."),n("startedMonth").toInt().notEmpty().withMessage("Bulan mulai tidak boleh kosong.").bail().isInt().withMessage("Bulan mulai harus berupa angka.").bail().isIn(r).withMessage(`Bulan mulai harus salah satu dari: ${r.join(", ")}.`),n("finishedMonth").toInt().notEmpty().withMessage("Bulan selesai tidak boleh kosong.").bail().isInt().withMessage("Bulan selesai harus berupa angka.").bail().isIn(r).withMessage(`Bulan selesai harus salah satu dari: ${r.join(", ")}.`),n("startedYear").toInt().notEmpty().withMessage("Tahun mulai tidak boleh kosong.").bail().isInt({min:1900,max:2100}).withMessage("Tahun mulai tidak valid (1900 s.d 2100)."),n("finishedYear").toInt().notEmpty().withMessage("Tahun selesai tidak boleh kosong.").bail().isInt({min:1900,max:2100}).withMessage("Tahun selesai tidak valid (1900 s.d 2100)."),n(["startedMonth","startedYear","finishedMonth","finishedYear"]).custom((e,{req:a})=>{const t=Number(a.body.startedMonth),n=Number(a.body.startedYear),i=Number(a.body.finishedMonth),s=Number(a.body.finishedYear);if(Number.isNaN(t)||Number.isNaN(n)||Number.isNaN(i)||Number.isNaN(s))throw new Error("Nilai bulan/tahun tidak valid.");if(s<n||s===n&&i<t)throw new Error("finished (bulan/tahun) tidak boleh lebih kecil dari started (bulan/tahun).");return!0})]},2972:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=t(1784),r=t(6293),o=t(3824),l=t(5789);r.extend(o),r.extend(l);const d=/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,u=/^([01]\d|2[0-3])\.([0-5]\d)\.([0-5]\d)$/;function c(e){const a=String(e||"").trim();if(d.test(a))return a;const t=a.match(u);if(t){const[,e,a,n]=t;return`${e}:${a}:${n}`}return a}a.updateActivityCalendarValidator=[n("activityCategoryId").notEmpty().withMessage("Kategori aktivitas wajib dipilih.").bail().isInt().withMessage("Kategori aktivitas harus berupa angka.").bail().custom(async e=>{if(!await i("monev_activity_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori aktivitas yang Anda pilih tidak ditemukan.");return!0}),n("name").notEmpty().withMessage("Nama kegiatan tidak boleh kosong.").bail().isString().withMessage("Nama kegiatan harus berupa teks.").bail().isLength({max:255}).withMessage("Nama kegiatan maksimal 255 karakter."),n("description").optional({nullable:!0,checkFalsy:!0}).isString().withMessage("Deskripsi harus berupa teks."),n("location").notEmpty().withMessage("Lokasi tidak boleh kosong.").bail().isString().withMessage("Lokasi harus berupa teks.").bail().isLength({max:200}).withMessage("Lokasi maksimal 200 karakter."),n("startedDate").notEmpty().withMessage("Tanggal mulai wajib diisi (ISO 8601 dengan Z/offset), contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.").bail().custom(e=>{if(!s.isIso8601Z(e))throw new Error("Tanggal mulai harus ISO 8601 dengan Z/offset, contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.");if(!s.toUTC(e))throw new Error("Tanggal mulai tidak valid.");return!0}),n("finishedDate").notEmpty().withMessage("Tanggal selesai wajib diisi (ISO 8601 dengan Z/offset), contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.").bail().custom(e=>{if(!s.isIso8601Z(e))throw new Error("Tanggal selesai harus ISO 8601 dengan Z/offset, contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.");if(!s.toUTC(e))throw new Error("Tanggal selesai tidak valid.");return!0}),n("startedTime").notEmpty().withMessage("Jam mulai wajib diisi (format HH:mm:ss).").bail().custom(e=>{const a=String(e||"").trim();return d.test(a)||u.test(a)}).withMessage("Format jam mulai tidak valid. Gunakan HH:mm:ss (24 jam).").bail().customSanitizer(e=>c(e)),n("finishedTime").notEmpty().withMessage("Jam selesai wajib diisi (format HH:mm:ss atau HH.mm.ss).").bail().custom(e=>{const a=String(e||"").trim();return d.test(a)||u.test(a)}).withMessage("Format jam selesai tidak valid. Gunakan HH:mm:ss atau HH.mm.ss (24 jam).").bail().customSanitizer(e=>c(e))]},3016:(e,a,t)=>{const n=t(7252).Router(),i=t(6285),{storeEventsCategoryValidator:s}=t(6279),{updateEventsCategoryValidator:r}=t(5423),o=t(2110),l=t(9022),d=t(6967),u=(t(7443),t(5794)),c=t(8461)();n.use(d,l),n.get("/index",u(["view.master_data"]),i.index),n.get("/show/:id",u(["view.master_data"]),i.show),n.post("/create",u(["create.master_data"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.master_data"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.master_data"]),i.destroy),n.patch("/restore",u(["restore.master_data"]),i.restore),e.exports=n},3034:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(7857),s=t(4930),r=t(2482);e.exports=async function(e){const a=e.role_id?await s("roles").where("id",e.role_id).first():null,t=await n(e.photo_profile_ids,"documents",r);return{id:e.id,role:a?await i(a):null,photoProfile:t,name:e.name,email:e.email,phoneNumber:e.phone_number,profession:e.profession,gender:e.gender,birthDate:e.birth_date,address:e.address,accountStatus:e.account_status,registerAt:e.register_at,deactiveAt:e.deactivate_at,lastLogin:e.last_login,lastChangePassword:e.last_change_password,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},3123:(e,a,t)=>{const{body:n}=t(7975);a.sendOTPValidator=[n("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.")]},3210:(e,a,t)=>{const{toDatabaseUTC:n}=t(1784);function i(e){if(Array.isArray(e)){for(const a of e){const e=null==a?"":String(a).trim();if(e)return e}return null}if("string"==typeof e){let a=e.trim();if(!a)return null;if(a.startsWith("[")&&a.endsWith("]")){if(a=a.slice(1,-1).trim(),!a)return null;const e=a.split(",")[0]?.trim().replace(/^['"]|['"]$/g,"");return e||null}return a}return(null==e?"":String(e).trim())||null}function s(e,a){const t=i(e),s=i(a);if(t&&!s||!t&&s)return{ok:!1,code:"DATE_RANGE_PARTIAL",title:"Rentang Tanggal Tidak Lengkap",desc:"start_date dan end_date harus dikirim bersamaan."};if(!t&&!s)return{ok:!0,startDb:null,endDb:null,hasRange:!1};const r=n(t),o=n(s);return r?o?r>o?{ok:!1,code:"INVALID_DATE_RANGE",title:"Rentang Tanggal Tidak Logis",desc:"start_date tidak boleh lebih besar dari end_date."}:{ok:!0,startDb:r,endDb:o,hasRange:!0}:{ok:!1,code:"INVALID_DATE_FORMAT",title:"Format Tanggal Salah",desc:"end_date tidak valid. Gunakan ISO 8601, mis. 2025-09-28T05:29:12.712Z."}:{ok:!1,code:"INVALID_DATE_FORMAT",title:"Format Tanggal Salah",desc:"start_date tidak valid. Gunakan ISO 8601, mis. 2025-09-28T05:29:12.712Z."}}e.exports={validateDateRangeRequiredBoth:s,applyStartEndDateFilter:function(e,a,t,n,i={}){const{inclusiveEnd:r=!0}=i,o=s(t,n);return o.ok?(o.hasRange&&(e.andWhere(a,">=",o.startDb),e.andWhere(a,r?"<=":"<",o.endDb)),e):e},applyRelationIn:function(e,a,t,n={}){const{as:i="number",negate:s=!1,allowEmpty:r=!1}=n;let o;if(Array.isArray(t))o=t;else if("string"==typeof t){let e=t.trim();if(e)if(e.startsWith("[")&&e.endsWith("]"))try{const a=JSON.parse(e);o=Array.isArray(a)?a:[a]}catch{o=e.slice(1,-1).split(",").map(e=>e.trim().replace(/^['"]|['"]$/g,"")).filter(Boolean)}else o=e.split(",").map(e=>e.trim()).filter(Boolean);else o=[]}else o=null==t?[]:[t];let l="number"===i?o.map(e=>Number(String(e).trim())).filter(e=>Number.isFinite(e)):o.map(e=>String(e).trim()).filter(e=>e.length>0);return l=[...new Set(l)],0===l.length?(r&&e.whereRaw("1=0"),e):s?e.whereNotIn(a,l):e.whereIn(a,l)},applySearch:function(e,a,t){return a&&0!==t.length?(e.where(function(){t.forEach(e=>{this.orWhere(e,"ilike",`%${a}%`)})}),e):e},applyJsonbSearch:function(e,a,t,n={}){const{mode:i="or",split:s=!1}=n;if(!a||!Array.isArray(t)||0===t.length)return e;const r=s?String(a).trim().split(/\s+/).filter(Boolean):[String(a).trim()];return 0===r.length||e.andWhere(function(){r.forEach((e,a)=>{const n=`%${s=e,String(s).replace(/[\\%_]/g,"\\$&")}%`;var s;const r=e=>{t.forEach((a,t)=>{const i=`(${a}) ILIKE ? ESCAPE '\\'`;0===t?e.whereRaw(i,[n]):e.orWhereRaw(i,[n])})};0===a?this.where(function(){r(this)}):"and"===i?this.andWhere(function(){r(this)}):this.orWhere(function(){r(this)})})}),e},applyPagination:function(e={}){const a=Object.prototype.hasOwnProperty.call(e,"limit"),t=a?e.limit:void 0,n=e.page;if(!a||void 0===t||""===t||"all"===String(t).toLowerCase()||0===Number(t))return{page:1,limit:null,offset:0,unlimited:!0};const i=Math.max(parseInt(n,10)||1,1),s=Math.max(parseInt(t,10)||10,1);return{page:i,limit:s,offset:(i-1)*s,unlimited:!1}},formatPaginationResult:async function(e,a,t){const{page:n,limit:i,offset:s,unlimited:r}=a,o=e.clone();r||o.limit(i).offset(s);const l=await o,d=e.clone().clearSelect().clearOrder(),[{count:u}]=await t.count("*").from(d.as("subquery")),c=parseInt(u,10)||0;if(r)return{data:l,pagination:{meta:{current_page:1,last_page:1,per_page:null,total:c},links:{first:null,last:null,prev:null,next:null}}};const m=0===c?1:Math.ceil(c/i);return{data:l,pagination:{meta:{current_page:n,last_page:m,per_page:i,total:c},links:{first:`?page=1&limit=${i}`,last:`?page=${m}&limit=${i}`,prev:n>1?`?page=${n-1}&limit=${i}`:null,next:n<m?`?page=${n+1}&limit=${i}`:null}}}}}},3306:(e,a,t)=>{const n=t(4930),i=t(3034);e.exports=async function(e){const a=await n("users").where("id",e.id).first();let t="number"==typeof e.total_material?e.total_material:null;if(null==t){const e=await n("kmis_materials as m").whereNull("m.deleted_at").andWhere(function(){this.where("m.uploaded_by",a.id).orWhere("m.created_by",a.id)}).count({c:"*"}).first();t=Number(e?.c??0)}return{id:a.id,user:a?await i(a):null,totalMaterial:t,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},3318:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["A","B","C","D"]);a.storeQuizAttemptValidator=[n("learningAttemptId").notEmpty().withMessage("Pembelajaran materi wajib dipilih.").bail().isInt().withMessage("Pembelajaran materi harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_learning_attempts").where("id",e).whereNull("deleted_at").first())throw new Error("Pembelajaran materi yang dipilih tidak ditemukan.");return!0}),n("quizId").notEmpty().withMessage("Kuis wajib dipilih.").bail().isInt().withMessage("Kuis harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_quiz").where("id",e).whereNull("deleted_at").first())throw new Error("Kuis yang Anda pilih tidak ditemukan.");return!0}),n("selectedOption").optional({nullable:!0,checkFalsy:!0}).bail().isString().withMessage("Jawaban harus berupa teks.").bail().customSanitizer(e=>String(e).trim().toUpperCase()).isIn(s).withMessage(`Jawaban harus salah satu dari: ${s.join(", ")}.`),n("isMarker").optional().isBoolean().withMessage("Penanda soal harus berupa boolean.").toBoolean()]},3345:(e,a,t)=>{const n=t(4930),i=t(5206);e.exports=async function(e){const a=e.kmis_quiz_id?await n("kmis_quiz").where("id",e.kmis_quiz_id).first():null;return{id:e?.id??null,quiz:a?await i(a):null,selectedOption:e?.selected_option??null,isMarker:e?.is_marker??null,isCorrect:e?.is_correct??null,answeredAt:e?.answered_at??null,createdAt:e?.created_at??null,updatedAt:e?.updated_at??null,deletedAt:e?.deleted_at??null}}},3623:(e,a,t)=>{const n=t(4835).createClient({socket:{host:"localhost",port:6379}});(async()=>{try{await n.connect(),console.log(" Redis client connected successfully.")}catch(e){console.error(" Redis connection error:",e)}})(),n.on("error",e=>{console.error("Redis Error:",e)}),e.exports=n},3694:(e,a,t)=>{const n=t(4930),i=t(3034);e.exports=async function({userRow:e,isPic:a}){const t=e?.id?e:await n("users").where("id",e.id).first();return{id:t.id,user:t?await i(t):null,createdAt:t.created_at,updatedAt:t.updated_at,deletedAt:t.deleted_at}}},3809:(e,a,t)=>{const n=t(7252).Router(),i=t(4686),{storeMonevUserValidator:s}=t(6397),r=t(2110),o=t(9022),l=t(6967),d=t(5794),u=t(8461)();n.use(l,o),n.get("/sso",d(["view.monev_user"]),i.getAllUserSso),n.get("/index",d(["view.monev_user"]),i.index),n.get("/show/:id",d(["view.monev_user"]),i.show),n.post("/create",d(["create.monev_user"]),u.none(),s,r,i.store),n.patch("/deactivate",d(["edit.monev_user"]),i.deactivateAccount),n.patch("/activate",d(["edit.monev_user"]),i.activateAccount),e.exports=n},3821:(e,a,t)=>{const{body:n}=t(7975);a.storeNewsCategoryValidator=[n("name").custom(e=>{if(void 0===e)throw new Error("Nama kategori berita wajib diisi.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi kategori berita wajib diisi.");return!0})]},3824:e=>{"use strict";e.exports=require("dayjs/plugin/utc")},3943:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{normIdArray:r}=t(7872),{applySearch:o,applyPagination:l,formatPaginationResult:d}=t(3210),u=t(1332),c=t(6870),m=t(7807),p=t(6479),{applyTrashedScope:g}=t(7438),{applyLatestThenTrashed:w}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("kmis_categories as category").select("category.*");g(n,e,"category.deleted_at"),o(n,t,["category.title"]),w(n,"category.deleted_at","category.created_at","category.id");const s=l(e.query),r=await d(n,s,i);if(0===r.data.length){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const p=await Promise.all(r.data.map(e=>m(e))),h=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori berhasil diambil.",{data:p,pagination:r.pagination});return a.status(200).json(h.toResponse())}catch(e){s.error(`| Category KMIS | - Error function index : ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("kmis_categories").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").first()){const e=new c(422,"DUPLICATE_TITLE","Duplikat Data",`Judul kategori '${r}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}await t("kmis_categories").insert({title:r,description:o}).returning("*"),await p.logCreate({userId:p.fromReq(e),module:"kmis",subject:"List Kategori"},t),await t.commit();const s=new c(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kategori '${r}' berhasil ditambahkan.`);return a.status(201).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| Category KMIS | - Error function store: ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("kmis_categories").select("*").where("id",t).first();if(!e){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await m(e),s=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori '${e.title}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Category KMIS | - Error function show: ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body,l=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(!await t("kmis_categories").where("id",l).first()){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori dengan ID '${l}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("kmis_categories").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").whereNot("id",l).first()){const e=new c(422,"DUPLICATE_TITLE","Duplikat Data",`Judul '${r}' sudah digunakan pada kategori lain.`);return a.status(422).json(e.toResponse())}await t("kmis_categories").where("id",l).update({title:r,description:o,updated_at:t.fn.now()}),await p.logUpdate({userId:p.fromReq(e),module:"kmis",subject:"List Kategori"},t),await t.commit();const s=new c(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kategori '${r}' berhasil diperbarui.`);return a.status(200).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| Category KMIS | - Error function update : ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=r(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new c(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new c(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("kmis_categories").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=s.map(e=>e.id);await t("kmis_categories").whereIn("id",o).update({deleted_at:t.fn.now()}),await p.logDelete({userId:p.fromReq(e),module:"kmis",subject:"List Kategori"},t),await t.commit();const l=new c(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${o.length} data kategori.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| Category KMIS | - Error function destroy : ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=r(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new c(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new c(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const o=await t("kmis_categories").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===o.length){await t.rollback();const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=o.map(e=>e.title?.toLowerCase?.()??""),d=await t("kmis_categories").select(i.raw("lower(title) AS ltitle")).whereNull("deleted_at").whereIn(i.raw("lower(title)"),l),u=new Set(d.map(e=>e.ltitle)),m=new Set,g=new Set;for(const e of o){const a=(e.title||"").toLowerCase();m.has(a)?g.add(a):m.add(a)}const w=[],h=[],_=new Set;for(const e of o){const a=(e.title||"").toLowerCase(),t=u.has(a),n=g.has(a);t||n||_.has(a)?h.push({id:e.id,title:e.title}):(_.add(a),w.push(e))}let k=0;if(w.length>0){const e=w.map(e=>e.id);await t("kmis_categories").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),k=e.length}if(await p.logRestore({userId:p.fromReq(e),module:"kmis",subject:"List Kategori"},t),await t.commit(),0===k){const e=new c(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const b=[`Berhasil mengembalikan ${k} data yang terhapus.`];h.length&&b.push(`Terlewat ${h.length} karena bentrok/duplikat data.`);const f=new c(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",b.join(" "));return a.status(200).json(f.toResponse())}catch(e){s.error(`| Category KMIS | - Error function restore: ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},3955:(e,a,t)=>{const n=t(7252).Router(),i=t(1766),{storePicDivisionValidator:s}=t(5211),{updatePicDivisionValidator:r}=t(4083),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.master_data"]),i.index),n.get("/show/:id",u(["view.master_data"]),i.show),n.post("/create",u(["create.master_data"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.master_data"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.master_data"]),i.destroy),n.patch("/restore",u(["restore.master_data"]),i.restore),n.patch("/assign/:id",u(["edit.master_data"]),c.none(),i.assignPic),e.exports=n},3997:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeMaterialValidator=[n("materialType").notEmpty().withMessage("Tipe materi wajib diisi.").bail().isString().withMessage("Tipe materi harus berupa teks.").bail().customSanitizer(e=>{const a=String(e||"").trim().toLowerCase();return"teks"===a?"text":a}).isIn(["text","gambar","video","dokumen"]).withMessage("Tipe materi hanya boleh berisikan text, gambar, video, atau dokumen."),n("title").notEmpty().withMessage("Judul materi wajib diisi.").bail().isString().withMessage("Judul materi harus berupa teks.").bail().isLength({max:180}).withMessage("Judul materi maksimal 180 karakter."),n("description").notEmpty().withMessage("Deskripsi materi wajib diisi.").bail().isString().withMessage("Deskripsi materi harus berupa teks."),n("topicId").notEmpty().withMessage("Topik materi wajib dipilih untuk tipe gambar/dokumen.").bail().isInt({gt:0}).withMessage("Topik materi harus berupa angka.").bail().custom(async(e,{req:a})=>{if(!await i("kmis_topics").where("id",e).whereNull("deleted_at").first())throw new Error("Topik materi yang Anda pilih tidak ditemukan atau sudah dihapus.")}),n("materialUrl").if(n("materialType").equals("video")).notEmpty().withMessage("materialUrl wajib diisi untuk tipe video.").bail().isString().withMessage("materialUrl harus berupa teks."),n("materialUrl").if(n("materialType").not().equals("video")).optional({nullable:!0,checkFalsy:!0}).isString().withMessage("materialUrl harus berupa teks.").bail().trim()]},4083:(e,a,t)=>{const{body:n}=t(7975);a.updatePicDivisionValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},4219:(e,a,t)=>{const n=t(7252).Router(),i=t(9022),s=t(6967),r=t(5233);n.get("/get-all-role",s,r.getAllRole),n.get("/get-all-user",s,r.getAllUser),n.get("/get-all-user-educator-admin",s,i,r.getAllUserEducatorWithAuth),n.get("/get-all-user-student",s,r.getAllUserStudent),n.get("/get-user-by-role/:id",s,r.getAllUserbyRoleId),n.get("/get-user/:id",s,r.getUserbyId),e.exports=n},4289:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l,isPlainObject:d,handleLocalizedText:u}=t(7872),{asJsonb:c}=t(6192),{applyRelationIn:m,applyJsonbSearch:p,applyPagination:g,formatPaginationResult:w}=t(3210),h=t(1701),_=t(1332),k=t(6870),b=t(8669),f=t(6479),{applyTrashedScope:y}=t(7438),{applyLatestThenTrashed:R}=t(7540);a.index=async(e,a)=>{const{search:t,newsCategoryId:n}=e.query,r=n??e.query["newsCategoryId[]"];try{let n=i("cms_news as news").select("news.*");y(n,e,"news.deleted_at"),m(n,"news.cms_news_category_id",r,{as:"number"}),p(n,t,["news.title->>'id'","news.title->>'en'"],{mode:"or",split:!0}),R(n,"news.deleted_at","news.created_at","news.id");const s=g(e.query),o=await w(n,s,i);if(0===o.data.length){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>b(e))),d=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data berita berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){s.error(`| News CMS | - Error function index : ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{categoryId:r,title:o,slug:l,description:d,newsContent:m}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=u(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"title"});if(s.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const p=u(l,{allowPartial:!1,maxLen:void 0,fieldLabel:"slug"});if(p.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",p.error.message);return a.status(422).json(e.toResponse())}const g=u(d,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(g.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",g.error.message);return a.status(422).json(e.toResponse())}const w=u(m,{allowPartial:!1,maxLen:void 0,fieldLabel:"newsContent"});if(w.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",w.error.message);return a.status(422).json(e.toResponse())}if(!e.files||0===e.files.length){const e=new k(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File thumbnail wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>1){const e=new k(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(t.mimetype)){const e=new k(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh JPG, JPEG, PNG, dan WebP.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new k(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}if(await t("cms_news").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(title->>'en') = lower(?)",[s.value.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Judul berita (ID/EN) sudah digunakan. Silakan gunakan judul lain.");return a.status(422).json(e.toResponse())}const _=await h.uploadDocuments(e.files,e),b=_?.[0],y=Number(b);await t("cms_news").insert({cms_news_category_id:r,thumbnail_ids:c([y]),title:{id:s.value.id,en:s.value.en},slug:{id:p.value.id,en:p.value.en},description:{id:g.value.id,en:g.value.en},news_content:{id:w.value.id,en:w.value.en}}).returning("*"),await f.logCreate({userId:f.fromReq(e),module:"cms",subject:"List Berita"},t),await t.commit();const R=new k(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data berita '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(R.toResponse())}catch(e){await t.rollback(),s.error(`| News CMS | - Error function store: ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_news").select("*").where("id",t).first();if(!e){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data berita dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=d(e.title)?e.title:parseJsonSafe(e.title)||{},s=n.id||n.en||"Tanpa Nama",r=await b(e),o=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data berita '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){s.error(`| News CMS | - Error function show: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{categoryId:m,title:p,slug:g,description:w,newsContent:_,deleteDocumentIds:b}=e.body,y=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_news").where("id",y).first();if(!s){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data berita dengan ID '${y}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const R=d(s.title)?s.title:parseJsonSafe(s.title)??{id:"",en:""},E=d(s.slug)?s.slug:parseJsonSafe(s.slug)??{id:"",en:""},D=d(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""},T=d(s.news_content)?s.news_content:parseJsonSafe(s.news_content)??{id:"",en:""};let S=R;if(void 0!==p){const e=u(p,{allowPartial:!0,maxLen:void 0,fieldLabel:"title"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...R,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=R.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=R.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Judul harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}S={id:String(t.id).trim(),en:String(t.en).trim()}}let A=E;if(void 0!==g){const e=u(g,{allowPartial:!0,maxLen:void 0,fieldLabel:"slug"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...E,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=E.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=E.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Slug harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}A={id:String(t.id).trim(),en:String(t.en).trim()}}let I=D;if(void 0!==w){const e=u(w,{allowPartial:!0,maxLen:void 0,fieldLabel:"description"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...D,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=D.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=D.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}I={id:String(t.id).trim(),en:String(t.en).trim()}}let N=T;if(void 0!==_){const e=u(_,{allowPartial:!0,maxLen:void 0,fieldLabel:"newsContent"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...T,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=T.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=T.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Konten acara harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}N={id:String(t.id).trim(),en:String(t.en).trim()}}if(((S.id??"").toLowerCase()!==(R.id??"").toLowerCase()||(S.en??"").toLowerCase()!==(R.en??"").toLowerCase())&&await t("cms_news").whereNull("deleted_at").whereNot("id",y).andWhere(function(){this.whereRaw("lower(title->>'id') = lower(?)",[S.id]).orWhereRaw("lower(title->>'en') = lower(?)",[S.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Judul berita (ID/EN) sudah digunakan pada berita lain.");return a.status(422).json(e.toResponse())}const j=r(b).map(String),v=["image/jpeg","image/jpg","image/png","image/webp"],O=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="thumbnail_ids",maxFilesAllowed:i=1,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, dan WebP."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:s,deleteDocumentIds:j,files:Array.isArray(e.files)?e.files:[],dbColumn:"thumbnail_ids",maxFilesAllowed:1,allowedTypes:v,sizeLimitBytes:52428800});if(!O.ok){const e=new k(O.http,O.code,O.title,O.desc);return a.status(O.http).json(e.toResponse())}const L=o(s.thumbnail_ids);let M=l(L,{as:"number"})[0]??null;null!=M&&j.includes(String(M))&&(await h.deleteDocuments([M]),M=null);let C=null;Array.isArray(e.files)&&e.files.length>0&&(C=await h.uploadDocuments(e.files,e));const F=C?.[0]??M??null,P=null!=F?[Number(F)]:[];await t("cms_news").where("id",y).update({cms_news_category_id:m,thumbnail_ids:c(P),title:S,slug:A,description:I,news_content:N,updated_at:t.fn.now()}),await f.logUpdate({userId:f.fromReq(e),module:"cms",subject:"List Berita"},t),await t.commit();const $=new k(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data berita '${S.id}' berhasil diperbarui.`);return a.status(200).json($.toResponse())}catch(e){await t.rollback(),s.error(`| News CMS | - Error function update : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_news").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data berita yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_news").whereIn("id",r).update({deleted_at:t.fn.now()}),await f.logDelete({userId:f.fromReq(e),module:"cms",subject:"List Berita"},t),await t.commit();const o=new k(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data berita.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| News CMS | - Error function destroy : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("cms_news").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data berita terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=e=>{const a=d(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=r.map(e=>{const a=o(e.title);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let p=[];(c.length||m.length)&&(p=await t("cms_news").select("id","title").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(title->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(title->>'en')"),m):this.whereIn(i.raw("lower(title->>'en')"),m))}));const g=new Set;for(const e of p){const a=o(e.title);a.idLower&&g.add(`id:${a.idLower}`),a.enLower&&g.add(`en:${a.enLower}`)}const w=new Set,h=new Set,_=new Set;for(const e of u)e.idLower&&(w.has(e.idLower)?_.add(`id:${e.idLower}`):w.add(e.idLower)),e.enLower&&(h.has(e.enLower)?_.add(`en:${e.enLower}`):h.add(e.enLower));const b=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&g.has(a)||t&&g.has(t),i=a&&_.has(a)||t&&_.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,title:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),b.push(e))}let D=0;if(b.length>0){const e=b.map(e=>e.rowId);await t("cms_news").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await f.logRestore({userId:f.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit(),0===D){const e=new k(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new k(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| News CMS | - Error function restore: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},4388:(e,a,t)=>{const n=t(3034);e.exports=async function(e,a=null){return{id:e.id,user:a?await n(a):null,module:e.module,key:e.key,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},4456:(e,a,t)=>{const{URL:n}=t(7016);function i(){return String(process.env.PG_ENV||"windows").trim().toLowerCase()}function s(){return"linux"===i()}function r(e,a){const t=Number(e);return Number.isFinite(t)?t:a}e.exports={getAppEnv:i,isLinux:s,resolvePublicBaseUrl:function(e,a={}){const t="docs"===e?"DOC_SERVER_BASE_URL":"PUBLIC_BASE_URL",i=function(e){const a=String(e||"").trim();if(!a)return null;const t=new n(a);return`${t.protocol}//${t.host}`}(process.env[t]);if(i)return i;const o=r(a.app,4e3),l=r(a.docs,4001);return s()?"docs"===e?"https://doc.rimbaexium.org":"https://rimbaexium.org":"docs"===e?`http://localhost:${l}`:`http://localhost:${o}`}}},4525:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{normJsonbArray:r,normIdArray:o,parseJsonSafe:l,isPlainObject:d}=t(7872),{asJsonb:u}=t(6192),c=t(1701),m=t(6870),p=t(6479),g=["image/jpeg","image/jpg","image/png","image/webp","image/svg+xml"],w=["video/mp4","video/mpeg","video/quicktime","video/x-matroska","video/x-msvideo"],h=["audio/mpeg","audio/mp3","audio/wav","audio/aac","audio/ogg"],_=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain","application/zip","application/x-zip-compressed"];function k(e){return Array.isArray(e.files)?e.files:e.files?.files&&Array.isArray(e.files.files)?e.files.files:e.file?[e.file]:[]}function b(e){return null==e||"string"==typeof e&&""===e.trim()}function f(e,a,t,n,i=422){const s=new m(i,a,t,n);return e.status(i).json(s.toResponse())}function y(e,a){const t=(e,a,t)=>new m(422,e,a,t),n=()=>0===a.length?t("FILES_NOT_FOUND","File Tidak Ditemukan","Wajib unggah 1 file."):a.length>1?t("MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file."):null;if("Image"===e){const e=n();if(e)return e;const i=a[0];return g.includes(i.mimetype)?i.size>52428800?t("FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap gambar adalah 50mB."):null:t("INVALID_FILE_TYPE","Tipe File Salah","File hanya diperbolehkan menggunakan format JPG, JPEG, PNG, SVG, atau WebP.")}if("Video"===e){const e=n();if(e)return e;const i=a[0];return w.includes(i.mimetype)?i.size>419430400?t("FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap video adalah 400MB."):null:t("INVALID_FILE_TYPE","Tipe File Salah","Video hanya diperbolehkan menggunakan format MP4/MPEG/MOV/MKV/AVI.")}if("Audio"===e){const e=n();if(e)return e;const i=a[0];return h.includes(i.mimetype)?i.size>419430400?t("FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap audio adalah 400MB."):null:t("INVALID_FILE_TYPE","Tipe File Salah","Audio hanya diperbolehkan menggunakan format MP3/WAV/AAC/OGG.")}if("File"===e){const e=n();if(e)return e;const i=a[0];return _.includes(i.mimetype)?i.size>52428800?t("FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal file adalah 50MB."):null:t("INVALID_FILE_TYPE","Tipe File Salah","File hanya diperbolehkan menggunakan format PDF/DOCX/XLSX/PPTX/TXT/ZIP.")}if("ImageArray"===e){if(0===a.length)return t("FILES_NOT_FOUND","File Tidak Ditemukan","Wajib unggah minimal 1 gambar.");if(a.length>20)return t("MAX_FILES","Terlalu Banyak File","Maksimal 20 gambar.");for(const e of a){if(!g.includes(e.mimetype))return t("INVALID_FILE_TYPE","Tipe File Salah","Semua gambar harus JPG, JPEG, atau PNG.");if(e.size>52428800)return t("FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap gambar adalah 50mB.")}return null}return null}function R(e){const a=function(e){try{const a=new URL(String(e));return/^https?:$/i.test(a.protocol)?String(e).trim():null}catch{return null}}(e);return a?{contentFileIds:null,contentValue:a}:{error:new m(422,"INVALID_LINK","URL Tidak Valid","Nilai content untuk tipe Link harus URL valid (http/https).")}}function E(e){let a=e;return"string"==typeof a&&(a=l(a)??a),d(a)&&"string"==typeof a.id&&"string"==typeof a.en?{contentFileIds:null,contentValue:JSON.stringify({id:a.id,en:a.en})}:{error:new m(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Untuk tipe Text/TextArray, content harus objek dengan properti id dan en bertipe string.")}}function D(e){let a=e;if("string"==typeof a&&(a=l(a)??a),!Array.isArray(a))return{error:new m(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Untuk tipe TextArray, content harus array of object dengan properti id dan en bertipe string.")};const t=a.map(e=>{if(!d(e))return null;const{id:a,en:t}=e;return"string"!=typeof a||"string"!=typeof t?null:{id:a,en:t}}).filter(Boolean);return t.length!==a.length||0===t.length?{error:new m(422,"INVALID_CONTENT_ITEMS","Elemen Konten Tidak Valid","Setiap elemen harus objek dengan id dan en (string), dan minimal satu elemen valid.")}:{contentFileIds:null,contentValue:JSON.stringify(t)}}a.store=async(e,a)=>{const t=await i.transaction(),{type:r}=e.body;let{content:o,order:l}=e.body;try{const s=n(e);if(!s.isEmpty())return f(a,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",s.array().map(e=>e.msg).join(" "));const d=k(e),g=y(r,d);if(g)return a.status(422).json(g.toResponse());let w=null,h=null;if(["Image","Video","Audio","File"].includes(r)){const a=await async function(e,a,t){const n=(await c.uploadDocuments(a,t)||[]).map(Number).filter(Boolean);if(0===n.length)throw new Error("UPLOAD_FAILED::Tidak ada file yang berhasil diunggah.");const s=await i("documents").select("id","file_url").whereIn("id",n);if(!s.length||!s[0]?.file_url)throw new Error("FILE_URL_NOT_FOUND::Gagal mendapatkan URL publik file dari storage.");return{contentFileIds:u(n),contentValue:String(s[0].file_url)}}(0,d,e);w=a.contentFileIds,h=a.contentValue}else if("ImageArray"===r){const a=await async function(e,a){const t=(await c.uploadDocuments(e,a)||[]).map(Number).filter(Boolean);if(0===t.length)throw new Error("UPLOAD_FAILED::Tidak ada file yang berhasil diunggah.");const n=(await i("documents").select("id","file_url").whereIn("id",t).orderBy("id","asc")).map(e=>String(e.file_url)).filter(Boolean);if(0===n.length)throw new Error("FILE_URL_NOT_FOUND::Gagal mendapatkan URL publik file dari storage.");return{contentFileIds:u(t),contentValue:JSON.stringify(n)}}(d,e);w=a.contentFileIds,h=a.contentValue}else if("Link"===r){const e=R(o);if(e.error)return a.status(422).json(e.error.toResponse());w=e.contentFileIds,h=e.contentValue}else if("Text"===r){const e=E(o);if(e.error)return a.status(422).json(e.error.toResponse());w=e.contentFileIds,h=e.contentValue}else{if("TextArray"!==r)return f(a,"UNSUPPORTED_TYPE","Tipe Tidak Didukung","Tipe konten tidak dikenali.");{const e=D(o);if(e.error)return a.status(422).json(e.error.toResponse());w=e.contentFileIds,h=e.contentValue}}const _={content_file_ids:w,type:r,content:h};b(l)||(_.order=Number(l));const[T]=await t("cms_contents").insert(_).returning("*");let S=T.order;b(l)&&(await t("cms_contents").update({order:T.id}).where({id:T.id}),S=T.id),await p.logCreate({userId:p.fromReq(e),module:"cms",subject:"List Konten"},t),await t.commit();const A=new m(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data konten dengan order '${S}' berhasil ditambahkan.`);return a.status(201).json(A.toResponse())}catch(e){if(await t.rollback(),"string"==typeof e.message&&e.message.includes("::")){const[t,n]=e.message.split("::");return s.error(`| CMS Content | - ${t}: ${n}`),f(a,t,"Gagal Memproses Berkas",n)}s.error(`| Event CMS | - Error function store: ${e.message}`);const n=new m(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{type:l,content:d,order:g,deleteDocumentIds:w}=e.body,h=e.params.id;try{const s=n(e);if(!s.isEmpty())return f(a,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",s.array().map(e=>e.msg).join(" "));const _=await t("cms_contents").where("id",h).first();if(!_){const e=new m(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${h}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const b=l??_.type,T=k(e),S=function(e,a){return a&&0!==a.length?y(e,a):null}(b,T);if(S)return a.status(422).json(S.toResponse());const A=o(r(_.content_file_ids),{as:"number"}),I=o(w,{as:"number"}),N=A.filter(e=>I.includes(e));let j=A;if(N.length>0){await c.deleteDocuments(N);const e=new Set(N);j=A.filter(a=>!e.has(a))}let v,O,L=[];if(T.length>0&&(L=(await c.uploadDocuments(T,e)).map(e=>Number(e)).filter(Number.isFinite)),["Image","Video","Audio","File"].includes(b)){const e=L[0]??j[0]??null;if(!e)return await t.rollback(),f(a,"FILES_NOT_FOUND","File Tidak Ditemukan","Harus tersedia tepat 1 file untuk tipe ini.");const n=await i("documents").select("file_url").where({id:e}).first();if(!n?.file_url)return await t.rollback(),f(a,"FILE_URL_NOT_FOUND","URL File Tidak Ditemukan","Gagal mendapatkan URL publik file dari storage.");v=u([e]),O=String(n.file_url)}else if("ImageArray"===b){const e=Array.from(new Set([...j,...L]));if(0===e.length)return await t.rollback(),f(a,"FILES_NOT_FOUND","File Tidak Ditemukan","Minimal 1 gambar untuk tipe ImageArray.");if(e.length>20)return await t.rollback(),f(a,"MAX_FILES","Terlalu Banyak File","Maksimal 20 gambar untuk tipe ImageArray.");const n=(await i("documents").select("id","file_url").whereIn("id",e).orderBy("id","asc")).map(e=>String(e.file_url)).filter(Boolean);if(0===n.length)return await t.rollback(),f(a,"FILE_URL_NOT_FOUND","URL File Tidak Ditemukan","Gagal mendapatkan URL publik file dari storage.");v=u(e),O=JSON.stringify(n)}else if("Link"===b){const e=R(d);if(e.error)return a.status(422).json(e.error.toResponse());O=e.contentValue,v=e.contentFileIds}else if("Text"===b){const e=E(d);if(e.error)return a.status(422).json(e.error.toResponse());O=e.contentValue,v=e.contentFileIds}else{if("TextArray"!==b)return f(a,"UNSUPPORTED_TYPE","Tipe Tidak Didukung","Tipe konten tidak dikenali.");{const e=D(d);if(e.error)return a.status(422).json(e.error.toResponse());O=e.contentValue,v=e.contentFileIds}}const M={updated_at:t.fn.now()};void 0!==l&&(M.type=b),void 0!==O&&(M.content=O),void 0!==v&&(M.content_file_ids=v),null!=g&&(M.order=Number(g)),await t("cms_contents").where("id",h).update(M),await p.logUpdate({userId:p.fromReq(e),module:"cms",subject:"List Kegiatan"},t),await t.commit();const C=M.order??_.order,F=new m(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data konten dengan order '${C}' berhasil diperbarui.`);return a.status(200).json(F.toResponse())}catch(e){await t.rollback(),s.error(`| Event CMS | - Error function update : ${e.message}`);const n=new m(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},4534:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeNewsValidator=[n("categoryId").notEmpty().withMessage("Kategori berita wajib dipilih.").bail().isInt().withMessage("Kategori berita harus berupa angka.").bail().custom(async e=>{if(!await i("cms_news_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori berita yang Anda pilih tidak ditemukan.");return!0}),n("title").custom(e=>{if(void 0===e)throw new Error("Judul berita tidak boleh kosong.");return!0}),n("slug").custom(e=>{if(void 0===e)throw new Error("Slug berita tidak boleh kosong.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi berita tidak boleh kosong.");return!0}),n("newsContent").custom(e=>{if(void 0===e)throw new Error("Konten berita tidak boleh kosong.");return!0})]},4611:(e,a,t)=>{const{body:n}=t(7975),i=Object.freeze([2,3]);a.updateTargetVerificationValidator=[n("validationStatus").exists({checkNull:!0,checkFalsy:!0}).withMessage("Status validasi tidak boleh kosong.").bail().toInt().isInt().withMessage("Status validasi harus bilangan bulat.").bail().isIn(i).withMessage("Status validasi harus 2 (Approve) atau 3 (Rejected)."),n("rejectionReason").optional({nullable:!0}).isString().withMessage("Alasan penolakan harus berupa teks.").bail().trim(),n("rejectionReason").custom((e,{req:a})=>{if(3===Number(a.body.validationStatus)&&(null==e||""===String(e).trim()))throw new Error("Alasan penolakan wajib diisi saat status = 3 (Rejected).");return!0}),n("rejectionReason").customSanitizer((e,{req:a})=>2===Number(a.body.validationStatus)?null:"string"==typeof e?e.trim():e??null)]},4631:(e,a,t)=>{const{body:n}=t(7975);a.createAccountValidator=[n("name").notEmpty().withMessage("Nama tidak boleh kosong.").bail().isString().withMessage("Nama harus berupa teks.").bail().isLength({max:255}).withMessage("Nama maksimal 255 karakter."),n("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),n("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter."),n("passwordConfirmation").notEmpty().withMessage("Password konfirmasi tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password konfirmasi minimal terdiri dari 8 karakter.").bail().custom((e,{req:a})=>{if(e!==a.body.password)throw new Error("Password konfirmasi tidak cocok.");return!0})]},4654:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{asJsonb:r}=t(6192),{normIdArray:o,normJsonbArray:l}=t(7872),d=t(1701),u=t(1332),c=t(6870),m=t(9974),p=t(6479);function g(){return Array.from({length:12},(e,a)=>({month:a,value:0}))}a.dashboardInfo=async(e,a)=>{try{const t=(e.query&&e.query.year)??(e.body&&e.body.year),n=Number(t),s=Number.isInteger(n)&&n>0?n:(new Date).getFullYear(),r=await async function(){const e=await i("monev_dashboards").select("*").where("id",1).first();if(!e)return null;return await m(e)}(),o=await async function(e){const a=await i("monev_targets as mt").where("mt.year",e).whereNull("mt.deleted_at").select(i.raw("COALESCE(AVG(mt.physical_target), 0) AS avg_physical_target")).first(),t=Number(a?.avg_physical_target??0);return Math.round(100*t)/100}(s),l=await async function(e){const a=await i("monev_monthly_realizations as mmr").where("mmr.year",e).whereNull("mmr.deleted_at").select(i.raw("COALESCE(AVG(LEAST(GREATEST(mmr.progress, 0), 100)), 0) AS avg_progress")).first(),t=Number(a?.avg_progress??0);return Math.round(100*t)/100}(s),d=await async function(e){const a=`${e}-01-01 00:00:00`,t=`${e+1}-01-01 00:00:00`,n=await i("monev_activity_packages as map").whereNull("map.deleted_at").andWhere("map.created_at",">=",a).andWhere("map.created_at","<",t).count({total:"*"}).first();return Number(n?.total??0)}(s),c=await async function(e){const a=await i("monev_targets as mt").where("mt.year",e).whereNull("mt.deleted_at").select("mt.month").select(i.raw("COALESCE(SUM((mt.budget_target)::bigint), 0) AS total")).groupBy("mt.month").orderBy("mt.month","asc"),t=new Map(a.map(e=>[Number(e.month),Number(e.total)])),n=g();for(let e=0;e<12;e++)n[e].value=t.get(e+1)??0;return n}(s),p=await async function(e){const a=await i("monev_monthly_realizations as mmr").where("mmr.year",e).whereNull("mmr.deleted_at").joinRaw("LEFT JOIN LATERAL jsonb_array_elements(COALESCE(mmr.budget_realization, '[]'::jsonb)) AS elem ON TRUE").select("mmr.month").select(i.raw("COALESCE(SUM(GREATEST((elem->>'value')::bigint, 0)), 0) AS total")).groupBy("mmr.month").orderBy("mmr.month","asc"),t=new Map(a.map(e=>[Number(e.month),Number(e.total)])),n=g();for(let e=0;e<12;e++)n[e].value=t.get(e+1)??0;return n}(s),w=await async function(e){const a=await i("monev_targets as mt").where("mt.year",e).whereNull("mt.deleted_at").select(i.raw("COALESCE(SUM(mt.budget_target), 0) AS total_budget_target")).first();return Number(a?.total_budget_target??0)}(s),h=await async function(e){const a=await i("monev_monthly_realizations as mmr").where("mmr.year",e).whereNull("mmr.deleted_at").joinRaw("LEFT JOIN LATERAL jsonb_array_elements(COALESCE(mmr.budget_realization,'[]'::jsonb)) AS elem ON TRUE").select(i.raw("COALESCE(SUM(GREATEST((elem->>'value')::bigint, 0)), 0) AS total_realization")).first();return Number(a?.total_realization??0)}(s),_=await async function(e){const a=`${e}-01-01 00:00:00`,t=`${e+1}-01-01 00:00:00`,n=await i("monev_activity_calendar as mac").whereNull("mac.deleted_at").andWhere("mac.created_at",">=",a).andWhere("mac.created_at","<",t).count({total:"*"}).first();return Number(n?.total??0)}(s),k=new u(200,"DATA_FOUND","Data Ditemukan","Data dashboard MONEV berhasil didapatkan.",{dashboard:r,avgPhysicalTarget:o,avgProgressRealization:l,totalActivityPackages:d,statsBudgetTarget:c,statsBudgetRealization:p,sumBudgetTarget:w,sumBudgetRealization:h,totalActivityCalendar:_});a.status(200).json(k.toResponse())}catch(e){s.error(`| Dashboard MONEV | - Error function dashboardInfo : ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{description:l,hibahIDR:u,hibahUSD:m}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=e.files?.frameworkFiles||[],g=e.files?.planFiles||[],w={"application/pdf":"PDF"},h=["application/pdf"],_=52428800,k=e=>[...new Set(e.map(e=>w[e]||e))].join(", "),b=(e,a,t)=>{const n=k(a);for(const i of e){if(!a.includes(i.mimetype))throw new c(422,"INVALID_FILE_TYPE","Tipe File Salah",`${t} harus berformat: ${n}.`);if(i.size>_)throw new c(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar",`Ukuran maksimal tiap file pada ${t} adalah 50mB.`)}return null};if(0===s.length){const e=new c(422,"FILES_NOT_FOUND","File Tidak Ditemukan","Berkas file dashboard framework wajib diunggah.");return a.status(422).json(e.toResponse())}if(b(s,h,"Berkas file framework"),0===g.length){const e=new c(422,"FILES_NOT_FOUND","File Tidak Ditemukan","Berkas file dashboard plan wajib diunggah.");return a.status(422).json(e.toResponse())}if(b(g,h,"Berkas file plan"),s.length>1){const e=new c(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload file framework per request adalah 1 file.");return a.status(200).json(e.toResponse())}if(g.length>1){const e=new c(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload file plan per request adalah 1 file.");return a.status(200).json(e.toResponse())}let f=[],y=[];s.length>0&&(f=await d.uploadDocuments(s,e)),g.length>0&&(y=await d.uploadDocuments(g,e));const R=o(e.body.frameworkFiles,{as:"number"}),E=o(e.body.planFiles,{as:"number"}),D=R.length?R:f,T=E.length?E:y;await t("monev_dashboards").insert({networth_hibah_usd:m,networth_hibah_idr:u,description:l,framework_file_ids:D?.length?r(D):null,plan_file_ids:T?.length?r(T):null}).returning("*"),await p.logCreate({userId:p.fromReq(e),module:"master_data",subject:"Dashboard Monev"},t),await t.commit();const S=new c(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data","Data dashboard berhasil ditambahkan.");return a.status(201).json(S.toResponse())}catch(e){if(await t.rollback(),e&&"function"==typeof e.toResponse){const t=e.status||e.statusCode||422;return a.status(t).json(e.toResponse())}s.error(`| Dashboard MONEV | - Error function store: ${e?.message||String(e)}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(n.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{description:u,hibahUSD:m,hibahIDR:g,deleteFrameworkFileIds:w,deletePlanFileIds:h}=e.body,_=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const k=await t("monev_dashboards").where("id",_).first();if(!k){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data dashboard dengan ID '${_}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const b=e.files?.frameworkFiles||[],f=e.files?.planFiles||[],y={"application/pdf":"PDF"},R=["application/pdf"],E=52428800,D=e=>[...new Set(e.map(e=>y[e]||e))].join(", "),T=(e,a,t)=>{const n=D(a);for(const i of e){if(!a.includes(i.mimetype))throw new c(422,"INVALID_FILE_TYPE","Tipe File Salah",`${t} harus berformat: ${n}.`);if(i.size>E)throw new c(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar",`Ukuran maksimal tiap file pada ${t} adalah 50mB.`)}return null};if(b.length>0){const e=T(b,R,"File (frameworkFiles)");if(e)return a.status(422).json(e.toResponse());if(b.length>1){const e=new c(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload file framework per request adalah 1 file.");return a.status(200).json(e.toResponse())}}if(f.length>0){const e=T(f,R,"File (planFiles)");if(e)return a.status(422).json(e.toResponse());if(f.length>1){const e=new c(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload file plan per request adalah 1 file.");return a.status(200).json(e.toResponse())}}const S=o(l(k.framework_file_ids),{as:"number"}),A=o(l(k.plan_file_ids),{as:"number"}),I=o(w,{as:"number"}),N=o(h,{as:"number"});let j=S.filter(e=>!I.includes(e)),v=A.filter(e=>!N.includes(e)),O=[],L=[];b.length>0&&(O=o(await d.uploadDocuments(b,e),{as:"number"})),f.length>0&&(L=o(await d.uploadDocuments(f,e),{as:"number"}));const M=o(b,{as:"number"}),C=o(f,{as:"number"}),F=e=>Array.from(new Set(e.filter(e=>null!=e)));j=F([...j,...M,...O]),v=F([...v,...C,...L]),await t("monev_dashboards").where("id",_).update({networth_hibah_usd:m??k.networth_hibah_usd,networth_hibah_idr:g??k.networth_hibah_idr,description:u??k.description,framework_file_ids:r(j),plan_file_ids:r(v),updated_at:t.fn.now()}),await p.logCreate({userId:p.fromReq(e),module:"master_data",subject:"Dashboard Monev"},t),await t.commit();const P=[...I,...N].filter(e=>Number.isFinite(e));if(P.length)try{await d.deleteDocuments(P)}catch(e){s?.error?.(`| Dashboard MONEV | - Gagal hapus dokumen: ${e.message}`)}const $=new c(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui","Data dashboard berhasil diperbarui.");return a.status(200).json($.toResponse())}catch(e){if(await t.rollback(),e&&"function"==typeof e.toResponse){const t=e.status||e.statusCode||422;return a.status(t).json(e.toResponse())}s.error(`| Dashboard MONEV | - Error function update : ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},4674:(e,a,t)=>{const n=t(7252).Router(),i=t(7901),{storeShareReportValidator:s}=t(2756),{updateShareReportValidator:r}=t(2470),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.monev_share_report"]),i.index),n.get("/show/:id",u(["view.monev_share_report"]),i.show),n.post("/create",u(["create.monev_share_report"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.monev_share_report"]),c.array("files",20),r,o,i.update),n.delete("/delete",u(["delete.monev_share_report"]),i.destroy),e.exports=n},4683:(e,a,t)=>{const n=t(7252).Router(),i=t(4952),{storeActivityCategoryValidator:s}=t(6611),{updateActivityCategoryValidator:r}=t(1227),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.master_data"]),i.index),n.get("/show/:id",u(["view.master_data"]),i.show),n.post("/create",u(["create.master_data"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.master_data"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.master_data"]),i.destroy),n.patch("/restore",u(["restore.master_data"]),i.restore),e.exports=n},4686:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4729),s=t(4930),r=t(7484),o=t(1572),{applySearch:l,applyPagination:d,formatPaginationResult:u}=t(3210),{normIdArray:c}=t(7872),m=t(1332),p=t(6870),g=t(6348),w=t(3694),h=t(3034),_=t(6479),{stripTitlesOnly:k,generateRandomPassword:b}=t(337),{checkEmailDeliverability:f}=t(8467),{applyTrashedScope:y}=t(7438);a.getAllUserSso=async(e,a)=>{const{search:t}=e.query;try{let n=s("users as user").select(["user.id","user.name","user.email","user.role_id","user.photo_profile_ids"]).whereNot("user.id",1).where("user.account_status",2).where("user.role_id",1).leftJoin("roles as role","user.role_id","role.id").whereNull("user.deleted_at").orderBy("user.created_at","desc");l(n,t,["user.name","user.email"]);const i=d(e.query),r=await u(n,i,s);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>h(e))),c=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data SSO berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(c.toResponse())}catch(e){r.error(`| Account MONEV | - Error function getAllUserSso : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.index=async(e,a)=>{const{search:t}=e.query;try{let n=s("users as user").leftJoin("roles as role","user.role_id","role.id").where("user.role_id",3).select("user.*").orderBy("user.created_at","desc");y(n,e,"user.deleted_at"),l(n,t,["user.name","user.email"]);const i=d(e.query),r=await u(n,i,s);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>w(e))),c=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data akun monev berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(c.toResponse())}catch(e){r.error(`| Account MONEV | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await s.transaction(),{name:l,email:d}=e.body;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const u=await f(d,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(r.info(`| Account MONEV | - [email-check] ${d} -> ${u.ok} (${u.reason}) ${JSON.stringify(u.detail||[])}`),!u.ok){const e=new p(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${d}' tampaknya tidak dapat menerima email. Gunakan email valid yang lain.`);return a.status(422).json(e.toResponse())}if(await t("users").whereRaw("lower(email) = lower(?)",[d]).whereNull("deleted_at").first()){const e=new p(422,"DUPLICATE_EMAIL","Duplikat Data",`Email '${d}' sudah digunakan oleh akun monev lain. Silakan gunakan email lain.`);return a.status(422).json(e.toResponse())}const c=k(l),m=b(8),w=await i.hash(m,12),[h]=await t("users").insert({name:l,email:d,role_id:3,account_status:2,password:w}).returning(["id","name","email","created_at"]);await _.logCreate({userId:_.fromReq(e),module:"monev",subject:"Akun Monev Non PIC"},t),await t.commit();const y=o.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),R=g("credential_monev.html",{name:c,email:h.email,password:m,login_url:process.env.APP_LOGIN_URL||"#",from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await y.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:h.email,subject:"Credential Akun Monev Non PIC",html:R}),r.info(`| Account MONEV | - Credential email successfully sent to ${h.email} at ${(new Date).toISOString()}`);const E=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data akun monev dengan email '${d}' berhasil ditambahkan.`);return a.status(201).json(E.toResponse())}catch(e){await t.rollback(),r.error(`| Account MONEV | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await s("users").select("*").where("id",t).where("role_id",3).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data akun monev dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await w(e),i=k(e.name),r=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data akun monev '${i}' berhasil didapatkan.`,n);return a.status(200).json(r.toResponse())}catch(e){r.error(`| Account MONEV | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.deactivateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.deactivateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deactivateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",3).where("account_status",3).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_INACTIVE","Akun Sudah Nonaktif",`Terdapat ${s.length} akun monev yang sudah nonaktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id","email").whereIn("id",n).where("role_id",3).whereNull("deleted_at").whereNot("account_status",3);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun monev yang cocok untuk dinonaktifkan atau akun sudah nonaktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:3,deactivate_at:t.fn.now(),updated_at:t.fn.now()}),await _.logUpdate({userId:_.fromReq(e),module:"monev",subject:"Akun Monev Non PIC"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil menonaktifkan ${o.length} akun monev.`];l>0&&d.push(`Terlewat ${l} data, karena sudah nonaktif atau telah dihapus.`);const u=new p(200,"SUCCESS_DEACTIVATE_ACCOUNT","Berhasil Nonaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),r.error(`| Account MONEV | - Error function deactivateAccount : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.activateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.activateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan activateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",3).where("account_status",2).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_ACTIVE","Akun Sudah Aktif",`Terdapat ${s.length} akun monev yang sudah aktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id").whereIn("id",n).where("role_id",3).whereNull("deleted_at").whereNot("account_status",2);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun monev yang cocok untuk diaktifkan atau akun sudah aktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:2,deactivate_at:null,updated_at:t.fn.now()}),await _.logUpdate({userId:_.fromReq(e),module:"monev",subject:"Akun Monev Non PIC"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil mengaktifkan ${o.length} akun monev.`];l>0&&d.push(`Terlewat ${l} karena sudah aktif, bukan educator, atau telah dihapus.`);const u=new p(200,"SUCCESS_ACTIVATE_ACCOUNT","Berhasil Mengaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){r.error(`| Account MONEV | - Error function activateAccount: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},4701:(e,a,t)=>{const n=t(8577);e.exports=n({origin:["https://rimba.webgis.app","https://rimba.webgis.app/kmis"],methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})},4729:e=>{"use strict";e.exports=require("bcryptjs")},4762:(e,a,t)=>{const n=t(7252).Router(),i=t(675),s=t(9022),r=t(6967),o=t(5794);n.use(r,s),n.get("/info",o(["view.kmis_dashboard"]),i.dashboardInfo),e.exports=n},4835:e=>{"use strict";e.exports=require("redis")},4930:(e,a,t)=>{function n(e){const a=(process.env[e]??"").toString().trim();if(!a)throw new Error(`ENV wajib "${e}" belum diisi.`);return a}function i(e){const a=n(e),t=Number(a);if(!Number.isInteger(t))throw new Error(`ENV "${e}" harus integer. Dapat: "${a}"`);return t}const s=t(1832)({client:"pg",connection:function(){const e=n("PG_ENV").toLowerCase().toUpperCase();return{host:n(`DB_HOST_${e}`),port:i(`DB_PORT_${e}`),user:n(`DB_USER_${e}`),password:n(`DB_PASSWORD_${e}`),database:n(`DB_NAME_${e}`)}}(),pool:{min:2,max:50},acquireConnectionTimeout:1e4});e.exports=s},4949:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeLearningAttemptValidator=[n("topicId").notEmpty().withMessage("Topik wajib dipilih.").bail().isInt().withMessage("Topik harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_topics").where("id",e).whereNull("deleted_at").first())throw new Error("Topik yang Anda pilih tidak ditemukan.");return!0})]},4952:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{normIdArray:r}=t(7872),{applySearch:o,applyPagination:l,formatPaginationResult:d}=t(3210),u=t(1332),c=t(6870),m=t(1004),p=t(6479),{applyTrashedScope:g}=t(7438),{applyLatestThenTrashed:w}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("monev_activity_categories as category").select("category.*");g(n,e,"category.deleted_at"),o(n,t,["category.title"]),w(n,"category.deleted_at","category.created_at","category.id");const s=l(e.query),r=await d(n,s,i);if(0===r.data.length){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const p=await Promise.all(r.data.map(e=>m(e))),h=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori berhasil diambil.",{data:p,pagination:r.pagination});return a.status(200).json(h.toResponse())}catch(e){s.error(`| Activity Category MONEV | - Error function index : ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("monev_activity_categories").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").first()){const e=new c(422,"DUPLICATE_TITLE","Duplikat Data",`Judul kategori '${r}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}await t("monev_activity_categories").insert({title:r,description:o}).returning("*"),await p.logCreate({userId:p.fromReq(e),module:"master_data",subject:"List Kategori Aktivitas Kegiatan"},t),await t.commit();const s=new c(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kategori '${r}' berhasil ditambahkan.`);return a.status(201).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Category MONEV | - Error function store: ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("monev_activity_categories").select("*").where("id",t).first();if(!e){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await m(e),s=new u(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori '${e.title}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Activity Category MONEV | - Error function show: ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{title:r,description:o}=e.body,l=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new c(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(!await t("monev_activity_categories").where("id",l).first()){const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori dengan ID '${l}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("monev_activity_categories").whereRaw("lower(title) = lower(?)",[r]).whereNull("deleted_at").whereNot("id",l).first()){const e=new c(422,"DUPLICATE_TITLE","Duplikat Data",`Judul '${r}' sudah digunakan pada kategori lain.`);return a.status(422).json(e.toResponse())}await t("monev_activity_categories").where("id",l).update({title:r,description:o,updated_at:t.fn.now()}),await p.logUpdate({userId:p.fromReq(e),module:"master_data",subject:"List Kategori Aktivitas Kegiatan"},t),await t.commit();const s=new c(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kategori '${r}' berhasil diperbarui.`);return a.status(200).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Category MONEV | - Error function update : ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=r(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new c(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new c(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("monev_activity_categories").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=s.map(e=>e.id);await t("monev_activity_categories").whereIn("id",o).update({deleted_at:t.fn.now()}),await p.logDelete({userId:p.fromReq(e),module:"master_data",subject:"List Kategori Aktivitas Kegiatan"},t),await t.commit();const l=new c(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${o.length} data kategori.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Category MONEV | - Error function destroy : ${e.message}`);const n=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=r(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new c(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new c(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const o=await t("monev_activity_categories").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===o.length){await t.rollback();const e=new c(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=o.map(e=>e.title?.toLowerCase?.()??""),d=await t("monev_activity_categories").select(i.raw("lower(title) AS ltitle")).whereNull("deleted_at").whereIn(i.raw("lower(title)"),l),u=new Set(d.map(e=>e.ltitle)),m=new Set,g=new Set;for(const e of o){const a=(e.title||"").toLowerCase();m.has(a)?g.add(a):m.add(a)}const w=[],h=[],_=new Set;for(const e of o){const a=(e.title||"").toLowerCase(),t=u.has(a),n=g.has(a);t||n||_.has(a)?h.push({id:e.id,title:e.title}):(_.add(a),w.push(e))}let k=0;if(w.length>0){const e=w.map(e=>e.id);await t("monev_activity_categories").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),k=e.length}if(await p.logRestore({userId:p.fromReq(e),module:"master_data",subject:"List Kategori Aktivitas Kegiatan"},t),await t.commit(),0===k){const e=new c(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const b=[`Berhasil mengembalikan ${k} data yang terhapus.`];h.length&&b.push(`Terlewat ${h.length} karena bentrok/duplikat data.`);const f=new c(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",b.join(" "));return a.status(200).json(f.toResponse())}catch(e){s.error(`| Activity Category MONEV | - Error function restore: ${e.message}`);const t=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},5057:(e,a,t)=>{const{body:n}=t(7975);a.storeEducatorValidator=[n("name").notEmpty().withMessage("Nama pengajar tidak boleh kosong.").bail().isString().withMessage("Nama pengajar harus berupa teks.").bail().isLength({max:255}).withMessage("Nama pengajar maksimal 255 karakter."),n("email").notEmpty().withMessage("Email pengajar tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.").bail().isString().withMessage("Email pengajar harus berupa teks.")]},5124:e=>{"use strict";e.exports=require("winston")},5206:(e,a,t)=>{const n=t(4930),i=t(7724),s=t(3034);e.exports=async function(e){const[a,t]=await Promise.all([e.kmis_topic_id?await n("kmis_topics").where("id",e.kmis_topic_id).first():null,e.created_by?n("users").where("id",e.created_by).first():null]);return{id:e.id,topic:a?await i(a):null,createdUser:t?await s(t):null,question:e.question,answerA:e.answer_a,answerB:e.answer_b,answerC:e.answer_c,answerD:e.answer_d,correctOption:e.correct_option,explanation:e.explanation,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},5211:(e,a,t)=>{const{body:n}=t(7975);a.storePicDivisionValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},5212:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(2482);e.exports=async function(e){const a=await n(e.document_ids,"documents",i);return{id:e.id,document:a,title:e.title,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},5233:(e,a,t)=>{const n=t(4930),i=t(7484),{applySearch:s,applyJsonbSearch:r,applyRelationIn:o,applyStartEndDateFilter:l,validateDateRangeRequiredBoth:d,applyPagination:u,formatPaginationResult:c}=t(3210),{normIdArray:m,isPlainObject:p}=t(7872),{getUserPicFilterFlag:g}=t(7072),w=t(1332),h=t(6870),_=t(3034),k=t(7857),b=t(7807),f=t(7724),y=t(5278),R=t(5206),E=t(7026),D=t(8669),T=t(2273),S=t(52),A=t(8641),I=t(1022),N=t(9342),j=t(5212),v=t(9304),{trackTopicViewsForReq:O}=t(6417);a.getAllRole=async(e,a)=>{const{search:t}=e.query;try{let i=n("roles as role").select(["role.name","role.description"]).whereNot("role.id",1).whereNull("role.deleted_at").orderBy("role.created_at","desc");s(i,t,["role.name"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>k(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data role berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllRole : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAllCategory=async(e,a)=>{const{search:t}=e.query;try{let i=n("kmis_categories as category").select(["category.id","category.title","category.description"]).whereNull("category.deleted_at").orderBy("category.created_at","desc");s(i,t,["category.title"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>b(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllCategory : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getCategorybyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("kmis_categories").select(["id","title","description"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await b(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori '${e.title}' berhasil didapatkan.`,i);return a.status(200).json(s.toResponse())}catch(e){i.error(`| Public Request | - Error function getCategorybyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllTopic=async(e,a)=>{const{search:t,categoryId:r,topicType:l}=e.query,d=r??e.query["categoryId[]"],m=l??e.query["topicType[]"];if(!m){const e=new h(422,"MISSING_TOPIC_TYPE","Filter topicType wajib diisi","Filter topicType tidak diperbolehkan kosong. Silahkan tentukan tipe topik yang ingin dicari.");return a.status(422).json(e.toResponse())}try{let i=n("kmis_topics as topic").select(["topic.id","topic.user_pic","topic.material_order_ids","topic.topic_cover_ids","topic.kmis_categories_id","topic.topic_type","topic.title","topic.description","topic.total_quiz","topic.quiz_duration","topic.total_views"]).leftJoin("kmis_categories as category","topic.kmis_categories_id","category.id").whereNull("topic.deleted_at").orderBy("topic.created_at","desc");o(i,"topic.kmis_categories_id",d,{as:"number"}),o(i,"topic.topic_type",m,{as:"string"}),s(i,t,["topic.title","category.title"]);const r=u(e.query),l=await c(i,r,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const p=await Promise.all(l.data.map(e=>f(e))),g=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data topik berhasil diambil.",{data:p,pagination:l.pagination});return a.status(200).json(g.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllTopic : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAllTopicWithAuth=async(e,a)=>{const{search:t,categoryId:r,topicType:l}=e.query,d=r??e.query["categoryId[]"],m=l??e.query["topicType[]"];if(!m){const e=new h(422,"MISSING_TOPIC_TYPE","Filter topicType wajib diisi","Filter topicType tidak diperbolehkan kosong. Silahkan tentukan tipe topik yang ingin dicari.");return a.status(422).json(e.toResponse())}try{let i=n("kmis_topics as topic").select(["topic.id","topic.user_pic","topic.material_order_ids","topic.topic_cover_ids","topic.kmis_categories_id","topic.topic_type","topic.title","topic.description","topic.total_quiz","topic.quiz_duration","topic.total_views"]).leftJoin("kmis_categories as category","topic.kmis_categories_id","category.id").whereNull("topic.deleted_at").orderBy("topic.created_at","desc");o(i,"topic.kmis_categories_id",d,{as:"number"}),o(i,"topic.topic_type",m,{as:"string"});const{canSeeUserPic:r,userId:l}=await g(e);r&&null!=l&&(i=i.whereRaw("topic.user_pic @> ?",[JSON.stringify([Number(l)])])),s(i,t,["topic.title","category.title"]);const p=u(e.query),_=await c(i,p,n);if(0===_.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const k=await Promise.all(_.data.map(e=>f(e))),b=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data topik berhasil diambil.",{data:k,pagination:_.pagination});return a.status(200).json(b.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllTopicWithAuth : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getTopicbyId=async(e,a)=>{const{id:t}=e.params;try{const i=await n("kmis_topics").select(["id","topic_cover_ids","material_order_ids","kmis_categories_id","topic_type","title","description","total_quiz","quiz_duration","total_views"]).where("id",t).whereNull("deleted_at").first();if(!i){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data topik dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}await O(result.data.map(e=>e.id),e);const s=await f(i),r=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data topik '${i.title}' berhasil didapatkan.`,s);return a.status(200).json(r.toResponse())}catch(e){i.error(`| Public Request | - Error function getTopicbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getTopicbyCategoryId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("kmis_topics as topic").select(["topic.id","topic.topic_cover_ids","topic.material_order_ids","topic.kmis_categories_id","topic.topic_type","topic.title","topic.description","topic.total_quiz","topic.quiz_duration","topic.total_views"]).where("topic.kmis_categories_id",r).leftJoin("kmis_categories as category","topic.kmis_categories_id","category.id").whereNull("topic.deleted_at").orderBy("topic.created_at","desc");s(i,t,["topic.title","category.title"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>f(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data topik berdasarkan kategori berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getTopicbyCategoryId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllUser=async(e,a)=>{const{search:t}=e.query;try{let i=n("users as user").whereNot("user.role_id",1).where("user.account_status",2).leftJoin("roles as role","user.role_id","role.id").select(["user.id","user.name","user.email","user.role_id","user.photo_profile_ids"]).whereNull("user.deleted_at").orderBy("user.created_at","desc");s(i,t,["user.name","role.name"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>_(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data pengguna berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllUser : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAllUserEducatorWithAuth=async(e,a)=>{const{search:t}=e.query;try{let i=n("users as user").select(["user.id","user.name","user.email","user.role_id","user.photo_profile_ids"]).where("user.account_status",2).where("user.role_id",2).leftJoin("roles as role","user.role_id","role.id").whereNull("user.deleted_at").orderBy("user.created_at","desc");s(i,t,["user.name","role.name"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>_(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data pengajar berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllUserEducatorWithAuth : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAllUserStudent=async(e,a)=>{const{search:t}=e.query;try{let i=n("users as user").where("user.account_status",2).where("user.role_id",4).leftJoin("roles as role","user.role_id","role.id").select(["user.id","user.name","user.email","user.role_id","user.photo_profile_ids"]).whereNull("user.deleted_at").orderBy("user.created_at","desc");s(i,t,["user.name","role.name"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>_(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data peserta berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllUserStudent : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAllUserbyRoleId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("users as user").whereNot("user.role_id",1).where("user.account_status",2).where("user.role_id",r).leftJoin("roles as role","user.role_id","role.id").select(["user.id","user.name","user.email","user.role_id","user.photo_profile_ids"]).whereNull("user.deleted_at").orderBy("user.created_at","desc");s(i,t,["user.name","role.name"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>_(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data pengguna berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllUser : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getUserbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("users").select(["name","email","role_id","photo_profile_ids"]).whereNot("role_id",1).where("id",t).where("account_status",2).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data pengguna dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await _(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail data pengguna berhasil didapatkan.",i);return a.status(200).json(s.toResponse())}catch(e){i.error(`| Public Request | - Error function getUserbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllMaterial=async(e,a)=>{const{search:t,categoryId:r,topicId:l}=e.query,d=r??e.query["categoryId[]"],m=l??e.query["topicId[]"];try{let i=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).whereNull("material.deleted_at").orderBy("material.created_at","desc");o(i,"material.kmis_categories_id",d,{as:"number"}),o(i,"material.kmis_topic_id",m,{as:"number"}),s(i,t,["material.title","category.title","topic.title"]);const r=u(e.query),l=await c(i,r,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const p=await Promise.all(l.data.map(e=>y(e))),g=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berhasil diambil.",{data:p,pagination:l.pagination});return a.status(200).json(g.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllMaterial : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getMaterialbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("kmis_materials").select(["id","title","description","material_types","created_by","uploaded_by","kmis_categories_id","kmis_topic_id"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data materi dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await y(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data materi '${e.title}' berhasil didapatkan.`,i);return a.status(200).json(s.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getMaterialbyTopicIdorCategoryId=async(e,a)=>{const{search:t}=e.query,r=[...new Set(m(e.body?.categoryIds??e.body?.categoryId??e.query?.categoryIds??e.query?.categoryId,{as:"number"}))],o=[...new Set(m(e.body?.topicIds??e.body?.topicId??e.query?.topicIds??e.query?.topicId,{as:"number"}))];try{if(0===r.length&&0===o.length){const e=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan","Payload harus diisi minimal salah satu: categoryId[] atau topicId[].");return a.status(422).json(e.toResponse())}if(r.length>0){const e=await n("kmis_categories").whereIn("id",r).pluck("id"),t=r.map(String).filter(a=>!e.includes(a));if(t.length>0){const e=new h(422,"FAILED_VALIDATION","Validasi Gagal",`Beberapa categoryId tidak ditemukan: [${t.join(", ")}].`);return a.status(422).json(e.toResponse())}}if(o.length>0){const e=await n("kmis_topics").whereIn("id",o).pluck("id"),t=o.map(String).filter(a=>!e.includes(a));if(t.length>0){const e=new h(422,"FAILED_VALIDATION","Validasi Gagal",`Beberapa topicId tidak ditemukan: [${t.join(", ")}].`);return a.status(422).json(e.toResponse())}}let i=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).whereNull("material.deleted_at").orderBy("material.created_at","desc");r.length>0&&i.whereIn("material.kmis_categories_id",r),o.length>0&&i.whereIn("material.kmis_topic_id",o),s(i,t,["material.title","category.title","topic.title"]);const l=u(e.query),d=await c(i,l,n);if(0===d.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(d.data.map(e=>y(e))),p=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berdasarkan categori atau topik berhasil diambil.",{data:m,pagination:d.pagination});return a.status(200).json(p.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyTopicIdorCategoryId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getMaterialbyCreatedId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).whereNull("material.deleted_at").where("material.created_by",r).orderBy("material.created_at","desc");s(i,t,["material.title","category.title","topic.title"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>y(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berdasarkan atasnama pembuat berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyCreatedId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getMaterialbyUploadedId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).where("material.uploaded_by",r).whereNull("material.deleted_at").orderBy("material.created_at","desc");s(i,t,["material.title","category.title","topic.title"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>y(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berdasarkan atasnama pengunggah berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyUploadedId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getMaterialbyMaterialTypes=async(e,a)=>{const{search:t}=e.query,{materialType:r}=e.body;try{if(!Array.isArray(r)||0===r.length){const e=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan","materialType harus berupa array berisi minimal satu tipe materi.");return a.status(422).json(e.toResponse())}const i=new Set(["text","gambar","video","dokumen"]),o=e=>String(e??"").trim().toLowerCase().replace(/\s+/g," "),l=[...new Set(r.map(o).map(e=>"teks"===e?"text":e).filter(Boolean))];if(l.filter(e=>!i.has(e)).length>0){const e=new h(422,"INVALID_MATERIAL_TYPES","Tipe materi tidak didukung","Tipe yang diizinkan hanya: text, gambar, video, dokumen.");return a.status(422).json(e.toResponse())}let d=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).whereIn("material.material_types",l).whereNull("material.deleted_at").orderBy("material.created_at","desc");s(d,t,["material.title","category.title","topic.title"]);const m=u(e.query),p=await c(d,m,n);if(0===p.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const g=await Promise.all(p.data.map(e=>y(e))),_=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berdasarkan tipe materi berhasil diambil.",{data:g,pagination:p.pagination});return a.status(200).json(_.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyMaterialTypes: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getMaterialbyIsPublic=async(e,a)=>{const{search:t}=e.query;try{let i=n("kmis_materials as material").leftJoin("kmis_categories as category","category.id","material.kmis_categories_id").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.title","material.description","material.material_types","material.created_by","material.uploaded_by","material.kmis_categories_id","material.kmis_topic_id"]).whereNull("material.deleted_at").orderBy("material.created_at","desc");s(i,t,["material.title","category.title","topic.title"]);const r=u(e.query),o=await c(i,r,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>y(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berdasarkan status publik berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getMaterialbyIsPublic: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllQuiz=async(e,a)=>{const{search:t,topicId:r}=e.query,l=r??e.query["topicId[]"];try{let i=n("kmis_quiz as quiz").leftJoin("kmis_topics as topic","topic.id","quiz.kmis_topic_id").select("quiz.id","quiz.kmis_topic_id","quiz.question","quiz.answer_a","quiz.answer_b","quiz.answer_c","quiz.answer_d","quiz.correct_option","quiz.explanation").whereNull("quiz.deleted_at").orderBy("quiz.created_at","desc");o(i,"quiz.kmis_topic_id",l,{as:"number"}),s(i,t,["quiz.question","topic.title"]);const r=u(e.query),d=await c(i,r,n);if(0===d.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(d.data.map(e=>R(e))),p=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data soal pertanyaan berhasil diambil.",{data:m,pagination:d.pagination});return a.status(200).json(p.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllQuiz : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getQuizbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("kmis_quiz").select("id","kmis_topic_id","question","answer_a","answer_b","answer_c","answer_d","correct_option","explanation").where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data soal dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await R(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail data soal berhasil didapatkan.",i);return a.status(200).json(s.toResponse())}catch(e){i.error(`| Public Request | - Error function getQuizbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getQuizbytopicId=async(e,a)=>{const{search:t}=e.query,r=[...new Set(m(e.body?.topicIds??e.body?.topicId??e.query?.topicIds??e.query?.topicId,{as:"number"}))];try{if(0===r.length){const e=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan","Payload harus diisi topicId[].");return a.status(422).json(e.toResponse())}const i=await n("kmis_topics").whereIn("id",r).whereNull("deleted_at").pluck("id"),o=new Set(i.map(Number)),l=r.filter(e=>!o.has(Number(e)));if(l.length>0){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Beberapa topicId tidak ditemukan: [${l.join(", ")}].`);return a.status(200).json(e.toResponse())}let d=n("kmis_quiz as quiz").leftJoin("kmis_topics as topic","topic.id","quiz.kmis_topic_id").select("quiz.id","quiz.kmis_topic_id","quiz.question","quiz.answer_a","quiz.answer_b","quiz.answer_c","quiz.answer_d","quiz.correct_option","quiz.explanation","quiz.created_at","quiz.updated_at").whereNull("quiz.deleted_at").orderBy("quiz.created_at","desc");r.length>0&&d.whereIn("quiz.kmis_topic_id",r),s(d,t,["quiz.question","topic.title"]);const m=u(e.query),p=await c(d,m,n);if(0===p.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const g=await Promise.all(p.data.map(e=>R(e))),_=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data soal pertanyaan berdasarkan kategori atau topik berhasil diambil.",{data:g,pagination:p.pagination});return a.status(200).json(_.toResponse())}catch(e){i.error(`| Public Request | - Error function getQuizbytopicId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllNewsCategory=async(e,a)=>{const{search:t}=e.query;try{let i=n("cms_news_categories as category").select(["category.id","category.name","category.description"]).whereNull("category.deleted_at").orderBy("category.created_at","desc");r(i,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0});const s=u(e.query),o=await c(i,s,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>E(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori berita berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllNewsCategory : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getNewsCategorybyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_news_categories").select(["id","name","description"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori berita dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.name)?e.name:parseJsonSafe(e.name)||{},s=(i.id||i.en,await E(e)),r=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori berita '${e.name}' berhasil didapatkan.`,s);return a.status(200).json(r.toResponse())}catch(e){i.error(`| Public Request | - Error function getNewsCategorybyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllEventCategory=async(e,a)=>{const{search:t}=e.query;try{let i=n("cms_events_categories as category").select(["category.id","category.name","category.description"]).whereNull("category.deleted_at").orderBy("category.created_at","desc");r(i,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0});const s=u(e.query),o=await c(i,s,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>T(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori kegiatan berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllEventCategory : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getEventCategorybyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_events_categories").select(["id","name","description"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.name)?e.name:parseJsonSafe(e.name)||{},s=(i.id||i.en,await E(e)),r=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori kegiatan '${e.name}' berhasil didapatkan.`,s);return a.status(200).json(r.toResponse())}catch(e){i.error(`| Public Request | - Error function getEventCategorybyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllAnimalCategory=async(e,a)=>{const{search:t}=e.query;try{let i=n("cms_animal_categories as category").select(["category.id","category.name","category.description"]).whereNull("category.deleted_at").orderBy("category.created_at","desc");r(i,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0});const s=u(e.query),o=await c(i,s,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>A(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori satwa berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllAnimalCategory : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAnimalCategorybyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_animal_categories").select(["id","name","description"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori satwa dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.name)?e.name:parseJsonSafe(e.name)||{},s=i.id||i.en||"Tanpa Nama",r=await E(e),o=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori satwa '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){i.error(`| Public Request | - Error function getAnimalCategorybyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllEvent=async(e,a)=>{const{search:t,eventCategoryId:s}=e.query,l=s??e.query["eventCategoryId[]"];try{let i=n("cms_events as event").select(["event.id","event.cms_event_category_id","event.title","event.description","event.event_content","event.thumbnail_ids","event.created_at"]).whereNull("event.deleted_at").orderBy("event.created_at","desc");o(i,"event.cms_event_category_id",l,{as:"number"}),r(i,t,["event.title->>'id'","event.title->>'en'"],{mode:"or",split:!0});const s=u(e.query),d=await c(i,s,n);if(0===d.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(d.data.map(e=>S(e))),p=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kegiatan berhasil diambil.",{data:m,pagination:d.pagination});return a.status(200).json(p.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllEvent : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getEventbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_events").select(["id","cms_event_category_id","title","description","event_content","thumbnail_ids","created_at"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.title)?e.title:parseJsonSafe(e.title)||{},s=i.id||i.en||"Tanpa Nama",r=await S(e),o=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kegiatan '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){i.error(`| Public Request | - Error function getEventbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getEventbyEventCategoryId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("cms_events as event").leftJoin("cms_events_categories as category","category.id","event.cms_event_category_id").select(["event.id","event.cms_event_category_id","event.title","event.description","event.event_content","event.thumbnail_ids","event.created_at"]).whereNull("event.deleted_at").where("event.cms_event_category_id",r).orderBy("event.created_at","desc");s(i,t,["event.title","category.name"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>S(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kegiatan berdasarkan kategori berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getEventbyEventCategoryId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllNews=async(e,a)=>{const{search:t,newsCategoryId:s}=e.query,l=s??e.query["newsCategoryId[]"];try{let i=n("cms_news as news").select(["news.id","news.cms_news_category_id","news.thumbnail_ids","news.title","news.slug","news.description","news.news_content","news.created_at"]).whereNull("news.deleted_at").orderBy("news.created_at","desc");o(i,"news.cms_news_category_id",l,{as:"number"}),r(i,t,["news.title->>'id'","news.title->>'en'"],{mode:"or",split:!0});const s=u(e.query),d=await c(i,s,n);if(0===d.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(d.data.map(e=>D(e))),p=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data berita berhasil diambil.",{data:m,pagination:d.pagination});return a.status(200).json(p.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllNews : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getNewsbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_news").select(["id","thumbnail_ids","cms_news_category_id","title","slug","description","news_content","created_at"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data berita dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.title)?e.title:parseJsonSafe(e.title)||{},s=i.id||i.en||"Tanpa Nama",r=await D(e),o=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data berita '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){i.error(`| Public Request | - Error function getNewsbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getNewsbyNewsCategoryId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("cms_news as news").leftJoin("cms_news_categories as category","category.id","news.cms_news_category_id").select(["news.id","news.cms_news_category_id","news.title","news.slug","news.description","news.news_content","news.thumbnail_ids","news.created_at"]).whereNull("news.deleted_at").where("news.cms_news_category_id",r).orderBy("news.created_at","desc");s(i,t,["news.title","category.name"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>D(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data berita berdasarkan kategori berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getNewsbyNewsCategoryId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getNewsbySlug=async(e,a)=>{const{slug:t}=e.params;try{const e=await n("cms_news").select(["id","thumbnail_ids","cms_news_category_id","title","slug","description","news_content","created_at"]).whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(slug->>'id') = lower(?)",[t]).orWhereRaw("lower(slug->>'en') = lower(?)",[t])}).first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data berita dengan ID '${id}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await D(e),s=e.title&&(e.title.id||e.title.en)||"Tanpa Judul",r=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data berita '${s}' berdasarkan 'slug' berhasil didapatkan.`,i);return a.status(200).json(r.toResponse())}catch(e){i.error(`| Public Request | - Error function getNewsbySlug: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllAnimalComposition=async(e,a)=>{const{search:t,animalCategoryId:s}=e.query,l=s??e.query["animalCategoryId[]"];try{let i=n("cms_animal_composition as animal").select(["animal.id","animal.cms_animal_category_id","animal.species_image_ids","animal.name","animal.description","animal.total"]).whereNull("animal.deleted_at").orderBy("animal.created_at","desc");o(i,"animal.cms_animal_category_id",l,{as:"number"}),r(i,t,["animal.name->>'id'","animal.name->>'en'"],{mode:"or",split:!0});const s=u(e.query),d=await c(i,s,n);if(0===d.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(d.data.map(e=>N(e))),p=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data komposisi satwa berhasil diambil.",{data:m,pagination:d.pagination});return a.status(200).json(p.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllAnimalComposition : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getAnimalCompositionbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_animal_composition").select(["id","cms_animal_category_id","species_image_ids","name","description","total"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data komposisi satwa dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.name)?e.name:parseJsonSafe(e.name)||{},s=i.id||i.en||"Tanpa Nama",r=await N(e),o=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data komposisi satwa '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){i.error(`| Public Request | - Error function getAnimalCompositionbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAnimalCompositionbyAnimalCategoryId=async(e,a)=>{const{search:t}=e.query,{id:r}=e.params;try{let i=n("cms_animal_composition as animal").leftJoin("cms_animal_categories as category","category.id","animal.cms_animal_category_id").select(["animal.id","animal.cms_animal_category_id","animal.name","animal.description","animal.total","animal.species_image_ids"]).whereNull("animal.deleted_at").where("animal.cms_animal_category_id",r).orderBy("animal.created_at","desc");s(i,t,["animal.name","category.name"]);const o=u(e.query),l=await c(i,o,n);if(0===l.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const d=await Promise.all(l.data.map(e=>N(e))),m=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data komposisi satwa berdasarkan kategori berhasil diambil.",{data:d,pagination:l.pagination});return a.status(200).json(m.toResponse())}catch(e){i.error(`| Public Request | - Error function getAnimalCompositionbyAnimalCategoryId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllLegalDocument=async(e,a)=>{const{search:t,start_date:s,end_date:o}=e.query;try{const i=d(s,o);if(!i.ok){const e=new h(400,i.code,i.title,i.desc);return a.status(422).json(e.toResponse())}let m=n("cms_legal_documents as document").select(["document.id","document.document_ids","document.title","document.description","document.created_at"]).whereNull("document.deleted_at").orderBy("document.created_at","desc");l(m,"document.created_at",s,o,{inclusiveEnd:!0}),r(m,t,["document.title->>'id'","document.title->>'en'"],{mode:"or",split:!0});const p=u(e.query),g=await c(m,p,n);if(0===g.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const _=await Promise.all(g.data.map(e=>j(e))),k=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data dokumen hukum berhasil diambil.",{data:_,pagination:g.pagination});return a.status(200).json(k.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllLegalDocument : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getLegalDocumentbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_legal_documents").select(["id","document_ids","title","description","created_at"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data dokumen hukum dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=p(e.title)?e.title:parseJsonSafe(e.title)||{},s=i.id||i.en||"Tanpa Nama",r=await j(e),o=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data dokumen hukum '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){i.error(`| Public Request | - Error function getLegalDocumentbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllFaq=async(e,a)=>{const{search:t}=e.query;try{let i=n("cms_faqs as faq").select(["faq.id","faq.question","faq.answer"]).whereNull("faq.deleted_at").orderBy("faq.created_at","desc");r(i,t,["faq.question->>'id'","faq.question->>'en'","faq.answer->>'id'","faq.answer->>'en'"],{mode:"or",split:!0});const s=u(e.query),o=await c(i,s,n);if(0===o.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>v(e))),d=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data FAQ berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllFaq : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.getFaqbyId=async(e,a)=>{const{id:t}=e.params;try{const e=await n("cms_faqs").select(["id","question","answer"]).where("id",t).whereNull("deleted_at").first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data FAQ dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=await v(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail data FAQ berhasil didapatkan.",i);return a.status(200).json(s.toResponse())}catch(e){i.error(`| Public Request | - Error function getFaqbyId: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.getAllContent=async(e,a)=>{const t=e.query?.cms,s=!0===t||"true"===t||1===t||"1"===t;try{const e=await n("cms_contents as content").select(["content.id","content.type","content.content","content.content_file_ids",n.raw('"content"."order" as ord')]).whereNull("content.deleted_at").orderBy([{column:n.raw('"content"."order"'),order:"asc"},{column:"content.id",order:"asc"}]),t={};for(const a of e)t[String(a.id)]=await I(a,{withImage:s});const i=await n("cms_events as event").select(["event.id","event.cms_event_category_id","event.title","event.description","event.event_content","event.thumbnail_ids","event.created_at"]).whereNull("event.deleted_at").orderBy("event.created_at","desc"),r=await Promise.all(i.map(S)),o=await n("cms_news as news").select(["news.id","news.cms_news_category_id","news.thumbnail_ids","news.title","news.slug","news.description","news.news_content","news.created_at"]).whereNull("news.deleted_at").orderBy("news.created_at","desc"),l=await Promise.all(o.map(D)),d=await async function(e){const a=await e("cms_animal_composition as cac").leftJoin("cms_animal_categories as cat","cat.id","cac.cms_animal_category_id").whereNull("cac.deleted_at").whereNull("cat.deleted_at").groupBy("cat.id","cat.name").select(["cat.name",e.raw("SUM(cac.total)::bigint AS total")]).orderBy("cat.id","asc"),t=a.reduce((e,a)=>e+Number(a.total||0),0),n=a.map(e=>{let a={};p(e.name)?a=e.name:"string"==typeof e.name&&(a=parseJsonSafe(e.name)||{});const n=a&&"string"==typeof a.id&&""!==a.id.trim()?a.id:"string"==typeof e.name?e.name:"Unknown",i=Number(e.total||0);return{name:n,value:i,percentage:t>0?Math.round(i/t*100):0}});return n.sort((e,a)=>a.value-e.value),n}(n),u=await async function(e,{yearsBack:a=2}={}){const t=new Date,n=t.getFullYear(),i=t.getMonth()+1,s=Array.from({length:a+1},(e,t)=>n-a+t),r=await e("cms_animal_composition as cac").select([e.raw("EXTRACT(YEAR  FROM cac.created_at)::int AS yr"),e.raw("EXTRACT(MONTH FROM cac.created_at)::int AS mo"),e.raw("SUM(cac.total)::bigint AS total")]).whereNull("cac.deleted_at").whereIn(e.raw("EXTRACT(YEAR FROM cac.created_at)::int"),s).groupByRaw("1,2").orderBy([{column:e.raw("yr"),order:"asc"},{column:e.raw("mo"),order:"asc"}]),o={};for(const e of s)o[e]=Array.from({length:12},()=>0);for(const e of r){const a=e.yr,t=e.mo;o[a][t-1]=Number(e.total||0)}const l={};for(const e of s){l[e]=[];let a=0;for(let t=1;t<=12;t++)a+=o[e][t-1],l[e][t-1]=a}return Array.from({length:12},(e,a)=>{const t={};for(const e of s)t[String(e)]=e===n&&a+1>i?null:l[e][a];return t})}(n,{yearsBack:2}),c=await n("cms_legal_documents").select(["id","title","description","document_ids","created_at"]).whereNull("deleted_at").orderBy("created_at","desc"),m=await Promise.all(c.map(j)),g=await n("cms_faqs").select(["id","question","answer"]).whereNull("deleted_at").orderBy("created_at","desc"),_=await Promise.all(g.map(v));if(0===Object.keys(t).length&&0===r.length&&0===l.length&&0===d.length&&u.every(e=>Object.values(e).every(e=>0===e||null===e))&&0===m.length&&0===_.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Belum ada konten, event, berita, komposisi satwa, dokumen hukum, atau FAQ yang tersedia.");return a.status(200).json(e.toResponse())}const k=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data konten CMS berhasil diambil.",{staticContents:t,homeActivities:r,homeAnimalComposition:d,homeCompletionProgress:u,homeLegalDocuments:m,homeNews:l,FAQs:_});return a.status(200).json(k.toResponse())}catch(e){i.error(`| Public Request | - Error function getAllContent : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}}},5278:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(4930),s=t(3034),r=t(2482);e.exports=async function(e){const[a,t,o]=await Promise.all([e.created_by?await i("users").where("id",e.created_by).first():null,e.uploaded_by?await i("users").where("id",e.uploaded_by).first():null,e.kmis_topic_id?await i("kmis_topics").where("id",e.kmis_topic_id).first():null]),l=await n(e.materials_file_ids,"documents",r),d=await n(e.materials_cover_ids,"documents",r);return{id:e.id,createdUser:a?await s(a):null,uploadedUser:t?await s(t):null,topic:o?{id:o.id,topicType:o.topic_type,title:o.title,description:o.description,totalQuiz:o.total_quiz,quizDuration:o.quiz_duration,createdAt:o.created_at,updatedAt:o.updated_at,deletedAt:o.deleted_at}:null,materialFiles:l,materialCovers:d,title:e.title,materialType:e.material_types,materialUrl:e.material_data,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},5317:(e,a,t)=>{const n=t(4930),{resolveArrayRelations:i}=t(7972),s=t(3034),r=t(2482);e.exports=async function(e){const[a,t]=await Promise.all([e.validate_by?n("users").where("id",e.validate_by).first():null,e.edited_by?n("users").where("id",e.edited_by).first():null]),o=await i(e.evidence_file_ids,"documents",r);return{id:e.id,validatedUser:a?await s(a):null,editedUser:t?await s(t):null,evidence:o,month:e.month,year:e.year,budgetRealization:e.budget_realization,progress:e.progress,description:e.description,problem:e.problem,validationStatus:e.validation_status,rejectionReason:e.rejection_message,validateAt:e.validate_at,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},5423:(e,a,t)=>{const{body:n}=t(7975);a.updateEventsCategoryValidator=[n("name").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},5437:(e,a,t)=>{const{body:n}=t(7975);a.updateMonevDashboardValidator=[n("hibah").notEmpty().withMessage("Hibah tidak boleh kosong.").bail().isInt().withMessage("Hibah harus berupa angka."),n("description").notEmpty().withMessage("Deskripsi hibah tidak boleh kosong.").bail().isString().withMessage("Deskripsi hibah harus berupa teks.")]},5718:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(5751),s=t(4930),r=t(7484),{normIdArray:o}=t(7872),{applyRelationIn:l,applySearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),m=t(1332),p=t(6870),{storeQuizValidator:g}=t(8409),w=t(5206),h=t(6479),{applyLatestThenTrashed:_}=t(7540),k=e=>String(e??"").toLowerCase().normalize("NFKC").replace(/\s+/g," ").trim();async function b(e,a){const t=[...new Set((a||[]).map(e=>Number(e)).filter(Number.isFinite))];if(0===t.length)return;const n=await e("kmis_quiz").select("kmis_topic_id as topic_id").count({n:"*"}).whereNull("deleted_at").whereIn("kmis_topic_id",t).groupBy("kmis_topic_id"),i=new Map(n.map(e=>[Number(e.topic_id),Number(e.n)]));for(const a of t){const t=i.get(a)??0;await e("kmis_topics").where("id",a).update({total_quiz:t,updated_at:e.fn.now()})}}a.index=async(e,a)=>{const{search:t,topicId:n}=e.query,i=n??e.query["topicId[]"],o=Number(e.userId);try{const n=await s("users").select("id","role_id").where({id:o}).first();if(!n){const e=new p(401,"USER_NOT_FOUND","Akses Ditolak","Pengguna tidak ditemukan di sistem. Silakan hubungi admin.");return a.status(401).json(e.toResponse())}const r=Number(n.role_id);let g=s("kmis_quiz as quiz").select("quiz.*");Number.isFinite(r)&&1===r||g.where("quiz.created_by",o),l(g,"quiz.kmis_topic_id",i,{as:"number"}),d(g,t,["quiz.question"]),_(g,"quiz.deleted_at","quiz.created_at","quiz.id");const h=u(e.query),k=await c(g,h,s);if(0===k.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const b=await Promise.all(k.data.map(e=>w(e))),f=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data soal pertanyaan berhasil diambil.",{data:b,pagination:k.pagination});return a.status(200).json(f.toResponse())}catch(e){r.error(`| Quiz KMIS | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await s.transaction(),{topicId:i,question:o,answerA:l,answerB:d,answerC:u,answerD:c,correctOption:m,explanation:g}=e.body,w=Number(e.userId);try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}{const e=[["A",l],["B",d],["C",u],["D",c]],t=new Map;for(const[n,i]of e){const e=k(i);if(t.has(e)){const i=t.get(e),s=new p(422,"DUPLICATE_ANSWERS","Duplikat Opsi Jawaban",`Jawaban pilihan ${n} sama dengan pilihan ${i}. Setiap opsi A sampai D harus unik.`);return a.status(422).json(s.toResponse())}t.set(e,n)}}if(await t("kmis_quiz").whereRaw("lower(question) = lower(?)",[o]).whereNull("deleted_at").first()){const e=new p(422,"DUPLICATE_QUESTION","Duplikat Data","Ada soal pertanyaan yang sama dengan yang anda buat. Silakan buat soal yang lain.");return a.status(422).json(e.toResponse())}const r=null==g||"string"==typeof g&&""===g.trim()?null:"string"==typeof g?g.trim():g;await t("kmis_quiz").insert({created_by:w,kmis_topic_id:i,question:o,answer_a:l,answer_b:d,answer_c:u,answer_d:c,correct_option:m,explanation:r}).returning("*"),await b(t,[i]),await h.logCreate({userId:h.fromReq(e),module:"kmis",subject:"List Soal Pertanyaan"},t),await t.commit();const _=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data","Data soal pertanyaan baru berhasil ditambahkan.");return a.status(201).json(_.toResponse())}catch(e){if(await t.rollback(),"OVER_QUOTA"===e.code){const t=new p(422,"OVER_QUOTA","Melebihi Batas Kuota Soal",e.message);return a.status(422).json(t.toResponse())}r.error(`| Quiz KMIS | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await s("kmis_quiz").select("*").where("id",t).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data soal pertanyaan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await w(e),i=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail data soal pertanyaan berhasil didapatkan.",n);return a.status(200).json(i.toResponse())}catch(e){r.error(`| Quiz KMIS | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await s.transaction(),{topicId:i,question:o,answerA:l,answerB:d,answerC:u,answerD:c,correctOption:m,explanation:g}=e.body,w=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const r=await t("kmis_quiz").where("id",w).first();if(!r){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data soal pertanyaan dengan ID '${w}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("kmis_quiz").whereRaw("lower(question) = lower(?)",[o]).whereNull("deleted_at").whereNot("id",w).first()){const e=new p(422,"DUPLICATE_QUESTION","Duplikat Data","Ada soal pertanyaan yang sama dengan yang anda perbarui. Silakan buat soal yang lain.");return a.status(422).json(e.toResponse())}{const e=[["A",l],["B",d],["C",u],["D",c]],t=new Map;for(const[n,i]of e){const e=k(i);if(t.has(e)){const i=t.get(e),s=new p(422,"DUPLICATE_ANSWERS","Duplikat Opsi Jawaban",`Jawaban pilihan ${n} sama dengan pilihan ${i}. Setiap opsi A sampai D harus unik.`);return a.status(422).json(s.toResponse())}t.set(e,n)}}await t("kmis_quiz").where("id",w).update({kmis_topic_id:i??r.kmis_topic_id,question:o??r.question,answer_a:l??r.answer_a,answer_b:d??r.answer_b,answer_c:u??r.answer_c,answer_d:c??r.answer_d,correct_option:m??r.correct_option,explanation:g??r.explanation,updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"List Soal Pertanyaan"},t),await t.commit();const _=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui","Data soal pertanyaan berhasil diperbarui.");return a.status(200).json(_.toResponse())}catch(e){await t.rollback(),r.error(`| Quiz KMIS | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await s.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("kmis_quiz").select("id","question","kmis_topic_id as topicId").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data soal pertanyaan yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id),l=[...new Set(s.map(e=>Number(e.topicId)))];await t("kmis_quiz").whereIn("id",r).update({deleted_at:t.fn.now()}),await b(t,l),await h.logDelete({userId:h.fromReq(e),module:"kmis",subject:"List Soal Pertanyaan"},t),await t.commit();const d=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data soal pertanyaan.`);return a.status(200).json(d.toResponse())}catch(e){await t.rollback(),r.error(`| Quiz KMIS | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await s.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const r=await t("kmis_quiz").select("id","question","kmis_topic_id as topicId").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data soal pertanyaan terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=r.map(e=>e.question?.toLowerCase?.()??""),d=await t("kmis_quiz").select(s.raw("lower(question) AS lquestion")).whereNull("deleted_at").whereIn(s.raw("lower(question)"),l),u=new Set(d.map(e=>e.lquestion)),c=new Set,m=new Set;for(const e of r){const a=(e.question||"").toLowerCase();c.has(a)?m.add(a):c.add(a)}const g=[],w=[],_=new Set;for(const e of r){const a=(e.question||"").toLowerCase(),t=u.has(a),n=m.has(a);t||n||_.has(a)?w.push({id:e.id,question:e.question}):(_.add(a),g.push(e))}let k=0;if(g.length>0){const e=g.map(e=>e.id);await t("kmis_quiz").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()});const a=[...new Set(g.map(e=>Number(e.topicId)))];await b(t,a),k=e.length}if(await h.logRestore({userId:h.fromReq(e),module:"kmis",subject:"List Soal Pertanyaan"},t),await t.commit(),0===k){const e=new p(422,"DUPLICATE_QUESTION","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const f=[`Berhasil mengembalikan ${k} data yang terhapus.`];w.length&&f.push(`Terlewat ${w.length} karena bentrok/duplikat data.`);const y=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",f.join(" "));return a.status(200).json(y.toResponse())}catch(e){r.error(`| Quiz KMIS | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.downloadTemplate=async(e,a)=>{try{const[e,t]=await Promise.all([s("kmis_topics as t").join("kmis_categories as c","c.id","t.kmis_categories_id").whereNull("t.deleted_at").whereNull("c.deleted_at").select({id:"t.id",topicName:"t.title",topicDescription:"t.description",totalQuiz:"t.total_quiz",categoryId:"c.id",categoryName:"c.title"}).orderBy("t.id","asc"),s("kmis_categories as c").whereNull("c.deleted_at").select({id:"c.id",name:"c.title",description:"c.description"}).orderBy("c.id","asc")]),n=[["topicId","question","answerA","answerB","answerC","answerD","correctOption","explanation"],["(number)","(text)","(text)","(text)","(text)","(text)","A/B/C/D","(text, optional)"]],r=i.utils.aoa_to_sheet(n);r["!cols"]=[{wch:15},{wch:120},{wch:25},{wch:25},{wch:25},{wch:25},{wch:20},{wch:120}];const o=[["TOPICS (pakai kolom 'id' untuk diisi ke 'topicId' pada sheet Template)"],["id","categoryName","topicName","description","totalQuiz"],...e.map(e=>[e.id,e.categoryName,e.topicName,e.topicDescription,e.totalQuiz??""])],l=i.utils.aoa_to_sheet(o);l["!cols"]=[{wch:8},{wch:40},{wch:40},{wch:40},{wch:12}];const d=i.utils.book_new();i.utils.book_append_sheet(d,r,"Template"),i.utils.book_append_sheet(d,l,"Referensi");const u=i.write(d,{bookType:"biff8",type:"buffer"});return a.setHeader("Content-Disposition",'attachment; filename="quiz_template.xls"'),a.setHeader("Content-Type","application/vnd.ms-excel"),a.status(200).send(u)}catch(e){await trx.rollback(),r.error(`| Quiz KMIS | - Error function downloadTemplate : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(t.toResponse())}},a.importTemplate=async(e,a)=>{const t=await s.transaction(),o=Number(e.userId);try{if(!e.files||0===e.files.length){const e=new p(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File soal pertanyaan wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>1){const e=new p(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file.");return a.status(422).json(e.toResponse())}const s=e.files[0];if(!new Set(["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","application/csv"]).has(s.mimetype)){const e=new p(422,"INVALID_FILE_TYPE","Tipe File Tidak Didukung","Format file harus .xls, .xlsx, atau .csv.");return a.status(422).json(e.toResponse())}let d;try{d=i.read(s.buffer,{type:"buffer"})}catch(e){const t=new p(422,"BAD_EXCEL","File Excel Tidak Valid","File Excel rusak atau tidak dapat dibaca.");return a.status(422).json(t.toResponse())}const u=d.SheetNames.find(e=>"template"===e.toLowerCase())||d.SheetNames[0],c=d.Sheets[u];if(!c){const e=new p(422,"SHEET_NOT_FOUND","Sheet Tidak Ditemukan",'Sheet "Template" tidak ditemukan pada file yang diunggah.');return a.status(422).json(e.toResponse())}const m=i.utils.sheet_to_json(c,{header:1,defval:null,blankrows:!1});if(!m.length){const e=new p(422,"EMPTY_SHEET","Sheet Kosong","Sheet Template tidak berisi data.");return a.status(422).json(e.toResponse())}const w=m[0].map(e=>String(e??"").trim().toLowerCase()),_=["topicid","question","answera","answerb","answerc","answerd","correctoption","explanation"];if(w.join("|")!==_.join("|")){const e=new p(422,"HEADER_MISMATCH","Format Header Tidak Sesuai","Header pada sheet Template tidak sesuai dengan format terbaru.");return a.status(422).json(e.toResponse())}const f=e=>null==e?"":String(e).trim(),y=e=>{if(null==e||""===e)return NaN;const a=Number(e);return Number.isInteger(a)?a:NaN},R=new Set(["(number)","(text)","A/B/C/D","(optional)"]),E=(l=m[1],Array.isArray(l)&&l.some(e=>"string"==typeof e&&R.has(e.trim()))?2:1),D=E+1,T=m.slice(E),S=[],A=[];for(let e=0;e<T.length;e++){const a=T[e]||[];if(a.every(e=>null===e||""===e))continue;const t=D+e,i={topicId:y(a[0]),question:f(a[1]),answerA:f(a[2]),answerB:f(a[3]),answerC:f(a[4]),answerD:f(a[5]),correctOption:f(a[6]).toUpperCase(),explanation:(()=>{const e=f(a[7]);return""===e?null:e})()};{const e=[["A",i.answerA],["B",i.answerB],["C",i.answerC],["D",i.answerD]],a=new Map;let n=null;for(const[i,s]of e){const e=k(s);if(a.has(e)){n=`Baris ${t}: Jawaban pilihan ${i} sama dengan pilihan ${a.get(e)}. Setiap opsi A sampai D harus unik.`;break}a.set(e,i)}if(n){A.push(n);continue}}const s={body:i};await Promise.all(g.map(e=>e.run(s)));const r=n(s);r.isEmpty()?S.push({excelRowNum:t,...i}):A.push(`Baris ${t}: ${r.array().map(e=>e.msg).join(" ")}`)}if(!S.length){const e=new p(422,"NO_VALID_ROWS","Tidak Ada Data Valid",A.length?A.join(" "):"Tidak ada baris data yang dapat diproses.");return a.status(422).json(e.toResponse())}const I=new Map;for(const e of S){const a=e.question.toLowerCase();if(I.has(a)){const t=I.get(a);A.push(`Baris ${e.excelRowNum}: Duplikat pertanyaan dengan baris ${t}.`)}else I.set(a,e.excelRowNum)}if(A.length){const e=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",A.join(" "));return a.status(422).json(e.toResponse())}const N=[...new Set(S.map(e=>e.topicId))],j=await t("kmis_topics as t").leftJoin("kmis_categories as c","c.id","t.kmis_categories_id").whereIn("t.id",N).whereNull("t.deleted_at").whereNull("c.deleted_at").select("t.id"),v=new Set(j.map(e=>Number(e.id)));for(const e of S)v.has(e.topicId)||A.push(`Baris ${e.excelRowNum}: topicId (${e.topicId}) tidak valid / tidak ditemukan.`);if(A.length){const e=new p(422,"INVALID_RELATION","Relasi Tidak Valid",A.join(" "));return a.status(422).json(e.toResponse())}const O=[...I.keys()],L=await t("kmis_quiz").select("question").whereNull("deleted_at").whereIn(t.raw("lower(question)"),O);if(L.length){const e=new Set(L.map(e=>e.question.toLowerCase()));for(const a of S)e.has(a.question.toLowerCase())&&A.push(`Baris ${a.excelRowNum}: Soal pertanyaan sudah ada di database. Silakan buat soal yang lain.`);const t=new p(422,"DUPLICATE_QUESTION","Duplikat Pada Database",A.join(" "));return a.status(422).json(t.toResponse())}try{const n=S.map(e=>({created_by:o,kmis_topic_id:e.topicId,question:e.question,answer_a:e.answerA,answer_b:e.answerB,answer_c:e.answerC,answer_d:e.answerD,correct_option:e.correctOption,explanation:e.explanation}));await t("kmis_quiz").insert(n);const i=[...new Set(S.map(e=>e.topicId))];await b(t,i),await h.logCreate({userId:h.fromReq(e),module:"kmis",subject:`Import Soal Pertanyaan (${n.length})`},t),await t.commit();const s=new p(201,"SUCCESS_IMPORT","Berhasil Mengimpor Data",`Berhasil mengimpor ${n.length} soal pertanyaan.`);return a.status(201).json(s.toResponse())}catch(e){const t=new p(500,"SERVER_ERROR","Server Sedang Error","Gagal menyimpan data ke database.");return r.error(`| Quiz KMIS | - Error function importTemplate (DB): ${e.message}`),a.status(500).json(t.toResponse())}}catch(e){await t.rollback(),r.error(`| Quiz KMIS | - Error function importTemplate : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}var l}},5726:(e,a,t)=>{const n=t(4930),i=t(1004),s=t(3034);e.exports=async function(e){const[a,t]=await Promise.all([e.created_by?n("users").where("id",e.created_by).first():null,e.monev_activity_category_id?n("monev_activity_categories").where("id",e.monev_activity_category_id).first():null]);return{id:e.id,createdUser:a?await s(a):null,activityCategory:t?await i(t):null,name:e.name,description:e.description,location:e.location,startedDate:e.started_date,finishedDate:e.finished_date,startedTime:e.started_time,finishedTime:e.finished_time,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},5730:(e,a,t)=>{const n=t(7252).Router(),i=t(4525),{storeContentValidator:s}=t(1328),{updateContentValidator:r}=t(6806),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)({limits:{fileSize:419430400}});n.use(d,l),n.post("/create",u(["create.cms_management"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.array("files",20),r,o,i.update),e.exports=n},5751:e=>{"use strict";e.exports=require("xlsx")},5789:e=>{"use strict";e.exports=require("dayjs/plugin/timezone")},5794:(e,a,t)=>{const n=t(6870),i=t(7484),s=t(4930),{resolveArrayRelations:r}=t(7972);function o(e){return(Array.isArray(e)?e:[e]).filter(Boolean).map(e=>String(e).trim().toLowerCase())}e.exports=function(e,a={}){const t="all"===a.mode?"all":"any",l=o(e);return async(e,a,d)=>{try{if(!e.userId){const e=new n(401,"UNAUTHORIZED","Akses Ditolak","Token tidak valid atau sesi tidak ditemukan.");return a.status(401).json(e.toResponse())}let u=Array.isArray(e.auth?.permissions)?o(e.auth.permissions):null;if(!u){const a=await s("users as u").leftJoin("roles as r","r.id","u.role_id").where("u.id",e.userId).select("r.permission_ids").first();u=o(await r(a?.permission_ids,"permissions",e=>e?.key?String(e.key).trim().toLowerCase():null)),e.auth=e.auth||{},e.auth.permissions=u}if(0===u.length){const e=new n(403,"NO_ACCESS","Tidak Memiliki Akses","Anda tidak memiliki permission yang dibutuhkan.");return a.status(403).json(e.toResponse())}const c=new Set(u);if(!("all"===t?l.every(e=>c.has(e)):l.some(e=>c.has(e)))){i.info(`| Permission | - Denied userId=${e.userId}; need(${t})=[${l.join(", ")}], has=[${u.join(", ")}]`);const s=new n(403,"NO_ACCESS","Tidak Memiliki Akses","Anda tidak memiliki akses untuk mengakses halaman ini.");return a.status(403).json(s.toResponse())}d()}catch(e){i.error(`| Permission | - Error: ${e.message}`);const t=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}}},5852:(e,a,t)=>{const{body:n}=t(7975);a.verifyOTPValidator=[n("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail.com atau yang lain."),n("otp").notEmpty().withMessage("OTP tidak boleh kosong, silahkan masukkan kode OTP yang berasal dari email yang Anda terima.").bail().isLength({min:6,max:6}).withMessage("Kode OTP harus terdiri dari 6 digit.")]},6004:(e,a,t)=>{const n=t(4930),i=t(3034);e.exports=async function(e){const[a,t]=await Promise.all([e.validate_by?n("users").where("id",e.validate_by).first():null,e.edited_by?n("users").where("id",e.edited_by).first():null]);return{id:e.id,validatedUser:a?await i(a):null,editedUser:t?await i(t):null,month:e.month,year:e.year,budgetTarget:e.budget_target,physicalTarget:e.physical_target,description:e.description,validationStatus:e.validation_status,rejectionReason:e.rejection_message,validateAt:e.validate_at,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},6039:e=>{"use strict";e.exports=require("smtp-connection")},6079:(e,a,t)=>{const n=t(7252).Router(),i=t(7580),{storeFaqValidator:s}=t(2299),{updateFaqValidator:r}=t(957),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.cms_management"]),i.index),n.get("/show/:id",u(["view.cms_management"]),i.show),n.post("/create",u(["create.cms_management"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.cms_management"]),i.destroy),n.patch("/restore",u(["restore.cms_management"]),i.restore),e.exports=n},6087:(e,a,t)=>{const n=t(7252).Router(),i=t(9654),{loginValidator:s}=t(1501),{resetPasswordValidator:r}=t(1244),{verifyOTPValidator:o}=t(5852),{sendOTPValidator:l}=t(3123),{createAccountValidator:d}=t(4631),u=t(2110),c=t(9022),m=t(6967),p=t(8461)();n.post("/sso/signin",m,p.none(),s,(e,a)=>i.signInAdminSSO(e,a)),n.post("/admin/signin",m,p.none(),s,(e,a)=>i.signInEducator(e,a)),n.post("/monev/signin",m,p.none(),s,(e,a)=>i.signInMonev(e,a)),n.post("/signin",m,p.none(),s,(e,a)=>i.signInStudent(e,a)),n.post("/signup",m,p.none(),d,u,i.createAccount),n.post("/oauth",m,i.createOrLoginWithOauth),n.post("/send-otp",m,p.none(),l,u,i.sendOTP),n.post("/verify-otp",m,p.none(),o,u,i.verifyOTP),n.post("/reset-password",m,p.none(),r,u,i.resetPassword),n.get("/signout",m,c,i.logout),e.exports=n},6113:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=t(1784),r=e=>String(e??"").trim().toLowerCase().replace(/\s+/g," "),o=(e,a)=>{const t=String(a||"").trim().toLowerCase().replace(/\s+/g,"_");return 1===Number(e)||"super_admin"===t},l=e=>{if(null==e)return!1;const a=String(e).trim();return!!a&&!/^null$/i.test(a)&&!/^undefined$/i.test(a)};a.profileValidator=[n("name").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).isString().withMessage("Nama harus berupa teks.").bail().trim().isLength({max:150}).withMessage("Nama maksimal 150 karakter.").bail().custom(async(e,{req:a})=>{const t=Number(a.auth?.userId)??Number(a.params?.id)??null,n=Number.isFinite(t)?await i("users as u").leftJoin("roles as r","r.id","u.role_id").select("u.id","u.name as current_name","r.name as role_name").where("u.id",t).whereNull("u.deleted_at").first():null;if(n&&o(t,n.role_name)){if(r(e)!==r(n.current_name))throw new Error("Akun super admin tidak boleh mengubah nama.");return!0}if(await i("users").select("id").whereNull("deleted_at").whereRaw("LOWER(name) = LOWER(?)",[e]).modify(e=>{Number.isFinite(t)&&e.andWhereNot("id",t)}).first())throw new Error("Nama sudah digunakan.");return!0}),n("email").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).isString().withMessage("Email harus berupa teks.").bail().trim().isEmail().withMessage("Silakan masukkan email yang valid.").isLength({max:254}).withMessage("Email maksimal 254 karakter.").bail().custom(async(e,{req:a})=>{const t=Number(a.auth?.userId)??Number(a.params?.id)??null,n=Number.isFinite(t)?await i("users as u").leftJoin("roles as r","r.id","u.role_id").select("u.id","u.email as current_email","r.name as role_name").where("u.id",t).whereNull("u.deleted_at").first():null;if(n&&o(t,n.role_name)){if(String(e).trim().toLowerCase()!==String(n.current_email||"").trim().toLowerCase())throw new Error("Akun super admin tidak boleh mengubah email.");return!0}if(await i("users").select("id").whereNull("deleted_at").where("email",e).modify(e=>{Number.isFinite(t)&&e.andWhereNot("id",t)}).first())throw new Error("Email ini sudah digunakan.");return!0}),n("birthDate").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).custom(e=>{if(!s.isIso8601Z(e))throw new Error("Tanggal lahir harus ISO 8601 dengan Z/offset, contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.");const a=s.toUTC(e);if(!a)throw new Error("Tanggal lahir tidak valid.");const t=new Date,n=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),i=new Date("1900-01-01T00:00:00.000Z");if(a>n)throw new Error("Tanggal lahir tidak boleh di masa depan.");if(a<i)throw new Error("Tanggal lahir tidak masuk akal.");return!0}),n("gender").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).custom(e=>{const a=Number(e);if(!Number.isInteger(a)||![0,1].includes(a))throw new Error("Gender hanya boleh 0 atau 1.");return!0}),n("phoneNumber").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).isString().withMessage("Nomor telepon harus berupa teks.").bail().trim().isLength({max:30}).withMessage("Nomor telepon maksimal 30 karakter."),n("profession").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).isString().withMessage("Profesi harus berupa teks.").bail().trim().isLength({max:100}).withMessage("Profesi maksimal 100 karakter."),n("address").optional({nullable:!0,checkFalsy:!0}).if(e=>l(e)).isString().withMessage("Alamat harus berupa teks.").bail().trim().isLength({max:2e3}).withMessage("Alamat terlalu panjang (maksimal 2000 karakter).")]},6144:(e,a,t)=>{const{body:n}=t(7975);a.updateAnimalCategoryValidator=[n("name").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},6154:e=>{"use strict";e.exports=require("google-auth-library")},6167:e=>{"use strict";e.exports=require("dayjs/plugin/advancedFormat")},6192:(e,a,t)=>{const n=t(4930);e.exports={asJsonb:function(e){return n.raw("?::jsonb",[JSON.stringify(e)])}}},6279:(e,a,t)=>{const{body:n}=t(7975);a.storeEventsCategoryValidator=[n("name").custom(e=>{if(void 0===e)throw new Error("Nama kategori kegiatan wajib diisi.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi kategori kegiatan wajib diisi.");return!0})]},6285:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{isPlainObject:r,normIdArray:o,handleLocalizedText:l}=t(7872),{applyJsonbSearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),m=t(1332),p=t(6870),g=t(2273),w=t(6479),{applyTrashedScope:h}=t(7438),{applyLatestThenTrashed:_}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("cms_events_categories as category").select("category.*");h(n,e,"category.deleted_at"),d(n,t,["category.name->>'id'","category.name->>'en'","category.description->>'id'","category.description->>'en'"],{mode:"or",split:!0}),_(n,"category.deleted_at","category.created_at","category.id");const s=u(e.query),r=await c(n,s,i);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>g(e))),l=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kategori kegiatan berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| Event Category Master | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{name:r,description:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=l(r,{allowPartial:!1,maxLen:void 0,fieldLabel:"name"});if(s.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const d=l(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(d.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",d.error.message);return a.status(422).json(e.toResponse())}if(await t("cms_events_categories").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(name->>'en') = lower(?)",[s.value.en])}).first()){await t.rollback();const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori kegiatan ini sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_events_categories").insert({name:{id:s.value.id,en:s.value.en},description:{id:d.value.id,en:d.value.en}}),await w.logCreate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Kegiatan"},t),await t.commit();const u=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kategori kegiatan '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Event Category Master | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_events_categories").select("*").where("id",t).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await g(e),s=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kategori kegiatan '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Event Category Master | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{name:o,description:d}=e.body,u=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_events_categories").where("id",u).first();if(!s){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kategori kegiatan dengan ID '${u}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const c=r(s.name)?s.name:parseJsonSafe(s.name)??{id:"",en:""},m=r(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""};let g=c;if(void 0!==o){const e=l(o,{allowPartial:!0,maxLen:void 0,fieldLabel:"nama"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...c,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=c.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=c.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Nama harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}g={id:String(t.id).trim(),en:String(t.en).trim()}}let h=m;if(void 0!==d){const e=l(d,{allowPartial:!0,maxLen:void 0,fieldLabel:"deskripsi"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...m,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=m.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=m.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}h={id:String(t.id).trim(),en:String(t.en).trim()}}if(((g.id??"").toLowerCase()!==(c.id??"").toLowerCase()||(g.en??"").toLowerCase()!==(c.en??"").toLowerCase())&&await t("cms_events_categories").whereNull("deleted_at").whereNot("id",u).andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[g.id]).orWhereRaw("lower(name->>'en') = lower(?)",[g.en])}).first()){const e=new p(422,"DUPLICATE_NAME","Duplikat Data","Nama kategori berita (ID/EN) sudah digunakan pada kategori lain.");return a.status(422).json(e.toResponse())}await t("cms_events_categories").where("id",u).update({name:g,description:h,updated_at:t.fn.now()}),await w.logUpdate({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Kegiatan"},t),await t.commit();const _=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kategori kegiatan '${g.id}' berhasil diperbarui.`);return a.status(200).json(_.toResponse())}catch(e){await t.rollback(),s.error(`| Event Category Master | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_events_categories").select("id","name").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori kegiatan yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_events_categories").whereIn("id",r).update({deleted_at:t.fn.now()}),await w.logDelete({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Kegiatan"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data kategori kegiatan.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| Event Category Master | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const l=await t("cms_events_categories").select("id","name").whereIn("id",n).whereNotNull("deleted_at");if(0===l.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const d=e=>{const a=r(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=l.map(e=>{const a=d(e.name);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let g=[];(c.length||m.length)&&(g=await t("cms_events_categories").select("id","name").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(name->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(name->>'en')"),m):this.whereIn(i.raw("lower(name->>'en')"),m))}));const h=new Set;for(const e of g){const a=d(e.name);a.idLower&&h.add(`id:${a.idLower}`),a.enLower&&h.add(`en:${a.enLower}`)}const _=new Set,k=new Set,b=new Set;for(const e of u)e.idLower&&(_.has(e.idLower)?b.add(`id:${e.idLower}`):_.add(e.idLower)),e.enLower&&(k.has(e.enLower)?b.add(`en:${e.enLower}`):k.add(e.enLower));const f=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&h.has(a)||t&&h.has(t),i=a&&b.has(a)||t&&b.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,name:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),f.push(e))}let D=0;if(f.length>0){const e=f.map(e=>e.rowId);await t("cms_events_categories").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await w.logRestore({userId:w.fromReq(e),module:"master_data",subject:"List Kategori Kegiatan"},t),await t.commit(),0===D){const e=new p(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| Event Category Master | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},6293:e=>{"use strict";e.exports=require("dayjs")},6321:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(4930),s=t(2482),r=t(3034);e.exports=async function(e){const a=e.created_by?await i("users").where("id",e.created_by).first():null,t=await n(e.report_file_ids,"documents",s);return{id:e.id,createdUser:a?await r(a):null,report:t,name:e.name,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},6348:(e,a,t)=>{const n=t(9896),i=t(6928);e.exports=function(e,a={}){const t=i.join(__dirname,"..","..","templates","email",e);let s=n.readFileSync(t,"utf8");for(const e in a){const t=new RegExp(`{{\\s*${e}\\s*}}`,"g");s=s.replace(t,a[e])}return s}},6365:(e,a,t)=>{const n=t(7252).Router(),i=t(1483),{storeLearningAttemptValidator:s}=t(4949),{updateFeedbackValidator:r}=t(9819),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(7443),m=t(8461)();n.get("/get-material-public/:id",d,i.getPublicMaterialbyId),n.get("/get-all-learning-attempt",d,l,c("student"),u(["view.kmis_learning_course"]),i.getListLearningAttempt),n.get("/show/:id",d,i.getDetailLearningAttemptbyTopicId),n.get("/detail/:id",d,l,c("student"),u(["view.kmis_learning_course"]),i.getOrderMaterialLearningAttemptbyTopicId),n.get("/get-material/:id",d,l,c("student"),u(["view.kmis_learning_course"]),i.getLearningAttemptMaterialbyId),n.get("/get-quiz-by-topic/:id",d,l,c("student"),u(["view.kmis_learning_course"]),i.getAllQuizbyTopicId),n.get("/get-quiz-with-answer/:id",d,l,c("student"),u(["view.kmis_learning_course"]),i.getQuizAttemptbylearningAttemptId),n.post("/create",d,l,c("student"),u(["create.kmis_learning_course"]),m.none(),s,o,i.storeLearningAttempt),n.patch("/update/:id",d,l,c("student"),u(["edit.kmis_learning_course"]),i.updateProgressLearningAttempt),n.patch("/feedback/:id",d,l,c("student"),u(["edit.kmis_learning_course"]),m.none(),r,o,i.feedback),n.get("/get-finished-attempt/:id",d,l,c("student"),u(["view.kmis_learning_course"]),i.getLearningAttemptCompletedById),e.exports=n},6397:(e,a,t)=>{const{body:n}=t(7975);a.storeMonevUserValidator=[n("name").notEmpty().withMessage("Nama akun monev (Non PIC) tidak boleh kosong.").bail().isString().withMessage("Nama akun monev (Non PIC) harus berupa teks.").bail().isLength({max:255}).withMessage("Nama akun monev (Non PIC) maksimal 255 karakter."),n("email").notEmpty().withMessage("Email pengajar tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.").bail().isString().withMessage("Email pengajar harus berupa teks.")]},6417:(e,a,t)=>{const n=t(4930);function i(e){return String(e||"").trim().replace(/^::ffff:/,"")}function s(e){const a=i(e);return!a||(a.includes(":")?"::1"===a||a.startsWith("fe80")||a.startsWith("fc")||a.startsWith("fd"):function(e){const a=e.split(".").map(Number);return 4===a.length&&!a.some(e=>Number.isNaN(e))&&(10===a[0]||172===a[0]&&a[1]>=16&&a[1]<=31||192===a[0]&&168===a[1]||127===a[0]||169===a[0]&&254===a[1])}(a))}function r(e){const a=i(e.headers["cf-connecting-ip"]);if(a)return a;const t=i(e.headers["true-client-ip"]);if(t)return t;const n=function(e){if(!e)return null;const a=String(e).split(",").map(e=>i(e)).filter(Boolean);for(const e of a)if(!s(e))return e;return a[0]||null}(e.headers["x-forwarded-for"]);if(n)return n;const r=i(e.headers["x-real-ip"]);return r||i(e.ip||e.connection?.remoteAddress||e.socket?.remoteAddress||e.connection?.socket?.remoteAddress)}function o(e){const a=(e.headers["cf-ipcountry"]||"").trim();return a||((e.headers["x-geo-country"]||e.headers["x-country-code"]||"").trim()||null)}e.exports={trackTopicViewsForReq:async function(e,a){if(!Array.isArray(e)||0===e.length)return;const t=r(a);if(!t)return;const i=o(a),s=Array.from(new Set(e.map(Number).filter(e=>Number.isFinite(e)&&e>0)));0!==s.length&&await n.transaction(async e=>{await e.raw("\n      WITH ids AS (SELECT UNNEST(?::bigint[]) AS id),\n      ins AS (\n        INSERT INTO kmis_topic_views (kmis_topic_id, viewer_ip, viewer_region, view_date)\n        SELECT ids.id, ?::inet, ?::text, CURRENT_DATE\n        FROM ids\n        ON CONFLICT ON CONSTRAINT uniq_topic_ip_date DO NOTHING\n        RETURNING kmis_topic_id\n      ),\n      agg AS (\n        SELECT kmis_topic_id, COUNT(*)::int AS add_count\n        FROM ins\n        GROUP BY kmis_topic_id\n      )\n      UPDATE kmis_topics t\n      SET total_views = COALESCE(t.total_views, 0) + agg.add_count\n      FROM agg\n      WHERE t.id = agg.kmis_topic_id\n      ",[s,t,i])})},getClientIp:r,getViewerRegion:o}},6479:(e,a,t)=>{const n=t(4930),i=t(7484),s=t(1784),r=new Set(["profile","kmis","cms","monev","master_data"]),o=new Set(["create","update","delete","restore"]);e.exports=class{static table="activity_logs";static fromReq(e){return e.auth?.userId??e.auth?.user_id??e.auth?.id??e.userId??e.user?.id??null}static _verbByKey(e){switch(e){case"create":return"Menambahkan";case"update":return"Memperbarui";case"delete":return"Menghapus";case"restore":return"Mengembalikan";default:return"Melakukan"}}static _buildAutoDescription({key:e,subject:a="entitas",notes:t=null,now:n=new Date}){let i=`${this._verbByKey(e)} data '${a}' pada '${s.formatTanggalIndonesia(n,2)}'.`;return t&&(i+=` ${t}`),i}static _normalize({userId:e=null,module:a,key:t,description:i=null,subject:s=null,notes:l=null}){if(!r.has(a))throw new Error(`activity_logs.module tidak valid: '${a}'`);if(!o.has(t))throw new Error(`activity_logs.key tidak valid: '${t}'`);return{user_id:e??null,module:a,key:t,description:i&&String(i).trim().length?i:this._buildAutoDescription({key:t,subject:s,notes:l}),updated_at:n.fn.now()}}static async log(e,a=null){const t=this._normalize(e),i=a||n,s=await i(this.table).insert(t).returning("id");return Array.isArray(s)?"object"==typeof s[0]?s[0].id:s[0]:s}static async tryLog(e,a=null){try{return await this.log(e,a)}catch(e){return i.warn(`| ActivityLog | - Gagal mencatat aktivitas: ${e.message}`),null}}static async logCreate(e,a){return this.tryLog({...e,key:"create"},a)}static async logUpdate(e,a){return this.tryLog({...e,key:"update"},a)}static async logDelete(e,a){return this.tryLog({...e,key:"delete"},a)}static async logRestore(e,a){return this.tryLog({...e,key:"restore"},a)}}},6516:(e,a,t)=>{const n=t(7252).Router(),i=t(4289),{storeNewsValidator:s}=t(4534),{updateNewsValidator:r}=t(2732),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.cms_management"]),i.index),n.get("/show/:id",u(["view.cms_management"]),i.show),n.post("/create",u(["create.cms_management"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.array("files",20),r,o,i.update),n.delete("/delete",u(["delete.cms_management"]),i.destroy),n.patch("/restore",u(["restore.cms_management"]),i.restore),e.exports=n},6561:(e,a,t)=>{const{body:n}=t(7975),i=Object.freeze([2,3]);a.updateMonthlyRealizationVerificationValidator=[n("validationStatus").exists({checkNull:!0,checkFalsy:!0}).withMessage("Status validasi tidak boleh kosong.").bail().toInt().isInt().withMessage("Status validasi harus bilangan bulat.").bail().isIn(i).withMessage("Status validasi harus 2 (Approve) atau 3 (Rejected)."),n("rejectionReason").optional({nullable:!0}).isString().withMessage("Alasan penolakan harus berupa teks.").bail().trim(),n("rejectionReason").custom((e,{req:a})=>{if(3===Number(a.body.validationStatus)&&(null==e||""===String(e).trim()))throw new Error("Alasan penolakan wajib diisi saat status = 3 (Rejected).");return!0}),n("rejectionReason").customSanitizer((e,{req:a})=>2===Number(a.body.validationStatus)?null:"string"==typeof e?e.trim():e??null)]},6567:(e,a,t)=>{const{body:n}=t(7975);a.storeLegalDocumentValidator=[n("title").custom(e=>{if(void 0===e)throw new Error("Judul kegiatan tidak boleh kosong.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi kegiatan tidak boleh kosong.");return!0})]},6611:(e,a,t)=>{const{body:n}=t(7975);a.storeActivityCategoryValidator=[n("title").notEmpty().withMessage("Judul kategori tidak boleh kosong.").bail().isString().withMessage("Judul kategori harus berupa teks.").bail().isLength({max:255}).withMessage("Judul kategori maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi kategori tidak boleh kosong.").bail().isString().withMessage("Deskripsi kategori harus berupa teks.")]},6716:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4729),s=t(4930),r=t(7484),o=t(1572),{applySearch:l,applyPagination:d,formatPaginationResult:u}=t(3210),{normIdArray:c}=t(7872),m=t(1332),p=t(6870),g=t(6348),w=t(2024),h=t(6479),{stripTitlesOnly:_,generateRandomPassword:k}=t(337),{checkEmailDeliverability:b}=t(8467),{applyTrashedScope:f}=t(7438);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=s("users as user").leftJoin("roles as role","user.role_id","role.id").where("user.role_id",4).select("user.*").orderBy("user.created_at","desc");f(n,e,"user.deleted_at"),l(n,t,["user.name","user.email"]);const i=d(e.query),r=await u(n,i,s);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=r.data.map(e=>e.id),c=await s("kmis_learning_attempts").whereIn("attempt_by",o).whereNull("deleted_at").groupBy("attempt_by").select("attempt_by").count({total:"*"}),g=new Map(c.map(e=>[Number(e.attempt_by),Number(e.total)])),h=await Promise.all(r.data.map(e=>w({...e,total_topic:g.get(e.id)??0}))),_=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data akun peserta berhasil diambil.",{data:h,pagination:r.pagination});return a.status(200).json(_.toResponse())}catch(e){r.error(`| Student KMIS | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await s.transaction(),{name:l,email:d}=e.body;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const u=await b(d,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(r.info(`[email-check] ${d} -> ${u.ok} (${u.reason}) ${JSON.stringify(u.detail||[])}`),!u.ok){const e=new p(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${d}' tampaknya tidak dapat menerima email. Gunakan email valid yang lain.`);return a.status(422).json(e.toResponse())}if(await t("users").whereRaw("lower(email) = lower(?)",[d]).whereNull("deleted_at").first()){const e=new p(422,"DUPLICATE_EMAIL","Duplikat Data",`Email '${d}' sudah digunakan oleh akun peserta lain. Silakan gunakan email lain.`);return a.status(422).json(e.toResponse())}const c=_(l),m=k(8),w=await i.hash(m,12),[f]=await t("users").insert({name:l,email:d,role_id:4,account_status:2,password:w}).returning(["id","name","email","created_at"]);await h.logCreate({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit();const y=o.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),R=g("credential_student.html",{name:c,email:f.email,password:m,login_url:process.env.APP_LOGIN_URL||"#",from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await y.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:f.email,subject:"Credential Akun Peserta RIMBA",html:R}),r.info(`| Student KMIS | - Credential email successfully sent to ${f.email} at ${(new Date).toISOString()}`);const E=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data akun peserta '${c}' berhasil ditambahkan.`);return a.status(201).json(E.toResponse())}catch(e){await t.rollback(),r.error(`| Student KMIS | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await s("users").select("*").where("id",t).where("role_id",4).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data peserta dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await w(e),i=_(e.name),r=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data peserta '${i}' berhasil didapatkan.`,n);return a.status(200).json(r.toResponse())}catch(e){r.error(`| Student KMIS | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await s.transaction(),{name:i,email:o,accountStatus:l}=e.body,d=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(!await t("users").where("id",d).where("role_id",4).first()){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data peserta dengan ID '${d}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const u=await b(o,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(r.info(`[email-check] ${o} -> ${u.ok} (${u.reason}) ${JSON.stringify(u.detail||[])}`),!u.ok){const e=new p(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${o}' tampaknya tidak dapat menerima email. Gunakan email valid yang lain.`);return a.status(422).json(e.toResponse())}if(await t("users").whereRaw("lower(email) = lower(?)",[o]).whereNull("deleted_at").whereNot("id",d).first()){const e=new p(422,"DUPLICATE_TITLE","Duplikat Data",`Email '${o}' sudah digunakan pada pengguna lain.`);return a.status(422).json(e.toResponse())}const c={name:i,email:o,updated_at:t.fn.now()};!0===l?(c.account_status=2,c.deactivate_at=null):(c.account_status=3,c.deactivate_at=t.fn.now()),await t("users").where("id",d).update(c),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit();const m=new p(200,"SUCCESS_UPDATE_DATA",l?"Berhasil Mengaktifkan Akun":"Berhasil Menonaktifkan Akun",l?`Akun peserta dengan email '${o}' berhasil diaktifkan dan datanya diperbarui.`:`Akun peserta dengan email '${o}' berhasil dinonaktifkan dan datanya diperbarui.`);return a.status(200).json(m.toResponse())}catch(e){await t.rollback(),r.error(`| Student KMIS | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",4).where("account_status",3).whereNotNull("deactivate_at").select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_DELETED","Akun Sudah Dihapus",`Terdapat ${s.length} akun peserta yang sudah dihapus: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").whereIn("id",n).where("role_id",4).whereNot("account_status",3).select("id","name");if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data pengguna yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:3,deactivate_at:t.fn.now(),deleted_at:t.fn.now()}),await h.logDelete({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) dan menonaktifkan ${o.length} data peserta.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),r.error(`| Student KMIS | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const r=await t("users").whereIn("id",n).where("role_id",4).where("account_status",2).whereNull("deleted_at").select("id","name");if(r.length>0){await t.rollback();const e=r.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=r.length>5?`, dan ${r.length-5} lainnya`:"",i=new p(409,"ACCOUNT_NOT_DELETED","Akun Belum Terhapus",`Terdapat ${r.length} akun peserta yang belum terhapus atau sudah dikembalikan: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const o=await t("users").select("id","email").whereIn("id",n).where("role_id",4).where("account_status",3).whereNotNull("deleted_at");if(0===o.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data akun peserta terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=o.map(e=>(e.email||"").toLowerCase()),d=await t("users").select(s.raw("lower(email) AS lemail")).whereNull("deleted_at").whereIn(s.raw("lower(email)"),l),u=new Set(d.map(e=>e.lemail)),m=new Set,g=new Set;for(const e of o){const a=(e.email||"").toLowerCase();m.has(a)?g.add(a):m.add(a)}const w=[],_=[],k=new Set;for(const e of o){const a=(e.email||"").toLowerCase(),t=u.has(a),n=g.has(a);t||n||k.has(a)?_.push({id:e.id,email:e.email}):(k.add(a),w.push(e))}let b=0;if(w.length>0){const e=w.map(e=>e.id);await t("users").whereIn("id",e).update({deleted_at:null,account_status:2,deactivate_at:null,updated_at:t.fn.now()}),b=e.length}if(await h.logRestore({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit(),0===b){const e=new p(422,"DUPLICATE_EMAIL","Restore Gagal","Semua ID gagal direstore karena duplikat email dengan entri aktif atau duplikat email di dalam batch.");return a.status(422).json(e.toResponse())}const f=[`Berhasil mengembalikan dan mengaktifkan kembali ${b} data peserta.`];_.length&&f.push(`Terlewat ${_.length} karena konflik/duplikat email.`);const y=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",f.join(" "));return a.status(200).json(y.toResponse())}catch(e){r.error(`| Student KMIS | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.deactivateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.deactivateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deactivateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",4).where("account_status",3).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_INACTIVE","Akun Sudah Nonaktif",`Terdapat ${s.length} akun peserta yang sudah nonaktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id","email").whereIn("id",n).where("role_id",4).whereNull("deleted_at").whereNot("account_status",3);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun peserta yang cocok untuk dinonaktifkan atau akun sudah nonaktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:3,deactivate_at:t.fn.now(),updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil menonaktifkan ${o.length} akun peserta.`];l>0&&d.push(`Terlewat ${l} data, karena sudah nonaktif atau telah dihapus.`);const u=new p(200,"SUCCESS_DEACTIVATE_ACCOUNT","Berhasil Nonaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),r.error(`| Student KMIS | - Error function deactivateAccount : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.activateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.activateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan activateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",4).where("account_status",2).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_ACTIVE","Akun Sudah Aktif",`Terdapat ${s.length} akun peserta yang sudah aktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id").whereIn("id",n).where("role_id",4).whereNull("deleted_at").whereNot("account_status",2);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun peserta yang cocok untuk diaktifkan atau akun sudah aktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:2,deactivate_at:null,updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Peserta"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil mengaktifkan ${o.length} akun peserta.`];l>0&&d.push(`Terlewat ${l} karena sudah aktif, bukan educator, atau telah dihapus.`);const u=new p(200,"SUCCESS_ACTIVATE_ACCOUNT","Berhasil Mengaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){r.error(`| Student KMIS | - Error function activateAccount: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},6806:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["Text","Image","Video","Audio","File","Link","TextArray","ImageArray"]);a.updateContentValidator=[n("type").trim().notEmpty().withMessage("Tipe konten tidak boleh kosong.").bail().isString().withMessage("Tipe konten harus berupa teks.").bail().isIn(s).withMessage(`Tipe konten harus salah satu dari: ${s.join(", ")}.`),n("content").optional({nullable:!0,checkFalsy:!0}),n("order").optional({nullable:!0,checkFalsy:!0}).toInt().isInt({min:0}).withMessage("Order harus berupa bilangan bulat bernilai  0.").bail().custom(async(e,{req:a})=>{if(null==e)return!0;const t=Number(a.params.id);if(await i("cms_contents").where({order:e}).whereNull("deleted_at").whereNot("id",t).first())throw new Error(`Order '${e}' sudah digunakan oleh konten lain.`);return!0})]},6824:(e,a,t)=>{const n=t(7252).Router(),i=t(3943),{storeCategoryValidator:s}=t(1442),{updateCategoryValidator:r}=t(1970),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.kmis_category"]),i.index),n.get("/show/:id",u(["view.kmis_category"]),i.show),n.post("/create",u(["create.kmis_category"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.kmis_category"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.kmis_category"]),i.destroy),n.patch("/restore",u(["restore.kmis_category"]),i.restore),e.exports=n},6870:e=>{e.exports=class{constructor(e,a=null,t,n){this.status=e,this.case=a,this.title=t,this.description=n}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description}}}}},6879:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.storeEventValidator=[n("categoryId").notEmpty().withMessage("Kategori kegiatan wajib dipilih.").bail().isInt().withMessage("Kategori kegiatan harus berupa angka.").bail().custom(async e=>{if(!await i("cms_events_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori kegiatan yang Anda pilih tidak ditemukan.");return!0}),n("title").custom(e=>{if(void 0===e)throw new Error("Judul kegiatan tidak boleh kosong.");return!0}),n("description").custom(e=>{if(void 0===e)throw new Error("Deskripsi kegiatan tidak boleh kosong.");return!0}),n("eventContent").custom(e=>{if(void 0===e)throw new Error("Konten kegiatan tidak boleh kosong.");return!0})]},6928:e=>{"use strict";e.exports=require("path")},6967:(e,a,t)=>{const{rateLimit:n,ipKeyGenerator:i}=t(1763),s=t(6870),r=t(7484),o=n({windowMs:6e4,max:50,keyGenerator:i,standardHeaders:!0,legacyHeaders:!1,message:()=>new s(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.").toResponse(),handler:(e,a)=>{const t=new s(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.");r.warn(`| RateLimiter | Too many requests from IP: ${e.ip}`),a.status(429).json(t.toResponse())}});e.exports=o},6982:e=>{"use strict";e.exports=require("crypto")},7016:e=>{"use strict";e.exports=require("url")},7026:e=>{e.exports=async function(e){return{id:e.id,name:e.name,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},7065:(e,a,t)=>{const n=t(7252).Router(),i=t(9230),{storeAnimalCompositionValidator:s}=t(601),{updateAnimalCompositionValidator:r}=t(9331),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.cms_management"]),i.index),n.get("/show/:id",u(["view.cms_management"]),i.show),n.post("/create",u(["create.cms_management"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.cms_management"]),c.array("files",20),r,o,i.update),n.delete("/delete",u(["delete.cms_management"]),i.destroy),n.patch("/restore",u(["restore.cms_management"]),i.restore),e.exports=n},7072:(e,a,t)=>{const n=t(4930);e.exports={getUserPicFilterFlag:async function(e){const a=function(e){return e.userId??null}(e);if(!a)return{canSeeUserPic:!1,userId:null};const t=Number(a),i=await n("users").where("id",t).select("role_id").first();return i?1===Number(i.role_id)?{canSeeUserPic:!1,userId:t}:{canSeeUserPic:!!await n("kmis_topics").whereRaw("user_pic @> ?",[JSON.stringify([t])]).whereNull("deleted_at").first(),userId:t}:{canSeeUserPic:!1,userId:null}}}},7110:(e,a,t)=>{const n=t(7252).Router(),i=t(4654),{storeMonevDashboardValidator:s}=t(1717),{updateMonevDashboardValidator:r}=t(5437),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)().fields([{name:"frameworkFiles",maxCount:1},{name:"planFiles",maxCount:1}]);n.use(d,l),n.get("/info",u(["view.monev_dashboard"]),i.dashboardInfo),n.post("/create",u(["create.monev_dashboard"]),c,s,o,i.store),n.patch("/update/:id",u(["edit.monev_dashboard"]),c,r,o,i.update),e.exports=n},7172:e=>{"use strict";e.exports=require("archiver")},7221:(e,a,t)=>{const{body:n}=t(7975);a.updateNewsCategoryValidator=[n("name").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},7252:e=>{"use strict";e.exports=require("express")},7273:(e,a,t)=>{const n=t(7252).Router(),i=t(2069),{storeAnimalCategoryValidator:s}=t(1960),{updateAnimalCategoryValidator:r}=t(6144),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.master_data"]),i.index),n.get("/show/:id",u(["view.master_data"]),i.show),n.post("/create",u(["create.master_data"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.master_data"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.master_data"]),i.destroy),n.patch("/restore",u(["restore.master_data"]),i.restore),e.exports=n},7385:(e,a,t)=>{const n=t(7252).Router(),i=t(8050),{storeEducatorValidator:s}=t(5057),{updateEducatorValidator:r}=t(9281),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.kmis_educator"]),i.index),n.get("/show/:id",u(["view.kmis_educator"]),i.show),n.post("/create",u(["create.kmis_educator"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.kmis_educator"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.kmis_educator"]),i.destroy),n.patch("/restore",u(["restore.kmis_educator"]),i.restore),n.patch("/deactivate",u(["edit.kmis_educator"]),i.deactivateAccount),n.patch("/activate",u(["edit.kmis_educator"]),i.activateAccount),e.exports=n},7397:(e,a,t)=>{const n=t(7252).Router(),i=t(6716),{storeStudentValidator:s}=t(925),{updateStudentValidator:r}=t(9661),o=t(2110),l=t(9022),d=t(6967),u=t(5794);n.use(d,l),n.get("/index",u(["view.kmis_student"]),i.index),n.get("/show/:id",u(["view.kmis_student"]),i.show),n.post("/create",u(["create.kmis_student"]),s,o,i.store),n.patch("/update/:id",u(["edit.kmis_student"]),r,o,i.update),n.delete("/delete",u(["delete.kmis_student"]),i.destroy),n.patch("/restore",u(["restore.kmis_student"]),i.restore),n.patch("/deactivate",u(["edit.kmis_student"]),i.deactivateAccount),n.patch("/activate",u(["edit.kmis_student"]),i.activateAccount),e.exports=n},7438:e=>{function a(e){const a=String(e?.auth?.roleName||"").toLowerCase(),t=(n=e?.auth?.abilities,Array.isArray(n)?n.map(e=>String(e).toLowerCase()):[]);var n;const i=e=>t.includes(String(e).toLowerCase());return{isSuperAdmin:"super admin"===a||i("super_admin"),isEducator:"educator"===a||i("educator"),isStudent:"student"===a||i("student"),roleNameLower:a,abilitiesLower:t,hasAbility:i}}e.exports={getAuthFlags:a,applyTrashedScope:function(e,t,n="deleted_at"){const{isSuperAdmin:i}=a(t),s=String(t?.query?.with_trashed??"").trim();return i?"0"===s&&e.whereNull(n):e.whereNull(n),e}}},7443:(e,a,t)=>{const n=t(6870),i=t(7484);function s(e,a){return Array.isArray(e.auth?.abilities)&&e.auth.abilities.includes(a)}e.exports=function(e){return(a,t,r)=>{try{const o=a.auth;if(!o||!Array.isArray(o.abilities)){i.error("| Require Ability | - Authorization or abilities data not found.");const e=new n(401,"UNAUTHORIZED","Akses Ditolak","Token tidak valid atau tidak memiliki ability.");return t.status(401).json(e.toResponse())}if(!s(a,e)){i.error("| Require Ability | - User does not have required ability.");const e=new n(403,"FORBIDDEN_ABILITY","Akses Ditolak","Anda tidak memiliki hak akses untuk endpoint ini.");return t.status(403).json(e.toResponse())}r()}catch(e){i.error(`| Require Ability | - Error: ${e.message}`);const a=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}}},e.exports.hasAbility=s,e.exports.getAbility=function(e,a={}){try{const t=Array.isArray(e.auth?.abilities)?e.auth.abilities:[],n=Array.isArray(a.priority)?a.priority:[];if(0===t.length)return null;if(n.length>0)for(const e of n)if(t.includes(e))return e;return t[0]||null}catch(e){i.error(`| Get Ability | - Error: ${e.message}`);const a=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");res.status(500).json(a.toResponse())}},e.exports.requireAnyAbility=function(e=[]){return(a,t,r)=>{try{if(!Array.isArray(a.auth?.abilities)){const e=new n(401,"UNAUTHORIZED","Akses Ditolak","Token tidak valid atau tidak memiliki ability.");return t.status(401).json(e.toResponse())}if(!e.some(e=>s(a,e))){const e=new n(403,"FORBIDDEN_ABILITY","Akses Ditolak","Anda tidak memiliki hak akses untuk endpoint ini.");return t.status(403).json(e.toResponse())}r()}catch(e){i.error(`| Require Any Ability | - Error: ${e.message}`);const a=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}}},e.exports.requireAllAbilities=function(e=[]){return(a,t,r)=>{try{if(!Array.isArray(a.auth?.abilities)){const e=new n(401,"UNAUTHORIZED","Akses Ditolak","Token tidak valid atau tidak memiliki ability.");return t.status(401).json(e.toResponse())}if(!e.every(e=>s(a,e))){const e=new n(403,"FORBIDDEN_ABILITY","Akses Ditolak","Anda tidak memiliki hak akses untuk endpoint ini.");return t.status(403).json(e.toResponse())}r()}catch(e){i.error(`| Require All Ability | - Error: ${e.message}`);const a=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}}}},7484:(e,a,t)=>{const n=t(5124),i=n.createLogger({level:"info",format:n.format.combine(n.format.timestamp(),n.format.json()),transports:[new n.transports.Console({format:n.format.combine(n.format.colorize({all:!0}),n.format.simple())}),new n.transports.File({filename:"logger.log"})]});e.exports=i},7540:e=>{e.exports={applyLatestThenTrashed:function(e,a="deleted_at",t="created_at",n="id"){return e.orderByRaw("CASE WHEN ?? IS NULL THEN 0 ELSE 1 END ASC, ?? DESC, ?? DESC",[a,t,n])}}},7580:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{isPlainObject:r,normIdArray:o,handleLocalizedText:l}=t(7872),{applyJsonbSearch:d,applyPagination:u,formatPaginationResult:c}=t(3210),m=t(1332),p=t(6870),g=t(9304),w=t(6479),{applyTrashedScope:h}=t(7438),{applyLatestThenTrashed:_}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("cms_faqs as faq").select("faq.*");h(n,e,"faq.deleted_at"),d(n,t,["faq.question->>'id'","faq.question->>'en'","faq.answer->>'id'","faq.answer->>'en'"],{mode:"or",split:!0}),_(n,"faq.deleted_at","faq.created_at","faq.id");const s=u(e.query),r=await c(n,s,i);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>g(e))),l=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data FAQ berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| FAQ CMS | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{question:r,answer:o}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=l(r,{allowPartial:!1,maxLen:void 0,fieldLabel:"question"});if(s.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const d=l(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"answer"});if(d.error){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",d.error.message);return a.status(422).json(e.toResponse())}if(await t("cms_faqs").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(question->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(question->>'en') = lower(?)",[s.value.en])}).first()){const e=new p(422,"DUPLICATE_QUESTION","Duplikat Data","Pertanyaan FAQ (ID/EN) sudah digunakan, silakan gunakan pertanyaan lain.");return a.status(422).json(e.toResponse())}await t("cms_faqs").insert({question:{id:s.value.id,en:s.value.en},answer:{id:d.value.id,en:d.value.en}}),await w.logCreate({userId:w.fromReq(e),module:"cms",subject:"List FAQ"},t),await t.commit();const u=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data","Data FAQ berhasil ditambahkan.");return a.status(201).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| FAQ CMS | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_faqs").select("*").where("id",t).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data FAQ dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await g(e),s=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Detail data FAQ berhasil didapatkan.",n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| FAQ CMS | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{question:o,answer:d}=e.body,u=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_faqs").where("id",u).first();if(!s){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data FAQ dengan ID '${u}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const c=r(s.question)?s.question:parseJsonSafe(s.question)??{id:"",en:""},m=r(s.answer)?s.answer:parseJsonSafe(s.answer)??{id:"",en:""};let g=c;if(void 0!==o){const e=l(o,{allowPartial:!0,maxLen:void 0,fieldLabel:"nama"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...c,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=c.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=c.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Nama harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}g={id:String(t.id).trim(),en:String(t.en).trim()}}let h=m;if(void 0!==d){const e=l(d,{allowPartial:!0,maxLen:void 0,fieldLabel:"deskripsi"});if(e.error){const t=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...m,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=m.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=m.en),!t.id||!t.en){const e=new p(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}h={id:String(t.id).trim(),en:String(t.en).trim()}}if(((g.id??"").toLowerCase()!==(c.id??"").toLowerCase()||(g.en??"").toLowerCase()!==(c.en??"").toLowerCase())&&await t("cms_faqs").whereNull("deleted_at").whereNot("id",u).andWhere(function(){this.whereRaw("lower(question->>'id') = lower(?)",[g.id]).orWhereRaw("lower(question->>'en') = lower(?)",[g.en])}).first()){const e=new p(422,"DUPLICATE_QUESTION","Duplikat Data","Pertanyaan FAQ (ID/EN) sudah digunakan pada data lain.");return a.status(422).json(e.toResponse())}await t("cms_faqs").where("id",u).update({question:g,answer:h,updated_at:t.fn.now()}),await w.logUpdate({userId:w.fromReq(e),module:"cms",subject:"List FAQ"},t),await t.commit();const _=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data FAQ '${g.id}' berhasil diperbarui.`);return a.status(200).json(_.toResponse())}catch(e){await t.rollback(),s.error(`| FAQ CMS | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_faqs").select("id","question").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_faqs").whereIn("id",r).update({deleted_at:t.fn.now()}),await w.logDelete({userId:w.fromReq(e),module:"cms",subject:"List FAQ"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data kategori satwa.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| FAQ CMS | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const l=await t("cms_faqs").select("id","question").whereIn("id",n).whereNotNull("deleted_at");if(0===l.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const d=e=>{const a=r(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=l.map(e=>{const a=d(e.question);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let g=[];(c.length||m.length)&&(g=await t("cms_faqs").select("id","question").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(question->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(question->>'en')"),m):this.whereIn(i.raw("lower(question->>'en')"),m))}));const h=new Set;for(const e of g){const a=d(e.question);a.idLower&&h.add(`id:${a.idLower}`),a.enLower&&h.add(`en:${a.enLower}`)}const _=new Set,k=new Set,b=new Set;for(const e of u)e.idLower&&(_.has(e.idLower)?b.add(`id:${e.idLower}`):_.add(e.idLower)),e.enLower&&(k.has(e.enLower)?b.add(`en:${e.enLower}`):k.add(e.enLower));const f=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&h.has(a)||t&&h.has(t),i=a&&b.has(a)||t&&b.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,question:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),f.push(e))}let D=0;if(f.length>0){const e=f.map(e=>e.rowId);await t("cms_faqs").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await w.logRestore({userId:w.fromReq(e),module:"cms",subject:"List FAQ"},t),await t.commit(),0===D){const e=new p(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| FAQ CMS | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},7707:(e,a,t)=>{const n=t(7252).Router(),i=t(9022),s=t(6967),r=t(5233);n.get("/get-all-role",s,r.getAllRole),n.get("/get-all-category",s,r.getAllCategory),n.get("/get-category/:id",s,r.getCategorybyId),n.get("/get-all-topic",s,r.getAllTopic),n.get("/get-all-topic-admin",s,i,r.getAllTopicWithAuth),n.get("/get-topic/:id",s,r.getTopicbyId),n.get("/get-topic-by-category/:id",s,r.getTopicbyCategoryId),n.get("/get-all-material",s,r.getAllMaterial),n.get("/get-material/:id",s,r.getMaterialbyId),n.post("/get-material-by-category-topic",s,r.getMaterialbyTopicIdorCategoryId),n.get("/get-material-by-created/:id",s,r.getMaterialbyCreatedId),n.get("/get-material-by-uploaded/:id",s,r.getMaterialbyUploadedId),n.post("/get-material-by-type",s,r.getMaterialbyMaterialTypes),n.post("/get-material-by-public",s,r.getMaterialbyIsPublic),n.get("/get-all-quiz",s,r.getAllQuiz),n.get("/get-quiz/:id",s,r.getQuizbyId),n.post("/get-quiz-by-category-topic",s,r.getQuizbytopicId),e.exports=n},7724:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(4930),s=t(7807),r=t(2482),o=t(5278),l=t(3034);e.exports=async function(e){const a=e.kmis_categories_id?await i("kmis_categories").where("id",e.kmis_categories_id).first():null,t=await n(e.topic_cover_ids,"documents",r),d=await i("kmis_materials").whereIn("id",e.material_order_ids||[]).select("*").orderByRaw("array_position(?, id)",[e.material_order_ids]),u=await i("users").whereIn("id",e.user_pic||[]).select("*").orderByRaw("array_position(?, id)",[e.user_pic]),c=await Promise.all(d.map(e=>o(e))),m=await Promise.all(u.map(e=>l(e)));return{id:e.id,userPic:m,category:a?await s(a):null,topicCover:t,materialOrder:c,topicType:e.topic_type,title:e.title,description:e.description,totalQuiz:e.total_quiz,quizDuration:e.quiz_duration,totalViews:e.total_views,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},7780:(e,a,t)=>{const n=t(8938),i=t(2305),s=t(9896),r=t(6928),o=t(7484),{resolvePublicBaseUrl:l}=t(4456);function d(e){try{return JSON.parse(e)}catch{return{raw:String(e)}}}e.exports=class{static token=null;static baseURL=null;static email=null;static password=null;static loginPromise=null;static FILE_FIELD="files";static getStaticDocumentAccount(){return{email:"rimba.development@gmail.com",password:"dokumenrimbaadmin123"}}static init(){if(!this.baseURL){this.baseURL=l("docs",{app:process.env.PORT||4e3,docs:process.env.DOC_SERVER_PORT||4001});const e=this.getStaticDocumentAccount();if(this.email=e.email,this.password=e.password,!this.baseURL||!this.email||!this.password)throw o.error("| Storage Server Helper | - Init error: konfigurasi tidak lengkap."),new Error("Konfigurasi tidak lengkap.")}}static axios(){return this.init(),n.create({baseURL:this.baseURL,timeout:6e4})}static async ensureToken(e=!1){return this.init(),this.token&&!e||(this.loginPromise||(this.loginPromise=this.login(!0).catch(e=>{throw e}).finally(()=>{this.loginPromise=null})),await this.loginPromise),this.token}static isTokenErrorCase(e){if(!e||"object"!=typeof e)return null;const a=e.case||e?.data?.case||e?.error?.case;return a&&["TOKEN_BLACKLISTED","TOKEN_EXPIRED","LOGIN_EXPIRED","INVALID_TOKEN"].includes(a)?a:null}static async withTokenAutoRefresh(e,a=!0){this.init(),await this.ensureToken();const t=async a=>{const n=this.token,i=await e(n),s="string"==typeof i.data?d(i.data):i.data;if(401===i.status&&a){const e=this.isTokenErrorCase(s);if(e)return o.warn(`| Storage Server Helper | - Token bermasalah (${e}), mencoba login ulang & retry sekali.`),await this.ensureToken(!0),t(!1)}return{res:i,payload:s}};return t(a)}static async login(e=!1){if(this.init(),this.token&&!e)return this.token;try{const e=await this.axios().post("/api/rimba/docs/signin",{email:this.email,password:this.password},{validateStatus:()=>!0}),a="string"==typeof e.data?d(e.data):e.data;if(e.status>=400)throw o.error(`| Storage Server Helper | - Login gagal: Status ${e.status}. Body: ${JSON.stringify(a)}.`),new Error(`Login gagal. Status ${e.status}. Body: ${JSON.stringify(a)}`);const t=a?.data?.token;if(!t)throw o.error(`| Storage Server Helper | - Login berhasil tapi token tidak ditemukan pada 'data.token'. Body: ${JSON.stringify(a)}`),new Error(`Login berhasil tapi token tidak ditemukan pada 'data.token'. Body: ${JSON.stringify(a)}`);return this.token=t,t}catch(e){throw o.error("| Storage Server Helper | - Login error:",e.message),e}}static async logout(){if(this.token)try{await this.axios().get("/api/rimba/docs/signout",{headers:{Authorization:`Bearer ${this.token}`},validateStatus:()=>!0})}catch(e){o.warn("| Storage Server Helper | - Logout error:",e.message)}finally{this.token=null}}static async uploadToServer(e){this.init(),await this.ensureToken();const a=function(e){return e?Array.isArray(e)?e:[e]:[]}(e);if(!a.length)throw o.error("| Storage Server Helper | - Tidak ada file yang dikirim untuk diunggah."),new Error("Tidak ada file yang dikirim untuk diunggah.");const t=()=>{const e=new i;for(const t of a){const a=t.originalname,n=r.extname(a||"").replace(/^\./,""),i=n||this.getExtensionFromMimeType(t.mimetype)||"bin",l=n?a:`${a}.${i}`;t.buffer&&Buffer.isBuffer(t.buffer)?e.append(this.FILE_FIELD,t.buffer,{filename:l,contentType:t.mimetype||"application/octet-stream"}):t.path&&s.existsSync(t.path)?e.append(this.FILE_FIELD,s.createReadStream(t.path),{filename:l,contentType:t.mimetype||"application/octet-stream"}):o.warn(`| Storage Server Helper | - File tidak valid/tiada buffer/path: ${t.originalname}`)}return e};if(n=t(),l=this.FILE_FIELD,!(n&&n._streams&&n._streams.some(e=>"function"==typeof e||"string"==typeof e&&e.includes(`name="${l}"`))))throw o.error("| Storage Server Helper | - Tidak ada file valid untuk diunggah."),new Error("Tidak ada file valid untuk diunggah.");var n,l;const{res:d,payload:u}=await this.withTokenAutoRefresh(async e=>{const a=t(),n={...a.getHeaders(),Authorization:`Bearer ${e}`};return this.axios().post("/api/rimba/docs/upload-file",a,{headers:n,maxBodyLength:1/0,validateStatus:()=>!0})},!0);if(d.status>=400)throw o.error(`| Storage Server Helper | - Upload gagal: Status ${d.status}. Body: ${JSON.stringify(u)}.`),new Error(`Upload gagal. Status ${d.status}. Body: ${JSON.stringify(u)}`);const c=u?.data;if(void 0===c)throw o.error(`| Storage Server Helper | - Response tidak memiliki 'data'. Body: ${JSON.stringify(u)}`),new Error(`Response tidak memiliki 'data'. Body: ${JSON.stringify(u)}`);return c}static async deleteFromServer(e=[]){if(this.init(),await this.ensureToken(),!Array.isArray(e)||0===e.length)throw o.error("| Storage Server Helper | - Tidak ada file_id yang dikirim untuk dihapus."),new Error("Tidak ada file_id yang dikirim untuk dihapus.");const a=e.map(String).filter(Boolean),t=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,n=a.filter(e=>!t.test(e));if(n.length)throw new Error(`ID bukan UUID v4: ${n.join(", ")}`);const i={document_ids:a},{res:s,payload:r}=await this.withTokenAutoRefresh(async e=>this.axios().delete("/api/rimba/docs/delete-file",{headers:{Authorization:`Bearer ${e}`},data:i,validateStatus:()=>!0}),!0);if(s.status>=400)throw o.error(`| Storage Server Helper | - Delete gagal: Status ${s.status}. Body: ${JSON.stringify(r)}.`),new Error(`Delete gagal. Status ${s.status}. Body: ${JSON.stringify(r)}`);const l=(r?.message?.description||"").match(/menghapus\s+(\d+)\s+dokumen/i),d=l?Number(l[1]):null;return{status:r?.status??s.status,case:r?.case??"DELETE_SUCCESS",message:r?.message??null,deleted_count:d,raw:r}}static getExtensionFromMimeType(e){return{"text/plain":"txt","text/html":"html","text/css":"css","text/csv":"csv","text/xml":"xml","image/jpeg":"jpg","image/png":"png","image/gif":"gif","image/bmp":"bmp","image/webp":"webp","image/svg+xml":"svg","audio/mpeg":"mp3","audio/ogg":"ogg","audio/wav":"wav","audio/x-ms-wma":"wma","video/mp4":"mp4","video/ogg":"ogv","video/webm":"webm","video/x-msvideo":"avi","video/x-ms-wmv":"wmv","application/pdf":"pdf","application/zip":"zip","application/x-rar-compressed":"rar","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.ms-powerpoint":"ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":"pptx","application/json":"json","application/javascript":"js","application/vnd.oasis.opendocument.text":"odt","application/vnd.oasis.opendocument.spreadsheet":"ods","application/vnd.oasis.opendocument.presentation":"odp","font/otf":"otf","font/ttf":"ttf","font/woff":"woff","font/woff2":"woff2","application/octet-stream":"bin"}[e]||"bin"}}},7789:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{normIdArray:r}=t(7872),o=t(1784),l=t(1332),d=t(6870),u=t(5726),c=t(6479),m=t(6293),p=t(3824);m.extend(p);const g=/^\d{4}-\d{2}-\d{2}$/;function w(e){if(!e)return null;const a=String(e).trim();if(g.test(a)){const e=m.utc(`${a}T00:00:00Z`);return e.isValid()?e.format("YYYY-MM-DD"):null}if(o.isIso8601Z(a)){const e=m.utc(a);return e.isValid()?e.format("YYYY-MM-DD"):null}return null}function h(e){if(!e)return null;if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;try{const a=m.utc(e instanceof Date?e.toISOString():String(e));return a.isValid()?a.format("YYYY-MM-DD"):null}catch{return null}}function _(e){return h(e.startedDateUTC||e.started_date||e.startedDate||null)}function k(e){return h(e.finishedDateUTC||e.finished_date||null)||_(e)}function b(e){const a=_(e),t=k(e);return a&&t&&t>a}function f(e){const a=_(e);return a?e.startedAtUTC?e.startedAtUTC:`${a}T${e.startedTimeUTC||e.started_time||"00:00:00"}Z`:null}function y(e){const a=k(e)||_(e);return a?e.finishedAtUTC?e.finishedAtUTC:`${a}T${e.finishedTimeUTC||e.finished_time||e.startedTimeUTC||e.started_time||"00:00:00"}Z`:null}function R(e,a){const t=b(e),n=b(a);if(t!==n)return t?-1:1;if(t&&n){const t=_(e)||"",n=_(a)||"";if(t!==n)return t<n?-1:1;const i=m.utc(k(e)).diff(m.utc(t),"day"),s=m.utc(k(a)).diff(m.utc(n),"day");if(i!==s)return s-i;const r=f(e)||"",o=f(a)||"";if(r!==o)return r<o?-1:1;const l=y(e)||"",d=y(a)||"";if(l!==d)return l<d?-1:1;return(e.name||"").localeCompare(a.name||"")||(e.id||0)-(a.id||0)}const i=f(e)||"",s=f(a)||"";if(i!==s)return i<s?-1:1;const r=y(e)||"",o=y(a)||"";if(r!==o)return r<o?-1:1;return(e.name||"").localeCompare(a.name||"")||(e.id||0)-(a.id||0)}a.index=async(e,a)=>{const{startDate:t,endDate:n}=e.query;try{let e=w(t),s=w(n);if(e||s)e&&!s?s=m.utc(`${e}T00:00:00Z`).endOf("month").format("YYYY-MM-DD"):!e&&s&&(e=m.utc(`${s}T00:00:00Z`).startOf("month").format("YYYY-MM-DD"));else{const a=m.utc();e=a.startOf("month").format("YYYY-MM-DD"),s=a.endOf("month").format("YYYY-MM-DD")}if(!e||!s){const e=new d(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan","Parameter startDate/endDate tidak valid. Gunakan YYYY-MM-DD atau ISO 8601 dengan Z/offset.");return a.status(422).json(e.toResponse())}if(s<e){const a=e;e=s,s=a}const r=[];for(let a=m.utc(`${e}T00:00:00Z`);!a.isAfter(m.utc(`${s}T00:00:00Z`));a=a.add(1,"day"))r.push(a.format("YYYY-MM-DD"));const o=new Map(r.map(e=>[e,[]])),c=await i("monev_activity_calendar as calendar").leftJoin("monev_activity_categories as category","calendar.monev_activity_category_id","category.id").select(["calendar.id","calendar.created_by","calendar.monev_activity_category_id","calendar.name","calendar.description","calendar.location",i.raw("calendar.started_date::text AS started_date"),i.raw("calendar.finished_date::text AS finished_date"),"calendar.started_time","calendar.finished_time","calendar.created_at","calendar.updated_at","calendar.deleted_at"]).whereNull("calendar.deleted_at").whereRaw("calendar.started_date <= ? AND COALESCE(calendar.finished_date, calendar.started_date) >= ?",[s,e]).orderBy("calendar.started_date","asc").orderBy("calendar.started_time","asc").orderBy("calendar.name","asc"),p=await Promise.all(c.map(e=>u(e))),g=new Map(c.map((e,a)=>[e.id,p[a]]));for(const a of c){const t=h(a.started_date),n=h(a.finished_date||a.started_date)||t,i=t<e?e:t,r=n>s?s:n;for(let e=m.utc(`${i}T00:00:00Z`);!e.isAfter(m.utc(`${r}T00:00:00Z`));e=e.add(1,"day")){const t=e.format("YYYY-MM-DD"),n=o.get(t);n&&n.push(g.get(a.id))}}const _=r.map(e=>{const a=o.get(e)||[];return a.sort(R),{date:e,agendas:a.length?a:null}}),k=new l(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data kegiatan berhasil didapatkan.",_);return a.status(200).json(k.toResponse())}catch(e){s.error(`| Activity Calendar MONEV | - Error function index : ${e.message}`);const t=new d(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{activityCategoryId:r,name:o,description:l,location:u,startedDate:m,finishedDate:p,startedTime:g,finishedTime:w}=e.body,h=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new d(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("monev_activity_calendar").whereRaw("lower(name) = lower(?)",[o]).whereNull("deleted_at").first()){const e=new d(422,"DUPLICATE_TITLE","Duplikat Data",`Nama kegiatan '${o}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}await t("monev_activity_calendar").insert({created_by:h,monev_activity_category_id:r,name:o,description:l,location:u,started_date:m,finished_date:p,started_time:g,finished_time:w}).returning("*"),await c.logCreate({userId:c.fromReq(e),module:"monev",subject:"Kegiatan Kalender"},t),await t.commit();const s=new d(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data kegiatan '${o}' berhasil ditambahkan.`);return a.status(201).json(s.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Calendar MONEV | - Error function store: ${e.message}`);const n=new d(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("monev_activity_calendar").select("*").where("id",t).first();if(!e){const e=new d(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await u(e),s=new l(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data kegiatan '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Activity Calendar MONEV | - Error function show: ${e.message}`);const t=new d(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{activityCategoryId:r,name:o,description:l,location:u,startedDate:m,finishedDate:p,startedTime:g,finishedTime:w}=e.body,h=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new d(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("monev_activity_calendar").where("id",h).first();if(!s){const e=new d(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data kegiatan dengan ID '${h}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("monev_activity_calendar").whereRaw("lower(name) = lower(?)",[o]).whereNull("deleted_at").whereNot("id",h).first()){const e=new d(422,"DUPLICATE_TITLE","Duplikat Data",`Nama kegiatan '${o}' sudah digunakan pada kegiatan lain.`);return a.status(422).json(e.toResponse())}const _={monev_activity_category_id:r??s.monev_activity_category_id,name:o??s.name,description:l??s.description,location:u??s.location,started_date:m??s.started_date,finished_date:p??s.finished_date,started_time:g??s.started_time,finished_time:w??s.finished_time,updated_at:t.fn.now()};await t("monev_activity_calendar").where("id",h).update(_),await c.logUpdate({userId:c.fromReq(e),module:"monev",subject:"Kegiatan Kalender"},t),await t.commit();const k=new d(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data kegiatan '${o}' berhasil diperbarui.`);return a.status(200).json(k.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Calendar MONEV | - Error function update : ${e.message}`);const n=new d(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=r(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new d(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new d(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("monev_activity_calendar").select("id","name").whereIn("id",n);if(0===s.length){await t.rollback();const e=new d(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kegiatan yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=s.map(e=>e.id),l=await t("monev_activity_calendar").whereIn("id",o).del().returning(["id","name"]);await c.logDelete({userId:c.fromReq(e),module:"monev",subject:"Kegiatan Kalender"},t),await t.commit();const u=new d(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus secara permanen ${l.length} data kegiatan.`);return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Calendar MONEV | - Error function destroy : ${e.message}`);const n=new d(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},7807:e=>{e.exports=async function(e){return{id:e.id,title:e.title,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},7832:(e,a,t)=>{const n=t(7252).Router(),i=t(769),{updateMonthlyRealizationValidator:s}=t(360),{updateMonthlyRealizationVerificationValidator:r}=t(6561),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/:id",u(["view.monev_monthly_realization"]),i.getMonthlyRealizationbyActivityPackageId),n.patch("/update/:id",u(["edit.monev_monthly_realization"]),c.array("files",20),s,o,i.update),n.patch("/verification/:id",u(["edit.monev_monthly_realization"]),c.none(),r,o,i.verification),e.exports=n},7857:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972);e.exports=async function(e){const a=await n(e.permission_ids,"permissions",e=>e&&null!=e.key?String(e.key).trim():null);return{id:e.id,permissions:a,name:e.name,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},7872:e=>{const a=e=>"[object Object]"===Object.prototype.toString.call(e),t=e=>{try{return JSON.parse(e)}catch{return null}};function n(e){if(Array.isArray(e))return e;if(null==e)return[];if("string"==typeof e){const a=t(e);return Array.isArray(a)?a:e.split(",").map(e=>e.trim()).filter(Boolean)}return[]}function i(e){if(Array.isArray(e))return e;if(null==e)return[];if("string"==typeof e){const a=t(e);return Array.isArray(a)?a:[]}return a(e)&&Array.isArray(e)?e:[]}e.exports={toArray:n,normJsonbArray:i,normIdArray:function(e,a={}){const{as:s="number",key:r="id"}=a;let o;if(Array.isArray(e))o=e;else if("string"==typeof e){const a=t(e);o=Array.isArray(a)?a:n(e)}else o=e&&"object"==typeof e?i(e):[];return o.map(e=>{if(null!=e&&"object"==typeof e&&(e=e[r]),null==e)return null;if("number"===s){const a=Number(e);return Number.isFinite(a)?a:null}if("bigint"===s)try{return BigInt(String(e))}catch{return null}return String(e)}).filter(e=>null!=e)},normUUIDv4Array:function(e,a="id"){const s=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;let r=[];if(Array.isArray(e))r=e;else if("string"==typeof e){const a=t(e);r=Array.isArray(a)?a:n(e)}else e&&"object"==typeof e&&(r=i(e));return r.map(e=>(null!=e&&"object"==typeof e&&(e=e[a]),null==e?null:String(e).trim())).filter(e=>"string"==typeof e&&s.test(e))},parseJsonSafe:t,isPlainObject:a,handleLocalizedText:function(e,n={}){const{allowPartial:i=!1,maxLen:s,fieldLabel:r="teks"}=n;let o=e;if("string"==typeof o&&(o=t(o)??o),!a(o))return{error:{code:"INVALID_CONTENT_FORMAT",message:`Format ${r} harus berupa objek { id, en }.`}};const l={},d=Object.prototype.hasOwnProperty.call(o,"id"),u=Object.prototype.hasOwnProperty.call(o,"en");if(d){if("string"!=typeof o.id)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.id harus string.`}};if(l.id=o.id.trim(),!i&&""===l.id)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.id tidak boleh kosong.`}};if("number"==typeof s&&l.id&&l.id.length>s)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.id maksimal ${s} karakter.`}}}if(u){if("string"!=typeof o.en)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.en harus string.`}};if(l.en=o.en.trim(),!i&&""===l.en)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.en tidak boleh kosong.`}};if("number"==typeof s&&l.en&&l.en.length>s)return{error:{code:"INVALID_CONTENT_FORMAT",message:`${r}.en maksimal ${s} karakter.`}}}return i||d&&u?{value:l}:{error:{code:"INVALID_CONTENT_FORMAT",message:`${r} harus memiliki properti id dan en.`}}}}},7901:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l}=t(7872),{asJsonb:d}=t(6192),{applySearch:u,applyPagination:c,formatPaginationResult:m}=t(3210),p=t(1701),g=t(1332),w=t(6870),h=t(6321),_=t(6479),{applyTrashedScope:k}=t(7438),{applyLatestThenTrashed:b}=t(7540);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=i("monev_share_reports as report").select("report.*");k(n,e,"report.deleted_at"),u(n,t,["report.name"]),b(n,"report.deleted_at","report.created_at","report.id");const s=c(e.query),r=await m(n,s,i);if(0===r.data.length){const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=await Promise.all(r.data.map(e=>h(e))),l=new g(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data laporan berhasil diambil.",{data:o,pagination:r.pagination});return a.status(200).json(l.toResponse())}catch(e){s.error(`| Share Report MONEV | - Error function index : ${e.message}`);const t=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{name:r,description:o}=e.body,u=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new w(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("monev_share_reports").whereRaw("lower(name) = lower(?)",[r]).whereNull("deleted_at").first()){await t.rollback();const e=new w(422,"DUPLICATE_TITLE","Duplikat Data",`Nama laporan '${r}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}if(!e.files||0===e.files.length){await t.rollback();const e=new w(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File laporan wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>5){await t.rollback();const e=new w(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 5 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["image/jpeg","image/jpg","image/png","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(t.mimetype)){const e=new w(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh JPG, JPEG, PNG, WEBP, PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new w(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}const s=await p.uploadDocuments(e.files,e),c=l(e.body.files,{as:"number"}),m=c.length?c:s;await t("monev_share_reports").insert({created_by:u,report_file_ids:d(m),name:r,description:o}).returning("*"),await _.logCreate({userId:_.fromReq(e),module:"monev",subject:"List Laporan"},t),await t.commit();const g=new w(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data laporan '${r}' berhasil ditambahkan.`);return a.status(201).json(g.toResponse())}catch(e){await t.rollback(),s.error(`| Share Report MONEV | - Error function store: ${e.message}`);const n=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("monev_share_reports").select("*").where("id",t).first();if(!e){const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data laporan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await h(e),s=new g(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data laporan '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Share Report MONEV | - Error function show: ${e.message}`);const t=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{name:u,description:c,deleteDocumentIds:m}=e.body,g=e.params.id,h=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new w(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const k=await t("monev_share_reports").where("id",g).first();if(!k){await t.rollback();const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data laporan dengan ID '${g}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(Number(k.created_by)!==Number(h)){await t.rollback();const e=new w(403,"FORBIDDEN_USER_ID","User Tidak Diizinkan","Anda tidak memiliki izin untuk memperbarui laporan ini karena bukan pembuatnya.");return a.status(403).json(e.toResponse())}if(await t("monev_share_reports").whereRaw("lower(name) = lower(?)",[u]).whereNull("deleted_at").whereNot("id",g).first()){await t.rollback();const e=new w(422,"DUPLICATE_TITLE","Duplikat Data",`Nama '${u}' sudah digunakan pada laporan lain.`);return a.status(422).json(e.toResponse())}const b=r(m).map(String),f=Array.isArray(e.files)?e.files:[],y=["image/jpeg","image/jpg","image/png","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"],R=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="report_file_ids",maxFilesAllowed:i=5,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, WebP, PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:k,deleteDocumentIds:b,files:f,dbColumn:"report_file_ids",maxFilesAllowed:5,allowedTypes:y,sizeLimitBytes:52428800});if(!R.ok){const e=new w(R.http,R.code,R.title,R.desc);return a.status(R.http).json(e.toResponse())}const E=l(o(k.report_file_ids),{as:"number"}),D=new Set(b.map(e=>Number(e))),T=[];for(let e=0;e<E.length;e++)D.has(E[e])&&T.push(e);let S=[];f.length>0&&(S=await p.uploadDocuments(f,e));const A=(S||[]).map(e=>Number(e)).filter(Number.isFinite);let I=[...E];const N=Math.min(T.length,A.length);for(let e=0;e<N;e++)I[T[e]]=A[e];if(T.length>N){const e=T.slice(N);for(let a=e.length-1;a>=0;a--)I.splice(e[a],1)}A.length>N&&(I=I.concat(A.slice(N))),I=I.filter(e=>Number.isFinite(Number(e))).map(e=>Number(e));const j={report_file_ids:d(I),name:u??k.name,description:c??k.description,updated_at:t.fn.now()};await t("monev_share_reports").where("id",g).update(j),await _.logUpdate({userId:_.fromReq(e),module:"monev",subject:"List Laporan"},t),await t.commit();const v=E.filter(e=>D.has(e));if(v.length>0)try{await p.deleteDocuments(v)}catch(e){s.warn(`| Share Report MONEV | - Gagal menghapus sebagian dokumen: ${e.message}`)}const O=new w(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data laporan '${u}' berhasil diperbarui.`);return a.status(200).json(O.toResponse())}catch(e){await t.rollback(),s.error(`| Share Report MONEV | - Error function update : ${e.message}`);const n=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new w(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new w(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const r=await t("monev_share_reports").select("id","name","report_file_ids").whereIn("id",n);if(0===r.length){await t.rollback();const e=new w(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data laporan yang cocok.");return a.status(200).json(e.toResponse())}const d=r.map(e=>e.id),u=[];for(const e of r){const a=o(e?.report_file_ids),t=l(a,{as:"number"}).filter(Number.isFinite);u.push(...t)}const c=[...new Set(u)];if(c.length>0)try{await p.deleteDocuments(c)}catch(e){s.warn(`| Share Report MONEV | - Gagal hapus files (${c.join(", ")}): ${e.message}`)}const m=await t("monev_share_reports").whereIn("id",d).del();await _.logDelete({userId:_.fromReq(e),module:"monev",subject:"List Laporan"},t),await t.commit();const g=new w(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus secara permanen ${m} data laporan.`);return a.status(200).json(g.toResponse())}catch(e){await t.rollback(),s.error(`| Share Report MONEV | - Error function destroy : ${e.message}`);const n=new w(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},7906:e=>{"use strict";e.exports=require("validator")},7972:(e,a,t)=>{const n=t(4930);e.exports={resolveArrayRelations:async function(e,a,t=e=>e){const i=function(e){let a=[];if(null==e)return a;if(Array.isArray(e))a=e;else if("string"==typeof e)try{a=JSON.parse(e)}catch{a=[]}else"object"==typeof e&&(a=e);return a=a.map(e=>{e&&"object"==typeof e&&(e=e.id??e.value??e.ID??null),"bigint"==typeof e&&(e=Number(e));const a=Number(e);return Number.isFinite(a)?a:null}).filter(e=>null!=e),a}(e);if(0===i.length)return[];const s=await n(a).whereIn("id",i).select("*"),r=new Map(s.map(e=>[Number(e.id),e]));return i.map(e=>{const a=r.get(Number(e));return a?t(a):null}).filter(Boolean)}}},7975:e=>{"use strict";e.exports=require("express-validator")},8050:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4729),s=t(4930),r=t(7484),o=t(1572),{applySearch:l,applyPagination:d,formatPaginationResult:u}=t(3210),{normIdArray:c}=t(7872),m=t(1332),p=t(6870),g=t(6348),w=t(3306),h=t(6479),{stripTitlesOnly:_,generateRandomPassword:k}=t(337),{checkEmailDeliverability:b}=t(8467),{applyTrashedScope:f}=t(7438);a.index=async(e,a)=>{const{search:t}=e.query;try{let n=s("users as user").leftJoin("roles as role","user.role_id","role.id").where("user.role_id",2).select("user.*").orderBy("user.created_at","desc");f(n,e,"user.deleted_at"),l(n,t,["user.name","user.email"]);const i=d(e.query),r=await u(n,i,s);if(0===r.data.length){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const o=r.data.map(e=>e.id),c=o.map(e=>Number(e)).filter(Number.isFinite);console.log("[educator.index] idsRaw:",o),console.log("[educator.index] ids (numeric):",c);const g=s("kmis_materials as m").whereNull("m.deleted_at").andWhere(function(){this.whereIn("m.uploaded_by",c).orWhereIn("m.created_by",c)}).select(s.raw("COALESCE(m.uploaded_by, m.created_by) AS owner_id")).count({total:"*"}).groupByRaw("COALESCE(m.uploaded_by, m.created_by)"),h=await g,_=new Map(h.map(e=>[Number(e.owner_id),Number(e.total)])),k=await Promise.all(r.data.map(e=>{const a=Number(e.id),t=_.get(a)??0;return w({...e,total_material:t})})),b=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data akun pengajar berhasil diambil.",{data:k,pagination:r.pagination});return a.status(200).json(b.toResponse())}catch(e){r.error(`| Educator KMIS | - Error function index : ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await s.transaction(),{name:l,email:d}=e.body;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const u=await b(d,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(r.info(`[email-check] ${d} -> ${u.ok} (${u.reason}) ${JSON.stringify(u.detail||[])}`),!u.ok){const e=new p(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${d}' tampaknya tidak dapat menerima email. Gunakan email valid yang lain.`);return a.status(422).json(e.toResponse())}if(await t("users").whereRaw("lower(email) = lower(?)",[d]).whereNull("deleted_at").first()){const e=new p(422,"DUPLICATE_EMAIL","Duplikat Data",`Email '${d}' sudah digunakan oleh akun pengajar lain. Silakan gunakan email lain.`);return a.status(422).json(e.toResponse())}const c=_(l),m=k(8),w=await i.hash(m,12),[f]=await t("users").insert({name:l,email:d,role_id:2,account_status:2,password:w}).returning(["id","name","email","created_at"]);await h.logCreate({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit();const y=o.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),R=g("credential_educator.html",{name:c,email:f.email,password:m,login_url:process.env.APP_LOGIN_URL||"#",from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await y.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:f.email,subject:"Credential Akun Pengajar RIMBA",html:R}),r.info(`| Educator KMIS | - Credential email successfully sent to ${f.email} at ${(new Date).toISOString()}`);const E=new p(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data akun pengajar dengan email '${d}' berhasil ditambahkan.`);return a.status(201).json(E.toResponse())}catch(e){await t.rollback(),r.error(`| Educator KMIS | - Error function store: ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await s("users").select("*").where("id",t).where("role_id",2).first();if(!e){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data pengajar dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await w(e),i=_(e.name),r=new m(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data pengajar '${i}' berhasil didapatkan.`,n);return a.status(200).json(r.toResponse())}catch(e){r.error(`| Educator KMIS | - Error function show: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await s.transaction(),{name:i,email:o}=e.body,l=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new p(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(!await t("users").where("id",l).where("role_id",2).first()){const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data pengajar dengan ID '${l}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const d=await b(o,{useSmtp:!0,strict:!1,timeoutMs:7e3,maxMx:3});if(r.info(`[email-check] ${o} -> ${d.ok} (${d.reason}) ${JSON.stringify(d.detail||[])}`),!d.ok){const e=new p(422,"EMAIL_NOT_DELIVERABLE","Email Tidak Dapat Dikirim",`Alamat email '${o}' tampaknya tidak dapat menerima email. Gunakan email valid yang lain.`);return a.status(422).json(e.toResponse())}if(await t("users").whereRaw("lower(email) = lower(?)",[o]).whereNull("deleted_at").whereNot("id",l).first()){const e=new p(422,"DUPLICATE_TITLE","Duplikat Data",`Email '${o}' sudah digunakan pada pengguna lain.`);return a.status(422).json(e.toResponse())}const u={name:i,email:o,updated_at:t.fn.now()};await t("users").where("id",l).update(u),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit();const c=new p(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui Data",`Akun pengajar dengan email '${o}' berhasil diperbarui.`);return a.status(200).json(c.toResponse())}catch(e){await t.rollback(),r.error(`| Educator KMIS | - Error function update : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",2).where("account_status",3).whereNotNull("deactivate_at").select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_DELETED","Akun Sudah Dihapus",`Terdapat ${s.length} akun pengajar yang sudah dihapus: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").whereIn("id",n).where("role_id",2).whereNot("account_status",3).select("id","name");if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data pengguna yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:3,deactivate_at:t.fn.now(),deleted_at:t.fn.now()}),await h.logDelete({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit();const l=new p(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) dan menonaktifkan ${o.length} data pengajar.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),r.error(`| Educator KMIS | - Error function destroy : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const r=await t("users").whereIn("id",n).where("role_id",2).where("account_status",2).whereNull("deleted_at").select("id","name");if(r.length>0){await t.rollback();const e=r.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=r.length>5?`, dan ${r.length-5} lainnya`:"",i=new p(409,"ACCOUNT_NOT_DELETED","Akun Belum Terhapus",`Terdapat ${r.length} akun pengajar yang belum terhapus atau sudah dikembalikan: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const o=await t("users").select("id","email").whereIn("id",n).where("role_id",2).where("account_status",3).whereNotNull("deleted_at");if(0===o.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data akun pengajar terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=o.map(e=>(e.email||"").toLowerCase()),d=await t("users").select(s.raw("lower(email) AS lemail")).whereNull("deleted_at").whereIn(s.raw("lower(email)"),l),u=new Set(d.map(e=>e.lemail)),m=new Set,g=new Set;for(const e of o){const a=(e.email||"").toLowerCase();m.has(a)?g.add(a):m.add(a)}const w=[],_=[],k=new Set;for(const e of o){const a=(e.email||"").toLowerCase(),t=u.has(a),n=g.has(a);t||n||k.has(a)?_.push({id:e.id,email:e.email}):(k.add(a),w.push(e))}let b=0;if(w.length>0){const e=w.map(e=>e.id);await t("users").whereIn("id",e).update({deleted_at:null,account_status:2,deactivate_at:null,updated_at:t.fn.now()}),b=e.length}if(await h.logRestore({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit(),0===b){const e=new p(422,"DUPLICATE_EMAIL","Restore Gagal","Semua ID gagal direstore karena duplikat email dengan entri aktif atau duplikat email di dalam batch.");return a.status(422).json(e.toResponse())}const f=[`Berhasil mengembalikan dan mengaktifkan kembali ${b} data pengajar.`];_.length&&f.push(`Terlewat ${_.length} karena konflik/duplikat email.`);const y=new p(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",f.join(" "));return a.status(200).json(y.toResponse())}catch(e){r.error(`| Educator KMIS | - Error function restore: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.deactivateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.deactivateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deactivateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",2).where("account_status",3).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_INACTIVE","Akun Sudah Nonaktif",`Terdapat ${s.length} akun pengajar yang sudah nonaktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id","email").whereIn("id",n).where("role_id",2).whereNull("deleted_at").whereNot("account_status",3);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun pengajar yang cocok untuk dinonaktifkan atau akun sudah nonaktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:3,deactivate_at:t.fn.now(),updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil menonaktifkan ${o.length} akun pengajar.`];l>0&&d.push(`Terlewat ${l} data, karena sudah nonaktif atau telah dihapus.`);const u=new p(200,"SUCCESS_DEACTIVATE_ACCOUNT","Berhasil Nonaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){await t.rollback(),r.error(`| Educator KMIS | - Error function deactivateAccount : ${e.message}`);const n=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.activateAccount=async(e,a)=>{const t=await s.transaction();try{const n=c(e.body?.activateAccountIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new p(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan activateAccountIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new p(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("users").whereIn("id",n).where("role_id",2).where("account_status",2).select("id","name");if(s.length>0){await t.rollback();const e=s.slice(0,5).map(e=>`'${e.name}' (ID: ${e.id})`).join(", "),n=s.length>5?`, dan ${s.length-5} lainnya`:"",i=new p(409,"ACCOUNT_ALREADY_ACTIVE","Akun Sudah Aktif",`Terdapat ${s.length} akun pengajar yang sudah aktif: ${e}${n}. Operasi dibatalkan.`);return a.status(409).json(i.toResponse())}const r=await t("users").select("id").whereIn("id",n).where("role_id",2).whereNull("deleted_at").whereNot("account_status",2);if(0===r.length){await t.rollback();const e=new p(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada akun pengajar yang cocok untuk diaktifkan atau akun sudah aktif/terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id);await t("users").whereIn("id",o).update({account_status:2,deactivate_at:null,updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"kmis",subject:"Akun Pengajar"},t),await t.commit();const l=n.length-o.length,d=[`Berhasil mengaktifkan ${o.length} akun pengajar.`];l>0&&d.push(`Terlewat ${l} karena sudah aktif, bukan educator, atau telah dihapus.`);const u=new p(200,"SUCCESS_ACTIVATE_ACCOUNT","Berhasil Mengaktifkan Akun",d.join(" "));return a.status(200).json(u.toResponse())}catch(e){r.error(`| Educator KMIS | - Error function activateAccount: ${e.message}`);const t=new p(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},8196:(e,a,t)=>{const n=t(7252).Router(),i=t(1483),{storeQuizAttemptValidator:s}=t(3318),{storeSubmitAllAttemptValidator:r}=t(2534),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(7443),m=t(8461)();n.use(d,l,c("student")),n.post("/create",u(["create.kmis_learning_course"]),m.none(),s,o,i.storeQuizAttempt),n.post("/submit-answer",u(["create.kmis_learning_course"]),m.none(),r,o,i.submitAllAttempt),e.exports=n},8284:(e,a,t)=>{const n=t(3623);e.exports={blacklistToken:async(e,a)=>{const t=parseInt(a,10);!Number.isInteger(t)||t<=0?(console.warn(`[Redis] Invalid expirationInSeconds (${a}), fallback to 86400`),await n.setEx(`blacklist:${e}`,86400,"true")):await n.setEx(`blacklist:${e}`,t,"true")},isTokenBlacklisted:async e=>"true"===await n.get(`blacklist:${e}`)}},8374:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{normJsonbArray:r,normIdArray:o}=t(7872),{asJsonb:l}=t(6192),{applyRelationIn:d,applySearch:u,applyPagination:c,formatPaginationResult:m}=t(3210),{toYoutubeEmbed:p}=t(99),g=t(1701),w=t(1332),h=t(6870),_=t(6479),{applyTrashedScope:k}=t(7438),{applyLatestThenTrashed:b}=t(7540),f=t(5278);async function y(){const e=await i.transaction();try{const a=await e("kmis_topics").select("id","material_order_ids").whereNull("deleted_at");for(const t of a){const a=(await e("kmis_materials").select("id").where("kmis_topic_id",t.id).whereNull("deleted_at")).map(e=>Number(e.id));await e("kmis_topics").where("id",t.id).update({material_order_ids:l(a),updated_at:e.fn.now()})}const t=await e("kmis_learning_attempts").select("id","kmis_topic_id","completed_material_ids").whereNull("deleted_at");for(const a of t){const t=(await e("kmis_materials").select("id").where("kmis_topic_id",a.kmis_topic_id).whereNull("deleted_at")).map(e=>Number(e.id)),n=o(a.completed_material_ids,{as:"number"}).filter(e=>t.includes(e));await e("kmis_learning_attempts").where("id",a.id).update({completed_material_ids:l(n),updated_at:e.fn.now()})}await e.commit()}catch(a){throw await e.rollback(),s.error(`| Material KMIS | - Error function syncMaterialOrder: ${a.message}`),new Error(`Error syncing material order: ${a.message}`)}}a.index=async(e,a)=>{const{search:t,topicId:n}=e.query,r=n??e.query["topicId[]"],o=Number(e.userId);try{const n=await i("users").select("id","role_id").where({id:o}).first();if(!n){const e=new h(401,"USER_NOT_FOUND","Akses Ditolak","Pengguna tidak ditemukan di sistem. Silakan hubungi admin.");return a.status(401).json(e.toResponse())}const s=Number(n.role_id);let l=i("kmis_materials as material").leftJoin("kmis_topics as topic","topic.id","material.kmis_topic_id").select(["material.id","material.kmis_topic_id","material.created_by","material.uploaded_by","material.materials_file_ids","material.materials_cover_ids","material.title","material.material_types","material.material_data","material.description","material.deleted_at","material.created_at","material.updated_at","topic.id as topic_id","topic.title as topic_title"]);Number.isFinite(s)&&1===s||l.where("material.created_by",o),k(l,e,"material.deleted_at"),d(l,"material.kmis_topic_id",r,{as:"number"}),u(l,t,["material.title","topic.title"]),b(l,"material.deleted_at","material.created_at","material.id");const p=c(e.query),g=await m(l,p,i);if(0===g.data.length){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const _=await Promise.all(g.data.map(e=>f(e))),y=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data materi berhasil diambil.",{data:_,pagination:g.pagination});return a.status(200).json(y.toResponse())}catch(e){s.error(`| Material KMIS | - Error function index : ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{materialType:r,title:d,description:u,topicId:c,materialUrl:m}=e.body,w=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=String(r||"").toLowerCase(),k=e.files?.materialCovers||[],b=e.files?.materialFiles||[],f="video"===s&&m?p(m):m,R={"application/pdf":"PDF","application/msword":"DOC","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"DOCX","application/vnd.ms-excel":"XLS","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"XLSX","application/vnd.ms-powerpoint":"PPT","application/vnd.openxmlformats-officedocument.presentationml.presentation":"PPTX","image/jpeg":"JPG/JPEG","image/jpg":"JPG","image/png":"PNG"},E=["image/jpeg","image/png","image/jpg"],D=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"],T=52428800,S=e=>[...new Set(e.map(e=>R[e]||e))].join(", "),A=(e,a,t)=>{const n=S(a);for(const i of e){if(!a.includes(i.mimetype))throw new h(422,"INVALID_FILE_TYPE","Tipe File Salah",`${t} harus berformat: ${n}.`);if(i.size>T)throw new h(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar",`Ukuran maksimal tiap file pada ${t} adalah 50mB.`)}return null};if("gambar"===s){if(0===b.length){const e=new h(422,"FILES_NOT_FOUND","File Tidak Ditemukan","Berkas materi (materialFiles) wajib diunggah untuk tipe gambar.");return a.status(422).json(e.toResponse())}A(b,E,"Berkas materi (materialFiles)")}else if("dokumen"===s){if(0===b.length){const e=new h(422,"FILES_NOT_FOUND","File Tidak Ditemukan","Berkas materi (materialFiles) wajib diunggah untuk tipe dokumen.");return a.status(422).json(e.toResponse())}A(b,D,"Berkas materi (materialFiles)")}else b.length>0&&A(b,D,"Berkas materi (materialFiles)");if(await t("kmis_materials").whereRaw("lower(title) = lower(?)",[d]).where("kmis_topic_id",c).whereNull("deleted_at").first()){const e=new h(422,"DUPLICATE_TITLE","Duplikat Data",`Judul materi '${d}' sudah digunakan oleh materi ini. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}let I=[],N=[];k.length>0&&(I=await g.uploadDocuments(k,e)),b.length>0&&(N=await g.uploadDocuments(b,e));const j=o(e.body.materialCovers,{as:"number"}),v=o(e.body.materialFiles,{as:"number"}),O=j.length?j:I,L=v.length?v:N;await t("kmis_materials").insert({created_by:w,uploaded_by:w,kmis_topic_id:c??null,material_types:s,title:d,description:u,material_data:f??null,materials_file_ids:L?.length?l(L):null,materials_cover_ids:O?.length?l(O):null}).returning("*"),await _.logCreate({userId:_.fromReq(e),module:"kmis",subject:"List Materi"},t),await t.commit(),await y();const M=new h(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data materi '${d}' berhasil ditambahkan.`);return a.status(201).json(M.toResponse())}catch(e){if(await t.rollback(),e&&"function"==typeof e.toResponse){const t=e.status||e.statusCode||422;return a.status(t).json(e.toResponse())}s.error(`| Material KMIS | - Error function store: ${e?.message||String(e)}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("kmis_materials").select("*").where("id",t).first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data materi dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await f(e),s=new w(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data materi '${e.title}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Material KMIS | - Error function show: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{materialType:d,title:u,description:c,topicId:m,materialUrl:w,materialCovers:k,materialFiles:b,deleteCoverIds:f,deleteFileIds:R}=e.body,E=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const D=await t("kmis_materials").where("id",E).first();if(!D){const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data materi dengan ID '${E}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const T=String(d??D.material_types??"").toLowerCase(),S=e.files?.materialCovers||[],A=e.files?.materialFiles||[],I="video"===T&&w?p(w):w,N={"application/pdf":"PDF","application/msword":"DOC","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"DOCX","application/vnd.ms-excel":"XLS","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"XLSX","application/vnd.ms-powerpoint":"PPT","application/vnd.openxmlformats-officedocument.presentationml.presentation":"PPTX","image/jpeg":"JPG/JPEG","image/jpg":"JPG","image/png":"PNG","image/webp":"WEBP"},j=["image/jpeg","image/png","image/jpg","image/webp"],v=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"],O=52428800,L=e=>[...new Set(e.map(e=>N[e]||e))].join(", "),M=(e,a,t)=>{const n=L(a);for(const i of e){if(!a.includes(i.mimetype))throw new h(422,"INVALID_FILE_TYPE","Tipe File Salah",`${t} harus berformat: ${n}.`);if(i.size>O)throw new h(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar",`Ukuran maksimal tiap file pada ${t} adalah 50mB.`)}return null};if(S.length>0){const e=M(S,j,"File cover (materialCovers)");if(e)return a.status(422).json(e.toResponse());if(S.length>5)return a.status(422).json(new h(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload cover per request adalah 5 file.").toResponse())}if(A.length>0){const e=M(A,"gambar"===T?j:v,"Berkas materi (materialFiles)");if(e)return a.status(422).json(e.toResponse())}const C=o(r(D.materials_cover_ids),{as:"number"}),F=o(r(D.materials_file_ids),{as:"number"}),P=o(f,{as:"number"}),$=o(R,{as:"number"});let U=C.filter(e=>!P.includes(e)),V=F.filter(e=>!$.includes(e)),B=[],q=[];S.length>0&&(B=o(await g.uploadDocuments(S,e),{as:"number"})),A.length>0&&(q=o(await g.uploadDocuments(A,e),{as:"number"}));const x=o(k,{as:"number"}),z=o(b,{as:"number"}),K=e=>Array.from(new Set(e.filter(e=>null!=e)));if(U=K([...U,...x,...B]),V=K([...V,...z,...q]),"gambar"===T){if(0===V.length){const e=new h(422,"FILES_REQUIRED","File Wajib","Untuk tipe 'gambar', minimal harus ada 1 berkas pada materialFiles.");return a.status(422).json(e.toResponse())}}else if("dokumen"===T&&0===V.length){const e=new h(422,"FILES_REQUIRED","File Wajib","Untuk tipe 'dokumen', minimal harus ada 1 berkas pada materialFiles.");return a.status(422).json(e.toResponse())}if(await t("kmis_materials").whereRaw("lower(title) = lower(?)",[u]).where("kmis_topic_id",m).whereNull("deleted_at").whereNot("id",E).first()){const e=new h(422,"DUPLICATE_TITLE","Duplikat Data",`Judul '${u}' sudah digunakan pada materi lain.`);return a.status(422).json(e.toResponse())}await t("kmis_materials").where("id",E).update({kmis_topic_id:m??D.kmis_topic_id,material_types:T||D.material_types,title:u??D.title,description:c??D.description,material_data:I??D.material_data,materials_cover_ids:l(U),materials_file_ids:l(V),updated_at:t.fn.now()}),await _.logUpdate({userId:_.fromReq(e),module:"kmis",subject:"List Materi"},t),await t.commit(),await y();const G=[...P,...$].filter(e=>Number.isFinite(e));if(G.length)try{await g.deleteDocuments(G)}catch(e){s?.error?.(`| Material KMIS | - Gagal hapus dokumen: ${e.message}`)}const J=new h(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data materi '${u}' berhasil diperbarui.`);return a.status(200).json(J.toResponse())}catch(e){if(await t.rollback(),e&&"function"==typeof e.toResponse){const t=e.status||e.statusCode||422;return a.status(t).json(e.toResponse())}s.error(`| Material KMIS | - Error function update : ${e.message}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new h(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new h(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("kmis_materials").select("id","title").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data materi yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("kmis_materials").whereIn("id",r).update({deleted_at:t.fn.now()}),await _.logDelete({userId:_.fromReq(e),module:"kmis",subject:"List Materi"},t),await t.commit(),await y();const l=new h(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data materi.`);return a.status(200).json(l.toResponse())}catch(e){await t.rollback(),s.error(`| Material KMIS | - Error function destroy : ${e.message}`);const n=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=o(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new h(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new h(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("kmis_materials").select("id","title").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new h(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data materi terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const l=r.map(e=>e.title?.toLowerCase?.()??""),d=await t("kmis_materials").select(i.raw("lower(title) AS ltitle")).whereNull("deleted_at").whereIn(i.raw("lower(title)"),l),u=new Set(d.map(e=>e.ltitle)),c=new Set,m=new Set;for(const e of r){const a=(e.title||"").toLowerCase();c.has(a)?m.add(a):c.add(a)}const p=[],g=[],w=new Set;for(const e of r){const a=(e.title||"").toLowerCase(),t=u.has(a),n=m.has(a);t||n||w.has(a)?g.push({id:e.id,title:e.title}):(w.add(a),p.push(e))}let k=0;if(p.length>0){const e=p.map(e=>e.id);await t("kmis_materials").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),k=e.length}if(await _.logRestore({userId:_.fromReq(e),module:"kmis",subject:"List Materi"},t),await t.commit(),await y(),0===k){const e=new h(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const b=[`Berhasil mengembalikan ${k} data materi yang terhapus.`];g.length&&b.push(`Terlewat ${g.length} karena bentrok/duplikat data.`);const f=new h(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",b.join(" "));return a.status(200).json(f.toResponse())}catch(e){s.error(`| Material KMIS | - Error function restore: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},8409:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=Object.freeze(["A","B","C","D"]);a.storeQuizValidator=[n("topicId").notEmpty().withMessage("Topik kuis wajib dipilih.").bail().isInt().withMessage("Topik kuis harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_topics").where("id",e).whereNull("deleted_at").first())throw new Error("Topik kuis yang Anda pilih tidak ditemukan.");return!0}),n("question").trim().notEmpty().withMessage("Soal pertanyaan tidak boleh kosong.").bail().isString().withMessage("Soal pertanyaan harus berupa teks."),n("answerA").trim().notEmpty().withMessage("Jawaban pilihan A tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan A harus berupa teks."),n("answerB").trim().notEmpty().withMessage("Jawaban pilihan B tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan B harus berupa teks."),n("answerC").trim().notEmpty().withMessage("Jawaban pilihan C tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan C harus berupa teks."),n("answerD").trim().notEmpty().withMessage("Jawaban pilihan D tidak boleh kosong.").bail().isString().withMessage("Jawaban pilihan D harus berupa teks."),n("correctOption").trim().notEmpty().withMessage("Jawaban tidak boleh kosong.").bail().isString().withMessage("Jawaban harus berupa teks.").bail().isIn(s).withMessage(`Jawaban harus salah satu dari: ${s.join(", ")}.`),n("explanation").customSanitizer(e=>{if(null==e)return null;const a=String(e).trim();return""===a?null:a}).optional({nullable:!0}).isString().withMessage("Penjelasan jawaban dari pertanyaan harus berupa teks.")]},8461:e=>{"use strict";e.exports=require("multer")},8467:(e,a,t)=>{const n=t(2250).promises,i=t(6039),s=new Set(["gmail.com","googlemail.com","yahoo.com","yahoo.co.id","ymail.com","outlook.com","hotmail.com","live.com","msn.com","icloud.com","me.com","proton.me","protonmail.com","yandex.com","gmx.com","aol.com","zoho.com"]);function r(e){return new Promise(a=>setTimeout(a,e))}async function o(e,a,{timeoutMs:t,heloName:n,probeFrom:s}){return new Promise(r=>{const o=new i({host:e,port:25,name:n||void 0,ignoreTLS:!1,socketTimeout:Math.min(t,8e3),connectionTimeout:Math.min(t,6e3),greetingTimeout:Math.min(t,6e3)}),l=e=>{try{o.close()}catch(e){}r(e)};o.on("error",()=>l({ok:!1,reason:"SMTP_UNAVAILABLE"})),o.connect(()=>{const e=null==s?"":String(s);o.send({from:e,to:[a]},Buffer.from("probe\r\n"),e=>{if(!e)return l({ok:!0,reason:"SMTP_ACCEPT"});const a=Number(e&&(e.responseCode||e.code)||0);return l(a>=500&&a<600?{ok:!1,reason:"SMTP_REJECT"}:a>=400&&a<500?{ok:!1,reason:"SMTP_TEMPFAIL"}:{ok:!1,reason:"SMTP_UNAVAILABLE"})})})})}async function l(e,a={}){const{useSmtp:t=!0,strict:i=!1,timeoutMs:l=7e3,maxMx:d=3,heloName:u,probeFrom:c}=a;if("string"!=typeof e||!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e))return{ok:!1,reason:"INVALID_FORMAT"};const m=e.split("@")[1].toLowerCase();let p;try{if(p=await async function(e){return(await n.resolveMx(e)||[]).sort((e,a)=>e.priority-a.priority)}(m),!p||0===p.length)return{ok:!1,reason:"NO_MX"}}catch{return{ok:!1,reason:"DNS_ERROR"}}if(s.has(m))return{ok:!0,reason:"TRUSTED_DOMAIN_MX"};if(!t)return{ok:!0,reason:"MX_FOUND"};const g=[];for(const a of p.slice(0,Math.max(1,d))){const t=await Promise.race([o(a.exchange,e,{timeoutMs:l,heloName:u,probeFrom:c}),r(l).then(()=>({ok:!1,reason:"SMTP_UNAVAILABLE"}))]);if(g.push({host:a.exchange,...t}),t.ok&&"SMTP_ACCEPT"===t.reason)return{ok:!0,reason:"SMTP_ACCEPT",detail:g};t.reason}const w=g.some(e=>"SMTP_REJECT"===e.reason),h=g.every(e=>"SMTP_TEMPFAIL"===e.reason||"SMTP_UNAVAILABLE"===e.reason);return w?{ok:!1,reason:"SMTP_REJECT",detail:g}:h?{ok:!i,reason:i?"SMTP_TEMPFAIL":"SOFT_PASS_TEMPORARY",detail:g}:{ok:!i,reason:i?"SMTP_UNAVAILABLE":"SOFT_PASS_MIXED",detail:g}}e.exports={checkEmailDeliverability:l,isEmailDeliverable:async function(e,a={}){const{ok:t}=await l(e,a);return t},TRUSTED_CONSUMER_DOMAINS:s}},8503:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{orderByYearMonth:r}=t(9062),o=t(1332),l=t(6870),d=t(6004),u=t(6479);function c(e,a){const t=function(e){const a=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],t=Number(e);return Number.isFinite(t)?t>=0&&t<=11?a[t]:t>=1&&t<=12?a[t-1]:String(e):String(e??"")}(e);return null!=a?`${t} ${a}`:t}a.getTargetbyActivityPackageId=async(e,a)=>{const{id:t}=e.params;try{if(!await i("monev_activity_packages").select("id").where("id",t).whereNull("deleted_at").first()){const e=new l(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Paket aktivitas dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const{sql:e,bindings:n}=r("year","month","asc","asc"),s=await i("monev_targets").where("monev_activity_packages_id",t).whereNull("deleted_at").orderByRaw(e,n),u=await i("monev_target_pending_updates").where("monev_activity_packages_id",t).whereNull("deleted_at").orderByRaw(e,n),c=await Promise.all(s.map(e=>d(e))),m=await Promise.all(u.map(e=>d(e))),p=new o(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Daftar target untuk paket aktivitas #${t} berhasil didapatkan.`,{monevTargetOriginal:c,monevTargetPendingUpdate:m});return a.status(200).json(p.toResponse())}catch(e){s.error(`| Target MONEV | - Error function getTargetbyActivityPackageId: ${e.message}`);const t=new l(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),r={budgetTarget:e.body.budgetTarget,physicalTarget:e.body.physicalTarget,description:e.body.description},o=e.userId,d=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new l(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const m=await i("users").select("id","role_id").where({id:o}).first();if(!m){await t.rollback();const e=new l(200,"INVALID_USER_ID","Akun Tidak Ditemukan",`Akun dengan id '${o}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const p=Number(m.role_id),g=await async function(e,{id:a,payload:t,userId:n,userRoleId:i}){const s=e=>!(null==e||""===String(e).trim()||/^null$/i.test(String(e))||/^undefined$/i.test(String(e))),r=e=>null===e||0===Number(e),o=e.fn.now(),l=(g=t.budgetTarget,s(g)?Math.max(0,parseInt(g,10)):null),d=(e=>s(e)?Math.max(0,parseFloat(e)):null)(t.physicalTarget),{description:m}=t,p=await e("monev_targets").select(["id","validate_by","edited_by","monev_activity_packages_id","month","year","budget_target","physical_target","description","validation_status","rejection_message"]).where("id",a).forUpdate().first();var g;if(!p){const e=new Error("Target not found");throw e.code="TARGET_NOT_FOUND",e}const w=c(p.month,p.year);if(1===Number(i)){const t={edited_by:n,validate_by:n,validation_status:2,validate_at:o,updated_at:o};return s(l)&&(t.budget_target=l),s(d)&&(t.physical_target=d),s(m)&&(t.description=m),await e("monev_targets").where("id",a).update(t),await u.logUpdate({userId:n,module:"monev",subject:`Target Kegiatan Bulan '${p.month} ${p.year}' (update langsung oleh superadmin)`},e),await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").update({deleted_at:o,updated_at:o}),{mode:"direct",patch:t}}if(r(p.budget_target)&&r(p.physical_target)){const t={updated_at:o,edited_by:n,validation_status:2,validate_by:n,updated_at:o};return s(l)&&(t.budget_target=l),s(d)&&(t.physical_target=d),s(m)&&(t.description=m),await e("monev_targets").where("id",a).update(t),await u.logUpdate({userId:n,module:"monev",subject:`Target Kegiatan Bulan '${w}' (update langsung)`},e),{mode:"direct",patch:t}}const h={monev_target_id:a,edited_by:n,monev_activity_packages_id:p.monev_activity_packages_id,month:p.month,year:p.year,budget_target:s(l)?l:p.budget_target,physical_target:s(d)?d:p.physical_target,description:s(m)?m:p.description};if(1===p.validation_status){const t=await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").orderBy("created_at","desc").first();if(t)return await e("monev_target_pending_updates").where("id",t.id).update({...h,updated_at:o}),await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").whereNot("id",t.id).update({deleted_at:o,updated_at:o}),await u.logUpdate({userId:n,module:"monev",subject:`Target Kegiatan Bulan '${w}' (pending update replaced)`},e),{mode:"pending",pending:{id:t.id,...h}}}const _={...h,created_at:o,updated_at:o},k=await e("monev_target_pending_updates").insert(_).returning(["id"]),b=Array.isArray(k)?"object"==typeof k[0]?k[0].id:k[0]:null;return 1!==p.validation_status&&await e("monev_targets").where("id",a).update({validation_status:1,updated_at:o}),await u.logCreate({userId:n,module:"monev",subject:`Target Kegiatan Bulan '${w}'  (pending update)`},e),{mode:"pending",pending:{id:b,..._}}}(t,{id:d,payload:r,userId:o,userRoleId:p});if(await t.commit(),"direct"===g.mode){const e=new l(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui","Perubahan target berhasil diperbarui langsung karena sebelumnya belum memiliki data.");return a.status(200).json(e.toResponse())}const w=new l(200,"SUCCESS_QUEUE_UPDATE","Perubahan Menunggu Validasi","Perubahan target berhasil disimpan sebagai usulan dan menunggu validasi.");return a.status(200).json(w.toResponse())}catch(e){await t.rollback(),s.error(`| Target MONEV | - Error function update : ${e.message}`);const n=new l(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.verification=async(e,a)=>{const t=await i.transaction(),r={validationStatus:e.body.validationStatus,rejectionReason:e.body.rejectionReason},o=e.userId,d=e.params.id;try{const s=n(e);if(!s.isEmpty()){const e=s.array().map(e=>e.msg).join(" "),t=new l(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const m=await i("users").select("id","role_id").where({id:o}).first();if(!m){await t.rollback();const e=new l(200,"INVALID_USER_ID","Akun Tidak Ditemukan",`Akun dengan id '${id}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(1!==Number(m.role_id)){await t.rollback();const e=new l(403,"FORBIDDEN_ROLE","Akses Ditolak","Anda tidak memiliki hak untuk melakukan Verifikasi Target.");return a.status(403).json(e.toResponse())}const p=await t("monev_target_pending_updates").select(["id","monev_target_id"]).where("id",d).whereNull("deleted_at").forUpdate().first();if(!p){await t.rollback();const e=new l(422,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data target pending dengan ID '${id}' tidak ditemukan.`);return a.status(422).json(e.toResponse())}const g=p.monev_target_id,w=await t("monev_targets").select(["id","month","year","budget_target","physical_target","description","validation_status","rejection_message"]).where("id",g).forUpdate().first();if(!w){await t.rollback();const e=new l(422,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Target dengan ID '${id}' tidak ditemukan.`);return a.status(422).json(e.toResponse())}const h=c(w.month,w.year),_=function(e){if(null==e)return null;const a=String(e).trim();if(/^-?\d+$/.test(a)){const e=Number(a);return e>=0&&e<=11?e:e>=1&&e<=12?e-1:null}return{jan:0,january:0,januari:0,feb:1,february:1,februari:1,mar:2,march:2,maret:2,apr:3,april:3,may:4,mei:4,jun:5,june:5,juni:5,jul:6,july:6,juli:6,aug:7,august:7,agustus:7,sep:8,sept:8,september:8,oct:9,october:9,oktober:9,nov:10,november:10,dec:11,december:11,desember:11}[a.toLowerCase()]??null}(w.month),k=Number(w.year);if(!Number.isFinite(k)||null==_){await t.rollback();const e=new l(422,"INVALID_PERIOD","Periode Tidak Valid","Nilai bulan/tahun tidak valid untuk diverifikasi.");return a.status(422).json(e.toResponse())}const b=new Date,f=b.getFullYear(),y=b.getMonth();if(k>f||k===f&&_>y){await t.rollback();const e=new l(422,"FUTURE_PERIOD_NOT_ALLOWED","Tidak Boleh Verifikasi Periode Mendatang",`Periode '${h}' masih di masa depan dan belum bisa diverifikasi.`);return a.status(422).json(e.toResponse())}if(2===w.validation_status||3===w.validation_status){const e=new l(200,"ALREADY_VALIDATED","Sudah Divalidasi",`Target bulan '${h}' sudah berstatus ${{1:"Pending",2:"Approve",3:"Rejected"}[w.validation_status]}.`);return a.status(200).json(e.toResponse())}const R=await async function(e,{targetId:a,payload:t,userId:n}){const i=e.fn.now(),s=await e("monev_targets").select(["id","month","year"]).where("id",a).first();if(!s){const e=new Error("Target not found");throw e.code="TARGET_NOT_FOUND",e}const r=c(s.month,s.year),o=await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").orderBy("created_at","desc").first();if(2===t.validationStatus){if(!o){const e=new Error("Tidak ada usulan pending untuk diverifikasi.");throw e.code="NO_PENDING",e}const t={budget_target:o.budget_target,physical_target:o.physical_target,description:o.description,validate_by:n,validate_at:i,validation_status:2,rejection_message:null,updated_at:i};return await e("monev_targets").where("id",a).update(t),await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").update({deleted_at:i,updated_at:i}),await u.logUpdate({userId:n,module:"monev",subject:`Verifikasi Target Bulan '${r}' (APPROVED)`},e),{mode:"approved",month:s.month,year:s.year,patch:t}}const l={validate_by:n,validate_at:i,validation_status:3,rejection_message:t.rejectionReason??null,updated_at:i};return await e("monev_targets").where("id",a).update(l),await e("monev_target_pending_updates").where({monev_target_id:a}).whereNull("deleted_at").update({deleted_at:i,updated_at:i}),await u.logUpdate({userId:n,module:"monev",subject:`Verifikasi Target Bulan '${r}' (REJECTED)`},e),{mode:"rejected",month:s.month,year:s.year,patch:l}}(t,{targetId:g,payload:r,userId:o}),E=c(R.month,R.year);if(await t.commit(),"approved"===R.mode){const e=new l(200,"SUCCESS_APPROVE","Berhasil Approve",`Target bulan '${E}' berhasil disetujui dan diperbarui.`);return a.status(200).json(e.toResponse())}const D=new l(200,"SUCCESS_REJECT","Berhasil Reject",`Target bulan '${E}' ditolak dengan alasan: ${r.rejectionReason}.`);return a.status(200).json(D.toResponse())}catch(e){await t.rollback(),s.error(`| Target MONEV | - Error function verification : ${e.message}`);const n=new l(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}}},8573:(e,a,t)=>{const{body:n}=t(7975);a.updateLegalDocumentValidator=[n("title").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0)]},8577:e=>{"use strict";e.exports=require("cors")},8605:(e,a,t)=>{const n=t(7252).Router(),i=t(8374),{storeMaterialValidator:s}=t(3997),{updateMaterialValidator:r}=t(9325),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)().fields([{name:"materialCovers",maxCount:1},{name:"materialFiles",maxCount:5}]);n.use(d,l),n.get("/index",u(["view.kmis_material"]),i.index),n.get("/show/:id",u(["view.kmis_material"]),i.show),n.post("/create",u(["create.kmis_material"]),c,s,o,i.store),n.patch("/update/:id",u(["edit.kmis_material"]),c,r,o,i.update),n.delete("/delete",u(["delete.kmis_material"]),i.destroy),n.patch("/restore",u(["restore.kmis_material"]),i.restore),e.exports=n},8617:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.updateTopicValidator=[n("categoryId").optional({nullable:!0,checkFalsy:!0}).bail().isInt().withMessage("Kategori topik harus berupa angka.").bail().custom(async e=>{if(!await i("kmis_categories").where("id",e).first())throw new Error("Kategori topik yang Anda pilih tidak ditemukan.");return!0}),n("topicType").notEmpty().withMessage("Tipe topik tidak boleh kosong.").isIn(["Pengetahuan","Pelatihan"]).withMessage("Tipe topik harus salah satu dari Pengetahuan dan Pelatihan."),n("title").notEmpty().withMessage("Judul topik tidak boleh kosong.").bail().isString().withMessage("Judul topik harus berupa teks.").bail().isLength({max:255}).withMessage("Judul topik maksimal 255 karakter."),n("description").notEmpty().withMessage("Deskripsi topik tidak boleh kosong.").bail().isString().withMessage("Deskripsi topik harus berupa teks."),n("totalQuiz").if(n("topicType").equals("Pelatihan")).notEmpty().withMessage("Jumlah soal pertanyaan wajib diisi untuk tipe topik Pelatihan.").bail().isInt().withMessage("Jumlah soal pertanyaan harus berupa angka."),n("quizDuration").if(n("topicType").equals("Pelatihan")).notEmpty().withMessage("Waktu penyelesaian pertanyaan wajib diisi untuk tipe topik Pelatihan.").bail().isInt().withMessage("Waktu penyelesaian pertanyaan harus berupa angka dan satuan detik.")]},8630:(e,a,t)=>{const n=t(7252).Router(),i=t(8503),{updateTargetValidator:s}=t(690),{updateTargetVerificationValidator:r}=t(4611),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/:id",u(["view.monev_target"]),i.getTargetbyActivityPackageId),n.patch("/update/:id",u(["edit.monev_target"]),c.none(),s,o,i.update),n.patch("/verification/:id",u(["edit.monev_target"]),c.none(),r,o,i.verification),e.exports=n},8641:e=>{e.exports=async function(e){return{id:e.id,name:e.name,description:e.description,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},8669:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(7026),s=t(4930),r=t(2482);e.exports=async function(e){const a=e.cms_news_category_id?await s("cms_news_categories").where("id",e.cms_news_category_id).first():null,t=await n(e.thumbnail_ids,"documents",r);return{id:e.id,newsCategory:a?await i(a):null,thumbnail:t,title:e.title,slug:e.slug,description:e.description,newsContent:e.news_content,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},8737:(e,a,t)=>{const n=t(7252).Router(),i=t(248),{storeTopicValidator:s}=t(521),{updateTopicValidator:r}=t(8617),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.kmis_topic"]),i.index),n.get("/show/:id",u(["view.kmis_topic"]),i.show),n.post("/create",u(["create.kmis_topic"]),c.array("files",20),s,o,i.store),n.patch("/update/:id",u(["edit.kmis_topic"]),c.array("files",20),r,o,i.update),n.delete("/delete",u(["delete.kmis_topic"]),i.destroy),n.patch("/restore",u(["restore.kmis_topic"]),i.restore),e.exports=n},8938:e=>{"use strict";e.exports=require("axios")},8992:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{applySearch:r,applyPagination:o,formatPaginationResult:l}=t(3210),{normJsonbArray:d,normIdArray:u}=t(7872),c=t(1784),m=t(1701),p=t(1332),g=t(6870),w=t(9451),h=t(6479),{applyLatestThenTrashed:_}=t(7540),k=t(6293),b=t(3824),f=t(5789);t(2064),k.extend(b),k.extend(f),k.locale("id");const y=/^\d{4}-\d{2}-\d{2}$/,R=864e5,E=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],D=t(6928),T=t(9896),S=T.promises,A=t(1278),I=t(7172),N=D.resolve(process.cwd(),"src","public","storage","documents","temp"),j=e=>String(e||"export").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80);function v(e){const a=Number(e);if(!Number.isInteger(a)||a<0||a>11){const e=new Error("Index bulan harus 0..11.");throw e.code="INVALID_MONTH_YEAR",e}return a}function O(e){const a=Number(e);return Number.isInteger(a)&&a>=0&&a<=11?E[a]:"N/A"}function L(e){return`"${String(e).replace(/"/g,'""')}"`}function M(e,a,t,n,i,s,r=-1){let o=a;e.save(),e.rect(a,t,i.reduce((e,a)=>e+a,0),22).fill("#f2f2f2"),e.restore(),e.font("Helvetica-Bold").fillColor("black").fontSize(9);for(let a=0;a<n.length;a++)e.rect(o,t,i[a],22).stroke(),e.text(n[a],o+s,t+(s-1),{width:i[a]-2*s,ellipsis:!0,align:a===r?"center":"left"}),o+=i[a];return t+22}function C(e,a,t,n,i,s,r,o,l=-1){let d=a;o%2==1&&(e.save(),e.rect(a,t,i.reduce((e,a)=>e+a,0),s).fill("#fbfbfb"),e.restore()),e.font("Helvetica").fillColor("black").fontSize(9);for(let a=0;a<n.length;a++)e.rect(d,t,i[a],s).stroke(),e.text(n[a],d+r,t+r,{width:i[a]-2*r,height:s-2*r,align:a===l?"center":"left"}),d+=i[a];return t+s}function F(e,a=28){if(!e)return e;const t=String(e);if("N/A"===t||t.length<a)return t;let n=t;const i=new RegExp(`([^\\s]{${a}})(?=[^\\s])`,"g");return n=n.replace(i,"$1"),t.length>=2*a&&(n=n.replace(/([\/_.-])(?!\u200B)/g,"$1")),n}function P(e){if(null==e)return"N/A";if("string"==typeof e&&""===e.trim())return"N/A";if("object"==typeof e)try{return F(JSON.stringify(e))}catch{return"N/A"}return F(String(e))}a.index=async(e,a)=>{const{search:t}=e.query,n=e.userId;try{const s=await i("users").select("id","role_id","email").where({id:n}).first();if(!s){const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Akun tidak valid atau tidak ditemukan.");return a.status(200).json(e.toResponse())}let d=i("monev_activity_packages as activity").select("activity.*");if(1!==Number(s.role_id)){if(!s.email){const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}d.whereExists(function(){this.select(1).from("monev_pic_divisions as d").whereRaw("d.id = activity.monev_pic_division_id").whereNull("d.deleted_at").whereRaw("EXISTS (\n              SELECT 1\n              FROM jsonb_array_elements(d.user_pic) AS up\n              WHERE lower(up->>'email') = lower(?)\n            )",[s.email])})}r(d,t,["activity.mak","activity.name"]),_(d,"activity.created_at","activity.id");const u=o(e.query),c=await l(d,u,i);if(0===c.data.length){const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const m=await Promise.all(c.data.map(e=>w(e))),h=new p(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data paket kegiatan berhasil diambil.",{data:m,pagination:c.pagination});return a.status(200).json(h.toResponse())}catch(e){s.error(`| Activity Package MONEV | - Error function index : ${e.message}`);const t=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{picDivisionId:r,contractType:o,mak:l,name:d,description:u,startedMonth:c,finishedMonth:m,startedYear:p,finishedYear:w,unitOutput:_,codeOutput:k,volume:b,pagu:f,partner:y}=e.body,R=e.userId;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new g(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}let s;try{s=function(e,a,t,n){const i=v(e),s=v(t),r=Number(a),o=Number(n);if(!Number.isInteger(r)||!Number.isInteger(o)){const e=new Error("Tahun harus berupa angka.");throw e.code="INVALID_MONTH_YEAR",e}if(o<r||o===r&&s<i){const e=new Error("finished (bulan/tahun) tidak boleh < started (bulan/tahun).");throw e.code="RANGE_INVALID",e}const l=[];let d=r,u=i;for(;d<o||d===o&&u<=s;)l.push({year:d,month_index:u,month_label:E[u]}),u++,12===u&&(u=0,d++);return{items:l,startIdx:i,endIdx:s,startYear:r,endYear:o}}(c,p,m,w)}catch(e){await t.rollback();const n=new g(422,"RANGE_INVALID"===e.code?"INVALID_RANGE":"INVALID_MONTH_YEAR","Validasi Bulan/Tahun Gagal",e.message||"Rentang bulan/tahun tidak valid.");return a.status(422).json(n.toResponse())}if(await t("monev_activity_packages").whereRaw("lower(name) = lower(?)",[d]).whereNull("deleted_at").first()){await t.rollback();const e=new g(422,"DUPLICATE_NAME","Duplikat Data",`Nama paket kegiatan '${d}' sudah digunakan. Silakan gunakan judul lain.`);return a.status(422).json(e.toResponse())}const[D]=await t("monev_activity_packages").insert({created_by:R,monev_pic_division_id:r,contract_type:o,mak:l,name:d,started_month:s.startIdx,finished_month:s.endIdx,started_year:s.startYear,finished_year:s.endYear,unit_output:_,code_output:k,volume:b,pagu:f,partner:y,description:u}).returning("*");await async function(e,a,t){const n=t.items.map(({year:e,month_index:t})=>({monev_activity_packages_id:a,year:e,month:t}));n.length&&await e("monev_targets").insert(n)}(t,D.id,s),await async function(e,a,t){const n=t.items.map(({year:e,month_index:t})=>({monev_activity_packages_id:a,year:e,month:t,progress:0}));n.length&&await e("monev_monthly_realizations").insert(n)}(t,D.id,s),await h.logCreate({userId:h.fromReq(e),module:"monev",subject:"List Aktivitas Paket Kegiatan"},t),await t.commit();const T=new g(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data paket kegiatan '${d}' berhasil ditambahkan.`);return a.status(201).json(T.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Package MONEV | - Error function store: ${e.message}`);const n=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("monev_activity_packages").select("*").where("id",t).first();if(!e){const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data paket kegiatan dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=await w(e),s=new p(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data paket kegiatan '${e.name}' berhasil didapatkan.`,n);return a.status(200).json(s.toResponse())}catch(e){s.error(`| Activity Package MONEV | - Error function show: ${e.message}`);const t=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{picDivisionId:r,contractType:o,mak:l,name:d,description:u,unitOutput:c,codeOutput:m,volume:p,pagu:w,partner:_}=e.body,k=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new g(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("monev_activity_packages").where("id",k).first();if(!s){const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data paket kegiatan dengan ID '${k}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}if(await t("monev_activity_packages").whereRaw("lower(name) = lower(?)",[d]).whereNull("deleted_at").whereNot("id",k).first()){const e=new g(422,"DUPLICATE_NAME","Duplikat Data",`Judul '${d}' sudah digunakan pada paket kegiatan lain.`);return a.status(422).json(e.toResponse())}await t("monev_activity_packages").where("id",k).update({monev_pic_division_id:r??s.monev_pic_division_id,contract_type:o??s.contract_type,mak:l??s.mak,name:d??s.name,unit_output:c??s.unit_output,code_output:m??s.code_output,volume:p??s.volume,pagu:w??s.pagu,partner:_??s.partner,description:u??s.description,updated_at:t.fn.now()}),await h.logUpdate({userId:h.fromReq(e),module:"monev",subject:"List Aktivitas Paket Kegiatan"},t),await t.commit();const b=new g(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data paket kegiatan '${d}' berhasil diperbarui.`);return a.status(200).json(b.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Package MONEV | - Error function update : ${e.message}`);const n=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=u(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new g(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new g(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const r=await t("monev_activity_packages").select("id","name").whereIn("id",n);if(0===r.length){await t.rollback();const e=new g(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data paket kegiatan yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const o=r.map(e=>e.id),[l,c]=await Promise.all([t("monev_monthly_realizations").select("evidence_file_ids").whereIn("monev_activity_packages_id",o),t("monev_monthly_realization_pending_updates").select("evidence_file_ids").whereIn("monev_activity_packages_id",o)]),p=[],w=e=>{const a=d(e),t=u(a,{as:"number"}).filter(Number.isFinite);p.push(...t)};for(const e of l)w(e?.evidence_file_ids);for(const e of c)w(e?.evidence_file_ids);const _=[...new Set(p)];if(_.length>0)try{await m.deleteDocuments(_)}catch(e){s.warn(`| Activity Package MONEV | - Gagal hapus evidence files (${_.join(", ")}): ${e.message}`)}await t("monev_targets").whereIn("monev_activity_packages_id",o).del(),await t("monev_monthly_realizations").whereIn("monev_activity_packages_id",o).del();const k=await t("monev_activity_packages").whereIn("id",o).del();await h.logDelete({userId:h.fromReq(e),module:"monev",subject:"List Aktivitas Paket Kegiatan"},t),await t.commit();const b=new g(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus secara permanen ${k} data paket kegiatan.`);return a.status(200).json(b.toResponse())}catch(e){await t.rollback(),s.error(`| Activity Package MONEV | - Error function destroy : ${e.message}`);const n=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.export=async(e,a)=>{const{startDate:t,endDate:n}=e.query,r=e.userId;try{const e=await i("users").select("id","role_id","email").where({id:r}).first(),o=i("monev_activity_packages as activity").select("activity.*").whereNull("activity.deleted_at");if(e&&1===Number(e.role_id)||(e?.email?o.whereExists(function(){this.select(1).from("monev_pic_divisions as d").whereRaw("d.id = activity.monev_pic_division_id").whereNull("d.deleted_at").whereRaw("EXISTS (\n                SELECT 1\n                FROM jsonb_array_elements(d.user_pic) AS up\n                WHERE lower(up->>'email') = lower(?)\n              )",[e.email])}):o.whereRaw("false")),t||n){const{startStr:e,endStr:a}=function(e,a){let t=e?c.toUTC(e):null,n=a?c.toUTC(a):null;return a&&"string"==typeof a&&y.test(a.trim())&&(n=new Date(n.getTime()+R)),t&&!n&&(n=new Date(t.getTime()+R)),!t&&n&&(t=new Date(n.getTime()-R)),t&&n&&n.getTime()<=t.getTime()&&(n=new Date(t.getTime()+R)),{startStr:t?c.toDatabaseUTC(t):null,endStr:n?c.toDatabaseUTC(n):null}}(t,n);o.modify(t=>{e&&t.where("activity.created_at",">=",e),a&&t.where("activity.created_at","<",a)})}const l=await o.orderBy([{column:"created_at",order:"asc"},{column:"id",order:"asc"}]),d=(await Promise.all(l.map(e=>w(e)))).map(({target:e,monthlyRealization:a,createdAt:t,updatedAt:n,deletedAt:i,sumBudgetRealization:s,avgProgress:r,...o})=>{const l=o.createdUser?.name??"N/A",d=o.editedUser?.name??"N/A",u=o.picDivision?.title??"N/A",c={...o,createdUser:l,editedUser:d,picDivision:u,startedMonth:O(o.startedMonth),finishedMonth:O(o.finishedMonth)};for(const e of Object.keys(c))c[e]=P(c[e]);return c}),u="activity-packages"+(t||n?"-"+j(`${t||""}-${n||""}`):""),m=`${Date.now()}-${j(u)}`,p=D.join(N,m);await async function(e){return await S.mkdir(e,{recursive:!0}),e}(p);const g=D.join(p,`${u}.csv`),h=D.join(p,`${u}.pdf`);await async function(e,a){let t=[];if(Array.isArray(e)&&e.length>0){const a=new Set;e.forEach(e=>Object.keys(e||{}).forEach(e=>a.add(e))),a.delete("id"),t=["No",...Array.from(a)]}else t=["No","info"],e=[{info:"N/A"}];const n=[t.map(L).join(",")];for(let a=0;a<e.length;a++){const i=e[a]||{},s=t.map(e=>L("No"===e?String(a+1):P(i?.[e])));n.push(s.join(","))}await S.writeFile(a,n.join("\n")+"\n","utf8")}(d,g),await async function(e,a){await new Promise((t,n)=>{const i=new A({size:"A3",layout:"landscape",margins:{top:36,bottom:36,left:16,right:16}}),s=T.createWriteStream(a);if(i.pipe(s),i.font("Helvetica-Bold").fontSize(16).text("Paket Kegiatan",{align:"left"}),i.moveDown(.5),!Array.isArray(e)||0===e.length)return i.font("Helvetica").fontSize(10).text("N/A"),i.end(),s.on("finish",t),s.on("error",n),void i.on("error",n);const r=new Set;for(const a of e)Object.keys(a||{}).forEach(e=>r.add(e));r.delete("id");const o=["No",...Array.from(r)],l=i.page.margins.left,d=i.page.margins.right,u=i.page.margins.top,c=i.page.margins.bottom,m=i.page.width-l-d,p=o.indexOf("No"),g=o.length-1;let w=Math.floor((m-42)/Math.max(1,g));w=Math.max(70,w);let h=o.map((e,a)=>a===p?42:w);const _=m-h.reduce((e,a)=>e+a,0);if(Math.abs(_)>0){let e=p===o.length-1?o.length-2:o.length-1;for(let a=0;a<h.length;a++)a!==p&&h[a]>h[e]&&(e=a);h[e]+=_}i.fontSize(9).font("Helvetica");let k=i.y+8;const b=l;k=M(i,b,k,o,h,6,p);for(let a=0;a<e.length;a++){const t=e[a]||{},n=o.map(e=>"No"===e?String(a+1):P(t[e])),s=n.map((e,a)=>Math.max(18,i.heightOfString(e,{width:h[a]-12})+12)),r=Math.max(...s);k+r>i.page.height-c&&(i.addPage({size:"A3",layout:"landscape",margins:{top:36,bottom:36,left:16,right:16}}),k=u,k=M(i,b,k,o,h,6,p)),k=C(i,b,k,n,h,r,6,a,p)}i.end(),s.on("finish",t),s.on("error",n),i.on("error",n)})}(d,h);const _=`${u}.zip`;a.setHeader("Content-Type","application/zip"),a.setHeader("Content-Disposition",`attachment; filename="${_}"`);let k=!1;const b=async()=>{if(!k){k=!0;try{await async function(e){await S.rm(e,{recursive:!0,force:!0})}(p)}catch(e){s.warn(`| Export Cleanup | gagal hapus temp dir: ${e.message}`)}}};a.once("finish",b),a.once("close",b),await async function(e,a){await new Promise((t,n)=>{const i=I("zip",{zlib:{level:9}});i.on("error",n),a.on("close",t),i.pipe(a);for(const a of e)i.file(a,{name:D.basename(a)});i.finalize()})}([g,h],a)}catch(e){s.error(`| Activity Package MONEV | - Error function export: ${e.message}`);const t=new g(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},9022:(e,a,t)=>{const n=t(829),i=t(6870),{isTokenBlacklisted:s,blacklistToken:r}=t(8284),o=t(7484),l=t(4930),d=process.env.JWT_SECRET_KEY;e.exports=async(e,a,t)=>{const u=e.header("Authorization")?.replace("Bearer ","");if(!u){const e=new i(401,"TOKEN_NOT_FOUND","Akses ditolak","Token tidak ditemukan. Pastikan Anda sudah login dan menyertakan token dalam header request.");return o.info(`| Auth | - Token tidak ditemukan di request, at ${(new Date).toISOString()}`),a.status(401).json(e.toResponse())}if(await s(u)){const e=new i(401,"TOKEN_BLACKLISTED","Akses ditolak","Sesi login Anda telah berakhir. Silakan login kembali.");return a.status(401).json(e.toResponse())}n.verify(u,d,async(n,s)=>{if(n&&"TokenExpiredError"===n.name){const e=new i(401,"TOKEN_EXPIRED","Akses ditolak","Token sudah kedaluwarsa. Silakan login kembali.");return o.info(`| Auth | - Token expired for user with token: ${u}, at ${(new Date).toISOString()}`),a.status(401).json(e.toResponse())}if(n){const e=new i(401,"INVALID_TOKEN","Akses ditolak","Token tidak valid. Silakan login kembali.");return o.info(`| Auth | - Invalid token, at ${(new Date).toISOString()}`),a.status(401).json(e.toResponse())}const d=s.userId;e.userId=d,e.auth={userId:d,roleName:s.role||null,abilities:Array.isArray(s.abilities)?s.abilities:[],ctx:s.ctx||null};try{const n=await l("users").where({id:d}).first();if(!n||!n.last_login){const e=new i(401,"USER_NOT_FOUND_OR_NOT_LOGGED_IN","Akses ditolak","Pengguna tidak ditemukan atau belum login.");return a.status(401).json(e.toResponse())}const c=new Date(n.last_login),m=new Date;if(Math.floor((m-c)/864e5)>3){await r(u,86400);const e=new i(401,"LOGIN_EXPIRED","Akses ditolak","Anda belum login dalam 3 hari terakhir. Silakan login kembali.");return o.info("| Auth | - Token valid tapi user idle > 3 hari"),a.status(401).json(e.toResponse())}e.userId=d,o.info(`| Auth | - Token valid for userId: ${s.userId}, at ${(new Date).toISOString()}`),t()}catch(e){o.error(`| Auth | - Gagal mengecek last_login: ${e.message}`);const t=new i(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}})}},9062:e=>{e.exports={orderByYearMonth:function(e="year",a="month",t="asc",n="asc"){return{sql:`?? ${"DESC"===String(t).toUpperCase()?"DESC":"ASC"}, ?? ${"DESC"===String(n).toUpperCase()?"DESC":"ASC"}, ?? ASC`,bindings:[e,a,"id"]}}}},9230:(e,a,t)=>{const{validationResult:n}=t(7975),i=t(4930),s=t(7484),{toArray:r,normJsonbArray:o,normIdArray:l,isPlainObject:d,handleLocalizedText:u}=t(7872),{asJsonb:c}=t(6192),{applyRelationIn:m,applyJsonbSearch:p,applyPagination:g,formatPaginationResult:w}=t(3210),h=t(1701),_=t(1332),k=t(6870),b=t(9342),f=t(6479),{applyTrashedScope:y}=t(7438),{applyLatestThenTrashed:R}=t(7540);a.index=async(e,a)=>{const{search:t,animalCategoryId:n}=e.query,r=n??e.query["animalCategoryId[]"];try{let n=i("cms_animal_composition as animal").select("animal.*");y(n,e,"animal.deleted_at"),m(n,"animal.cms_animal_category_id",r,{as:"number"}),p(n,t,["animal.name->>'id'","animal.name->>'en'"],{mode:"or",split:!0}),R(n,"animal.deleted_at","animal.created_at","animal.id");const s=g(e.query),o=await w(n,s,i);if(0===o.data.length){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data yang sesuai dengan filter atau pencarian.");return a.status(200).json(e.toResponse())}const l=await Promise.all(o.data.map(e=>b(e))),d=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data","Data komposisi satwa berhasil diambil.",{data:l,pagination:o.pagination});return a.status(200).json(d.toResponse())}catch(e){s.error(`| Animal Composition CMS | - Error function index : ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silakan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.store=async(e,a)=>{const t=await i.transaction(),{categoryId:r,name:o,description:l,total:d}=e.body;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=u(o,{allowPartial:!1,maxLen:void 0,fieldLabel:"name"});if(s.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",s.error.message);return a.status(422).json(e.toResponse())}const m=u(l,{allowPartial:!1,maxLen:void 0,fieldLabel:"description"});if(m.error){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",m.error.message);return a.status(422).json(e.toResponse())}if(!e.files||0===e.files.length){const e=new k(422,"FILES_NOT_FOUND","File Tidak Ditemukan","File thumbnail wajib diunggah.");return a.status(422).json(e.toResponse())}if(e.files.length>1){const e=new k(422,"MAX_FILES","Terlalu Banyak File","Maksimal upload adalah 1 file.");return a.status(422).json(e.toResponse())}for(const t of e.files){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(t.mimetype)){const e=new k(422,"INVALID_FILE_TYPE","Tipe File Salah","File File hanya boleh JPG, JPEG, PNG, dan WebP.");return a.status(422).json(e.toResponse())}if(t.size>52428800){const e=new k(422,"FILE_TOO_LARGE","Ukuran File Terlalu Besar","Ukuran maksimal tiap file adalah 50mB.");return a.status(422).json(e.toResponse())}}if(await t("cms_animal_composition").whereNull("deleted_at").andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[s.value.id]).orWhereRaw("lower(name->>'en') = lower(?)",[s.value.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Nama komposisi satwa (ID/EN) sudah digunakan. Silakan gunakan nama lain.");return a.status(422).json(e.toResponse())}const p=await h.uploadDocuments(e.files,e),g=p?.[0],w=Number(g);await t("cms_animal_composition").insert({cms_animal_category_id:r,species_image_ids:c([w]),name:{id:s.value.id,en:s.value.en},description:{id:m.value.id,en:m.value.en},total:d}).returning("*"),await f.logCreate({userId:f.fromReq(e),module:"cms",subject:"List Komposisi Satwa"},t),await t.commit();const _=new k(201,"SUCCESS_CREATE_DATA","Berhasil Menyimpan Data",`Data komposisi satwa '${s.value.id}' berhasil ditambahkan.`);return a.status(201).json(_.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Composition CMS | - Error function store: ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(n.toResponse())}},a.show=async(e,a)=>{const{id:t}=e.params;try{const e=await i("cms_animal_composition").select("*").where("id",t).first();if(!e){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data komposisi satwa dengan ID '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=d(e.name)?e.name:parseJsonSafe(e.name)||{},s=n.id||n.en||"Tanpa Nama",r=await b(e),o=new _(200,"SUCCESS_GET_DATA","Berhasil Mengambil Data",`Detail data komposisi satwa '${s}' berhasil didapatkan.`,r);return a.status(200).json(o.toResponse())}catch(e){s.error(`| Animal Composition CMS | - Error function show: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.update=async(e,a)=>{const t=await i.transaction(),{categoryId:m,name:p,description:g,total:w,deleteDocumentIds:_}=e.body,b=e.params.id;try{const i=n(e);if(!i.isEmpty()){const e=i.array().map(e=>e.msg).join(" "),t=new k(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}const s=await t("cms_animal_composition").where("id",b).first();if(!s){const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan",`Data komposisi satwa dengan ID '${b}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const y=d(s.name)?s.name:parseJsonSafe(s.name)??{id:"",en:""},R=d(s.description)?s.description:parseJsonSafe(s.description)??{id:"",en:""};let E=y;if(void 0!==p){const e=u(p,{allowPartial:!0,maxLen:void 0,fieldLabel:"name"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...y,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=y.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=y.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Nama harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}E={id:String(t.id).trim(),en:String(t.en).trim()}}let D=R;if(void 0!==g){const e=u(g,{allowPartial:!0,maxLen:void 0,fieldLabel:"description"});if(e.error){const t=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah",e.error.message);return a.status(422).json(t.toResponse())}const t={...R,...e.value};if(Object.prototype.hasOwnProperty.call(e.value,"id")&&""===String(e.value.id).trim()&&(t.id=R.id),Object.prototype.hasOwnProperty.call(e.value,"en")&&""===String(e.value.en).trim()&&(t.en=R.en),!t.id||!t.en){const e=new k(422,"INVALID_CONTENT_FORMAT","Format Konten Salah","Deskripsi harus memiliki id dan en yang tidak kosong.");return a.status(422).json(e.toResponse())}D={id:String(t.id).trim(),en:String(t.en).trim()}}if(((E.id??"").toLowerCase()!==(y.id??"").toLowerCase()||(E.en??"").toLowerCase()!==(y.en??"").toLowerCase())&&await t("cms_animal_composition").whereNull("deleted_at").whereNot("id",b).andWhere(function(){this.whereRaw("lower(name->>'id') = lower(?)",[E.id]).orWhereRaw("lower(name->>'en') = lower(?)",[E.en])}).first()){const e=new k(422,"DUPLICATE_TITLE","Duplikat Data","Nama komposisi satwa (ID/EN) sudah digunakan pada komposisi satwa lain.");return a.status(422).json(e.toResponse())}const T=r(_).map(String),S=["image/jpeg","image/jpg","image/png","image/webp"],A=await async function({existingRow:e,deleteDocumentIds:a,files:t,dbColumn:n="species_image_ids",maxFilesAllowed:i=1,allowedTypes:s=["image/jpeg","image/jpg","image/png","image/webp"],sizeLimitBytes:d=52428800}){const u=l(o(e?.[n]),{as:"string"}),c=r(a).map(String),m=u.filter(e=>!c.includes(String(e))),p=Array.isArray(t)?t.length:0;if(0===u.length&&0===p)return{ok:!1,http:422,code:"FILES_NOT_FOUND",title:"File Tidak Ditemukan",desc:"File wajib diunggah untuk pertama kali."};const g=m.length,w=Math.max(i-g,0);if(0===w&&p>0)return{ok:!1,http:422,code:"MAX_CAPACITY",title:"Kapasitas Sudah Penuh",desc:"Kapasitas file untuk data ini sudah terpenuhi. Tidak ada slot tersisa."};if(p>w)return{ok:!1,http:422,code:"UPLOAD_LIMIT_EXCEEDED",title:"Terlalu Banyak File",desc:`File yang diperbolehkan diupload adalah ${w} file.`};for(const e of t||[]){if(!s.includes(e.mimetype))return{ok:!1,http:422,code:"INVALID_FILE_TYPE",title:"Tipe File Salah",desc:"File hanya boleh bertipe: JPG, JPEG, PNG, dan WebP."};if(e.size>d)return{ok:!1,http:422,code:"FILE_TOO_LARGE",title:"Ukuran File Terlalu Besar",desc:`Ukuran maksimal tiap file adalah ${Math.floor(d/1048576)}mB.`}}return{ok:!0,remaining:w}}({existingRow:s,deleteDocumentIds:T,files:Array.isArray(e.files)?e.files:[],dbColumn:"species_image_ids",maxFilesAllowed:1,allowedTypes:S,sizeLimitBytes:52428800});if(!A.ok){const e=new k(A.http,A.code,A.title,A.desc);return a.status(A.http).json(e.toResponse())}const I=o(s.species_image_ids);let N=l(I,{as:"number"})[0]??null;null!=N&&T.includes(String(N))&&(await h.deleteDocuments([N]),N=null);let j=null;Array.isArray(e.files)&&e.files.length>0&&(j=await h.uploadDocuments(e.files,e));const v=j?.[0]??N??null,O=null!=v?[Number(v)]:[];await t("cms_animal_composition").where("id",b).update({cms_animal_category_id:m??s.cms_animal_category_id,species_image_ids:c(O),name:E,description:D,total:w??s.total,updated_at:t.fn.now()}),await f.logUpdate({userId:f.fromReq(e),module:"cms",subject:"List Komposisi Satwa"},t),await t.commit();const L=new k(200,"SUCCESS_UPDATE_DATA","Berhasil Memperbarui",`Data komposisi satwa '${E.id}' berhasil diperbarui.`);return a.status(200).json(L.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Composition CMS | - Error function update : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.destroy=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.deleteIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan deleteIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const i=50;if(n.length>i){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dihapus adalah ${i} ID.`);return a.status(422).json(e.toResponse())}const s=await t("cms_animal_composition").select("id","name").whereIn("id",n).whereNull("deleted_at");if(0===s.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data komposisi satwa yang cocok atau sudah terhapus.");return a.status(200).json(e.toResponse())}const r=s.map(e=>e.id);await t("cms_animal_composition").whereIn("id",r).update({deleted_at:t.fn.now()}),await f.logDelete({userId:f.fromReq(e),module:"cms",subject:"List Komposisi Satwa"},t),await t.commit();const o=new k(200,"SUCCESS_DELETE_DATA","Berhasil Menghapus Data",`Berhasil menghapus (soft delete) ${r.length} data komposisi satwa.`);return a.status(200).json(o.toResponse())}catch(e){await t.rollback(),s.error(`| Animal Composition CMS | - Error function destroy : ${e.message}`);const n=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem. Silakan coba lagi nanti.");return a.status(500).json(n.toResponse())}},a.restore=async(e,a)=>{const t=await i.transaction();try{const n=l(e.body?.restoreIds,{as:"number"}).filter(Number.isFinite);if(0===n.length){await t.rollback();const e=new k(422,"INVALID_INPUT","Gagal Menghapus Data","Mohon kirimkan restoreIds berupa array ID numerik, misal: [1,2,3].");return a.status(422).json(e.toResponse())}const s=50;if(n.length>s){await t.rollback();const e=new k(422,"TOO_MANY_IDS","Terlalu Banyak Data",`Maksimal id yang bisa dikembalikan adalah ${s} ID.`);return a.status(422).json(e.toResponse())}const r=await t("cms_animal_composition").select("id","name").whereIn("id",n).whereNotNull("deleted_at");if(0===r.length){await t.rollback();const e=new k(200,"DATA_NOT_FOUND","Data Tidak Ditemukan","Tidak ada data kategori satwa terhapus yang cocok untuk direstore.");return a.status(200).json(e.toResponse())}const o=e=>{const a=d(e)?e:parseJsonSafe(e)||{},t="string"==typeof a.id?a.id.trim():"",n="string"==typeof a.en?a.en.trim():"";return{id:t,en:n,idLower:t.toLowerCase(),enLower:n.toLowerCase()}},u=r.map(e=>{const a=o(e.name);return{rowId:e.id,...a}}),c=u.map(e=>e.idLower).filter(Boolean),m=u.map(e=>e.enLower).filter(Boolean);let p=[];(c.length||m.length)&&(p=await t("cms_animal_composition").select("id","name").whereNull("deleted_at").andWhere(function(){let e=!1;c.length&&(e=!0,this.whereIn(i.raw("lower(name->>'id')"),c)),m.length&&(e?this.orWhereIn(i.raw("lower(name->>'en')"),m):this.whereIn(i.raw("lower(name->>'en')"),m))}));const g=new Set;for(const e of p){const a=o(e.name);a.idLower&&g.add(`id:${a.idLower}`),a.enLower&&g.add(`en:${a.enLower}`)}const w=new Set,h=new Set,_=new Set;for(const e of u)e.idLower&&(w.has(e.idLower)?_.add(`id:${e.idLower}`):w.add(e.idLower)),e.enLower&&(h.has(e.enLower)?_.add(`en:${e.enLower}`):h.add(e.enLower));const b=[],y=[],R=new Set,E=new Set;for(const e of u){const a=e.idLower?`id:${e.idLower}`:null,t=e.enLower?`en:${e.enLower}`:null,n=a&&g.has(a)||t&&g.has(t),i=a&&_.has(a)||t&&_.has(t),s=!e.idLower&&!e.enLower;n||i||s||e.idLower&&R.has(e.idLower)||e.enLower&&E.has(e.enLower)?y.push({id:e.id,name:{id:e.idLower,en:e.enLower}}):(e.idLower&&R.add(e.idLower),e.enLower&&E.add(e.enLower),b.push(e))}let D=0;if(b.length>0){const e=b.map(e=>e.rowId);await t("cms_animal_composition").whereIn("id",e).update({deleted_at:null,updated_at:t.fn.now()}),D=e.length}if(await f.logRestore({userId:f.fromReq(e),module:"cms",subject:"List Komposisi Satwa"},t),await t.commit(),0===D){const e=new k(422,"DUPLICATE_NAME","Restore Gagal","Semua ID gagal direstore karena duplikat data dengan entri aktif atau duplikat data di dalam batch.");return a.status(422).json(e.toResponse())}const T=[`Berhasil mengembalikan ${D} data yang terhapus.`];y.length&&T.push(`Terlewat ${y.length} karena bentrok/duplikat data.`);const S=new k(200,"SUCCESS_RESTORE_DATA","Berhasil Mengembalikan Data",T.join(" "));return a.status(200).json(S.toResponse())}catch(e){s.error(`| Animal Category CMS | - Error function restore: ${e.message}`);const t=new k(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}}},9281:(e,a,t)=>{const{body:n}=t(7975);a.updateEducatorValidator=[n("name").notEmpty().withMessage("Nama pengajar tidak boleh kosong.").bail().isString().withMessage("Nama pengajar harus berupa teks.").bail().isLength({max:255}).withMessage("Nama pengajar maksimal 255 karakter."),n("email").notEmpty().withMessage("Email pengajar tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.").bail().isString().withMessage("Email pengajar harus berupa teks.")]},9289:(e,a,t)=>{const n=t(7252).Router(),i=t(168),s=t(9022),r=t(6967),o=t(5794);n.use(r,s),n.get("/index",o(["view.kmis_quiz"]),i.index),n.get("/show/:id",o(["view.kmis_quiz"]),i.show),e.exports=n},9304:e=>{e.exports=async function(e){return{id:e.id,question:e.question,answer:e.answer,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},9325:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.updateMaterialValidator=[n("materialType").optional({nullable:!0,checkFalsy:!0}).bail().isString().withMessage("Tipe materi harus berupa teks.").bail().customSanitizer(e=>{const a=String(e||"").trim().toLowerCase();return"teks"===a?"text":a}).isIn(["text","gambar","video","dokumen"]).withMessage("Tipe materi hanya boleh berisikan text, gambar, video, atau dokumen."),n("title").optional({nullable:!0,checkFalsy:!0}).bail().isString().withMessage("Judul materi harus berupa teks.").bail().isLength({max:180}).withMessage("Judul materi maksimal 180 karakter."),n("description").optional({nullable:!0,checkFalsy:!0}).bail().isString().withMessage("Deskripsi materi harus berupa teks."),n("topicId").notEmpty().withMessage("Topik materi wajib dipilih untuk tipe gambar/dokumen.").bail().isInt({gt:0}).withMessage("Topik materi harus berupa angka.").bail().custom(async(e,{req:a})=>{if(!await i("kmis_topics").where("id",e).whereNull("deleted_at").first())throw new Error("Topik materi yang Anda pilih tidak ditemukan atau sudah dihapus.")}),n("materialUrl").if(n("materialType").equals("video")).notEmpty().withMessage("materialUrl wajib diisi untuk tipe video.").bail().isString().withMessage("materialUrl harus berupa teks."),n("materialUrl").if(n("materialType").not().equals("video")).optional({nullable:!0}).isString().withMessage("materialUrl harus berupa teks.").bail().trim()]},9331:(e,a,t)=>{const{body:n}=t(7975),i=t(4930);a.updateAnimalCompositionValidator=[n("categoryId").notEmpty().withMessage("Kategori komposisi satwa wajib dipilih.").bail().isInt().withMessage("Kategori komposisi satwa harus berupa angka.").bail().custom(async e=>{if(!await i("cms_events_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori komposisi satwa yang Anda pilih tidak ditemukan.");return!0}),n("name").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("description").optional({nullable:!0,checkFalsy:!0}).custom(()=>!0),n("total").notEmpty().withMessage("Total komposisi satwa tidak boleh kosong.").bail().isInt({min:0}).withMessage("Total komposisi satwa harus berupa bilangan bulat lebih besar atau sama dengan 0.").toInt()]},9334:(e,a,t)=>{const{body:n}=t(7975),i=t(4930),s=t(1784),r=t(6293),o=t(3824),l=t(5789);r.extend(o),r.extend(l);const d=/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/,u=/^([01]\d|2[0-3])\.([0-5]\d)\.([0-5]\d)$/;function c(e){const a=String(e||"").trim();if(d.test(a))return a;const t=a.match(u);if(t){const[,e,a,n]=t;return`${e}:${a}:${n}`}return a}a.storeActivityCalendarValidator=[n("activityCategoryId").notEmpty().withMessage("Kategori aktivitas wajib dipilih.").bail().isInt().withMessage("Kategori aktivitas harus berupa angka.").bail().custom(async e=>{if(!await i("monev_activity_categories").where("id",e).whereNull("deleted_at").first())throw new Error("Kategori aktivitas yang Anda pilih tidak ditemukan.");return!0}),n("name").notEmpty().withMessage("Nama kegiatan tidak boleh kosong.").bail().isString().withMessage("Nama kegiatan harus berupa teks.").bail().isLength({max:255}).withMessage("Nama kegiatan maksimal 255 karakter."),n("description").optional({nullable:!0,checkFalsy:!0}).isString().withMessage("Deskripsi harus berupa teks."),n("location").notEmpty().withMessage("Lokasi tidak boleh kosong.").bail().isString().withMessage("Lokasi harus berupa teks.").bail().isLength({max:200}).withMessage("Lokasi maksimal 200 karakter."),n("startedDate").notEmpty().withMessage("Tanggal mulai wajib diisi (ISO 8601 dengan Z/offset), contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.").bail().custom(e=>{if(!s.isIso8601Z(e))throw new Error("Tanggal mulai harus ISO 8601 dengan Z/offset, contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.");if(!s.toUTC(e))throw new Error("Tanggal mulai tidak valid.");return!0}),n("finishedDate").notEmpty().withMessage("Tanggal selesai wajib diisi (ISO 8601 dengan Z/offset), contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.").bail().custom(e=>{if(!s.isIso8601Z(e))throw new Error("Tanggal selesai harus ISO 8601 dengan Z/offset, contoh: 1990-05-17T00:00:00+07:00 atau 1990-05-16T17:00:00Z.");if(!s.toUTC(e))throw new Error("Tanggal selesai tidak valid.");return!0}),n("startedTime").notEmpty().withMessage("Jam mulai wajib diisi (format HH:mm:ss).").bail().custom(e=>{const a=String(e||"").trim();return d.test(a)||u.test(a)}).withMessage("Format jam mulai tidak valid. Gunakan HH:mm:ss (24 jam).").bail().customSanitizer(e=>c(e)),n("finishedTime").notEmpty().withMessage("Jam selesai wajib diisi (format HH:mm:ss atau HH.mm.ss).").bail().custom(e=>{const a=String(e||"").trim();return d.test(a)||u.test(a)}).withMessage("Format jam selesai tidak valid. Gunakan HH:mm:ss atau HH.mm.ss (24 jam).").bail().customSanitizer(e=>c(e))]},9342:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(8641),s=t(4930),r=t(2482);e.exports=async function(e){const a=e.cms_animal_category_id?await s("cms_animal_categories").where("id",e.cms_animal_category_id).first():null,t=await n(e.species_image_ids,"documents",r);return{id:e.id,animalCategory:a?await i(a):null,speciesImage:t,name:e.name,description:e.description,total:e.total,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},9451:(e,a,t)=>{const n=t(4930),{orderByYearMonth:i}=t(9062),s=t(1606),r=t(3034),o=t(6004),l=t(5317);e.exports=async function(e){const[a,t,d]=await Promise.all([e.created_by?n("users").where("id",e.created_by).first():null,e.edited_by?n("users").where("id",e.edited_by).first():null,e.monev_pic_division_id?n("monev_pic_divisions").where("id",e.monev_pic_division_id).first():null]),{sql:u,bindings:c}=i("year","month","asc","asc"),[m,p,g,w]=await Promise.all([n("monev_targets").where("monev_activity_packages_id",e.id).whereNull("deleted_at").orderByRaw(u,c),n("monev_target_pending_updates").where("monev_activity_packages_id",e.id).whereNull("deleted_at").orderByRaw(u,c),n("monev_monthly_realizations").where("monev_activity_packages_id",e.id).whereNull("deleted_at").orderByRaw(u,c),n("monev_monthly_realization_pending_updates").where("monev_activity_packages_id",e.id).whereNull("deleted_at").orderByRaw(u,c)]),h=await Promise.all(m.map(a=>o(a,{activityPackage:e}))),_=await Promise.all(p.map(a=>o(a,{activityPackage:e}))),k=await Promise.all(g.map(a=>l(a,{activityPackage:e}))),b=await Promise.all(w.map(a=>l(a,{activityPackage:e}))),f=function(e){if(!Array.isArray(e)||0===e.length)return 0;let a=0;for(const t of e){let e=t?.budget_realization??t?.budget_realization??[];if(!Array.isArray(e))try{const a=JSON.parse(e);e=Array.isArray(a)?a:[]}catch{e=[]}for(const t of e){const e=Number(t?.value);Number.isFinite(e)&&(a+=e)}}return a}(g),y=function(e){if(!Array.isArray(e)||0===e.length)return 0;let a=0,t=0;for(const n of e){const e=Number(n?.progress);Number.isFinite(e)&&(a+=e,t+=1)}return 0===t?0:Number((a/t).toFixed(2))}(g),R=p.length>0,E=w.length>0;return{id:e.id,createdUser:a?await r(a):null,editedUser:t?await r(t):null,picDivision:d?await s(d):null,contractType:e.contract_type,mak:e.mak,name:e.name,description:e.description,startedMonth:e.started_month,finishedMonth:e.finished_month,startedYear:e.started_year,finishedYear:e.finished_year,unitOutput:e.unit_output,codeOutput:e.code_output,volume:e.volume,pagu:e.pagu,partner:e.partner,sumBudgetRealization:f,avgProgress:y,target:{monevTargetOriginal:h,monevTargetPendingUpdate:_},monthlyRealization:{monevMonthlyRealizationOriginal:k,monevMonthlyRealizationPendingUpdate:b},pendingTarget:R,pendingRealization:E,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},9505:(e,a,t)=>{const n=t(7252).Router(),i=t(5718),{storeQuizValidator:s}=t(8409),{updateQuizValidator:r}=t(2553),o=t(2110),l=t(9022),d=t(6967),u=t(5794),c=t(8461)();n.use(d,l),n.get("/index",u(["view.kmis_quiz"]),i.index),n.get("/show/:id",u(["view.kmis_quiz"]),i.show),n.post("/create",u(["create.kmis_quiz"]),c.none(),s,o,i.store),n.patch("/update/:id",u(["edit.kmis_quiz"]),c.none(),r,o,i.update),n.delete("/delete",u(["delete.kmis_quiz"]),i.destroy),n.patch("/restore",u(["restore.kmis_quiz"]),i.restore),n.get("/download-template",u(["create.kmis_quiz"]),i.downloadTemplate),n.post("/import",u(["create.kmis_quiz"]),c.array("files",20),o,i.importTemplate),e.exports=n},9654:(e,a,t)=>{const{OAuth2Client:n}=t(6154),i=new n(process.env.CLIENT_ID),s=t(4729),r=t(829),o=t(7906),l=t(6982),d=t(1572),{blacklistToken:u}=t(8284),{validationResult:c}=t(7975),m=t(7484),p=t(4930),g=t(3623),w=t(1332),h=t(6870),{stripTitlesOnly:_}=t(337),k=t(6348),b=t(3034),f=t(1784),y=process.env.JWT_SECRET_KEY;async function R(e,a,{context:t,requiredRole:n,requiredRoleId:i,ability:o}){const l="oauth"===e.authStrategy;if(!l&&!c(e).isEmpty()){const e=new h(422,"FAILED_VALIDATION","Login Gagal.","Tolong periksa kembali input anda. Pastikan email dan password terisi dengan benar.");return a.status(422).json(e.toResponse())}const d=l?e.oauthEmail:e.body.email,u=l?null:e.body.password;try{const e=await async function(e){return p("users as u").leftJoin("roles as r","r.id","u.role_id").where("u.email",e).whereNull("u.deleted_at").select("u.*","r.name as role_name","r.id as role_id").first()}(d);if(!e){m.info(`| Login | - Invalid credentials for email: ${d}, at ${(new Date).toISOString()}`);const e=new h(422,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return a.status(422).json(e.toResponse())}const c=Number(e.account_status);if(1===c){m.info(`| Login | - Account blocked: not-activated for email: ${d}, created_at: ${e.created_at}`);const t=new h(401,"ACCOUNT_RESET_REQUIRED","Reset Password Diperlukan","Akun Anda belum dapat digunakan karena masih memakai kata sandi default. Silakan lakukan reset password terlebih dahulu untuk mengaktifkan akun.");return a.status(401).json(t.toResponse())}if(3===c){const t=f.formatTanggalIndonesia(e.deactivate_at,1);m.info(`| Login | - Account blocked: deactivated/suspended for email: ${d}, deactivate_at: ${e.deactivate_at}`);const n=new h(401,"ACCOUNT_DEACTIVATED","Akun Nonaktif",`Kami mendeteksi bahwa akun Anda telah dinonaktifkan sejak ${t}, silakan hubungi admin untuk melakukan aktivasi kembali.`);return a.status(401).json(n.toResponse())}const g=Number(e.role_id),_=(e.role_name||"").toLowerCase(),k=Number(i||0),R=(n||"").toLowerCase();if(!(k?g===k:_===R)){m.info(`| Login | - Forbidden role for email: ${d} on context: ${t} (has: ${_}, need: ${n})`);const e=new h(403,"FORBIDDEN_ROLE","Akses Ditolak",`Akun Anda tidak memiliki hak akses untuk konteks ${t}.`);return a.status(403).json(e.toResponse())}if(!l&&!await s.compare(u,e.password)){m.info(`| Login | - Invalid credentials for email: ${d}, at ${(new Date).toISOString()}`);const e=new h(422,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return a.status(422).json(e.toResponse())}const E=new Date;await p("users").where({id:e.id}).update({last_login:E});const D=function({userId:e,roleName:a,ability:t,context:n}){const i={userId:e,role:a,abilities:[t],ctx:n};return r.sign(i,y)}({userId:e.id,roleName:e.role_name,ability:o,context:t}),T=await b({...e,last_login:E}),S={id:T.id,role:T.role,photoProfile:T.photoProfile,name:T.name,email:T.email,accountStatus:T.accountStatus,lastLogin:T.lastLogin};m.info(`| Login | - Login success for email: ${d}, context=${t}, ability=${o}, at ${E.toISOString()}`);const A=new w(200,"LOGIN_SUCCESS","Login Berhasil.",`Selamat datang ${e.name}, anda berhasil login.`,{token:D,user:S});return a.status(200).json(A.toResponse())}catch(e){m.error(`| Auth | - Error signInWithContext: ${e.message}`,{stack:e.stack});const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}}a.createAccount=async(e,a)=>{const t=await p.transaction(),{name:n,email:i,password:r}=e.body;try{const o=c(e);if(!o.isEmpty()){const e=o.array().map(e=>e.msg).join(" "),t=new h(422,"FAILED_VALIDATION","Format Data Tidak Sesuai Ketentuan",e);return a.status(422).json(t.toResponse())}if(await t("users").whereNull("deleted_at").where("email",i).first()){await t.rollback();const e=new h(409,"EMAIL_ALREADY_USED","Email Sudah Terpakai","Email yang anda gunakan sudah pernah terdaftar. Silahkan gunakan email yang lain.");return a.status(409).json(e.toResponse())}const l=await s.hash(r,12),[u]=await t("users").insert({role_id:4,name:n.trim(),email:i.trim(),password:l,account_status:2,register_at:p.fn.now(),created_at:p.fn.now(),updated_at:p.fn.now()}).returning(["name"]);await t.commit();const g=d.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),w=_(u.name),b=k("welcome_message.html",{name:w,email:i,from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await g.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:i,subject:"Selamat Datang di aplikasi Rimba",html:b}),m.info(`| Auth | - Welcome message sent to ${i} at ${(new Date).toISOString()}`);const f=new h(201,"ACCOUNT_CREATED","Akun Berhasil Dibuat",`Akun untuk '${u.name}' berhasil dibuat.`);return a.status(201).json(f.toResponse())}catch(e){m.error(`| Auth | - Error function createAccount: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.createOrLoginWithOauth=async(e,t)=>{const n=await p.transaction();try{const r=function(e){const a=(e.get("authorization")||"").match(/^Bearer\s+(.+)$/i);return a?a[1]:e.cookies?.g_id_token?e.cookies.g_id_token:e.get("x-id-token")||null}(e);if(!r)return await n.rollback(),t.status(401).json(new h(401,"GOOGLE_TOKEN_MISSING","Token Google Tidak Ditemukan","Harap sertakan Authorization: Bearer <id_token> dari Google.").toResponse());const o=(await i.verifyIdToken({idToken:r,audience:process.env.CLIENT_ID})).getPayload(),u=String(o?.email||"").trim(),c=Boolean(o?.email_verified),g=String(o?.name||"").trim();if(!u||!c){await n.rollback();const e=new h(401,"GOOGLE_EMAIL_NOT_VERIFIED","Email Google Belum Terverifikasi","Akun Google belum terverifikasi email-nya atau email tidak tersedia.");return t.status(401).json(e.toResponse())}const w=await n("roles").select("id","name").whereRaw("LOWER(name) = LOWER(?)",["Student"]).first();if(!w){await n.rollback(),m.error(`| Auth | - Role 'Student' not found, when creating account with email: ${u} via Google`);const e=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return t.status(500).json(e.toResponse())}let b=await n("users").whereNull("deleted_at").where("email",u).first();if(b)2!==Number(b.account_status)&&([b]=await n("users").where({id:b.id}).update({account_status:2,updated_at:p.fn.now()},["id","email","name","account_status"])),await n.commit();else{const e=await s.hash(l.randomBytes(32).toString("hex"),12),a=g||u.split("@")[0]||"Pengguna";[b]=await n("users").insert({role_id:w.id,name:a,email:u,password:e,account_status:2,register_at:p.fn.now(),created_at:p.fn.now(),updated_at:p.fn.now()}).returning(["id","email","name","account_status"]);const t=async e=>{try{const a=d.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),t="function"==typeof _?_(e.name):e.name,n=k("welcome_message.html",{name:t,email:e.email,from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await a.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:e.email,subject:"Selamat Datang di aplikasi Rimba",html:n}),m.info(`| Auth | - Welcome message sent to ${e.email}`)}catch(e){m.warn(`| Mail | - Gagal kirim welcome email: ${e.message}`)}};await n.commit(),t(b).catch(()=>{})}return e.authStrategy="oauth",e.oauthEmail=u,a.signInStudent(e,t)}catch(e){await n.rollback(),m.error(`| Auth | - Error createAccountOauth: ${e.message}`,{stack:e.stack});const a=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return t.status(500).json(a.toResponse())}},a.signInAdminSSO=(e,a)=>R(e,a,{context:"super_admin",requiredRole:"Super Admin",ability:"super_admin"}),a.signInEducator=(e,a)=>R(e,a,{context:"educator",requiredRole:"Educator",ability:"educator"}),a.signInMonev=(e,a)=>R(e,a,{context:"monev",requiredRole:"Monev",ability:"monev"}),a.signInStudent=async(e,a)=>{const t=await p("roles").select("id","name").whereRaw("LOWER(name) = LOWER(?)",["Student"]).first();if(!t){const e=new h(500,"ROLE_NOT_FOUND","Server Sedang Error","Role 'Student' tidak ditemukan. Mohon cek tabel roles.");return a.status(500).json(e.toResponse())}return R(e,a,{context:"student",requiredRoleId:t.id,requiredRole:t.name,ability:"student"})},a.logout=async(e,a)=>{const t=e.userId,n=e.header("Authorization")?.replace("Bearer ","");try{if(!t){const e=new h(401,"NO_ACTIVE_SESSION","Logout Gagal","Anda tidak memiliki sesi login yang aktif.");return m.info(`| Logout | - No active session for userId: ${t}`),a.status(401).json(e.toResponse())}const e=r.decode(n).exp-Math.floor(Date.now()/1e3);await u(n,e),m.info(`| Logout | - Logout success for userId: ${t}, at ${(new Date).toISOString()}`);const i=new h(200,"LOGOUT_SUCCESS","Logout Berhasil","Anda berhasil melakukan logout.");a.status(200).json(i.toResponse())}catch(e){m.error(`| Auth | - Error function logout: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");a.status(500).json(t.toResponse())}},a.sendOTP=async(e,a)=>{const{email:t}=e.body;if(!t||!o.isEmail(t)){const e=new h(422,"FAILED_VALIDATION","Pengiriman OTP Gagal","Email tidak valid atau kosong. Pastikan Anda mengisi email dengan benar.");return a.status(422).json(e.toResponse())}try{const e=await p("users").select("id","name","role_id","account_status","deactivate_at").where({email:t}).first();if(!e){const e=new h(200,"INVALID_EMAIL","Akun Tidak Ditemukan",`Akun dengan email '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const n=Number(e.id);if(!Number.isFinite(n)||1===n){const e=new h(403,"FORBIDDEN_ROLE","Akses Ditolak","Reset kata sandi hanya dapat dilakukan oleh akun yang berwenang.");return a.status(403).json(e.toResponse())}if(3===Number(e.account_status)){const n=f.formatTanggalIndonesia(e.deactivate_at,1);m.info(`| Send OTP | - Account blocked: deactivated/suspended for email: ${t}, since: ${e.deactivate_at}`);const i=new h(401,"ACCOUNT_DEACTIVATED","Akun Nonaktif",`Kami mendeteksi bahwa akun Anda telah dinonaktifkan sejak ${n}, silakan hubungi admin untuk melakukan aktivasi kembali sebelum melakukan reset password.`);return a.status(401).json(i.toResponse())}const i=Math.floor(1e5+9e5*Math.random()).toString(),s=`otp:${e.id}`,r=l.createHash("sha256").update(i).digest("hex");await g.setEx(s,1800,r);const o=d.createTransport({service:"Gmail",auth:{user:process.env.MAIL_USERNAME,pass:process.env.MAIL_PASSWORD}}),u=_(e.name),c=k("otp.html",{name:u,otp:i,from_email:process.env.MAIL_USERNAME,year:(new Date).getFullYear()});await o.sendMail({from:`"Rimba" <${process.env.MAIL_USERNAME}>`,to:t,subject:"Verifikasi Kode OTP Perubahan Kata Sandi",html:c}),m.info(`| Send OTP | - OTP sent to ${t} at ${(new Date).toISOString()}`);const w=new h(200,"OTP_SENT","Berhasil Mengirim Kode OTP","Kode OTP berhasil dikirim. Silakan cek email Anda.");return a.status(200).json(w.toResponse())}catch(e){m.error(`| Auth | - Error function sendOTP: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.verifyOTP=async(e,a)=>{const{email:t,otp:n}=e.body;try{const e=await p("users").select("id","email","role_id").where({email:t}).first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Akun Tidak Ditemukan",`Akun dengan email '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const i=Number(e.id);if(!Number.isFinite(i)||1===i){const e=new h(403,"FORBIDDEN_ROLE","Akses Ditolak","Reset kata sandi hanya dapat dilakukan oleh akun yang berwenang.");return a.status(403).json(e.toResponse())}const s=`otp:${e.id}`,r=await g.get(s);if(!r){m.info(`| Verify OTP | - OTP not found for user ${t}`);const e=new h(422,"OTP_NOT_FOUND","OTP Tidak Ditemukan","Kode OTP tidak ditemukan atau sudah kadaluarsa. Silakan kirim ulang OTP.");return a.status(422).json(e.toResponse())}if(l.createHash("sha256").update(String(n)).digest("hex")!==r){m.info(`| Verify OTP | - Incorrect OTP for user ${t}`);const e=new h(422,"INVALID_OTP","OTP Tidak Valid","Kode OTP yang anda masukkan tidak sesuai.");return a.status(422).json(e.toResponse())}m.info(`| Verify OTP | - Success for user ${t}`);const o=new h(200,"OTP_VERIFIED","OTP Berhasil Diverifikasi","Kode OTP anda berhasil diverifikasi. Silakan lanjutkan reset password.");return a.status(200).json(o.toResponse())}catch(e){m.error(`| Auth | - Error function verifyOTP: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}},a.resetPassword=async(e,a)=>{const{email:t,otp:n,password:i}=e.body;try{const e=await p("users").select("id","email","role_id","account_status","deactivate_at").where({email:t}).first();if(!e){const e=new h(200,"DATA_NOT_FOUND","Akun Tidak Ditemukan",`Akun dengan email '${t}' tidak ditemukan.`);return a.status(200).json(e.toResponse())}const r=Number(e.id);if(!Number.isFinite(r)||1===r){const e=new h(403,"FORBIDDEN_ROLE","Akses Ditolak","Reset kata sandi hanya dapat dilakukan oleh akun yang berwenang.");return a.status(403).json(e.toResponse())}const o=Number(e.account_status);if(3===o){const n=f.formatTanggalIndonesia(e.deactivate_at,1);m.info(`| Reset Password | - Account blocked: deactivated/suspended for email: ${t}, since: ${e.deactivate_at}`);const i=new h(401,"ACCOUNT_DEACTIVATED","Akun Nonaktif",`Kami mendeteksi bahwa akun Anda telah dinonaktifkan sejak ${n}, silakan hubungi admin untuk melakukan aktivasi kembali.`);return a.status(401).json(i.toResponse())}const d=`otp:${e.id}`,u=await g.get(d);if(!u){const e=new h(422,"OTP_NOT_FOUND","OTP Tidak Ditemukan","Kode OTP tidak ditemukan atau sudah kadaluarsa. Silakan kirim ulang OTP.");return a.status(422).json(e.toResponse())}if(l.createHash("sha256").update(String(n)).digest("hex")!==u){const e=new h(401,"INVALID_OTP","OTP Tidak Valid","Kode OTP yang anda masukkan salah. Silakan coba lagi atau kirim ulang OTP.");return a.status(401).json(e.toResponse())}const c={password:await s.hash(i,10),last_change_password:p.fn.now()};1===o&&(c.account_status=2),await p("users").where({id:e.id}).update(c),await g.del(d),m.info(`| Reset Password | - Success for email: ${t}`);const w=new h(200,"PASSWORD_RESET_SUCCESS","Password Berhasil Diubah","Password anda berhasil diubah. Silakan login menggunakan password baru anda.");return a.status(200).json(w.toResponse())}catch(e){m.error(`| Auth | - Error function resetPassword: ${e.message}`);const t=new h(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");return a.status(500).json(t.toResponse())}}},9661:(e,a,t)=>{const{body:n}=t(7975);a.updateStudentValidator=[n("name").notEmpty().withMessage("Nama peserta tidak boleh kosong.").bail().isString().withMessage("Nama peserta harus berupa teks.").bail().isLength({max:255}).withMessage("Nama peserta maksimal 255 karakter."),n("email").notEmpty().withMessage("Email peserta tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain.").bail().isString().withMessage("Email peserta harus berupa teks.")]},9819:(e,a,t)=>{const{body:n}=t(7975);a.updateFeedbackValidator=[n("feedback").notEmpty().withMessage("Feedback wajib diisi.").bail().isInt({min:0,max:5}).withMessage("Feedback harus berupa bilangan bulat 0 sampai 5.").toInt(),n("comment").trim().notEmpty().withMessage("Komentar tidak boleh kosong.").bail().isString().withMessage("Komentar harus berupa teks.")]},9896:e=>{"use strict";e.exports=require("fs")},9974:(e,a,t)=>{const{resolveArrayRelations:n}=t(7972),i=t(2482);e.exports=async function(e){const a=await n(e.framework_file_ids,"documents",i),t=await n(e.plan_file_ids,"documents",i);return{id:e.id,frameworkFiles:a,planFiles:t,description:e.description,networthHibahUSD:e.networth_hibah_usd,networthHibahIDR:e.networth_hibah_idr,createdAt:e.created_at,updatedAt:e.updated_at,deletedAt:e.deleted_at}}},9976:(e,a,t)=>{const n=t(7252).Router(),i=t(2327),{profileValidator:s}=t(6113),r=t(2110),o=t(9022),l=t(6967),{requireAnyAbility:d}=t(7443),u=t(8461)().fields([{name:"files",maxCount:1}]);n.use(l,o),n.get("/get-user-profile",d(["super_admin","educator","student","monev"]),i.getUserProfile),n.get("/activity-log/:id",d(["super_admin","educator"]),i.getUserActivitybyUserId),n.patch("/update-profile",u,s,r,d(["super_admin","educator","student","monev"]),i.updateUserData),e.exports=n}},a={};function t(n){var i=a[n];if(void 0!==i)return i.exports;var s=a[n]={exports:{}};return e[n](s,s.exports,t),s.exports}t(818).config();const n=t(2525),i=t(7252),s=t(2096),r=(t(4930),t(4701)),o=(t(7484),t(4219)),l=t(364),d=t(7707),u=t(6087),c=t(4762),m=t(6824),p=t(8737),g=t(7385),w=t(7397),h=t(8605),_=t(9505),k=t(9289),b=t(6365),f=t(8196),y=t(9976),R=t(897),E=t(3016),D=t(7273),T=t(4683),S=t(3955),A=t(7110),I=t(6079),N=t(5730),j=t(6516),v=t(339),O=t(7065),L=t(2363),M=t(3809),C=t(1976),F=t(8630),P=t(7832),$=t(48),U=t(4674),{isLinux:V,resolvePublicBaseUrl:B}=t(4456),q=i();q.use(n()),V()&&q.set("trust proxy",1);const x=Number(process.env.PORT),z=Number(process.env.DOC_SERVER_PORT);q.locals.baseUrl=B("app",{app:x,docs:z}),q.locals.storageBaseUrl=B("docs",{app:x,docs:z}),q.use(r),q.use(i.json()),q.use(s("dev")),q.get("/api",(e,a)=>{a.json({message:"Welcome to the Rimba!"})}),q.get("/api/debug/urls",(e,a)=>{a.json({PG_ENV:process.env.PG_ENV,baseUrl:q.locals.baseUrl,storageBaseUrl:q.locals.storageBaseUrl})}),q.use("/api/api",u),q.use("/api/api/profile",y),q.use("/api/api/public-request",o),q.use("/api/api/kmis/public-request",d),q.use("/api/api/cms/public-request",l),q.use("/api/api/cms/content",N),q.use("/api/api/cms/news",j),q.use("/api/api/cms/event",v),q.use("/api/api/cms/animal-composition",O),q.use("/api/api/cms/legal-document",L),q.use("/api/api/cms/faq",I),q.use("/api/api/kmis/dashboard",c),q.use("/api/api/kmis/category",m),q.use("/api/api/kmis/topic",p),q.use("/api/api/kmis/educator",g),q.use("/api/api/kmis/student",w),q.use("/api/api/kmis/material",h),q.use("/api/api/kmis/quiz",_),q.use("/api/api/kmis/learning-participant",k),q.use("/api/api/kmis/learning-course",b),q.use("/api/api/kmis/exam",f),q.use("/api/api/monev/user",M),q.use("/api/api/monev/activity-package",C),q.use("/api/api/monev/target",F),q.use("/api/api/monev/monthly-realization",P),q.use("/api/api/monev/activity-calendar",$),q.use("/api/api/monev/share-report",U),q.use("/api/api/master-data/news-category",R),q.use("/api/api/master-data/event-category",E),q.use("/api/api/master-data/animal-category",D),q.use("/api/api/master-data/activity-category",T),q.use("/api/api/master-data/pic-division",S),q.use("/api/api/master-data/monev-dashboard",A),q.listen(x,()=>console.log(`Server running on port ${x}`))})();